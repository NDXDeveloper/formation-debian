üîù Retour au [Sommaire](/SOMMAIRE.md)

# Module 6.4 : Serveur de fichiers

*Tutoriel accessible aux d√©butants - Niveau : Interm√©diaire-Avanc√©*

## Introduction

Un serveur de fichiers permet de **centraliser le stockage** et de **partager des donn√©es** entre plusieurs utilisateurs et syst√®mes. C'est un √©l√©ment essentiel d'une infrastructure d'entreprise pour :
- Partager des documents entre √©quipes
- Centraliser les sauvegardes
- Synchroniser des donn√©es entre syst√®mes
- Contr√¥ler l'acc√®s aux fichiers sensibles

### Protocoles de partage de fichiers

**Samba (SMB/CIFS)** :
- ‚úÖ Compatible avec Windows, Mac, Linux
- ‚úÖ Int√©gration Active Directory possible
- ‚úÖ Gestion avanc√©e des permissions
- ‚úÖ Protocole le plus universel

**NFS (Network File System)** :
- ‚úÖ Protocole natif Unix/Linux
- ‚úÖ Tr√®s performant pour syst√®mes Linux
- ‚úÖ Transparent pour les applications
- ‚ùå Moins s√©curis√© par d√©faut

**FTP/SFTP** :
- ‚úÖ Standard pour transferts de fichiers
- ‚úÖ SFTP s√©curis√© par SSH
- ‚úÖ Id√©al pour √©changes externes
- ‚ùå Pas de montage transparent

> **üí° Strat√©gie d√©butant** : Commencer par Samba (plus universel), puis NFS pour les environnements Linux purs, et SFTP pour les transferts s√©curis√©s.

---

## 6.4.1 Samba (partage Windows)

### Comprendre Samba

**Samba** est une impl√©mentation libre du protocole SMB/CIFS de Microsoft. Il permet √† un serveur Linux de :
- Partager des fichiers avec des clients Windows
- Agir comme contr√¥leur de domaine
- Int√©grer un domaine Active Directory existant
- Fournir des services d'impression r√©seau

### Installation de Samba

```bash
# Mise √† jour du syst√®me
apt update

# Installation de Samba et outils
apt install -y samba samba-common-bin smbclient cifs-utils

# V√©rifier l'installation
samba --version
systemctl status smbd nmbd

# D√©marrer et activer les services
systemctl start smbd nmbd
systemctl enable smbd nmbd
```

**Services Samba** :
- `smbd` : Service de partage de fichiers (port 445)
- `nmbd` : Service de r√©solution de noms NetBIOS (ports 137-138)

### Configuration de base de Samba

#### Structure des r√©pertoires

```bash
# Cr√©er la structure de partage
mkdir -p /srv/samba/public
mkdir -p /srv/samba/private
mkdir -p /srv/samba/groups/comptabilite
mkdir -p /srv/samba/groups/direction
mkdir -p /srv/samba/users

# D√©finir les permissions de base
chmod 755 /srv/samba/public
chmod 750 /srv/samba/private
chmod 750 /srv/samba/groups/comptabilite
chmod 750 /srv/samba/groups/direction
chmod 700 /srv/samba/users

# Propri√©taire et groupe
chown -R root:root /srv/samba
```

#### Configuration principale de Samba

```bash
# Sauvegarder la configuration par d√©faut
cp /etc/samba/smb.conf /etc/samba/smb.conf.backup

# √âditer la configuration
nano /etc/samba/smb.conf
```

**Configuration compl√®te pour d√©butants** :
```ini
# /etc/samba/smb.conf - Configuration Samba

#======================= Global Settings =======================
[global]
# === PARAM√àTRES R√âSEAU ===
workgroup = ENTREPRISE
netbios name = SERVEUR-FICHIERS
server string = Serveur de fichiers Samba sur %h

# Interface r√©seau (ajustez selon votre configuration)
interfaces = 192.168.1.0/24 lo
bind interfaces only = yes

# === S√âCURIT√â ===
# Mode de s√©curit√© utilisateur (recommand√©)
security = user
encrypt passwords = yes
passdb backend = tdbsam

# D√©sactiver les connexions anonymes
map to guest = never
null passwords = no

# Restrictions d'acc√®s par IP (optionnel)
hosts allow = 192.168.1. 127.
hosts deny = ALL

# === LOGS ===
log file = /var/log/samba/log.%m
max log size = 1000
log level = 1

# === OPTIMISATIONS ===
socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
dead time = 15
getwd cache = yes

# === CARACT√àRES ET ENCODAGE ===
unix charset = UTF-8
dos charset = CP850

# Gestion des noms de fichiers
case sensitive = no
preserve case = yes
short preserve case = yes

#======================= Partages =======================

# === PARTAGE PUBLIC (lecture/√©criture pour tous) ===
[public]
comment = Dossier public accessible √† tous
path = /srv/samba/public
browseable = yes
writable = yes
guest ok = no
create mask = 0664
directory mask = 0775
force group = samba-users

# === PARTAGE PRIV√â (acc√®s restreint) ===
[private]
comment = Dossier priv√© - Acc√®s restreint
path = /srv/samba/private
browseable = yes
writable = yes
valid users = @samba-admins
create mask = 0660
directory mask = 0770
force group = samba-admins

# === DOSSIERS PERSONNELS ===
[homes]
comment = Dossier personnel de %U
browseable = no
writable = yes
create mask = 0600
directory mask = 0700
valid users = %S

# === PARTAGE GROUPE COMPTABILIT√â ===
[comptabilite]
comment = Documents Comptabilit√©
path = /srv/samba/groups/comptabilite
browseable = yes
writable = yes
valid users = @compta
create mask = 0664
directory mask = 0775
force group = compta

# === PARTAGE GROUPE DIRECTION ===
[direction]
comment = Documents Direction
path = /srv/samba/groups/direction
browseable = yes
writable = yes
valid users = @direction
admin users = @direction
create mask = 0660
directory mask = 0770
force group = direction
```

### Gestion des utilisateurs Samba

#### Cr√©er des groupes syst√®me

```bash
# Cr√©er les groupes pour Samba
groupadd samba-users
groupadd samba-admins
groupadd compta
groupadd direction

# V√©rifier les groupes cr√©√©s
getent group | grep -E "(samba|compta|direction)"
```

#### Cr√©er des utilisateurs Samba

```bash
# Cr√©er des utilisateurs syst√®me d'abord
useradd -m -g samba-users -s /bin/bash alice
useradd -m -g samba-users -s /bin/bash bob
useradd -m -g samba-admins -s /bin/bash admin-samba

# Ajouter les utilisateurs aux groupes appropri√©s
usermod -aG compta alice
usermod -aG direction bob
usermod -aG samba-admins admin-samba

# D√©finir les mots de passe syst√®me
passwd alice
passwd bob
passwd admin-samba

# Ajouter les utilisateurs √† Samba (avec mot de passe Samba)
smbpasswd -a alice
smbpasswd -a bob
smbpasswd -a admin-samba

# Activer les comptes Samba
smbpasswd -e alice
smbpasswd -e bob
smbpasswd -e admin-samba

# V√©rifier les utilisateurs Samba
pdbedit -L -v
```

#### Script de cr√©ation d'utilisateur automatis√©

```bash
# Script pour cr√©er facilement des utilisateurs Samba
nano /usr/local/bin/add-samba-user
```

```bash
#!/bin/bash
# Script de cr√©ation d'utilisateur Samba

# V√©rifier les arguments
if [ $# -lt 2 ]; then
    echo "Usage: $0 <nom_utilisateur> <groupe_principal> [groupes_suppl√©mentaires]"
    echo "Exemple: $0 marie samba-users compta,direction"
    exit 1
fi

USERNAME=$1
PRIMARY_GROUP=$2
ADDITIONAL_GROUPS=$3

echo "=== CR√âATION UTILISATEUR SAMBA ==="
echo "Utilisateur: $USERNAME"
echo "Groupe principal: $PRIMARY_GROUP"
echo "Groupes suppl√©mentaires: $ADDITIONAL_GROUPS"

# V√©rifier que le groupe principal existe
if ! getent group $PRIMARY_GROUP > /dev/null; then
    echo "Erreur: Le groupe $PRIMARY_GROUP n'existe pas"
    exit 1
fi

# Cr√©er l'utilisateur syst√®me
echo "Cr√©ation de l'utilisateur syst√®me..."
useradd -m -g $PRIMARY_GROUP -s /bin/bash $USERNAME

if [ $? -ne 0 ]; then
    echo "Erreur lors de la cr√©ation de l'utilisateur syst√®me"
    exit 1
fi

# Ajouter aux groupes suppl√©mentaires
if [ ! -z "$ADDITIONAL_GROUPS" ]; then
    echo "Ajout aux groupes suppl√©mentaires..."
    usermod -aG $ADDITIONAL_GROUPS $USERNAME
fi

# D√©finir le mot de passe syst√®me
echo "D√©finition du mot de passe syst√®me..."
passwd $USERNAME

# Ajouter √† Samba
echo "Ajout √† Samba..."
smbpasswd -a $USERNAME

# Activer le compte Samba
smbpasswd -e $USERNAME

# Cr√©er le dossier personnel Samba
mkdir -p /srv/samba/users/$USERNAME
chown $USERNAME:$PRIMARY_GROUP /srv/samba/users/$USERNAME
chmod 700 /srv/samba/users/$USERNAME

echo "‚úì Utilisateur $USERNAME cr√©√© avec succ√®s!"
echo "Groupes: $(groups $USERNAME)"
```

```bash
# Rendre le script ex√©cutable
chmod +x /usr/local/bin/add-samba-user

# Exemple d'utilisation
add-samba-user marie samba-users compta
```

### Configuration des permissions avanc√©es

#### Ajuster les permissions des r√©pertoires

```bash
# Permissions pour le partage public
chown root:samba-users /srv/samba/public
chmod 775 /srv/samba/public

# Permissions pour le partage priv√©
chown root:samba-admins /srv/samba/private
chmod 770 /srv/samba/private

# Permissions pour les groupes
chown root:compta /srv/samba/groups/comptabilite
chmod 770 /srv/samba/groups/comptabilite

chown root:direction /srv/samba/groups/direction
chmod 770 /srv/samba/groups/direction

# Permissions pour les dossiers utilisateurs
chown root:samba-users /srv/samba/users
chmod 755 /srv/samba/users
```

#### Test de la configuration

```bash
# Tester la syntaxe de la configuration
testparm

# Red√©marrer Samba pour appliquer les modifications
systemctl restart smbd nmbd

# V√©rifier que les services fonctionnent
systemctl status smbd nmbd

# Lister les partages disponibles
smbclient -L localhost -U alice

# Tester l'acc√®s √† un partage
smbclient //localhost/public -U alice
```

### S√©curisation de Samba

#### Configuration du pare-feu

```bash
# Autoriser Samba dans UFW
ufw allow from 192.168.1.0/24 to any port 445
ufw allow from 192.168.1.0/24 to any port 139
ufw allow from 192.168.1.0/24 to any port 137
ufw allow from 192.168.1.0/24 to any port 138

# Ou plus simple (mais moins s√©curis√©)
ufw allow samba

# V√©rifier les r√®gles
ufw status numbered
```

#### Configuration SSL/TLS pour Samba

```bash
# Cr√©er un certificat SSL pour Samba
mkdir -p /etc/samba/tls
cd /etc/samba/tls

# G√©n√©rer une cl√© priv√©e
openssl genrsa -out samba.key 2048

# G√©n√©rer un certificat auto-sign√© (valide 365 jours)
openssl req -new -x509 -key samba.key -out samba.crt -days 365 -subj "/C=FR/ST=Region/L=Ville/O=Entreprise/CN=serveur-fichiers.local"

# S√©curiser les fichiers
chmod 600 samba.key
chmod 644 samba.crt
chown root:root samba.*
```

Ajouter √† la configuration Samba :
```ini
# Dans la section [global] de /etc/samba/smb.conf
tls enabled = yes
tls keyfile = /etc/samba/tls/samba.key
tls certfile = /etc/samba/tls/samba.crt
tls cafile =
server min protocol = SMB2_10
client max protocol = SMB3
client min protocol = SMB2_10
```

---

## 6.4.2 NFS (partage Linux)

### Comprendre NFS

**NFS (Network File System)** est le protocole de partage de fichiers natif des syst√®mes Unix/Linux. Il permet de :
- Monter des r√©pertoires distants comme s'ils √©taient locaux
- Partager efficacement des donn√©es entre serveurs Linux
- Centraliser les donn√©es avec transparence applicative

### Installation du serveur NFS

```bash
# Installation du serveur NFS
apt install -y nfs-kernel-server nfs-common rpcbind

# D√©marrer et activer les services
systemctl start nfs-kernel-server
systemctl enable nfs-kernel-server
systemctl start rpcbind
systemctl enable rpcbind

# V√©rifier l'installation
systemctl status nfs-kernel-server
showmount -e localhost
```

### Configuration du serveur NFS

#### Cr√©er la structure de partage NFS

```bash
# Cr√©er les r√©pertoires de partage NFS
mkdir -p /srv/nfs/public
mkdir -p /srv/nfs/secure
mkdir -p /srv/nfs/backup
mkdir -p /srv/nfs/web-data

# D√©finir les permissions
chmod 755 /srv/nfs/public
chmod 750 /srv/nfs/secure
chmod 755 /srv/nfs/backup
chmod 755 /srv/nfs/web-data

# Propri√©taires
chown nobody:nogroup /srv/nfs/public
chown nobody:nogroup /srv/nfs/backup
chown root:root /srv/nfs/secure
chown www-data:www-data /srv/nfs/web-data
```

#### Configuration des exports NFS

```bash
# √âditer le fichier des exports
nano /etc/exports
```

**Configuration compl√®te pour d√©butants** :
```bash
# /etc/exports - Configuration NFS

# === PARTAGE PUBLIC ===
# Accessible en lecture/√©criture depuis le r√©seau local
/srv/nfs/public    192.168.1.0/24(rw,sync,no_subtree_check,no_root_squash)

# === PARTAGE S√âCURIS√â ===
# Accessible seulement depuis des IPs sp√©cifiques, en lecture seule par d√©faut
/srv/nfs/secure    192.168.1.10(rw,sync,no_subtree_check,root_squash)
/srv/nfs/secure    192.168.1.20(ro,sync,no_subtree_check,root_squash)

# === SAUVEGARDE ===
# Montage pour sauvegardes automatiques
/srv/nfs/backup    192.168.1.0/24(rw,sync,no_subtree_check,no_root_squash,no_all_squash)

# === DONN√âES WEB ===
# Partage pour serveurs web (avec utilisateur www-data)
/srv/nfs/web-data  192.168.1.0/24(rw,sync,no_subtree_check,all_squash,anonuid=33,anongid=33)

# === EXEMPLES D'OPTIONS AVANC√âES ===

# Partage en lecture seule pour tout le monde
# /srv/nfs/readonly  *(ro,sync,no_subtree_check,root_squash)

# Partage avec authentification Kerberos (plus s√©curis√©)
# /srv/nfs/kerberos  192.168.1.0/24(rw,sync,sec=krb5p,no_subtree_check)

# Partage avec cache asynchrone (plus rapide mais moins s√ªr)
# /srv/nfs/fast      192.168.1.0/24(rw,async,no_subtree_check,no_root_squash)
```

**Explication des options pour d√©butants** :
- `rw` : Lecture/√©criture | `ro` : Lecture seule
- `sync` : Synchrone (s√©curis√©) | `async` : Asynchrone (rapide)
- `no_subtree_check` : D√©sactive la v√©rification de sous-arbre (plus rapide)
- `root_squash` : root distant devient nobody (s√©curis√©)
- `no_root_squash` : root distant reste root (attention s√©curit√©)
- `all_squash` : Tous les utilisateurs deviennent nobody
- `anonuid/anongid` : UID/GID pour les utilisateurs anonymes

#### Appliquer la configuration NFS

```bash
# Exporter les partages
exportfs -a

# Red√©marrer le service NFS
systemctl restart nfs-kernel-server

# V√©rifier les exports actifs
exportfs -v
showmount -e localhost
```

### Configuration des clients NFS

#### Installation sur client Linux

```bash
# Sur le client Linux
apt install -y nfs-common

# Cr√©er les points de montage
mkdir -p /mnt/nfs-public
mkdir -p /mnt/nfs-backup
mkdir -p /mnt/nfs-web
```

#### Montage manuel des partages NFS

```bash
# Monter le partage public
mount -t nfs 192.168.1.100:/srv/nfs/public /mnt/nfs-public

# V√©rifier le montage
df -h | grep nfs
ls -la /mnt/nfs-public

# Test d'√©criture
echo "Test NFS" > /mnt/nfs-public/test.txt
cat /mnt/nfs-public/test.txt

# D√©monter
umount /mnt/nfs-public
```

#### Montage automatique avec fstab

```bash
# √âditer fstab sur le client
nano /etc/fstab
```

```bash
# Montages NFS automatiques
192.168.1.100:/srv/nfs/public  /mnt/nfs-public  nfs  defaults,rw,hard,timeo=14,intr  0  0
192.168.1.100:/srv/nfs/backup  /mnt/nfs-backup  nfs  defaults,rw,hard,timeo=14,intr  0  0
192.168.1.100:/srv/nfs/web-data /var/www/shared nfs  defaults,rw,hard,timeo=14,intr  0  0
```

**Options de montage expliqu√©es** :
- `defaults` : Options par d√©faut
- `hard` : Retry ind√©finiment si serveur indisponible
- `soft` : Abandonner apr√®s timeout (alternative √† hard)
- `timeo=14` : Timeout en 1/10 de seconde
- `intr` : Interruptible par signal

```bash
# Monter tous les syst√®mes de fichiers
mount -a

# V√©rifier les montages
mount | grep nfs
```

### Optimisation et performance NFS

#### Configuration de performance serveur

```bash
# Ajuster le nombre de threads NFS
nano /etc/default/nfs-kernel-server
```

```bash
# Nombre de threads NFS (augmenter pour plus de performance)
RPCNFSDCOUNT=8

# Options RPC
RPCNFSDOPTS=""

# Activer NFSv4
RPCNFSDPRIO=0
```

#### Configuration client pour performance

```bash
# Options de montage optimis√©es
nano /etc/fstab
```

```bash
# Montage optimis√© pour performance
192.168.1.100:/srv/nfs/public  /mnt/nfs-public  nfs  defaults,rw,hard,intr,rsize=8192,wsize=8192,timeo=14  0  0

# Montage optimis√© pour r√©seaux lents
192.168.1.100:/srv/nfs/backup  /mnt/nfs-backup  nfs  defaults,rw,soft,intr,rsize=1024,wsize=1024,timeo=600  0  0
```

### S√©curisation de NFS

#### Configuration du pare-feu pour NFS

```bash
# NFS utilise plusieurs ports, configurer UFW
ufw allow from 192.168.1.0/24 to any port 2049  # NFS
ufw allow from 192.168.1.0/24 to any port 111   # RPC portmapper
ufw allow from 192.168.1.0/24 to any port 20048 # mountd

# Ou autoriser le service NFS complet (moins s√©curis√©)
ufw allow nfs

# V√©rifier
ufw status
```

#### Ports fixes pour NFS (recommand√©)

```bash
# Configurer des ports fixes pour les services NFS
nano /etc/default/nfs-kernel-server
```

```bash
# Ports fixes pour NFS
RPCMOUNTDOPTS="--manage-gids --port 20048"
STATDOPTS="--port 20024 --outgoing-port 20025"
```

```bash
# Configurer le port pour lockd
nano /etc/modprobe.d/nfs.conf
```

```bash
# Port fixe pour lockd
options lockd nlm_udpport=20026 nlm_tcpport=20026
```

```bash
# Red√©marrer les services NFS
systemctl restart nfs-kernel-server
systemctl restart rpcbind

# V√©rifier les ports utilis√©s
rpcinfo -p localhost
```

---

## 6.4.3 FTP/SFTP s√©curis√©

### Comprendre FTP vs SFTP

**FTP (File Transfer Protocol)** :
- ‚ùå Non s√©curis√© (mots de passe en clair)
- ‚ùå Deux connexions (commandes + donn√©es)
- ‚úÖ Support√© universellement
- ‚úÖ Bon pour transferts publics

**SFTP (SSH File Transfer Protocol)** :
- ‚úÖ S√©curis√© par SSH
- ‚úÖ Une seule connexion
- ‚úÖ Authentification par cl√©s possibles
- ‚úÖ Recommand√© pour donn√©es sensibles

> **üí° Recommandation** : Utiliser uniquement SFTP en production, FTP seulement si absolument n√©cessaire.

### Configuration SFTP avec OpenSSH

#### SFTP est inclus avec OpenSSH

SFTP est automatiquement disponible avec OpenSSH (d√©j√† install√© dans le Module 6.1).

```bash
# V√©rifier que SFTP est disponible
grep -i sftp /etc/ssh/sshd_config
# Doit contenir : Subsystem sftp /usr/lib/openssh/sftp-server
```

#### Cr√©er des utilisateurs SFTP

```bash
# Cr√©er un groupe pour les utilisateurs SFTP uniquement
groupadd sftponly

# Cr√©er un utilisateur SFTP (sans acc√®s shell)
useradd -m -g sftponly -s /bin/false alice-ftp
useradd -m -g sftponly -s /bin/false bob-ftp

# D√©finir les mots de passe
passwd alice-ftp
passwd bob-ftp

# Cr√©er la structure de r√©pertoires pour SFTP chroot
mkdir -p /srv/sftp/alice-ftp/upload
mkdir -p /srv/sftp/bob-ftp/upload

# Permissions pour chroot (important !)
chown root:root /srv/sftp
chown root:root /srv/sftp/alice-ftp
chown root:root /srv/sftp/bob-ftp
chmod 755 /srv/sftp/alice-ftp
chmod 755 /srv/sftp/bob-ftp

# L'utilisateur ne peut √©crire que dans upload
chown alice-ftp:sftponly /srv/sftp/alice-ftp/upload
chown bob-ftp:sftponly /srv/sftp/bob-ftp/upload
chmod 755 /srv/sftp/alice-ftp/upload
chmod 755 /srv/sftp/bob-ftp/upload
```

#### Configuration SFTP s√©curis√©e

```bash
# √âditer la configuration SSH pour SFTP
nano /etc/ssh/sshd_config
```

Ajouter √† la fin du fichier :
```bash
# Configuration SFTP s√©curis√©e

# Subsystem SFTP (d√©j√† pr√©sent normalement)
Subsystem sftp /usr/lib/openssh/sftp-server

# Configuration pour le groupe sftponly
Match Group sftponly
    # Forcer SFTP uniquement (pas de shell)
    ForceCommand internal-sftp

    # Isolation dans un r√©pertoire (chroot)
    ChrootDirectory /srv/sftp/%u

    # D√©sactiver le tunneling
    AllowTcpForwarding no
    X11Forwarding no

    # D√©sactiver les agents SSH
    AllowAgentForwarding no

    # Permissions restrictives
    PermitTunnel no
```

```bash
# Tester la configuration SSH
sshd -t

# Red√©marrer SSH pour appliquer
systemctl restart ssh

# V√©rifier que SSH fonctionne toujours
systemctl status ssh
```

#### Test de SFTP

```bash
# Tester depuis le serveur local
sftp alice-ftp@localhost

# Commandes SFTP de base
# ls          : lister les fichiers
# cd upload   : aller dans upload
# put fichier : envoyer un fichier
# get fichier : r√©cup√©rer un fichier
# quit        : quitter
```

### Installation de vsftpd (FTP s√©curis√©)

Si FTP est absolument n√©cessaire, utilisez vsftpd qui est plus s√©curis√©.

#### Installation et configuration de base

```bash
# Installer vsftpd
apt install -y vsftpd

# Sauvegarder la configuration par d√©faut
cp /etc/vsftpd.conf /etc/vsftpd.conf.backup

# √âditer la configuration
nano /etc/vsftpd.conf
```

**Configuration s√©curis√©e de vsftpd** :
```bash
# /etc/vsftpd.conf - Configuration s√©curis√©e

# === PARAM√àTRES DE BASE ===
listen=NO
listen_ipv6=YES
anonymous_enable=NO
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
use_localtime=YES

# === S√âCURIT√â ===
# D√©sactiver les connexions anonymes
anonymous_enable=NO

# Limitation des utilisateurs
userlist_enable=YES
userlist_file=/etc/vsftpd.userlist
userlist_deny=NO

# Jail (isolation) des utilisateurs
chroot_local_user=YES
allow_writeable_chroot=YES
secure_chroot_dir=/var/run/vsftpd/empty

# Connexions s√©curis√©es uniquement
ssl_enable=YES
allow_anon_ssl=NO
force_local_data_ssl=YES
force_local_logins_ssl=YES
ssl_tlsv1=YES
ssl_sslv2=NO
ssl_sslv3=NO

# Certificats SSL
rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key

# === PERFORMANCE ET LIMITES ===
# Connexions simultan√©es
max_clients=50
max_per_ip=5

# Timeouts
idle_session_timeout=300
data_connection_timeout=120

# Vitesse (bytes/sec) - 0 = illimit√©
local_max_rate=1000000

# === LOGS ===
xferlog_enable=YES
xferlog_file=/var/log/vsftpd.log
xferlog_std_format=YES
log_ftp_protocol=YES

# === PORTS ===
listen_port=21
ftp_data_port=20

# Mode passif (important pour les pare-feu)
pasv_enable=YES
pasv_min_port=10000
pasv_max_port=10100
```

#### Configuration des utilisateurs FTP

```bash
# Cr√©er la liste des utilisateurs autoris√©s
nano /etc/vsftpd.userlist
```

```bash
# Utilisateurs autoris√©s √† utiliser FTP
alice-ftp
bob-ftp
admin-ftp
```

```bash
# Cr√©er les r√©pertoires FTP
mkdir -p /srv/ftp/alice-ftp
mkdir -p /srv/ftp/bob-ftp

# Permissions
chown alice-ftp:sftponly /srv/ftp/alice-ftp
chown bob-ftp:sftponly /srv/ftp/bob-ftp
chmod 755 /srv/ftp/alice-ftp
chmod 755 /srv/ftp/bob-ftp

# D√©finir le r√©pertoire home pour FTP
usermod -d /srv/ftp/alice-ftp alice-ftp
usermod -d /srv/ftp/bob-ftp bob-ftp
```

#### Certificats SSL pour FTP

```bash
# G√©n√©rer un certificat SSL pour vsftpd
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout /etc/ssl/private/vsftpd.key \
    -out /etc/ssl/certs/vsftpd.crt \
    -subj "/C=FR/ST=Region/L=Ville/O=Entreprise/CN=ftp.exemple.com"

# S√©curiser les fichiers
chmod 600 /etc/ssl/private/vsftpd.key
chmod 644 /etc/ssl/certs/vsftpd.crt

# Mettre √† jour la configuration vsftpd
nano /etc/vsftpd.conf
```

```bash
# Certificats personnalis√©s
rsa_cert_file=/etc/ssl/certs/vsftpd.crt
rsa_private_key_file=/etc/ssl/private/vsftpd.key
```

#### D√©marrage et test de vsftpd

```bash
# D√©marrer et activer vsftpd
systemctl start vsftpd
systemctl enable vsftpd

# V√©rifier le statut
systemctl status vsftpd

# Tester les connexions
ftp localhost
# Ou avec SSL
lftp -e "set ftp:ssl-force true; set ssl:verify-certificate no" localhost
```

### Configuration du pare-feu pour FTP

```bash
# Ports pour FTP avec vsftpd
ufw allow from 192.168.1.0/24 to any port 21    # Port de contr√¥le FTP
ufw allow from 192.168.1.0/24 to any port 20    # Port de donn√©es FTP
ufw allow from 192.168.1.0/24 to any port 10000:10100  # Ports passifs

# Pour SFTP (utilise SSH)
ufw allow from 192.168.1.0/24 to any port 2222  # Si SSH sur port personnalis√©

# V√©rifier les r√®gles
ufw status numbered
```

---

## 6.4.4 Configuration et s√©curisation

### S√©curisation globale du serveur de fichiers

#### Audit des acc√®s et monitoring

```bash
# Script de monitoring des acc√®s fichiers
nano /usr/local/bin/file-server-monitor
```

```bash
#!/bin/bash
# Monitoring du serveur de fichiers

LOG_FILE="/var/log/file-server-monitor.log"
ALERT_EMAIL="admin@exemple.com"

# Fonction de log
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $LOG_FILE
}

# Monitoring Samba
check_samba() {
    log_message "=== MONITORING SAMBA ==="

    if systemctl is-active --quiet smbd; then
        # Connexions actives
        SAMBA_CONNECTIONS=$(smbstatus -b | grep -c "^[0-9]")
        log_message "Connexions Samba actives: $SAMBA_CONNECTIONS"

        # Fichiers verrouill√©s
        LOCKED_FILES=$(smbstatus -L | grep -c "DENY_")
        log_message "Fichiers verrouill√©s: $LOCKED_FILES"

        # Utilisateurs connect√©s
        ACTIVE_USERS=$(smbstatus -u | grep -c "^[a-zA-Z]")
        log_message "Utilisateurs actifs: $ACTIVE_USERS"

        # V√©rifier l'espace disque des partages
        for share_path in /srv/samba/public /srv/samba/private; do
            if [ -d "$share_path" ]; then
                USAGE=$(df "$share_path" | tail -1 | awk '{print $5}' | sed 's/%//')
                log_message "Utilisation $share_path: $USAGE%"

                if [ $USAGE -gt 85 ]; then
                    log_message "‚ö† ALERTE: Espace disque faible sur $share_path ($USAGE%)"
                fi
            fi
        done

        log_message "‚úì Samba op√©rationnel"
    else
        log_message "‚úó ERREUR: Service Samba arr√™t√©"
        return 1
    fi

    return 0
}

# Monitoring NFS
check_nfs() {
    log_message "=== MONITORING NFS ==="

    if systemctl is-active --quiet nfs-kernel-server; then
        # Exports actifs
        EXPORTS=$(showmount -e localhost 2>/dev/null | grep -c "^/")
        log_message "Exports NFS actifs: $EXPORTS"

        # Clients connect√©s
        CLIENTS=$(showmount -a localhost 2>/dev/null | grep -c ":")
        log_message "Clients NFS connect√©s: $CLIENTS"

        # V√©rifier les montages c√¥t√© serveur
        NFS_MOUNTS=$(mount | grep -c " nfs ")
        log_message "Montages NFS locaux: $NFS_MOUNTS"

        log_message "‚úì NFS op√©rationnel"
    else
        log_message "‚úó ERREUR: Service NFS arr√™t√©"
        return 1
    fi

    return 0
}

# Monitoring SFTP/FTP
check_ftp() {
    log_message "=== MONITORING FTP/SFTP ==="

    # SFTP (via SSH)
    if systemctl is-active --quiet ssh; then
        SFTP_CONNECTIONS=$(ss -t state connected | grep :22 | wc -l)
        log_message "Connexions SSH/SFTP: $SFTP_CONNECTIONS"
    fi

    # vsftpd (si install√©)
    if systemctl is-active --quiet vsftpd 2>/dev/null; then
        FTP_CONNECTIONS=$(ss -t state connected | grep :21 | wc -l)
        log_message "Connexions FTP: $FTP_CONNECTIONS"
        log_message "‚úì vsftpd op√©rationnel"
    fi

    return 0
}

# V√©rification de l'int√©grit√© des fichiers
check_file_integrity() {
    log_message "=== V√âRIFICATION INT√âGRIT√â ==="

    # V√©rifier les permissions critiques
    for dir in /srv/samba /srv/nfs /srv/ftp; do
        if [ -d "$dir" ]; then
            PERMS=$(stat -c %a "$dir")
            log_message "Permissions $dir: $PERMS"

            # Chercher des fichiers avec permissions suspectes
            SUSPICIOUS=$(find "$dir" -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null | wc -l)
            if [ $SUSPICIOUS -gt 0 ]; then
                log_message "‚ö† ALERTE: $SUSPICIOUS fichiers avec permissions SUID/SGID dans $dir"
                find "$dir" -type f \( -perm -4000 -o -perm -2000 \) -exec ls -la {} \; | tee -a $LOG_FILE
            fi
        fi
    done
}

# Analyse des logs de s√©curit√©
check_security_logs() {
    log_message "=== ANALYSE LOGS S√âCURIT√â ==="

    # Tentatives de connexion √©chou√©es (derni√®re heure)
    FAILED_LOGIN_SAMBA=$(grep -c "authentication for user.*failed" /var/log/samba/log.smbd 2>/dev/null || echo 0)
    log_message "√âchecs d'authentification Samba (1h): $FAILED_LOGIN_SAMBA"

    FAILED_LOGIN_SSH=$(grep -c "Failed password" /var/log/auth.log | tail -100 | grep "$(date '+%b %d %H:')" | wc -l 2>/dev/null || echo 0)
    log_message "√âchecs d'authentification SSH (1h): $FAILED_LOGIN_SSH"

    # Alertes si trop de tentatives
    if [ $FAILED_LOGIN_SAMBA -gt 10 ]; then
        log_message "‚ö† ALERTE: Trop de tentatives de connexion Samba √©chou√©es"
    fi

    if [ $FAILED_LOGIN_SSH -gt 10 ]; then
        log_message "‚ö† ALERTE: Trop de tentatives de connexion SSH √©chou√©es"
    fi
}

# Ex√©cution du monitoring
ERRORS=0

check_samba || ERRORS=$((ERRORS + 1))
check_nfs || ERRORS=$((ERRORS + 1))
check_ftp
check_file_integrity
check_security_logs

# R√©sum√© et alertes
if [ $ERRORS -gt 0 ]; then
    log_message "ALERTE: $ERRORS service(s) en erreur d√©tect√©(s)"

    # Envoyer email si configur√©
    if command -v mail >/dev/null 2>&1; then
        tail -50 $LOG_FILE | mail -s "Alerte Serveur de Fichiers - $HOSTNAME" $ALERT_EMAIL
    fi

    exit 1
else
    log_message "‚úì Tous les services de fichiers op√©rationnels"
    exit 0
fi
```

```bash
# Rendre le script ex√©cutable
chmod +x /usr/local/bin/file-server-monitor

# Tester le script
file-server-monitor
```

### Sauvegarde des configurations et donn√©es

#### Script de sauvegarde automatis√©e

```bash
nano /usr/local/bin/fileserver-backup
```

```bash
#!/bin/bash
# Sauvegarde compl√®te du serveur de fichiers

BACKUP_DIR="/var/backups/fileserver"
DATE=$(date +"%Y%m%d_%H%M%S")
RETENTION_DAYS=14

# Cr√©er le r√©pertoire de sauvegarde
mkdir -p $BACKUP_DIR

# Fonction de log
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $BACKUP_DIR/backup.log
}

log_message "=== D√âBUT SAUVEGARDE SERVEUR DE FICHIERS ==="

# Sauvegarde des configurations
log_message "Sauvegarde des configurations..."

# Configuration Samba
if [ -f /etc/samba/smb.conf ]; then
    cp /etc/samba/smb.conf $BACKUP_DIR/smb.conf_$DATE
    log_message "‚úì Configuration Samba sauvegard√©e"
fi

# Configuration NFS
if [ -f /etc/exports ]; then
    cp /etc/exports $BACKUP_DIR/exports_$DATE
    log_message "‚úì Configuration NFS sauvegard√©e"
fi

# Configuration FTP
if [ -f /etc/vsftpd.conf ]; then
    cp /etc/vsftpd.conf $BACKUP_DIR/vsftpd.conf_$DATE
    log_message "‚úì Configuration FTP sauvegard√©e"
fi

# Configuration SSH/SFTP
cp /etc/ssh/sshd_config $BACKUP_DIR/sshd_config_$DATE

# Utilisateurs et groupes
getent passwd | grep -E "(samba|ftp|nfs)" > $BACKUP_DIR/users_$DATE
getent group | grep -E "(samba|ftp|nfs)" > $BACKUP_DIR/groups_$DATE

# Base d'utilisateurs Samba
if command -v pdbedit >/dev/null; then
    pdbedit -L > $BACKUP_DIR/samba_users_$DATE 2>/dev/null
    log_message "‚úì Utilisateurs Samba sauvegard√©s"
fi

# Sauvegarde des donn√©es (selon la taille)
log_message "√âvaluation des donn√©es √† sauvegarder..."

for data_dir in /srv/samba /srv/nfs /srv/ftp; do
    if [ -d "$data_dir" ]; then
        SIZE=$(du -sm "$data_dir" | cut -f1)
        log_message "Taille de $data_dir: ${SIZE}MB"

        if [ $SIZE -lt 1000 ]; then  # Moins de 1GB
            log_message "Sauvegarde compl√®te de $data_dir..."
            tar -czf $BACKUP_DIR/$(basename $data_dir)_data_$DATE.tar.gz -C $(dirname $data_dir) $(basename $data_dir)
            log_message "‚úì Donn√©es $data_dir sauvegard√©es"
        else
            log_message "‚ö† $data_dir trop volumineux pour sauvegarde automatique (${SIZE}MB)"
            # Sauvegarder seulement la structure
            find "$data_dir" -type d > $BACKUP_DIR/$(basename $data_dir)_structure_$DATE.txt
            log_message "‚úì Structure de $data_dir sauvegard√©e"
        fi
    fi
done

# M√©tadonn√©es et permissions
log_message "Sauvegarde des m√©tadonn√©es..."
for data_dir in /srv/samba /srv/nfs /srv/ftp; do
    if [ -d "$data_dir" ]; then
        find "$data_dir" -type f -o -type d | xargs ls -la > $BACKUP_DIR/$(basename $data_dir)_permissions_$DATE.txt 2>/dev/null
    fi
done

# Statistiques de sauvegarde
log_message "Calcul des statistiques..."
BACKUP_SIZE=$(du -sh $BACKUP_DIR | cut -f1)
log_message "Taille totale des sauvegardes: $BACKUP_SIZE"

# Nettoyage des anciennes sauvegardes
log_message "Nettoyage des sauvegardes anciennes (>$RETENTION_DAYS jours)..."
find $BACKUP_DIR -name "*_*" -mtime +$RETENTION_DAYS -delete

# V√©rification d'int√©grit√©
log_message "V√©rification d'int√©grit√© des archives..."
for archive in $BACKUP_DIR/*.tar.gz; do
    if [ -f "$archive" ]; then
        if tar -tzf "$archive" >/dev/null 2>&1; then
            log_message "‚úì $(basename $archive) int√®gre"
        else
            log_message "‚úó ERREUR: $(basename $archive) corrompue"
        fi
    fi
done

log_message "=== FIN SAUVEGARDE SERVEUR DE FICHIERS ==="
```

#### Script de restauration

```bash
nano /usr/local/bin/fileserver-restore
```

```bash
#!/bin/bash
# Restauration du serveur de fichiers

BACKUP_DIR="/var/backups/fileserver"

# Fonction d'aide
show_help() {
    echo "Usage: $0 [OPTIONS]"
    echo "Options:"
    echo "  -d <date>     : Date de sauvegarde (format: YYYYMMDD_HHMMSS)"
    echo "  -c            : Restaurer seulement les configurations"
    echo "  -f            : Restaurer les donn√©es (attention: √©crase les donn√©es existantes)"
    echo "  -l            : Lister les sauvegardes disponibles"
    echo "  -h            : Afficher cette aide"
}

# Lister les sauvegardes
list_backups() {
    echo "=== SAUVEGARDES DISPONIBLES ==="
    echo "Configurations:"
    ls -la $BACKUP_DIR/*smb.conf_* 2>/dev/null | awk '{print $9, $5, $6, $7, $8}'
    echo
    echo "Donn√©es:"
    ls -la $BACKUP_DIR/*_data_*.tar.gz 2>/dev/null | awk '{print $9, $5, $6, $7, $8}'
}

# Restaurer les configurations
restore_configs() {
    local date=$1

    echo "Restauration des configurations pour la date: $date"

    # Samba
    if [ -f "$BACKUP_DIR/smb.conf_$date" ]; then
        echo "Restauration configuration Samba..."
        cp /etc/samba/smb.conf /etc/samba/smb.conf.before_restore
        cp "$BACKUP_DIR/smb.conf_$date" /etc/samba/smb.conf
        systemctl reload smbd
        echo "‚úì Configuration Samba restaur√©e"
    fi

    # NFS
    if [ -f "$BACKUP_DIR/exports_$date" ]; then
        echo "Restauration configuration NFS..."
        cp /etc/exports /etc/exports.before_restore
        cp "$BACKUP_DIR/exports_$date" /etc/exports
        exportfs -ra
        echo "‚úì Configuration NFS restaur√©e"
    fi

    # FTP
    if [ -f "$BACKUP_DIR/vsftpd.conf_$date" ]; then
        echo "Restauration configuration FTP..."
        cp /etc/vsftpd.conf /etc/vsftpd.conf.before_restore
        cp "$BACKUP_DIR/vsftpd.conf_$date" /etc/vsftpd.conf
        systemctl reload vsftpd
        echo "‚úì Configuration FTP restaur√©e"
    fi

    # SSH/SFTP
    if [ -f "$BACKUP_DIR/sshd_config_$date" ]; then
        echo "Restauration configuration SSH..."
        cp /etc/ssh/sshd_config /etc/ssh/sshd_config.before_restore
        cp "$BACKUP_DIR/sshd_config_$date" /etc/ssh/sshd_config

        # Tester la configuration avant de red√©marrer
        if sshd -t; then
            systemctl reload ssh
            echo "‚úì Configuration SSH restaur√©e"
        else
            echo "‚úó ERREUR: Configuration SSH invalide, restauration annul√©e"
            cp /etc/ssh/sshd_config.before_restore /etc/ssh/sshd_config
        fi
    fi
}

# Restaurer les donn√©es
restore_data() {
    local date=$1

    echo "ATTENTION: Cette op√©ration va √©craser les donn√©es existantes!"
    read -p "Continuer? (y/N): " confirm

    if [[ $confirm == [yY] ]]; then
        for service in samba nfs ftp; do
            archive="$BACKUP_DIR/${service}_data_${date}.tar.gz"
            if [ -f "$archive" ]; then
                echo "Restauration des donn√©es $service..."

                # Sauvegarde de s√©curit√©
                if [ -d "/srv/$service" ]; then
                    mv "/srv/$service" "/srv/${service}.backup_$(date +%Y%m%d_%H%M%S)"
                fi

                # Restauration
                tar -xzf "$archive" -C /srv/
                echo "‚úì Donn√©es $service restaur√©es depuis $archive"
            fi
        done

        # Restaurer les permissions
        for service in samba nfs ftp; do
            perm_file="$BACKUP_DIR/${service}_permissions_${date}.txt"
            if [ -f "$perm_file" ]; then
                echo "Les permissions sont document√©es dans: $perm_file"
                echo "Restauration manuelle des permissions recommand√©e."
            fi
        done
    fi
}

# Variables par d√©faut
CONFIG_ONLY=false
DATA_ONLY=false

# Traitement des arguments
while getopts "d:cflh" opt; do
    case $opt in
        d) DATE="$OPTARG" ;;
        c) CONFIG_ONLY=true ;;
        f) DATA_ONLY=true ;;
        l) list_backups; exit 0 ;;
        h) show_help; exit 0 ;;
        \?) echo "Option invalide: -$OPTARG"; show_help; exit 1 ;;
    esac
done

# V√©rifications
if [ -z "$DATE" ] && [ "$CONFIG_ONLY" = true -o "$DATA_ONLY" = true ]; then
    echo "Date de sauvegarde requise (-d)"
    show_help
    exit 1
fi

# Ex√©cution de la restauration
if [ "$CONFIG_ONLY" = true ]; then
    restore_configs "$DATE"
elif [ "$DATA_ONLY" = true ]; then
    restore_data "$DATE"
elif [ ! -z "$DATE" ]; then
    restore_configs "$DATE"
    restore_data "$DATE"
else
    show_help
fi
```

### Automatisation et maintenance

#### Configuration de cron pour maintenance automatique

```bash
# Rendre les scripts ex√©cutables
chmod +x /usr/local/bin/fileserver-backup
chmod +x /usr/local/bin/fileserver-restore

# Configuration de cron
crontab -e
```

```bash
# Maintenance serveur de fichiers

# Monitoring toutes les 10 minutes
*/10 * * * * /usr/local/bin/file-server-monitor >/dev/null 2>&1

# Sauvegarde quotidienne √† 3h du matin
0 3 * * * /usr/local/bin/fileserver-backup >/dev/null 2>&1

# Nettoyage hebdomadaire des logs et fichiers temporaires
0 2 * * 0 /usr/local/bin/fileserver-cleanup

# Rapport mensuel d'utilisation
0 6 1 * * /usr/local/bin/fileserver-usage-report
```

#### Script de nettoyage automatique

```bash
nano /usr/local/bin/fileserver-cleanup
```

```bash
#!/bin/bash
# Nettoyage automatique serveur de fichiers

LOG_FILE="/var/log/fileserver-cleanup.log"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $LOG_FILE
}

log_message "=== D√âBUT NETTOYAGE SERVEUR DE FICHIERS ==="

# Nettoyage des logs anciens
log_message "Nettoyage des logs..."
find /var/log/samba -name "*.log*" -mtime +30 -delete 2>/dev/null || true
find /var/log -name "fileserver*.log" -mtime +30 -delete 2>/dev/null || true

# Nettoyage des fichiers temporaires dans les partages
log_message "Nettoyage des fichiers temporaires..."
for share_dir in /srv/samba /srv/nfs /srv/ftp; do
    if [ -d "$share_dir" ]; then
        # Supprimer les fichiers temporaires (.tmp, .bak, ~*)
        find "$share_dir" -name "*.tmp" -mtime +7 -delete 2>/dev/null || true
        find "$share_dir" -name "*.bak" -mtime +30 -delete 2>/dev/null || true
        find "$share_dir" -name "~*" -mtime +7 -delete 2>/dev/null || true
        find "$share_dir" -name ".DS_Store" -delete 2>/dev/null || true
        find "$share_dir" -name "Thumbs.db" -delete 2>/dev/null || true

        log_message "‚úì Nettoyage temporaires dans $share_dir"
    fi
done

# Nettoyage des r√©pertoires vides
log_message "Suppression des r√©pertoires vides..."
for share_dir in /srv/samba /srv/nfs /srv/ftp; do
    if [ -d "$share_dir" ]; then
        find "$share_dir" -type d -empty -mtime +1 -delete 2>/dev/null || true
    fi
done

# V√©rification de l'espace disque
log_message "V√©rification espace disque..."
for share_dir in /srv/samba /srv/nfs /srv/ftp; do
    if [ -d "$share_dir" ]; then
        USAGE=$(df "$share_dir" | tail -1 | awk '{print $5}' | sed 's/%//')
        SIZE=$(du -sh "$share_dir" | cut -f1)
        log_message "Utilisation $share_dir: $USAGE% ($SIZE)"

        if [ $USAGE -gt 90 ]; then
            log_message "‚ö† ALERTE CRITIQUE: Espace disque tr√®s faible sur $share_dir"
            # Chercher les plus gros fichiers
            find "$share_dir" -type f -size +100M -exec ls -lh {} \; | head -10 >> $LOG_FILE
        fi
    fi
done

# Optimisation Samba (reconstruire les index)
if systemctl is-active --quiet smbd; then
    log_message "Optimisation base Samba..."
    net sam provision >/dev/null 2>&1 || true
fi

# Statistiques finales
TOTAL_SIZE=$(du -sh /srv 2>/dev/null | cut -f1 || echo "N/A")
log_message "Taille totale des partages: $TOTAL_SIZE"

log_message "=== FIN NETTOYAGE SERVEUR DE FICHIERS ==="
```

#### Rapport d'utilisation mensuel

```bash
nano /usr/local/bin/fileserver-usage-report
```

```bash
#!/bin/bash
# Rapport d'utilisation mensuel

REPORT_DIR="/var/reports"
REPORT_FILE="$REPORT_DIR/fileserver_report_$(date +%Y%m).txt"
mkdir -p $REPORT_DIR

echo "=== RAPPORT MENSUEL SERVEUR DE FICHIERS ===" > $REPORT_FILE
echo "P√©riode: $(date +'%B %Y')" >> $REPORT_FILE
echo "G√©n√©r√© le: $(date)" >> $REPORT_FILE
echo >> $REPORT_FILE

# Utilisation par service
echo "=== UTILISATION PAR SERVICE ===" >> $REPORT_FILE
for service_dir in /srv/samba /srv/nfs /srv/ftp; do
    if [ -d "$service_dir" ]; then
        echo "$(basename $service_dir):" >> $REPORT_FILE
        du -sh "$service_dir"/* 2>/dev/null | sort -hr | head -10 >> $REPORT_FILE
        echo >> $REPORT_FILE
    fi
done

# Top des plus gros fichiers
echo "=== TOP 20 PLUS GROS FICHIERS ===" >> $REPORT_FILE
find /srv -type f -size +10M -exec ls -lh {} \; 2>/dev/null | sort -k5 -hr | head -20 >> $REPORT_FILE
echo >> $REPORT_FILE

# Statistiques Samba
if systemctl is-active --quiet smbd; then
    echo "=== STATISTIQUES SAMBA ===" >> $REPORT_FILE
    pdbedit -L >> $REPORT_FILE 2>/dev/null || echo "Impossible d'obtenir la liste des utilisateurs" >> $REPORT_FILE
    echo >> $REPORT_FILE
fi

# Statistiques NFS
if systemctl is-active --quiet nfs-kernel-server; then
    echo "=== STATISTIQUES NFS ===" >> $REPORT_FILE
    showmount -e localhost >> $REPORT_FILE 2>/dev/null || echo "Aucun export NFS" >> $REPORT_FILE
    echo >> $REPORT_FILE
fi

# √âv√©nements de s√©curit√© (derniers 30 jours)
echo "=== √âV√âNEMENTS DE S√âCURIT√â (30 DERNIERS JOURS) ===" >> $REPORT_FILE
grep -i "failed\|error\|denied" /var/log/samba/*.log 2>/dev/null | grep "$(date -d '30 days ago' +'%Y/%m')" | wc -l >> $REPORT_FILE
echo >> $REPORT_FILE

# Recommandations
echo "=== RECOMMANDATIONS ===" >> $REPORT_FILE
TOTAL_USAGE=$(df /srv | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $TOTAL_USAGE -gt 80 ]; then
    echo "- Nettoyage recommand√© (utilisation: $TOTAL_USAGE%)" >> $REPORT_FILE
fi

echo "- V√©rifier les sauvegardes mensuelles" >> $REPORT_FILE
echo "- Contr√¥ler les permissions des nouveaux fichiers" >> $REPORT_FILE
echo "- R√©viser les comptes utilisateurs inactifs" >> $REPORT_FILE

# Envoyer le rapport par email si configur√©
if command -v mail >/dev/null 2>&1; then
    mail -s "Rapport mensuel serveur de fichiers - $(hostname)" admin@exemple.com < $REPORT_FILE
fi

echo "Rapport g√©n√©r√©: $REPORT_FILE"
```

### Tests et validation

#### Script de test complet

```bash
nano /usr/local/bin/fileserver-test
```

```bash
#!/bin/bash
# Tests complets du serveur de fichiers

TEST_USER="test-user"
TEST_PASS="TestPassword123!"

echo "=== TESTS SERVEUR DE FICHIERS ==="

# Test Samba
test_samba() {
    echo "Test Samba..."

    # Cr√©er un utilisateur de test
    useradd -m -g samba-users $TEST_USER 2>/dev/null || true
    echo "$TEST_PASS" | passwd $TEST_USER --stdin 2>/dev/null || echo "$TEST_PASS" | chpasswd
    smbpasswd -a $TEST_USER -s <<< "$TEST_PASS"$'\n'"$TEST_PASS" >/dev/null 2>&1
    smbpasswd -e $TEST_USER >/dev/null 2>&1

    # Test de connexion
    if smbclient -L localhost -U $TEST_USER%$TEST_PASS >/dev/null 2>&1; then
        echo "‚úì Samba: Connexion OK"

        # Test d'√©criture
        echo "Test Samba √©criture" | smbclient //localhost/public -U $TEST_USER%$TEST_PASS -c "put - test_samba.txt" >/dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo "‚úì Samba: √âcriture OK"
            smbclient //localhost/public -U $TEST_USER%$TEST_PASS -c "del test_samba.txt" >/dev/null 2>&1
        else
            echo "‚úó Samba: √âcriture √©chou√©e"
        fi
    else
        echo "‚úó Samba: Connexion √©chou√©e"
    fi
}

# Test NFS
test_nfs() {
    echo "Test NFS..."

    # Cr√©er un point de montage temporaire
    TEST_MOUNT="/tmp/nfs_test"
    mkdir -p $TEST_MOUNT

    # Test de montage
    if mount -t nfs localhost:/srv/nfs/public $TEST_MOUNT >/dev/null 2>&1; then
        echo "‚úì NFS: Montage OK"

        # Test d'√©criture
        if echo "Test NFS √©criture" > $TEST_MOUNT/test_nfs.txt 2>/dev/null; then
            echo "‚úì NFS: √âcriture OK"
            rm -f $TEST_MOUNT/test_nfs.txt
        else
            echo "‚úó NFS: √âcriture √©chou√©e"
        fi

        # D√©monter
        umount $TEST_MOUNT
        echo "‚úì NFS: D√©montage OK"
    else
        echo "‚úó NFS: Montage √©chou√©"
    fi

    # Nettoyer
    rmdir $TEST_MOUNT 2>/dev/null || true
}

# Test SFTP
test_sftp() {
    echo "Test SFTP..."

    # Cr√©er un utilisateur SFTP si pas d√©j√† fait
    if ! id "$TEST_USER-sftp" >/dev/null 2>&1; then
        useradd -m -g sftponly -s /bin/false $TEST_USER-sftp 2>/dev/null || true
        echo "$TEST_PASS" | passwd $TEST_USER-sftp --stdin 2>/dev/null || echo "$TEST_PASS" | chpasswd

        # Cr√©er la structure chroot
        mkdir -p /srv/sftp/$TEST_USER-sftp/upload 2>/dev/null || true
        chown root:root /srv/sftp/$TEST_USER-sftp
        chown $TEST_USER-sftp:sftponly /srv/sftp/$TEST_USER-sftp/upload
        chmod 755 /srv/sftp/$TEST_USER-sftp
        chmod 755 /srv/sftp/$TEST_USER-sftp/upload
    fi

    # Test de connexion SFTP
    if echo "quit" | sftp -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null" $TEST_USER-sftp@localhost >/dev/null 2>&1; then
        echo "‚úì SFTP: Connexion OK"

        # Test d'upload
        TEST_FILE="/tmp/sftp_test.txt"
        echo "Test SFTP upload" > $TEST_FILE

        if echo -e "cd upload\nput $TEST_FILE\nquit" | sftp -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null" $TEST_USER-sftp@localhost >/dev/null 2>&1; then
            echo "‚úì SFTP: Upload OK"

            # V√©rifier que le fichier existe
            if [ -f "/srv/sftp/$TEST_USER-sftp/upload/$(basename $TEST_FILE)" ]; then
                echo "‚úì SFTP: Fichier re√ßu OK"
                rm -f "/srv/sftp/$TEST_USER-sftp/upload/$(basename $TEST_FILE)"
            fi
        else
            echo "‚úó SFTP: Upload √©chou√©"
        fi

        rm -f $TEST_FILE
    else
        echo "‚úó SFTP: Connexion √©chou√©e"
    fi
}

# Test FTP (si vsftpd est install√©)
test_ftp() {
    if systemctl is-active --quiet vsftpd 2>/dev/null; then
        echo "Test FTP..."

        # Ajouter l'utilisateur √† la liste FTP
        if ! grep -q "^$TEST_USER$" /etc/vsftpd.userlist 2>/dev/null; then
            echo "$TEST_USER" >> /etc/vsftpd.userlist
        fi

        # Test de connexion (attention: FTP en clair pour le test)
        if echo -e "quit" | ftp -n localhost >/dev/null 2>&1; then
            echo "‚úì FTP: Service disponible"
        else
            echo "‚úó FTP: Service indisponible"
        fi
    else
        echo "- FTP: Non install√© (optionnel)"
    fi
}

# Test des permissions et s√©curit√©
test_security() {
    echo "Test s√©curit√©..."

    # V√©rifier les permissions critiques
    ERRORS=0

    # Permissions Samba
    if [ -d /srv/samba ]; then
        SAMBA_PERMS=$(stat -c %a /srv/samba/public 2>/dev/null)
        if [ "$SAMBA_PERMS" = "775" ] || [ "$SAMBA_PERMS" = "755" ]; then
            echo "‚úì S√©curit√©: Permissions Samba OK ($SAMBA_PERMS)"
        else
            echo "‚ö† S√©curit√©: Permissions Samba √† v√©rifier ($SAMBA_PERMS)"
            ERRORS=$((ERRORS + 1))
        fi
    fi

    # Permissions NFS
    if [ -d /srv/nfs ]; then
        NFS_PERMS=$(stat -c %a /srv/nfs/public 2>/dev/null)
        if [ "$NFS_PERMS" = "755" ]; then
            echo "‚úì S√©curit√©: Permissions NFS OK ($NFS_PERMS)"
        else
            echo "‚ö† S√©curit√©: Permissions NFS √† v√©rifier ($NFS_PERMS)"
            ERRORS=$((ERRORS + 1))
        fi
    fi

    # V√©rifier les utilisateurs syst√®me
    if getent passwd | grep -q "^$TEST_USER:"; then
        echo "‚úì S√©curit√©: Utilisateur de test cr√©√©"
    fi

    # V√©rifier les services actifs
    for service in smbd nmbd nfs-kernel-server ssh; do
        if systemctl is-active --quiet $service 2>/dev/null; then
            echo "‚úì S√©curit√©: Service $service actif"
        else
            echo "- S√©curit√©: Service $service inactif (peut √™tre normal)"
        fi
    done

    return $ERRORS
}

# Test de performance basique
test_performance() {
    echo "Test performance..."

    # Cr√©er un fichier de test de 10MB
    TEST_FILE="/tmp/performance_test_10mb"
    dd if=/dev/zero of=$TEST_FILE bs=1M count=10 2>/dev/null

    # Test Samba
    if systemctl is-active --quiet smbd; then
        echo "Test performance Samba (10MB)..."
        START_TIME=$(date +%s.%N)
        echo "put $TEST_FILE perf_test.dat" | smbclient //localhost/public -U $TEST_USER%$TEST_PASS >/dev/null 2>&1
        END_TIME=$(date +%s.%N)
        DURATION=$(echo "$END_TIME - $START_TIME" | bc -l 2>/dev/null || echo "N/A")

        if [ "$DURATION" != "N/A" ]; then
            SPEED=$(echo "scale=2; 10 / $DURATION" | bc -l 2>/dev/null || echo "N/A")
            echo "‚úì Samba: $SPEED MB/s (dur√©e: ${DURATION}s)"
        else
            echo "‚úì Samba: Transfer termin√©"
        fi

        # Nettoyer
        smbclient //localhost/public -U $TEST_USER%$TEST_PASS -c "del perf_test.dat" >/dev/null 2>&1
    fi

    # Test NFS
    if systemctl is-active --quiet nfs-kernel-server; then
        TEST_MOUNT="/tmp/nfs_perf_test"
        mkdir -p $TEST_MOUNT

        if mount -t nfs localhost:/srv/nfs/public $TEST_MOUNT >/dev/null 2>&1; then
            echo "Test performance NFS (10MB)..."
            START_TIME=$(date +%s.%N)
            cp $TEST_FILE $TEST_MOUNT/perf_test.dat 2>/dev/null
            sync  # Force l'√©criture
            END_TIME=$(date +%s.%N)
            DURATION=$(echo "$END_TIME - $START_TIME" | bc -l 2>/dev/null || echo "N/A")

            if [ "$DURATION" != "N/A" ]; then
                SPEED=$(echo "scale=2; 10 / $DURATION" | bc -l 2>/dev/null || echo "N/A")
                echo "‚úì NFS: $SPEED MB/s (dur√©e: ${DURATION}s)"
            else
                echo "‚úì NFS: Transfer termin√©"
            fi

            # Nettoyer
            rm -f $TEST_MOUNT/perf_test.dat
            umount $TEST_MOUNT
        fi

        rmdir $TEST_MOUNT 2>/dev/null || true
    fi

    rm -f $TEST_FILE
}

# Ex√©cution des tests
echo "D√©but des tests du serveur de fichiers..."
echo "Date: $(date)"
echo

test_samba
echo
test_nfs
echo
test_sftp
echo
test_ftp
echo
SECURITY_ERRORS=$(test_security)
echo
test_performance
echo

# Nettoyage des utilisateurs de test
cleanup_test_users() {
    echo "Nettoyage des utilisateurs de test..."

    # Supprimer les utilisateurs de test
    userdel -r $TEST_USER 2>/dev/null || true
    userdel -r $TEST_USER-sftp 2>/dev/null || true

    # Supprimer des bases Samba
    smbpasswd -x $TEST_USER 2>/dev/null || true

    # Nettoyer la liste FTP
    if [ -f /etc/vsftpd.userlist ]; then
        sed -i "/^$TEST_USER$/d" /etc/vsftpd.userlist 2>/dev/null || true
    fi

    echo "‚úì Nettoyage termin√©"
}

# R√©sum√© des tests
echo "=== R√âSUM√â DES TESTS ==="
if [ $SECURITY_ERRORS -eq 0 ]; then
    echo "‚úì Tous les tests de s√©curit√© sont OK"
else
    echo "‚ö† $SECURITY_ERRORS probl√®me(s) de s√©curit√© d√©tect√©(s)"
fi

echo
echo "Tests termin√©s. Proc√©dure de nettoyage..."
cleanup_test_users

echo
echo "=== RECOMMANDATIONS POST-TEST ==="
echo "1. V√©rifier les logs de s√©curit√© apr√®s les tests"
echo "2. Contr√¥ler les performances en conditions r√©elles"
echo "3. Tester les acc√®s depuis les clients Windows/Linux"
echo "4. Valider les sauvegardes"
echo "5. Documenter les configurations pour l'√©quipe"
```

```bash
# Rendre le script ex√©cutable
chmod +x /usr/local/bin/fileserver-test

# Ex√©cuter les tests
fileserver-test
```

### Documentation finale

#### Guide d'utilisation pour les utilisateurs

```bash
# Cr√©er un guide utilisateur
nano /srv/samba/public/GUIDE_UTILISATION.txt
```

```
=== GUIDE D'UTILISATION SERVEUR DE FICHIERS ===

** ACC√àS AUX PARTAGES **

1. WINDOWS (Samba/SMB)
   - Ouvrir l'Explorateur Windows
   - Dans la barre d'adresse, taper: \\192.168.1.100
   - Saisir vos identifiants domaine

   Partages disponibles:
   - public: Accessible √† tous (lecture/√©criture)
   - private: Acc√®s restreint aux administrateurs
   - homes: Votre dossier personnel
   - comptabilite: √âquipe comptabilit√© uniquement
   - direction: √âquipe direction uniquement

2. LINUX (NFS ou Samba)

   Via Samba:
   sudo mkdir /mnt/serveur-fichiers
   sudo mount -t cifs //192.168.1.100/public /mnt/serveur-fichiers -o username=votre_nom

   Via NFS:
   sudo mkdir /mnt/nfs-public
   sudo mount -t nfs 192.168.1.100:/srv/nfs/public /mnt/nfs-public

3. TRANSFERTS SFTP (s√©curis√©)
   - Client SFTP: FileZilla, WinSCP, ou ligne de commande
   - Serveur: 192.168.1.100
   - Port: 2222 (SSH personnalis√©)
   - Protocole: SFTP
   - Authentification: nom d'utilisateur/mot de passe ou cl√©s SSH

** BONNES PRATIQUES **

- Utilisez des noms de fichiers explicites
- √âvitez les caract√®res sp√©ciaux dans les noms
- Organisez vos documents dans des dossiers logiques
- Effectuez r√©guli√®rement le m√©nage de vos fichiers
- Signalez tout probl√®me d'acc√®s √† l'administrateur

** S√âCURIT√â **

- Ne partagez jamais vos identifiants
- D√©connectez-vous apr√®s utilisation
- Signalez tout comportement suspect
- Les acc√®s sont surveill√©s et journalis√©s

** SUPPORT **

En cas de probl√®me:
- Email: admin@entreprise.com
- T√©l√©phone: 01.23.45.67.89
- Tickets: system.entreprise.com

Mise √† jour: $(date)
```

#### Checklist de validation finale

```bash
nano /usr/local/bin/fileserver-validation-checklist
```

```bash
#!/bin/bash
# Checklist de validation finale du serveur de fichiers

echo "=== CHECKLIST VALIDATION SERVEUR DE FICHIERS ==="
echo "Date: $(date)"
echo "Administrateur: $(whoami)"
echo

ERRORS=0
WARNINGS=0

check_item() {
    local description="$1"
    local test_command="$2"
    local is_critical="$3"

    printf "%-60s" "$description"

    if eval "$test_command" >/dev/null 2>&1; then
        echo "‚úì OK"
    else
        if [ "$is_critical" = "critical" ]; then
            echo "‚úó ERREUR"
            ERRORS=$((ERRORS + 1))
        else
            echo "‚ö† ATTENTION"
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
}

echo "=== SERVICES DE BASE ==="
check_item "Service Samba (smbd) actif" "systemctl is-active --quiet smbd" critical
check_item "Service Samba (nmbd) actif" "systemctl is-active --quiet nmbd" critical
check_item "Service NFS actif" "systemctl is-active --quiet nfs-kernel-server" critical
check_item "Service SSH actif" "systemctl is-active --quiet ssh" critical
check_item "Service FTP actif (optionnel)" "systemctl is-active --quiet vsftpd" warning

echo
echo "=== CONFIGURATION R√âSEAU ==="
check_item "Port 445 (Samba) ouvert" "ss -tulpn | grep -q ':445'" critical
check_item "Port 2049 (NFS) ouvert" "ss -tulpn | grep -q ':2049'" critical
check_item "Port 2222 (SSH) ouvert" "ss -tulpn | grep -q ':2222'" critical
check_item "Pare-feu UFW actif" "ufw status | grep -q 'Status: active'" warning

echo
echo "=== STRUCTURE DE FICHIERS ==="
check_item "R√©pertoire Samba existe" "[ -d /srv/samba ]" critical
check_item "R√©pertoire NFS existe" "[ -d /srv/nfs ]" critical
check_item "R√©pertoire SFTP existe" "[ -d /srv/sftp ]" warning
check_item "Permissions Samba correctes" "[ $(stat -c %a /srv/samba/public 2>/dev/null) = '775' ]" warning
check_item "Permissions NFS correctes" "[ $(stat -c %a /srv/nfs/public 2>/dev/null) = '755' ]" warning

echo
echo "=== UTILISATEURS ET GROUPES ==="
check_item "Groupe samba-users existe" "getent group samba-users" critical
check_item "Groupe sftponly existe" "getent group sftponly" warning
check_item "Au moins un utilisateur Samba" "pdbedit -L | grep -q '.'" warning

echo
echo "=== SAUVEGARDES ET MAINTENANCE ==="
check_item "Script de sauvegarde existe" "[ -x /usr/local/bin/fileserver-backup ]" critical
check_item "Script de monitoring existe" "[ -x /usr/local/bin/file-server-monitor ]" critical
check_item "T√¢ches cron configur√©es" "crontab -l | grep -q fileserver" warning
check_item "R√©pertoire de sauvegarde existe" "[ -d /var/backups/fileserver ]" warning

echo
echo "=== S√âCURIT√â ==="
check_item "Configuration Samba s√©curis√©e" "grep -q 'security = user' /etc/samba/smb.conf" critical
check_item "Acc√®s root SSH d√©sactiv√©" "grep -q 'PermitRootLogin no' /etc/ssh/sshd_config" critical
check_item "Logs de s√©curit√© activ√©s" "[ -f /var/log/samba/log.smbd ]" warning
check_item "Fail2ban actif (recommand√©)" "systemctl is-active --quiet fail2ban" warning

echo
echo "=== PERFORMANCE ==="
check_item "Espace disque suffisant (<80%)" "[ $(df /srv | tail -1 | awk '{print $5}' | sed 's/%//') -lt 80 ]" warning
check_item "M√©moire disponible (>100MB)" "[ $(free -m | grep '^Mem:' | awk '{print $7}') -gt 100 ]" warning

echo
echo "=== DOCUMENTATION ==="
check_item "Guide utilisateur pr√©sent" "[ -f /srv/samba/public/GUIDE_UTILISATION.txt ]" warning
check_item "Configuration sauvegard√©e" "[ -f /etc/samba/smb.conf.backup ]" warning

echo
echo "=== R√âSUM√â ==="
echo "Erreurs critiques: $ERRORS"
echo "Avertissements: $WARNINGS"

if [ $ERRORS -eq 0 ]; then
    echo "‚úì VALIDATION R√âUSSIE - Le serveur de fichiers est pr√™t pour la production"
    exit 0
else
    echo "‚úó VALIDATION √âCHOU√âE - $ERRORS erreur(s) critique(s) √† corriger"
    echo
    echo "Actions requises avant mise en production:"
    echo "1. Corriger les erreurs critiques list√©es ci-dessus"
    echo "2. Relancer cette validation"
    echo "3. Effectuer des tests utilisateurs"
    echo "4. Former les utilisateurs finaux"
    exit 1
fi
```

```bash
chmod +x /usr/local/bin/fileserver-validation-checklist

# Ex√©cuter la validation finale
fileserver-validation-checklist
```

---

## Conclusion du Module 6.4

### Ce que nous avons accompli

‚úÖ **Samba** : Serveur de fichiers universel avec s√©curit√© renforc√©e
‚úÖ **NFS** : Partage haute performance pour environnements Linux
‚úÖ **SFTP/FTP** : Transferts s√©curis√©s avec chiffrement
‚úÖ **S√©curisation** : Permissions, chiffrement, monitoring complet
‚úÖ **Maintenance** : Sauvegarde, nettoyage et rapports automatiques
‚úÖ **Tests** : Validation compl√®te des fonctionnalit√©s

### Points cl√©s √† retenir

**S√©curit√© multicouche** :
- Authentification utilisateur obligatoire
- Chiffrement des communications (SSL/TLS)
- Isolation des utilisateurs (chroot, permissions)
- Monitoring et alertes automatiques

**Performance optimis√©e** :
- Configuration adapt√©e √† la charge
- Cache et compression activ√©s
- Ports r√©seau optimis√©s
- Maintenance pr√©ventive automatis√©e

**Haute disponibilit√©** :
- Services redondants possibles
- Sauvegardes automatiques et test√©es
- Scripts de r√©cup√©ration rapide
- Monitoring proactif 24h/24

### Architecture finale

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              CLIENTS                    ‚îÇ
‚îÇ  Windows  ‚îÇ   Linux   ‚îÇ   Mobile       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ         ‚îÇ         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  SMB    ‚îÇ ‚îÇ NFS ‚îÇ ‚îÇ  SFTP   ‚îÇ
    ‚îÇ Port    ‚îÇ ‚îÇPort ‚îÇ ‚îÇ  Port   ‚îÇ
    ‚îÇ 445     ‚îÇ ‚îÇ2049 ‚îÇ ‚îÇ  2222   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ     SERVEUR DE FICHIERS      ‚îÇ
    ‚îÇ                              ‚îÇ
    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
    ‚îÇ  ‚îÇ      SERVICES           ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ Samba (SMB/CIFS)     ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ NFS Server           ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ OpenSSH (SFTP)       ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ vsftpd (optionnel)   ‚îÇ  ‚îÇ
    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
    ‚îÇ                              ‚îÇ
    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
    ‚îÇ  ‚îÇ      STOCKAGE           ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  /srv/samba/            ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ public/            ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ private/           ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ groups/            ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ users/             ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  /srv/nfs/              ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ public/            ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ secure/            ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ backup/            ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ                         ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  /srv/sftp/             ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ users/             ‚îÇ  ‚îÇ
    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
    ‚îÇ                              ‚îÇ
    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
    ‚îÇ  ‚îÇ     S√âCURIT√â            ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ UFW Firewall         ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ SSL/TLS              ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ Fail2ban             ‚îÇ  ‚îÇ
    ‚îÇ  ‚îÇ  ‚Ä¢ Audit logs           ‚îÇ  ‚îÇ
    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Cas d'usage couverts

**PME (10-50 utilisateurs)** :
- Partage de documents bureautique
- Dossiers personnels s√©curis√©s
- Sauvegarde centralis√©e
- Acc√®s mobile et distant

**Environnement de d√©veloppement** :
- Code source partag√© via NFS
- D√©ploiements via SFTP
- Donn√©es de test isol√©es
- Int√©gration CI/CD

**Infrastructure serveur** :
- Partage de logs centralis√©s
- Configuration distribu√©e
- Sauvegarde inter-serveurs
- Synchronisation de donn√©es

### √âvolutions possibles

**Int√©gration Active Directory** :
- Authentification centralis√©e
- Strat√©gies de groupe
- Single Sign-On (SSO)

**R√©plication g√©ographique** :
- Sites distants
- Synchronisation automatique
- Tol√©rance de panne √©tendue

**Cloud hybride** :
- Synchronisation cloud
- Sauvegarde externe
- Acc√®s nomade √©tendu

### V√©rifications avant production

1. ‚úÖ Tous les tests de validation passent
2. ‚úÖ Les utilisateurs sont form√©s
3. ‚úÖ Les sauvegardes sont test√©es
4. ‚úÖ Le monitoring est op√©rationnel
5. ‚úÖ La documentation est compl√®te
6. ‚úÖ Les proc√©dures d'urgence sont d√©finies

**Votre serveur de fichiers est maintenant pr√™t √† servir vos utilisateurs de mani√®re s√©curis√©e, performante et fiable !**

---

*Prochaine √©tape : Module 7 - Services r√©seau avanc√©s (DNS, DHCP, Mail)*

**Le Module 6 (Services de base) est maintenant complet avec :**
- 6.1 Installation serveur ‚úÖ
- 6.2 Serveur web (Apache/Nginx) ‚úÖ
- 6.3 Bases de donn√©es (MySQL/PostgreSQL) ‚úÖ
- 6.4 Serveur de fichiers (Samba/NFS/SFTP) ‚úÖ

Votre infrastructure serveur Debian est maintenant solide et pr√™te pour les services avanc√©s !

‚è≠Ô∏è
