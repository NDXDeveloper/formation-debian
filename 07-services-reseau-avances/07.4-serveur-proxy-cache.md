üîù Retour au [Sommaire](/SOMMAIRE.md)

# 7.4 Serveur proxy et cache

Un serveur proxy fait office d'interm√©diaire entre les utilisateurs de votre r√©seau et Internet. Il offre de nombreux avantages : √©conomie de bande passante, contr√¥le d'acc√®s, s√©curit√© renforc√©e, et am√©lioration des performances gr√¢ce au cache.

## Comprendre le r√¥le du proxy

**Analogie simple :** Un proxy, c'est comme un portier intelligent dans un h√¥tel :
- Il **contr√¥le qui** peut sortir et o√π
- Il **m√©morise** les informations utiles (cache) pour les prochaines fois
- Il **filtre** les demandes suspectes
- Il **optimise** les acc√®s en groupant les demandes similaires

**Sans proxy :**
```
[Utilisateur 1] ‚îÄ‚îÄ‚Üí [Internet/Site Web]
[Utilisateur 2] ‚îÄ‚îÄ‚Üí [Internet/Site Web]
[Utilisateur 3] ‚îÄ‚îÄ‚Üí [Internet/Site Web]
```

**Avec proxy :**
```
[Utilisateur 1] ‚îÄ‚îÄ‚Üí [Proxy] ‚îÄ‚îÄ‚Üí [Internet/Site Web]
[Utilisateur 2] ‚îÄ‚îÄ‚Üí [Proxy] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
[Utilisateur 3] ‚îÄ‚îÄ‚Üí [Proxy] (d√©j√† en cache !)
```

**Avantages du proxy :**
- **üöÄ Performance** : Cache les contenus fr√©quemment consult√©s
- **üí∞ √âconomie** : R√©duit la bande passante utilis√©e
- **üõ°Ô∏è S√©curit√©** : Filtre les sites malveillants et contr√¥le d'acc√®s
- **üìä Monitoring** : Logs d√©taill√©s de l'utilisation Internet
- **üîí Anonymat** : Cache l'IP r√©elle des utilisateurs

---

## 7.4.1 Squid proxy avanc√©

### Qu'est-ce que Squid ?

Squid est le serveur proxy de r√©f√©rence sur Linux. Il est utilis√© par de nombreuses entreprises et fournisseurs d'acc√®s Internet dans le monde entier.

**Pourquoi choisir Squid :**
- **Gratuit et open source** avec 25+ ans de d√©veloppement
- **Tr√®s performant** : peut g√©rer des milliers d'utilisateurs simultan√©s
- **Extr√™mement configurable** : adapt√© √† tous les environnements
- **Cache intelligent** : algorithmes optimis√©s pour les performances
- **Support de l'authentification** : int√©gration LDAP, Active Directory
- **Journalisation compl√®te** : audit et monitoring d√©taill√©s

### Installation de Squid

```bash
# Mettre √† jour le syst√®me
sudo apt update

# Installer Squid et ses outils
sudo apt install squid squid-common squidclient

# D√©marrer et activer le service
sudo systemctl start squid
sudo systemctl enable squid

# V√©rifier l'installation
sudo systemctl status squid
```

### Comprendre la structure de configuration

Squid utilise principalement le fichier `/etc/squid/squid.conf`, mais sa structure peut para√Ætre intimidante :

```bash
# Voir la taille du fichier de configuration par d√©faut
wc -l /etc/squid/squid.conf
# R√©sultat : environ 8000 lignes avec tous les commentaires !

# Pour d√©buter, sauvegardons l'original et cr√©ons un fichier propre
sudo cp /etc/squid/squid.conf /etc/squid/squid.conf.original
```

### Configuration de base simplifi√©e

```bash
# Cr√©er une configuration propre et comment√©e
sudo nano /etc/squid/squid.conf
```

**Configuration de d√©marrage :**

```bash
#
# Configuration Squid pour monentreprise.local
# Version simplifi√©e pour d√©buter
#

# === PORTS ET INTERFACES ===
# Port d'√©coute du proxy (standard : 3128)
http_port 3128

# Interface d'√©coute (toutes les interfaces)
# http_port 192.168.1.10:3128  # Pour √©couter sur une IP sp√©cifique

# === R√âSEAUX AUTORIS√âS ===
# D√©finir les r√©seaux locaux autoris√©s
acl localnet src 10.0.0.0/8      # RFC1918 possible internal network
acl localnet src 172.16.0.0/12   # RFC1918 possible internal network
acl localnet src 192.168.0.0/16  # RFC1918 possible internal network
acl localnet src fc00::/7         # RFC 4193 local private network range
acl localnet src fe80::/10        # RFC 4291 link-local range

# R√©seau de votre entreprise (√† adapter)
acl monreseau src 192.168.1.0/24

# === PORTS AUTORIS√âS ===
# Ports standard pour HTTP et HTTPS
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# M√©thode CONNECT (pour HTTPS)
acl CONNECT method CONNECT

# === R√àGLES D'ACC√àS ===
# Refuser les demandes vers des ports dangereux
http_access deny !Safe_ports

# Refuser CONNECT vers des ports autres que SSL
http_access deny CONNECT !SSL_ports

# Autoriser la gestion locale (pour squidclient)
http_access allow localhost manager
http_access deny manager

# Autoriser les r√©seaux locaux
http_access allow localnet
http_access allow monreseau

# Autoriser localhost
http_access allow localhost

# Refuser tout le reste
http_access deny all

# === CACHE ===
# R√©pertoire de cache (sera cr√©√© automatiquement)
cache_dir ufs /var/spool/squid 1000 16 256

# Taille m√©moire pour les objets en cache (MB)
cache_mem 256 MB

# Taille max des objets en cache (KB)
maximum_object_size 10240 KB

# Taille max des objets en m√©moire (KB)
maximum_object_size_in_memory 512 KB

# === LOGS ===
# R√©pertoire des logs
access_log /var/log/squid/access.log squid

# === COMPORTEMENT ===
# Masquer la version de Squid (s√©curit√©)
httpd_suppress_version_string on

# Politique de refresh du cache
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# === R√âSEAU ===
# Nom d'h√¥te visible
visible_hostname proxy.monentreprise.local

# Ne pas servir de forward vers l'ext√©rieur sauf r√©seaux autoris√©s
forwarded_for delete
```

**Explication des param√®tres importants :**

- **http_port** : Port d'√©coute du proxy (3128 est le standard)
- **acl** : Listes de contr√¥le d'acc√®s (ACL = Access Control List)
- **http_access** : R√®gles d'autorisation (ordre important !)
- **cache_dir** : Emplacement et taille du cache disque
- **cache_mem** : Taille de la m√©moire d√©di√©e au cache

### Initialisation du cache

```bash
# Cr√©er les r√©pertoires de cache
sudo squid -z

# V√©rifier les permissions
sudo chown -R proxy:proxy /var/spool/squid
sudo chmod -R 750 /var/spool/squid

# Red√©marrer Squid
sudo systemctl restart squid

# V√©rifier que Squid fonctionne
sudo systemctl status squid
```

### Test de base

```bash
# V√©rifier que Squid √©coute sur le bon port
sudo netstat -tlnp | grep 3128
# Devrait afficher : tcp 0 0 0.0.0.0:3128 0.0.0.0:* LISTEN PID/squid

# Tester avec un client simple
export http_proxy=http://192.168.1.10:3128
export https_proxy=http://192.168.1.10:3128
curl -I http://www.google.com

# Voir les logs en temps r√©el
sudo tail -f /var/log/squid/access.log
```

---

## 7.4.2 Configuration et ACL

### Comprendre les ACL (Access Control Lists)

Les ACL sont le c≈ìur du contr√¥le d'acc√®s dans Squid. Elles d√©finissent **qui** peut acc√©der √† **quoi** et **quand**.

**Syntaxe de base :**
```bash
acl nom_acl type_acl valeur
http_access allow/deny nom_acl
```

**Types d'ACL courants :**

| Type | Description | Exemple |
|------|-------------|---------|
| **src** | Adresse IP source | `acl bureaux src 192.168.1.0/24` |
| **dst** | Adresse IP destination | `acl serveurs_internes dst 192.168.10.0/24` |
| **port** | Port de destination | `acl ports_web port 80 443` |
| **dstdomain** | Domaine de destination | `acl sites_sociaux dstdomain facebook.com twitter.com` |
| **url_regex** | Expression r√©guli√®re sur l'URL | `acl pub url_regex -i advertising` |
| **time** | Horaire | `acl heures_bureau time MTWHF 08:00-18:00` |
| **method** | M√©thode HTTP | `acl methodes_post method POST PUT` |

### Configuration ACL avanc√©e

```bash
# √âditer la configuration Squid
sudo nano /etc/squid/squid.conf
```

**Ajouter des ACL personnalis√©es :**

```bash
#
# === ACL PERSONNALIS√âES ===
#

# === R√âSEAUX ===
acl direction src 192.168.1.20/32 192.168.1.21/32    # IP des dirigeants
acl employes src 192.168.1.100/26                     # Employ√©s (100-163)
acl invites src 192.168.1.200/29                      # Invit√©s (200-207)
acl serveurs src 192.168.10.0/24                      # Serveurs internes

# === HORAIRES ===
acl heures_bureau time MTWHF 08:00-18:00              # Lun-Ven 8h-18h
acl pause_dejeuner time MTWHF 12:00-14:00             # Pause d√©jeuner
acl weekend time SA 00:00-23:59                       # Samedi
acl weekend time SU 00:00-23:59                       # Dimanche

# === CAT√âGORIES DE SITES ===
# Sites de travail (toujours autoris√©s)
acl sites_travail dstdomain .monentreprise.local
acl sites_travail dstdomain .github.com .stackoverflow.com .documentation.com

# Sites de news (autoris√©s aux heures de bureau)
acl sites_news dstdomain .lemonde.fr .bbc.com .reuters.com

# Sites sociaux (restreints)
acl sites_sociaux dstdomain .facebook.com .twitter.com .instagram.com .tiktok.com
acl sites_sociaux dstdomain .youtube.com .dailymotion.com

# Sites de streaming (tr√®s restreints)
acl sites_streaming dstdomain .netflix.com .amazon.com .hulu.com .disney.com

# Sites dangereux ou inappropri√©s
acl sites_interdits dstdomain "/etc/squid/listes/sites_interdits.txt"

# === TYPES DE FICHIERS ===
acl fichiers_executable url_regex -i \.exe$ \.msi$ \.dmg$
acl fichiers_video url_regex -i \.avi$ \.mp4$ \.mkv$ \.mov$
acl fichiers_audio url_regex -i \.mp3$ \.wav$ \.flac$

# === MOTS-CL√âS SUSPECTS ===
acl mots_cles_pub url_regex -i advertising ads banner popup
acl mots_cles_adult url_regex -i porn adult xxx sex

# === TAILLES DE FICHIERS ===
# Gros fichiers (> 100MB) - √† restreindre
acl gros_fichiers rep_header Content-Length ^[1-9][0-9]{8,}

# === NAVIGATEURS ===
acl navigateurs_autorises browser -i mozilla firefox chrome safari
```

### R√®gles d'acc√®s bas√©es sur les ACL

```bash
#
# === R√àGLES D'ACC√àS (ordre important !) ===
#

# 1. Refus global des sites interdits
http_access deny sites_interdits

# 2. Refus des fichiers ex√©cutables (s√©curit√©)
http_access deny fichiers_executable

# 3. Refus du contenu adulte
http_access deny mots_cles_adult

# 4. R√®gles pour la direction (acc√®s privil√©gi√©)
http_access allow direction heures_bureau
http_access allow direction sites_news
http_access deny direction sites_sociaux pause_dejeuner  # M√™me la direction !

# 5. R√®gles pour les employ√©s en heures de bureau
http_access allow employes sites_travail
http_access allow employes sites_news heures_bureau
http_access allow employes sites_sociaux heures_bureau !pause_dejeuner
http_access deny employes sites_streaming
http_access deny employes gros_fichiers

# 6. R√®gles pour les employ√©s hors heures de bureau
http_access allow employes sites_travail weekend
http_access deny employes sites_sociaux weekend
http_access deny employes sites_streaming weekend

# 7. R√®gles pour les invit√©s (tr√®s restrictif)
http_access allow invites sites_travail heures_bureau
http_access deny invites sites_sociaux
http_access deny invites sites_streaming
http_access deny invites sites_news

# 8. Refuser les gros t√©l√©chargements sauf pour certains
http_access deny gros_fichiers !direction

# 9. R√®gles par d√©faut des r√©seaux locaux
http_access allow monreseau heures_bureau
http_access deny monreseau

# 10. Autoriser localhost (administration)
http_access allow localhost

# 11. Refuser tout le reste
http_access deny all
```

### Cr√©ation de listes externes

**Cr√©er des listes de sites √† maintenir :**

```bash
# Cr√©er le r√©pertoire pour les listes
sudo mkdir -p /etc/squid/listes

# Liste des sites interdits
sudo nano /etc/squid/listes/sites_interdits.txt
```

```
# Sites de malware et phishing
badsite.com
malware-site.net
phishing-bank.org

# Sites de jeux en ligne
casino-online.com
poker-site.net

# Sites de t√©l√©chargement ill√©gal
torrent-site.com
warez-download.net

# Sites de streaming ill√©gal
streaming-illegal.tv
```

**Liste des domaines de publicit√© :**

```bash
# Cr√©er une liste anti-pub
sudo nano /etc/squid/listes/publicite.txt
```

```
# Serveurs de publicit√© courants
doubleclick.net
googlesyndication.com
facebook.com/tr
google-analytics.com
scorecardresearch.com
adsystem.com
```

**Utiliser la liste dans la configuration :**

```bash
# Dans squid.conf
acl anti_pub dstdomain "/etc/squid/listes/publicite.txt"
http_access deny anti_pub
```

### ACL temporelles avanc√©es

```bash
# ACL avec horaires complexes
acl matin time MTWHF 08:00-12:00
acl apres_midi time MTWHF 14:00-18:00
acl travail_combine time MTWHF 08:00-12:00,14:00-18:00

# ACL par jour sp√©cifique
acl vendredi time F 00:00-23:59
acl fin_de_mois time 28,29,30,31 00:00-23:59

# R√®gles temporelles
http_access allow employes sites_sociaux vendredi apres_midi
http_access deny employes sites_sociaux !travail_combine
```

### ACL bas√©es sur l'authentification

```bash
# ACL pour utilisateurs authentifi√©s (voir section LDAP plus loin)
acl utilisateurs_premium proxy_auth admin direction manager
acl utilisateurs_standard proxy_auth employe1 employe2 employe3

# R√®gles bas√©es sur l'identit√©
http_access allow utilisateurs_premium
http_access allow utilisateurs_standard heures_bureau
http_access deny utilisateurs_standard sites_streaming
```

### Messages d'erreur personnalis√©s

```bash
# Cr√©er des pages d'erreur personnalis√©es
sudo mkdir -p /etc/squid/errors/French

# Page d'erreur pour acc√®s refus√©
sudo nano /etc/squid/errors/French/ERR_ACCESS_DENIED
```

```html
<!DOCTYPE html>
<html>
<head>
    <title>Acc√®s refus√© - MonEntreprise</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>üö´ Acc√®s refus√©</h1>
    <p><strong>Le site que vous tentez de visiter est bloqu√© par la politique de s√©curit√© de l'entreprise.</strong></p>

    <h2>Informations :</h2>
    <ul>
        <li><strong>URL demand√©e :</strong> %U</li>
        <li><strong>Votre adresse IP :</strong> %a</li>
        <li><strong>Date/Heure :</strong> %T</li>
    </ul>

    <h2>Que faire ?</h2>
    <p>Si vous pensez que ce blocage est une erreur, contactez :</p>
    <ul>
        <li>üìß <strong>Support IT :</strong> support@monentreprise.local</li>
        <li>üìû <strong>T√©l√©phone :</strong> 01.23.45.67.89</li>
    </ul>

    <hr>
    <small>Proxy MonEntreprise - Politique d'utilisation Internet</small>
</body>
</html>
```

Configurer l'utilisation des messages personnalis√©s :

```bash
# Dans squid.conf
error_directory /etc/squid/errors/French
```

### Test et validation des ACL

```bash
# Recharger la configuration
sudo systemctl reload squid

# Tester une ACL sp√©cifique
sudo squidclient -h localhost -p 3128 mgr:info

# Voir les ACL actives
sudo squidclient mgr:config | grep acl

# Tester l'acc√®s depuis un client
# Depuis un poste du r√©seau :
export http_proxy=http://192.168.1.10:3128
curl -I http://facebook.com  # Devrait √™tre bloqu√© selon vos r√®gles
curl -I http://github.com    # Devrait √™tre autoris√©
```

---

## 7.4.3 Cache web et optimisation

### Comprendre le cache Squid

Le cache est l'une des fonctionnalit√©s les plus importantes de Squid. Il stocke temporairement les contenus web fr√©quemment demand√©s pour am√©liorer les performances et r√©duire la bande passante.

**Types d'objets cach√©s :**
- **Pages HTML statiques** : pages qui ne changent pas souvent
- **Images** : photos, logos, ic√¥nes (tr√®s efficace)
- **Fichiers CSS/JavaScript** : feuilles de style et scripts
- **Vid√©os** : contenu multim√©dia (attention √† l'espace disque)
- **Documents** : PDF, documents Office

**Ce qui N'est PAS cach√© par d√©faut :**
- **Pages dynamiques** : r√©sultats de recherche, donn√©es personnalis√©es
- **Contenu avec cookies** : sessions utilisateur
- **Contenu HTTPS** : respecte la confidentialit√©
- **Contenu avec en-t√™tes no-cache**

### Configuration avanc√©e du cache

```bash
# √âditer la configuration Squid
sudo nano /etc/squid/squid.conf
```

**Configuration optimis√©e du cache :**

```bash
#
# === CONFIGURATION CACHE AVANC√âE ===
#

# === R√âPERTOIRES DE CACHE ===
# Cache principal (disque dur rapide recommand√©)
cache_dir ufs /var/spool/squid 2048 16 256

# Cache secondaire sur SSD si disponible (optionnel)
# cache_dir ufs /var/cache/squid-ssd 1024 8 128

# Cache en m√©moire (RAM) - tr√®s important pour les performances
cache_mem 512 MB

# === TAILLES D'OBJETS ===
# Taille maximale d'un objet sur disque (en KB)
maximum_object_size 100 MB

# Taille maximale d'un objet en m√©moire (en KB)
maximum_object_size_in_memory 2048 KB

# Taille minimale pour mettre en cache
minimum_object_size 0 KB

# === POLITIQUE DE REMPLACEMENT ===
# Algorithme de remplacement du cache (LRU = Least Recently Used)
cache_replacement_policy lru
memory_replacement_policy lru

# === HI√âRARCHIES DE CACHE (optionnel) ===
# Si vous avez plusieurs proxies, d√©finir les relations parent/enfant
# cache_peer proxy-parent.exemple.com parent 3128 0 no-query default
# cache_peer proxy-sibling.exemple.com sibling 3128 3130

# === REFRESH PATTERNS (tr√®s important) ===
# D√©finir combien de temps garder diff√©rents types de contenu

# Images et fichiers statiques (garde longtemps)
refresh_pattern -i \.(gif|png|jpg|jpeg|ico|bmp|tiff)$ 10080 80% 43200 override-expire ignore-no-cache

# Fichiers CSS et JavaScript (garde moyennement)
refresh_pattern -i \.(css|js)$ 1440 40% 10080 override-expire

# Documents (PDF, DOC, etc.) - garde longtemps
refresh_pattern -i \.(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar)$ 2880 60% 14400 override-expire

# Pages HTML - garde peu de temps
refresh_pattern -i \.html?$ 60 20% 1440

# Sites de news (actualis√© souvent)
refresh_pattern -i (news|actualit|info) 30 10% 120

# Vid√©os YouTube et similaires (garde tr√®s longtemps)
refresh_pattern -i (youtube\.com|youtu\.be|vimeo\.com) 10080 80% 43200 override-expire

# Sites de r√©seaux sociaux (pas de cache long)
refresh_pattern -i (facebook|twitter|instagram) 5 5% 60

# Moteurs de recherche (tr√®s court)
refresh_pattern -i (google\.com|bing\.com|yahoo\.com)/search 1 5% 30

# R√®gles g√©n√©rales par d√©faut (ordre important, du sp√©cifique au g√©n√©ral)
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0      # Pas de cache pour les scripts
refresh_pattern .               0       20%     4320   # D√©faut pour tout le reste

# === OPTIMISATIONS AVANC√âES ===
# Nombre de threads pour les E/S disque
diskd_program /usr/lib/squid/diskd-daemon

# Pr√©chargement des objets populaires
# offline_mode off

# === HI√âRARCHIE DE M√âMOIRE ===
# Distribution de la m√©moire cache
cache_mem_low 90
cache_mem_high 95

# === OPTIMISATIONS R√âSEAU ===
# Connexions simultan√©es vers un m√™me serveur
server_persistent_connections on
client_persistent_connections on

# Timeout pour les connexions
connect_timeout 30 seconds
read_timeout 15 minutes

# === COMPRESSION ===
# Activer la compression (√©conomise de la bande passante)
# N√©cessite squid compil√© avec --enable-zph-qos
# compress_objects on
```

### Monitoring du cache

**Cr√©er un script de surveillance du cache :**

```bash
sudo nano /usr/local/bin/squid-cache-monitor.sh
```

```bash
#!/bin/bash
#
# Monitoring du cache Squid
#

LOG_FILE="/var/log/squid-cache-monitor.log"
SQUID_HOST="localhost"
SQUID_PORT="3128"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log_message "=== Monitoring cache Squid ==="

# Statistiques g√©n√©rales du cache
CACHE_INFO=$(squidclient -h $SQUID_HOST -p $SQUID_PORT mgr:info 2>/dev/null)

# Extraire les informations importantes
if [ ! -z "$CACHE_INFO" ]; then
    # Ratio de hit/miss du cache
    HIT_RATIO=$(echo "$CACHE_INFO" | grep "Request Hit Ratios" -A 5 | grep "5min:" | awk '{print $2}')
    BYTE_RATIO=$(echo "$CACHE_INFO" | grep "Byte Hit Ratios" -A 5 | grep "5min:" | awk '{print $2}')

    # Objets en cache
    OBJECTS_COUNT=$(echo "$CACHE_INFO" | grep "Store Entries" | awk '{print $3}')

    # Utilisation disque
    DISK_USAGE=$(echo "$CACHE_INFO" | grep "Store Directory Statistics" -A 10 | grep "Size:" | awk '{print $2}')

    log_message "Hit Ratio: $HIT_RATIO% | Byte Ratio: $BYTE_RATIO%"
    log_message "Objets en cache: $OBJECTS_COUNT | Utilisation disque: $DISK_USAGE"

    # Alertes
    if [ "${HIT_RATIO%.*}" -lt 30 ]; then
        log_message "‚ö† ATTENTION: Ratio de hit faible ($HIT_RATIO%)"
    fi
else
    log_message "‚ùå Impossible de contacter Squid"
fi

# V√©rifier l'espace disque du cache
CACHE_DISK_USAGE=$(df /var/spool/squid | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $CACHE_DISK_USAGE -gt 85 ]; then
    log_message "‚ö† ATTENTION: Disque cache plein √† $CACHE_DISK_USAGE%"
fi

# Top des sites les plus consult√©s (depuis les logs)
if [ -f /var/log/squid/access.log ]; then
    TOP_SITES=$(tail -1000 /var/log/squid/access.log | awk '{print $7}' | grep -E '^http' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -5)
    log_message "Top 5 sites consult√©s dans les 1000 derni√®res requ√™tes:"
    echo "$TOP_SITES" | while read line; do
        log_message "  $line"
    done
fi

log_message "=== Fin monitoring cache ==="
```

```bash
sudo chmod +x /usr/local/bin/squid-cache-monitor.sh

# Ex√©cuter toutes les heures
sudo crontab -e
# Ajouter : 0 * * * * /usr/local/bin/squid-cache-monitor.sh
```

### Optimisation des performances

**R√©glages syst√®me pour Squid :**

```bash
# Optimiser les param√®tres syst√®me pour Squid
sudo nano /etc/sysctl.d/squid.conf
```

```bash
# Optimisations r√©seau pour Squid
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Optimisations pour les connexions multiples
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_tw_reuse = 1
net.core.netdev_max_backlog = 3000

# Optimisations pour les fichiers
fs.file-max = 100000
```

```bash
# Appliquer les changements
sudo sysctl -p /etc/sysctl.d/squid.conf
```

**Optimiser la configuration Squid pour les performances :**

```bash
# Ajouter dans squid.conf
# === OPTIMISATIONS PERFORMANCE ===

# Processus workers (pour machines multi-CPU)
workers 2

# Connexions maximales par worker
http_port 3128 workers=2

# M√©moire par worker
if ${process_number} = 1
    cache_mem 256 MB
endif
if ${process_number} = 2
    cache_mem 256 MB
endif

# File descriptors (connections simultan√©es)
max_filedescriptors 8192

# === OPTIMISATIONS I/O ===
# Op√©rations d'√©criture asynchrones
cache_dir diskd /var/spool/squid 2048 16 256 Q1=72 Q2=64

# Buffer d'√©criture
write_buffer_size 64 KB
```
### Maintenance du cache

**Script de maintenance automatique :**

```bash
sudo nano /usr/local/bin/squid-cache-maintenance.sh
```

```bash
#!/bin/bash
#
# Maintenance automatique du cache Squid
#

LOG_FILE="/var/log/squid-maintenance.log"
CACHE_DIR="/var/spool/squid"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log_message "=== D√©but maintenance cache Squid ==="

# V√©rifier l'int√©grit√© du cache
log_message "V√©rification de l'int√©grit√© du cache..."
if squid -k check 2>&1 | grep -q "FATAL"; then
    log_message "‚ùå Erreur d√©tect√©e dans le cache"

    # Sauvegarder la configuration avant r√©paration
    cp /etc/squid/squid.conf /etc/squid/squid.conf.backup.$(date +%Y%m%d)

    # Arr√™ter Squid proprement
    systemctl stop squid
    sleep 5

    # Reconstruire le cache
    log_message "Reconstruction du cache en cours..."
    squid -z

    # Red√©marrer Squid
    systemctl start squid
    log_message "Cache reconstruit et Squid red√©marr√©"
else
    log_message "‚úì Int√©grit√© du cache OK"
fi

# Statistiques du cache
CACHE_SIZE=$(du -sh $CACHE_DIR 2>/dev/null | cut -f1)
CACHE_FILES=$(find $CACHE_DIR -type f 2>/dev/null | wc -l)
log_message "Taille du cache: $CACHE_SIZE | Fichiers: $CACHE_FILES"

# Nettoyage des logs anciens (garder 30 jours)
find /var/log/squid/ -name "*.log.*" -mtime +30 -delete 2>/dev/null
DELETED=$(find /var/log/squid/ -name "*.log.*" -mtime +30 2>/dev/null | wc -l)
if [ $DELETED -gt 0 ]; then
    log_message "Nettoyage: $DELETED anciens fichiers de logs supprim√©s"
fi

# Rotation manuelle des logs si trop volumineux
ACCESS_LOG_SIZE=$(stat -c%s /var/log/squid/access.log 2>/dev/null || echo 0)
if [ $ACCESS_LOG_SIZE -gt 104857600 ]; then  # 100MB
    log_message "Rotation des logs (taille: $(($ACCESS_LOG_SIZE/1024/1024))MB)"
    squid -k rotate
fi

# V√©rifier l'espace disque disponible
DISK_USAGE=$(df $CACHE_DIR | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 90 ]; then
    log_message "‚ö† ALERTE: Espace disque critique ($DISK_USAGE%)"

    # Purger les objets les plus anciens
    log_message "Purge d'urgence du cache..."
    squid -k shutdown
    sleep 10

    # R√©duire temporairement la taille du cache
    sed -i.backup "s/cache_dir ufs.*$/cache_dir ufs $CACHE_DIR 1024 16 256/" /etc/squid/squid.conf
    squid -z
    systemctl start squid

    log_message "Taille du cache temporairement r√©duite"
elif [ $DISK_USAGE -gt 80 ]; then
    log_message "‚ö† ATTENTION: Espace disque √©lev√© ($DISK_USAGE%)"
fi

# Optimiser les performances du cache
log_message "Optimisation du cache..."
# D√©fragmentation l√©g√®re (uniquement si n√©cessaire)
if [ $(find $CACHE_DIR -name "swap.state*" -size +50M | wc -l) -gt 0 ]; then
    log_message "D√©fragmentation du cache n√©cessaire"
    squid -k shutdown
    sleep 10
    squid -z
    systemctl start squid
    log_message "D√©fragmentation termin√©e"
fi

log_message "=== Fin maintenance cache Squid ==="
```

```bash
sudo chmod +x /usr/local/bin/squid-cache-maintenance.sh

# Programmer la maintenance (tous les dimanches √† 3h du matin)
sudo crontab -e
# Ajouter : 0 3 * * 0 /usr/local/bin/squid-cache-maintenance.sh
```

### Cache pour sites sp√©cifiques

**Configuration de r√®gles de cache personnalis√©es :**

```bash
# Dans squid.conf - Section cache personnalis√©e
# === R√àGLES DE CACHE SP√âCIALIS√âES ===

# Sites de streaming - cache agressif pour les m√©tadonn√©es
refresh_pattern -i youtube\.com/.*\.(jpg|png|webp)$ 43200 80% 86400 override-expire
refresh_pattern -i youtube\.com/api/ 300 50% 1800

# Sites de d√©veloppement - cache mod√©r√©
refresh_pattern -i (github\.com|gitlab\.com|stackoverflow\.com) 1440 40% 7200
refresh_pattern -i \.js$ 2880 60% 14400 override-expire ignore-reload
refresh_pattern -i \.css$ 2880 70% 14400 override-expire ignore-reload

# CDN et biblioth√®ques - cache tr√®s agressif
refresh_pattern -i (ajax\.googleapis\.com|cdn\.jsdelivr\.net|unpkg\.com) 10080 90% 43200 override-expire ignore-no-cache
refresh_pattern -i \.(woff|woff2|ttf|eot)$ 43200 95% 86400 override-expire ignore-no-cache

# Sites d'entreprise locaux - cache court mais pr√©sent
refresh_pattern -i \.monentreprise\.local 60 20% 300

# Sites de news - cache tr√®s court
refresh_pattern -i (cnn\.com|bbc\.com|lemonde\.fr) 5 10% 60

# Ne pas cacher les sites bancaires et de e-commerce
refresh_pattern -i (paypal\.com|amazon\.com|banque.*\.fr) 0 0% 0 no-cache
```

### Analyse des performances du cache

**Script d'analyse avanc√©e :**

```bash
sudo nano /usr/local/bin/squid-analyze-performance.sh
```

```bash
#!/bin/bash
#
# Analyse des performances du cache Squid
#

REPORT_FILE="/var/log/squid-performance-report.log"
ACCESS_LOG="/var/log/squid/access.log"

generate_report() {
    echo "=== RAPPORT PERFORMANCE SQUID - $(date) ===" > $REPORT_FILE
    echo "" >> $REPORT_FILE

    # Analyse des hits/miss sur la derni√®re heure
    echo "=== ANALYSE CACHE (derni√®re heure) ===" >> $REPORT_FILE
    LAST_HOUR=$(date -d '1 hour ago' '+%d/%b/%Y:%H')

    if [ -f $ACCESS_LOG ]; then
        TOTAL_REQUESTS=$(grep "$LAST_HOUR" $ACCESS_LOG | wc -l)
        CACHE_HITS=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_HIT\|TCP_MEM_HIT\|TCP_REFRESH_HIT" | wc -l)
        CACHE_MISS=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_MISS" | wc -l)

        if [ $TOTAL_REQUESTS -gt 0 ]; then
            HIT_RATE=$(( $CACHE_HITS * 100 / $TOTAL_REQUESTS ))
            echo "Requ√™tes totales: $TOTAL_REQUESTS" >> $REPORT_FILE
            echo "Cache hits: $CACHE_HITS ($HIT_RATE%)" >> $REPORT_FILE
            echo "Cache miss: $CACHE_MISS" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
        fi

        # Top 10 des sites les plus consult√©s
        echo "=== TOP 10 SITES (derni√®re heure) ===" >> $REPORT_FILE
        grep "$LAST_HOUR" $ACCESS_LOG | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Top 10 des types de fichiers cach√©s
        echo "=== TOP 10 TYPES FICHIERS CACH√âS ===" >> $REPORT_FILE
        grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_HIT" | awk '{print $7}' | sed 's/.*\.//' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Analyse des erreurs
        echo "=== ERREURS ET PROBL√àMES ===" >> $REPORT_FILE
        ERROR_COUNT=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_DENIED\|ERR_" | wc -l)
        echo "Nombre d'erreurs: $ERROR_COUNT" >> $REPORT_FILE

        if [ $ERROR_COUNT -gt 0 ]; then
            echo "D√©tail des erreurs:" >> $REPORT_FILE
            grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_DENIED\|ERR_" | awk '{print $4}' | sort | uniq -c | sort -nr >> $REPORT_FILE
        fi
        echo "" >> $REPORT_FILE

        # Analyse de la bande passante √©conomis√©e
        echo "=== √âCONOMIES BANDE PASSANTE ===" >> $REPORT_FILE
        BYTES_FROM_CACHE=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_HIT" | awk '{sum+=$5} END {print sum}')
        TOTAL_BYTES=$(grep "$LAST_HOUR" $ACCESS_LOG | awk '{sum+=$5} END {print sum}')

        if [ ! -z "$BYTES_FROM_CACHE" ] && [ ! -z "$TOTAL_BYTES" ] && [ $TOTAL_BYTES -gt 0 ]; then
            BANDWIDTH_SAVED=$(( $BYTES_FROM_CACHE * 100 / $TOTAL_BYTES ))
            echo "Donn√©es servies depuis le cache: $(($BYTES_FROM_CACHE/1024/1024)) MB" >> $REPORT_FILE
            echo "Total des donn√©es: $(($TOTAL_BYTES/1024/1024)) MB" >> $REPORT_FILE
            echo "Bande passante √©conomis√©e: $BANDWIDTH_SAVED%" >> $REPORT_FILE
        fi
    fi

    echo "=== FIN RAPPORT ===" >> $REPORT_FILE
    echo "" >> $REPORT_FILE
}

# G√©n√©rer le rapport
generate_report

# Envoyer le rapport par email si configur√©
if command -v mail >/dev/null 2>&1; then
    mail -s "Rapport Performance Squid - $(hostname)" admin@monentreprise.local < $REPORT_FILE
fi

echo "Rapport g√©n√©r√©: $REPORT_FILE"
```

```bash
sudo chmod +x /usr/local/bin/squid-analyze-performance.sh

# G√©n√©rer un rapport quotidien
sudo crontab -e
# Ajouter : 0 8 * * * /usr/local/bin/squid-analyze-performance.sh
```

---

## 7.4.4 Authentification LDAP

L'authentification LDAP permet aux utilisateurs de s'identifier avec leur compte d'entreprise (Active Directory ou OpenLDAP) plut√¥t qu'avec des comptes locaux.

### Pourquoi utiliser LDAP ?

**Avantages de l'authentification LDAP :**
- **üîê Centralisation** : Un seul annuaire pour tous les services
- **üë• Gestion simplifi√©e** : Ajout/suppression d'utilisateurs centralis√©e
- **üîÑ Synchronisation** : Coh√©rence entre tous les services
- **üìä Audit** : Tra√ßabilit√© des acc√®s par utilisateur
- **üõ°Ô∏è S√©curit√©** : Politiques de mots de passe centralis√©es

### Installation des composants LDAP

```bash
# Installer les outils d'authentification LDAP pour Squid
sudo apt install squid-ldap-auth ldap-utils

# Pour une authentification plus avanc√©e, installer aussi
sudo apt install libldap2-dev
```

### Configuration LDAP basique

**Configuration pour Active Directory :**

```bash
# √âditer la configuration Squid
sudo nano /etc/squid/squid.conf
```

Ajouter la configuration d'authentification :

```bash
#
# === AUTHENTIFICATION LDAP ===
#

# Configuration de base pour Active Directory
auth_param basic program /usr/lib/squid/basic_ldap_auth \
    -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Users,dc=monentreprise,dc=local" \
    -s sub \
    -f "(&(objectClass=person)(sAMAccountName=%s))"

# Configuration pour OpenLDAP
# auth_param basic program /usr/lib/squid/basic_ldap_auth \
#     -H ldap://ldap.monentreprise.local:389 \
#     -D "cn=squid,ou=services,dc=monentreprise,dc=local" \
#     -w "MotDePasseServiceSquid" \
#     -b "ou=people,dc=monentreprise,dc=local" \
#     -s sub \
#     -f "(&(objectClass=inetOrgPerson)(uid=%s))"

# Nom du realm (affich√© dans la popup d'authentification)
auth_param basic realm "Proxy MonEntreprise - Identifiez-vous"

# Nombre de processus d'authentification (performance)
auth_param basic children 20 startup=5 idle=5

# Dur√©e de cache des authentifications (en secondes)
auth_param basic credentialsttl 2 hours

# === ACL POUR UTILISATEURS AUTHENTIFI√âS ===
# ACL pour tous les utilisateurs authentifi√©s
acl utilisateurs_authentifies proxy_auth REQUIRED

# ACL pour des utilisateurs sp√©cifiques
acl admins proxy_auth admin direcion manager
acl power_users proxy_auth dev-team support-team
acl employees proxy_auth REQUIRED

# === GROUPES LDAP (optionnel, plus avanc√©) ===
# Authentification par groupe LDAP
# external_acl_type ldap_group children-max=10 %LOGIN /usr/lib/squid/ext_ldap_group_acl \
#     -H ldap://dc.monentreprise.local:389 \
#     -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
#     -w "MotDePasseServiceSquid" \
#     -b "ou=Groups,dc=monentreprise,dc=local" \
#     -f "(&(objectClass=group)(member=%u))"

# acl groupe_admin external ldap_group Administrateurs
# acl groupe_users external ldap_group Utilisateurs
```

**Explication des param√®tres LDAP :**

- **-H** : URL du serveur LDAP
- **-D** : Distinguished Name du compte de service Squid
- **-w** : Mot de passe du compte de service
- **-b** : Base DN pour la recherche des utilisateurs
- **-s** : Scope de recherche (sub = sous-arbre)
- **-f** : Filtre LDAP pour trouver l'utilisateur

### R√®gles d'acc√®s avec authentification LDAP

```bash
#
# === R√àGLES D'ACC√àS AVEC LDAP ===
#

# 1. Toujours refuser les sites interdits (m√™me authentifi√©s)
http_access deny sites_interdits

# 2. Acc√®s privil√©gi√© pour les administrateurs
http_access allow admins

# 3. Power users : acc√®s √©tendu mais contr√¥l√©
http_access allow power_users sites_travail
http_access allow power_users sites_news heures_bureau
http_access allow power_users sites_sociaux !pause_dejeuner
http_access deny power_users sites_streaming

# 4. Employ√©s standard : acc√®s contr√¥l√©
http_access allow employees sites_travail
http_access allow employees sites_news heures_bureau !pause_dejeuner
http_access deny employees sites_sociaux weekend
http_access deny employees sites_streaming
http_access deny employees gros_fichiers

# 5. Refuser les utilisateurs non authentifi√©s des r√©seaux internes
http_access deny monreseau !utilisateurs_authentifies

# 6. Autoriser localhost pour l'administration
http_access allow localhost

# 7. Refuser tout le reste
http_access deny all
```

### Configuration avanc√©e avec groupes LDAP

**Script d'aide pour tester la connectivit√© LDAP :**

```bash
sudo nano /usr/local/bin/test-ldap-squid.sh
```

```bash
#!/bin/bash
#
# Test de connectivit√© LDAP pour Squid
#

LDAP_SERVER="ldap://dc.monentreprise.local:389"
BIND_DN="cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local"
BIND_PASSWORD="MotDePasseServiceSquid"
BASE_DN="ou=Users,dc=monentreprise,dc=local"

echo "=== TEST CONNECTIVIT√â LDAP POUR SQUID ==="
echo ""

# Test 1: Connectivit√© de base
echo "1. Test de connectivit√© au serveur LDAP..."
if ldapsearch -x -H "$LDAP_SERVER" -s base > /dev/null 2>&1; then
    echo "‚úì Serveur LDAP accessible"
else
    echo "‚úó Impossible de contacter le serveur LDAP"
    exit 1
fi

# Test 2: Authentification du compte de service
echo ""
echo "2. Test d'authentification du compte de service..."
if ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -s base > /dev/null 2>&1; then
    echo "‚úì Authentification du compte de service r√©ussie"
else
    echo "‚úó √âchec d'authentification du compte de service"
    exit 1
fi

# Test 3: Recherche dans la base utilisateurs
echo ""
echo "3. Test de recherche dans la base utilisateurs..."
USER_COUNT=$(ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -b "$BASE_DN" "(objectClass=person)" | grep "dn:" | wc -l)
if [ $USER_COUNT -gt 0 ]; then
    echo "‚úì $USER_COUNT utilisateurs trouv√©s dans la base"
else
    echo "‚úó Aucun utilisateur trouv√©"
    exit 1
fi

# Test 4: Test avec un utilisateur sp√©cifique
echo ""
echo "4. Test avec un utilisateur sp√©cifique:"
read -p "Nom d'utilisateur √† tester: " TEST_USER
read -s -p "Mot de passe: " TEST_PASSWORD
echo ""

if ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -b "$BASE_DN" "(&(objectClass=person)(sAMAccountName=$TEST_USER))" | grep -q "dn:"; then
    echo "‚úì Utilisateur $TEST_USER trouv√© dans l'annuaire"

    # Test d'authentification de l'utilisateur
    USER_DN=$(ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -b "$BASE_DN" "(&(objectClass=person)(sAMAccountName=$TEST_USER))" | grep "dn:" | cut -d: -f2- | sed 's/^ *//')

    if ldapsearch -x -H "$LDAP_SERVER" -D "$USER_DN" -w "$TEST_PASSWORD" -s base > /dev/null 2>&1; then
        echo "‚úì Authentification de $TEST_USER r√©ussie"
    else
        echo "‚úó √âchec d'authentification de $TEST_USER"
    fi
else
    echo "‚úó Utilisateur $TEST_USER non trouv√©"
fi

echo ""
echo "=== FIN DES TESTS ==="
```

```bash
sudo chmod +x /usr/local/bin/test-ldap-squid.sh
```

### Authentification par groupes Active Directory

**Configuration avanc√©e pour les groupes AD :**

```bash
# Dans squid.conf - Section authentification avanc√©e
#
# === AUTHENTIFICATION PAR GROUPES ACTIVE DIRECTORY ===
#

# Authentification de base (comme pr√©c√©demment)
auth_param basic program /usr/lib/squid/basic_ldap_auth \
    -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Users,dc=monentreprise,dc=local" \
    -s sub \
    -f "(&(objectClass=person)(sAMAccountName=%s))"

auth_param basic realm "Proxy MonEntreprise"
auth_param basic children 20 startup=5 idle=5
auth_param basic credentialsttl 2 hours

# V√©rification des groupes via helper externe
external_acl_type check_ldap_group children-max=10 %LOGIN /usr/lib/squid/ext_ldap_group_acl \
    -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Groups,dc=monentreprise,dc=local" \
    -f "(&(objectClass=group)(member=%u))"

# D√©finir les ACL par groupes
acl groupe_admin external check_ldap_group "CN=Administrateurs IT,OU=Groups,DC=monentreprise,DC=local"
acl groupe_direction external check_ldap_group "CN=Direction,OU=Groups,DC=monentreprise,DC=local"
acl groupe_employes external check_ldap_group "CN=Employes,OU=Groups,DC=monentreprise,DC=local"
acl groupe_stagiaires external check_ldap_group "CN=Stagiaires,OU=Groups,DC=monentreprise,DC=local"

# ACL pour utilisateurs authentifi√©s
acl utilisateurs_authentifies proxy_auth REQUIRED

# === R√àGLES D'ACC√àS PAR GROUPES ===

# Administrateurs IT : acc√®s total
http_access allow groupe_admin

# Direction : acc√®s privil√©gi√©
http_access allow groupe_direction sites_travail
http_access allow groupe_direction sites_news
http_access allow groupe_direction sites_sociaux heures_bureau
http_access deny groupe_direction sites_streaming

# Employ√©s : acc√®s standard
http_access allow groupe_employes sites_travail
http_access allow groupe_employes sites_news heures_bureau
http_access allow groupe_employes sites_sociaux heures_bureau !pause_dejeuner
http_access deny groupe_employes sites_streaming
http_access deny groupe_employes gros_fichiers

# Stagiaires : acc√®s restreint
http_access allow groupe_stagiaires sites_travail heures_bureau
http_access deny groupe_stagiaires sites_sociaux
http_access deny groupe_stagiaires sites_news
http_access deny groupe_stagiaires sites_streaming

# Refuser les utilisateurs non authentifi√©s
http_access deny monreseau !utilisateurs_authentifies

# R√®gles par d√©faut
http_access allow localhost
http_access deny all
```

### Logs et monitoring de l'authentification

**Configuration des logs d'authentification :**

```bash
# Dans squid.conf
# === LOGS AUTHENTIFICATION ===

# Log sp√©cifique pour les authentifications
logformat authlog %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
access_log /var/log/squid/auth.log authlog !localhost

# Log des √©checs d'authentification
logformat authfail %ts.%03tu %>a %Ss/%03>Hs %rm %ru FAILED_AUTH
access_log /var/log/squid/auth-failures.log authfail !localhost
```

**Script de monitoring des authentifications :**

```bash
sudo nano /usr/local/bin/squid-auth-monitor.sh
```

```bash
#!/bin/bash
#
# Monitoring des authentifications Squid
#

LOG_FILE="/var/log/squid-auth-monitor.log"
AUTH_LOG="/var/log/squid/auth.log"
FAILURE_LOG="/var/log/squid/auth-failures.log"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log_message "=== Monitoring authentification Squid ==="

# Statistiques de la derni√®re heure
LAST_HOUR=$(date -d '1 hour ago' '+%d/%b/%Y:%H')

if [ -f $AUTH_LOG ]; then
    # Compter les connexions par utilisateur
    echo "=== UTILISATEURS ACTIFS (derni√®re heure) ===" >> $LOG_FILE
    grep "$LAST_HOUR" $AUTH_LOG | awk '{print $8}' | grep -v "^-$" | sort | uniq -c | sort -nr | head -10 >> $LOG_FILE

    # Compter les connexions par IP
    echo "" >> $LOG_FILE
    echo "=== TOP IP SOURCES ===" >> $LOG_FILE
    grep "$LAST_HOUR" $AUTH_LOG | awk '{print $3}' | sort | uniq -c | sort -nr | head -10 >> $LOG_FILE

    # Sites les plus consult√©s par utilisateur authentifi√©
    echo "" >> $LOG_FILE
    echo "=== TOP SITES (utilisateurs authentifi√©s) ===" >> $LOG_FILE
    grep "$LAST_HOUR" $AUTH_LOG | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 >> $LOG_FILE
fi

# Analyser les √©checs d'authentification
if [ -f $FAILURE_LOG ]; then
    FAILED_AUTH=$(grep "$LAST_HOUR" $FAILURE_LOG | wc -l)
    if [ $FAILED_AUTH -gt 0 ]; then
        log_message "‚ö† $FAILED_AUTH √©checs d'authentification d√©tect√©s"

        # Top des IP avec √©checs d'auth
        echo "" >> $LOG_FILE
        echo "=== √âCHECS D'AUTHENTIFICATION ===" >> $LOG_FILE
        grep "$LAST_HOUR" $FAILURE_LOG | awk '{print $2}' | sort | uniq -c | sort -nr | head -5 >> $LOG_FILE

        # Alerter si trop d'√©checs depuis une m√™me IP
        grep "$LAST_HOUR" $FAILURE_LOG | awk '{print $2}' | sort | uniq -c | while read count ip; do
            if [ $count -gt 10 ]; then
                log_message "üö® ALERTE: $count √©checs d'authentification depuis $ip"
            fi
        done
    else
        log_message "‚úì Aucun √©chec d'authentification"
    fi
fi

# V√©rifier la connectivit√© LDAP
if command -v ldapsearch >/dev/null 2>&1; then
    if ldapsearch -x -H "ldap://dc.monentreprise.local:389" -s base >/dev/null 2>&1; then
        log_message "‚úì Serveur LDAP accessible"
    else
        log_message "‚ùå Serveur LDAP inaccessible - authentification compromise!"
    fi
fi

log_message "=== Fin monitoring authentification ==="
```

```bash
sudo chmod +x /usr/local/bin/squid-auth-monitor.sh

# Surveiller toutes les heures
sudo crontab -e
# Ajouter : 0 * * * * /usr/local/bin/squid-auth-monitor.sh
```

### D√©pannage des probl√®mes LDAP

**Probl√®mes courants et solutions :**

#### 1. Impossible de se connecter au serveur LDAP

```bash
# V√©rifier la connectivit√© r√©seau
ping dc.monentreprise.local

# Tester le port LDAP
telnet dc.monentreprise.local 389

# V√©rifier les logs Squid
sudo tail -f /var/log/squid/cache.log | grep -i ldap
```

#### 2. Authentification du compte de service √©choue

```bash
# Tester manuellement
ldapsearch -x -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -s base

# V√©rifier que le compte n'est pas verrouill√© dans AD
```

#### 3. Utilisateurs trouv√©s mais authentification √©choue

```bash
# V√©rifier le filtre LDAP
ldapsearch -x -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Users,dc=monentreprise,dc=local" \
    "(&(objectClass=person)(sAMAccountName=nom_utilisateur))"

# V√©rifier les logs d'authentification
sudo tail -f /var/log/squid/cache.log | grep -i "auth\|ldap"
```

### Configuration du client proxy

**Configuration automatique via PAC (Proxy Auto-Configuration) :**

```bash
# Cr√©er le fichier PAC
sudo nano /var/www/html/proxy.pac
```

```javascript
function FindProxyForURL(url, host) {
    // Configuration proxy pour MonEntreprise

    // Adresse du serveur proxy
    var proxy = "PROXY proxy.monentreprise.local:3128";

    // Pas de proxy pour localhost et r√©seaux internes
    if (isPlainHostName(host) ||
        shExpMatch(host, "localhost") ||
        shExpMatch(host, "127.*") ||
        isInNet(host, "192.168.0.0", "255.255.0.0") ||
        isInNet(host, "10.0.0.0", "255.0.0.0") ||
        isInNet(host, "172.16.0.0", "255.240.0.0")) {
        return "DIRECT";
    }

    // Pas de proxy pour les domaines internes
    if (shExpMatch(host, "*.monentreprise.local") ||
        shExpMatch(host, "*.local")) {
        return "DIRECT";
    }

    // Sites qui doivent bypasser le proxy (ex: sites bancaires)
    if (shExpMatch(host, "*.banque-postale.fr") ||
        shExpMatch(host, "*.credit-agricole.fr") ||
        shExpMatch(host, "*.bnpparibas.net")) {
        return "DIRECT";
    }

    // Sites de mise √† jour (acc√®s direct pour √©viter les probl√®mes)
    if (shExpMatch(host, "*.microsoft.com") ||
        shExpMatch(host, "*.windowsupdate.com") ||
        shExpMatch(host, "*.ubuntu.com") ||
        shExpMatch(host, "*.debian.org")) {
        return "DIRECT";
    }

    // Tout le reste via le proxy
    return proxy;
}
```

**Configurer Apache pour servir le fichier PAC :**

```bash
# Ajouter le type MIME pour PAC
sudo nano /etc/apache2/mods-available/mime.conf
```

Ajouter dans la section types :
```apache
# Proxy Auto-Configuration
AddType application/x-ns-proxy-autoconfig .pac
```

```bash
# Red√©marrer Apache
sudo systemctl reload apache2

# Tester l'acc√®s au fichier PAC
curl http://proxy.monentreprise.local/proxy.pac
```

**Instructions pour configurer les clients :**

```bash
# Cr√©er une page d'aide pour les utilisateurs
sudo nano /var/www/html/configuration-proxy.html
```

```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration Proxy - MonEntreprise</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .config-box { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .warning { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üåê Configuration du Proxy MonEntreprise</h1>

    <div class="warning">
        <strong>‚ö†Ô∏è Important :</strong> Cette configuration est obligatoire pour acc√©der √† Internet depuis le r√©seau de l'entreprise.
    </div>

    <h2>üìù Configuration Automatique (Recommand√©e)</h2>
    <div class="config-box">
        <strong>URL de configuration automatique :</strong><br>
        <code>http://proxy.monentreprise.local/proxy.pac</code>
    </div>

    <h2>üîß Configuration Manuelle</h2>
    <div class="config-box">
        <strong>Serveur Proxy :</strong> proxy.monentreprise.local<br>
        <strong>Port :</strong> 3128<br>
        <strong>Authentification :</strong> Requise (vos identifiants r√©seau)
    </div>

    <h2>üñ•Ô∏è Instructions par Navigateur</h2>

    <h3>Google Chrome / Microsoft Edge</h3>
    <ol>
        <li>Ouvrir les Param√®tres</li>
        <li>Rechercher "proxy" dans la barre de recherche</li>
        <li>Cliquer sur "Param√®tres proxy"</li>
        <li>Activer "Utiliser un script de configuration"</li>
        <li>URL : <code>http://proxy.monentreprise.local/proxy.pac</code></li>
    </ol>

    <h3>Mozilla Firefox</h3>
    <ol>
        <li>Menu ‚Üí Param√®tres ‚Üí G√©n√©ral</li>
        <li>Descendre √† "Param√®tres r√©seau"</li>
        <li>Cliquer sur "Param√®tres..."</li>
        <li>S√©lectionner "URL de configuration automatique du proxy"</li>
        <li>URL : <code>http://proxy.monentreprise.local/proxy.pac</code></li>
    </ol>

    <h3>Safari (Mac)</h3>
    <ol>
        <li>Pr√©f√©rences Syst√®me ‚Üí R√©seau</li>
        <li>S√©lectionner votre connexion ‚Üí Avanc√©</li>
        <li>Onglet Proxies</li>
        <li>Cocher "Configuration automatique du proxy"</li>
        <li>URL : <code>http://proxy.monentreprise.local/proxy.pac</code></li>
    </ol>

    <h2>üì± Configuration Mobile</h2>

    <h3>Android</h3>
    <ol>
        <li>Param√®tres ‚Üí Wi-Fi</li>
        <li>Appui long sur le r√©seau de l'entreprise</li>
        <li>Modifier le r√©seau ‚Üí Options avanc√©es</li>
        <li>Proxy : Manuel</li>
        <li>Nom d'h√¥te : <code>proxy.monentreprise.local</code></li>
        <li>Port : <code>3128</code></li>
    </ol>

    <h3>iOS</h3>
    <ol>
        <li>R√©glages ‚Üí Wi-Fi</li>
        <li>Toucher le (i) √† c√¥t√© du r√©seau entreprise</li>
        <li>Faire d√©filer jusqu'√† "Proxy HTTP"</li>
        <li>S√©lectionner "Manuel"</li>
        <li>Serveur : <code>proxy.monentreprise.local</code></li>
        <li>Port : <code>3128</code></li>
        <li>Authentification : Activ√©e</li>
    </ol>

    <h2>üÜò Support</h2>
    <div class="success">
        <strong>Besoin d'aide ?</strong><br>
        üìß Email : support@monentreprise.local<br>
        üìû T√©l√©phone : 01.23.45.67.89<br>
        üïê Horaires : Lun-Ven 8h-18h
    </div>

    <hr>
    <small>Service IT - MonEntreprise | Derni√®re mise √† jour : $(date '+%d/%m/%Y')</small>
</body>
</html>
```

### Monitoring et reporting complets

**Script de rapport global du proxy :**

```bash
sudo nano /usr/local/bin/squid-report-complet.sh
```

```bash
#!/bin/bash
#
# Rapport complet du serveur proxy Squid
#

REPORT_DIR="/var/log/squid/reports"
REPORT_FILE="$REPORT_DIR/rapport-$(date +%Y%m%d).html"
ACCESS_LOG="/var/log/squid/access.log"

# Cr√©er le r√©pertoire de rapports
mkdir -p $REPORT_DIR

# Fonction pour g√©n√©rer le rapport HTML
generate_html_report() {
    cat > $REPORT_FILE << EOF
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport Proxy - $(date '+%d/%m/%Y')</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .metric { background: #e8f4f8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .alert { background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; }
        .success { background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb; }
        .chart { text-align: center; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üìä Rapport Proxy MonEntreprise</h1>
    <p><strong>Date :</strong> $(date '+%d/%m/%Y %H:%M:%S')</p>
    <p><strong>P√©riode analys√©e :</strong> $(date -d '24 hours ago' '+%d/%m/%Y %H:%M') - $(date '+%d/%m/%Y %H:%M')</p>

    <hr>
EOF

    # Statistiques g√©n√©rales
    if [ -f $ACCESS_LOG ]; then
        YESTERDAY=$(date -d '1 day ago' '+%d/%b/%Y')
        TODAY=$(date '+%d/%b/%Y')

        # Compter les requ√™tes
        TOTAL_REQUESTS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | wc -l)
        CACHE_HITS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_HIT\|TCP_MEM_HIT" | wc -l)
        CACHE_MISS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_MISS" | wc -l)
        DENIED_REQUESTS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_DENIED" | wc -l)

        # Calculer les pourcentages
        if [ $TOTAL_REQUESTS -gt 0 ]; then
            HIT_RATE=$(( $CACHE_HITS * 100 / $TOTAL_REQUESTS ))
            MISS_RATE=$(( $CACHE_MISS * 100 / $TOTAL_REQUESTS ))
            DENIED_RATE=$(( $DENIED_REQUESTS * 100 / $TOTAL_REQUESTS ))
        else
            HIT_RATE=0
            MISS_RATE=0
            DENIED_RATE=0
        fi

        # Bande passante
        TOTAL_BYTES=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | awk '{sum+=$5} END {print sum}')
        CACHED_BYTES=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_HIT\|TCP_MEM_HIT" | awk '{sum+=$5} END {print sum}')

        # Convertir en unit√©s lisibles
        TOTAL_MB=$(( ${TOTAL_BYTES:-0} / 1024 / 1024 ))
        CACHED_MB=$(( ${CACHED_BYTES:-0} / 1024 / 1024 ))
        SAVED_MB=$(( $CACHED_MB ))

        cat >> $REPORT_FILE << EOF
    <h2>üìà Statistiques G√©n√©rales</h2>
    <div class="metric">
        <strong>Requ√™tes totales :</strong> $TOTAL_REQUESTS<br>
        <strong>Cache hits :</strong> $CACHE_HITS ($HIT_RATE%)<br>
        <strong>Cache miss :</strong> $CACHE_MISS ($MISS_RATE%)<br>
        <strong>Requ√™tes refus√©es :</strong> $DENIED_REQUESTS ($DENIED_RATE%)<br>
        <strong>Bande passante totale :</strong> $TOTAL_MB MB<br>
        <strong>Bande passante √©conomis√©e :</strong> $SAVED_MB MB<br>
    </div>
EOF

        # √âtat du cache
        if [ $HIT_RATE -gt 50 ]; then
            echo '<div class="success">‚úÖ <strong>Excellent :</strong> Taux de cache √©lev√© ('$HIT_RATE'%)</div>' >> $REPORT_FILE
        elif [ $HIT_RATE -gt 30 ]; then
            echo '<div class="alert">‚ö†Ô∏è <strong>Moyen :</strong> Taux de cache acceptable ('$HIT_RATE'%)</div>' >> $REPORT_FILE
        else
            echo '<div class="alert">‚ùå <strong>Faible :</strong> Taux de cache √† am√©liorer ('$HIT_RATE'%)</div>' >> $REPORT_FILE
        fi

        # Top 10 des sites consult√©s
        cat >> $REPORT_FILE << EOF
    <h2>üåê Top 10 des Sites Consult√©s</h2>
    <table>
        <tr><th>Rang</th><th>Site</th><th>Requ√™tes</th><th>Pourcentage</th></tr>
EOF

        grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 | nl | while read rank count site; do
            percentage=$(( $count * 100 / $TOTAL_REQUESTS ))
            echo "<tr><td>$rank</td><td>$site</td><td>$count</td><td>$percentage%</td></tr>" >> $REPORT_FILE
        done

        echo '</table>' >> $REPORT_FILE

        # Top 10 des utilisateurs (si authentification LDAP activ√©e)
        if grep -q "proxy_auth" /etc/squid/squid.conf; then
            cat >> $REPORT_FILE << EOF
    <h2>üë• Top 10 des Utilisateurs</h2>
    <table>
        <tr><th>Rang</th><th>Utilisateur</th><th>Requ√™tes</th></tr>
EOF

            grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | awk '{print $8}' | grep -v "^-$" | sort | uniq -c | sort -nr | head -10 | nl | while read rank count user; do
                echo "<tr><td>$rank</td><td>$user</td><td>$count</td></tr>" >> $REPORT_FILE
            done

            echo '</table>' >> $REPORT_FILE
        fi

        # Analyse par heure
        cat >> $REPORT_FILE << EOF
    <h2>üïê R√©partition par Heure</h2>
    <table>
        <tr><th>Heure</th><th>Requ√™tes</th><th>Cache Hits</th><th>Taux de Hit</th></tr>
EOF

        for hour in $(seq -f "%02g" 0 23); do
            hour_requests=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep ":$hour:" | wc -l)
            hour_hits=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep ":$hour:" | grep "TCP_HIT\|TCP_MEM_HIT" | wc -l)
            if [ $hour_requests -gt 0 ]; then
                hour_hit_rate=$(( $hour_hits * 100 / $hour_requests ))
            else
                hour_hit_rate=0
            fi
            echo "<tr><td>${hour}h</td><td>$hour_requests</td><td>$hour_hits</td><td>$hour_hit_rate%</td></tr>" >> $REPORT_FILE
        done

        echo '</table>' >> $REPORT_FILE

        # Sites bloqu√©s les plus demand√©s
        cat >> $REPORT_FILE << EOF
    <h2>üö´ Sites Bloqu√©s les Plus Demand√©s</h2>
    <table>
        <tr><th>Site</th><th>Tentatives</th></tr>
EOF

        grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_DENIED" | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 | while read count site; do
            echo "<tr><td>$site</td><td>$count</td></tr>" >> $REPORT_FILE
        done

        echo '</table>' >> $REPORT_FILE
    fi

    # Informations syst√®me
    cat >> $REPORT_FILE << EOF
    <h2>üñ•Ô∏è Informations Syst√®me</h2>
    <div class="metric">
        <strong>Serveur :</strong> $(hostname)<br>
        <strong>Version Squid :</strong> $(squid -v | head -1)<br>
        <strong>Uptime :</strong> $(uptime | cut -d',' -f1 | cut -d' ' -f4-)<br>
        <strong>Charge syst√®me :</strong> $(uptime | awk -F'load average:' '{print $2}')<br>
        <strong>Utilisation disque cache :</strong> $(df -h /var/spool/squid | tail -1 | awk '{print $3"/"$2" ("$5")"}')<br>
        <strong>Processus Squid :</strong> $(ps aux | grep squid | grep -v grep | wc -l) processus actifs<br>
    </div>

    <h2>‚öôÔ∏è Configuration Active</h2>
    <div class="metric">
        <strong>Port d'√©coute :</strong> $(grep "^http_port" /etc/squid/squid.conf | head -1)<br>
        <strong>Taille cache disque :</strong> $(grep "^cache_dir" /etc/squid/squid.conf | awk '{print $4" MB"}')<br>
        <strong>M√©moire cache :</strong> $(grep "^cache_mem" /etc/squid/squid.conf | awk '{print $2" "$3}')<br>
        <strong>Authentification :</strong> $(if grep -q "auth_param" /etc/squid/squid.conf; then echo "Activ√©e (LDAP)"; else echo "D√©sactiv√©e"; fi)<br>
    </div>

    <hr>
    <p><small>Rapport g√©n√©r√© automatiquement le $(date '+%d/%m/%Y √† %H:%M:%S') par le serveur $(hostname)</small></p>
</body>
</html>
EOF
}

# G√©n√©rer le rapport
generate_html_report

# Compresser les anciens rapports (garder 30 jours)
find $REPORT_DIR -name "rapport-*.html" -mtime +30 -exec gzip {} \;

# Nettoyer les rapports compress√©s tr√®s anciens (garder 90 jours)
find $REPORT_DIR -name "rapport-*.html.gz" -mtime +90 -delete

echo "Rapport g√©n√©r√©: $REPORT_FILE"

# Envoyer par email si configur√©
if command -v mail >/dev/null 2>&1 && [ -f /etc/postfix/main.cf ]; then
    {
        echo "Rapport proxy quotidien en pi√®ce jointe."
        echo ""
        echo "R√©sum√© rapide:"
        echo "- Requ√™tes trait√©es: $TOTAL_REQUESTS"
        echo "- Taux de cache: $HIT_RATE%"
        echo "- Bande passante √©conomis√©e: $SAVED_MB MB"
        echo ""
        echo "Consultez le rapport complet en pi√®ce jointe."
    } | mail -s "Rapport Proxy $(date '+%d/%m/%Y')" -a $REPORT_FILE admin@monentreprise.local
fi
```

```bash
sudo chmod +x /usr/local/bin/squid-report-complet.sh

# G√©n√©rer un rapport quotidien √† 7h du matin
sudo crontab -e
# Ajouter : 0 7 * * * /usr/local/bin/squid-report-complet.sh
```

### Sauvegarde et r√©cup√©ration

**Script de sauvegarde compl√®te :**

```bash
sudo nano /usr/local/bin/backup-squid.sh
```

```bash
#!/bin/bash
#
# Sauvegarde compl√®te de la configuration Squid
#

BACKUP_DIR="/backup/squid"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="squid-backup-$DATE.tar.gz"

# Cr√©er le r√©pertoire de sauvegarde
mkdir -p $BACKUP_DIR

echo "=== Sauvegarde Squid - $DATE ==="

# Arr√™ter temporairement Squid pour coh√©rence
echo "Arr√™t temporaire de Squid..."
systemctl stop squid

# Sauvegarder la configuration
echo "Sauvegarde de la configuration..."
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    /etc/squid/ \
    /var/log/squid/access.log \
    /var/log/squid/cache.log \
    /usr/local/bin/squid-*.sh \
    /etc/cron.d/*squid* 2>/dev/null

# Sauvegarder les statistiques du cache (pas le cache lui-m√™me, trop volumineux)
squid -k shutdown 2>/dev/null || true
if [ -f /var/spool/squid/swap.state ]; then
    echo "Sauvegarde des m√©tadonn√©es du cache..."
    tar -rzf $BACKUP_DIR/$BACKUP_FILE /var/spool/squid/swap.state* 2>/dev/null
fi

# Red√©marrer Squid
echo "Red√©marrage de Squid..."
systemctl start squid

# V√©rifier que Squid fonctionne
if systemctl is-active --quiet squid; then
    echo "‚úÖ Squid red√©marr√© avec succ√®s"
else
    echo "‚ùå Erreur: Squid ne red√©marre pas!"
    exit 1
fi

# Nettoyer les anciennes sauvegardes (garder 14 jours)
find $BACKUP_DIR -name "squid-backup-*.tar.gz" -mtime +14 -delete

# Taille de la sauvegarde
BACKUP_SIZE=$(du -h $BACKUP_DIR/$BACKUP_FILE | cut -f1)
echo "‚úÖ Sauvegarde termin√©e: $BACKUP_FILE ($BACKUP_SIZE)"

# Log de la sauvegarde
echo "[$(date)] Sauvegarde r√©alis√©e: $BACKUP_FILE ($BACKUP_SIZE)" >> /var/log/squid-backup.log
```

```bash
sudo chmod +x /usr/local/bin/backup-squid.sh

# Sauvegarde automatique tous les dimanches √† 2h
sudo crontab -e
# Ajouter : 0 2 * * 0 /usr/local/bin/backup-squid.sh
```

**Script de restauration :**

```bash
sudo nano /usr/local/bin/restore-squid.sh
```

```bash
#!/bin/bash
#
# Restauration de la configuration Squid
#

BACKUP_DIR="/backup/squid"

if [ $# -eq 0 ]; then
    echo "Usage: $0 <fichier_sauvegarde>"
    echo ""
    echo "Sauvegardes disponibles:"
    ls -la $BACKUP_DIR/squid-backup-*.tar.gz 2>/dev/null || echo "Aucune sauvegarde trouv√©e"
    exit 1
fi

BACKUP_FILE="$1"

if [ ! -f "$BACKUP_FILE" ]; then
    echo "‚ùå Erreur: Fichier de sauvegarde non trouv√©: $BACKUP_FILE"
    exit 1
fi

echo "=== Restauration Squid depuis $BACKUP_FILE ==="

# Confirmation
read -p "‚ö†Ô∏è  Cette op√©ration va remplacer la configuration actuelle. Continuer? (oui/non): " confirm
if [ "$confirm" != "oui" ]; then
    echo "Restauration annul√©e."
    exit 0
fi

# Sauvegarder la configuration actuelle
echo "Sauvegarde de la configuration actuelle..."
cp -r /etc/squid /etc/squid.backup.$(date +%Y%m%d_%H%M%S)

# Arr√™ter Squid
echo "Arr√™t de Squid..."
systemctl stop squid

# Restaurer la configuration
echo "Restauration en cours..."
tar -xzf "$BACKUP_FILE" -C / --overwrite

# V√©rifier la configuration restaur√©e
echo "V√©rification de la configuration..."
if squid -k parse; then
    echo "‚úÖ Configuration valide"
else
    echo "‚ùå Configuration invalide, restauration de la sauvegarde pr√©c√©dente..."
    rm -rf /etc/squid
    mv /etc/squid.backup.* /etc/squid
    systemctl start squid
    exit 1
fi

# Reconstruire le cache si n√©cessaire
echo "Reconstruction du cache..."
squid -z

# Red√©marrer Squid
echo "Red√©marrage de Squid..."
systemctl start squid

if systemctl is-active --quiet squid; then
    echo "‚úÖ Restauration termin√©e avec succ√®s"
    echo "[$(date)] Restauration r√©ussie depuis $BACKUP_FILE" >> /var/log/squid-backup.log
else
    echo "‚ùå Erreur lors du red√©marrage de Squid"
    exit 1
fi
```

```bash
sudo chmod +x /usr/local/bin/restore-squid.sh
```

---

## R√©sum√© du chapitre Serveur Proxy et Cache

Dans cette section compl√®te, nous avons configur√© :

‚úÖ **Squid proxy avanc√©** avec configuration optimis√©e et s√©curis√©e
‚úÖ **ACL sophistiqu√©es** pour un contr√¥le d'acc√®s granulaire par utilisateurs, groupes et horaires
‚úÖ **Cache intelligent** avec r√®gles personnalis√©es pour maximiser les performances
‚úÖ **Authentification LDAP/Active Directory** pour une int√©gration entreprise
‚úÖ **Configuration automatique** des clients via fichier PAC
‚úÖ **Monitoring complet** avec rapports d√©taill√©s et alertes
‚úÖ **Maintenance automatis√©e** avec sauvegarde et r√©cup√©ration

**Architecture finale du proxy :**

```
[Clients] ‚Üê‚Üí [Authentification LDAP] ‚Üê‚Üí [Squid Proxy] ‚Üê‚Üí [Cache] ‚Üê‚Üí [Internet]
    ‚Üì              ‚Üì                      ‚Üì            ‚Üì
[PAC Auto]    [Active Directory]    [ACL Rules]   [Performance]
    ‚Üì              ‚Üì                      ‚Üì            ‚Üì
[Navigateurs]  [Groupes AD]         [Filtrage]    [Bande passante]
```

**Points cl√©s √† retenir :**

- **üöÄ Performance** : Le cache peut √©conomiser 30-70% de bande passante
- **üõ°Ô∏è S√©curit√©** : Filtrage des sites malveillants et contr√¥le d'acc√®s
- **üë• Gouvernance** : Politique d'usage Internet centralis√©e et tra√ßable
- **üìä Visibilit√©** : Monitoring complet de l'usage Internet
- **üîß Maintenance** : Scripts automatis√©s pour un fonctionnement optimal
- **üè¢ Int√©gration** : Authentification transparente avec l'annuaire d'entreprise

**B√©n√©fices business :**
- **Productivit√©** : Acc√®s Internet plus rapide gr√¢ce au cache
- **Contr√¥le** : Respect de la politique d'usage et conformit√© l√©gale
- **S√©curit√©** : Protection contre les sites malveillants et le malware
- **√âconomies** : R√©duction des co√ªts de bande passante
- **Audit** : Tra√ßabilit√© compl√®te pour les exigences r√©glementaires

Votre serveur proxy est maintenant professionnel, performant et parfaitement int√©gr√© dans votre infrastructure d'entreprise. Il offre un √©quilibre optimal entre s√©curit√©, performance et facilit√© d'usage pour tous les utilisateurs.

**Conseil final :**
Surveillez r√©guli√®rement les logs et les performances. Un proxy bien configur√© et maintenu est un atout majeur pour votre infrastructure r√©seau, mais n√©cessite une attention continue pour rester optimal et s√©curis√©.

‚è≠Ô∏è
