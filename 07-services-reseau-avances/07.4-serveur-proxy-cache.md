🔝 Retour au [Sommaire](/SOMMAIRE.md)

# 7.4 Serveur proxy et cache

Un serveur proxy fait office d'intermédiaire entre les utilisateurs de votre réseau et Internet. Il offre de nombreux avantages : économie de bande passante, contrôle d'accès, sécurité renforcée, et amélioration des performances grâce au cache.

## Comprendre le rôle du proxy

**Analogie simple :** Un proxy, c'est comme un portier intelligent dans un hôtel :
- Il **contrôle qui** peut sortir et où
- Il **mémorise** les informations utiles (cache) pour les prochaines fois
- Il **filtre** les demandes suspectes
- Il **optimise** les accès en groupant les demandes similaires

**Sans proxy :**
```
[Utilisateur 1] ──→ [Internet/Site Web]
[Utilisateur 2] ──→ [Internet/Site Web]
[Utilisateur 3] ──→ [Internet/Site Web]
```

**Avec proxy :**
```
[Utilisateur 1] ──→ [Proxy] ──→ [Internet/Site Web]
[Utilisateur 2] ──→ [Proxy] ──────┘
[Utilisateur 3] ──→ [Proxy] (déjà en cache !)
```

**Avantages du proxy :**
- **🚀 Performance** : Cache les contenus fréquemment consultés
- **💰 Économie** : Réduit la bande passante utilisée
- **🛡️ Sécurité** : Filtre les sites malveillants et contrôle d'accès
- **📊 Monitoring** : Logs détaillés de l'utilisation Internet
- **🔒 Anonymat** : Cache l'IP réelle des utilisateurs

---

## 7.4.1 Squid proxy avancé

### Qu'est-ce que Squid ?

Squid est le serveur proxy de référence sur Linux. Il est utilisé par de nombreuses entreprises et fournisseurs d'accès Internet dans le monde entier.

**Pourquoi choisir Squid :**
- **Gratuit et open source** avec 25+ ans de développement
- **Très performant** : peut gérer des milliers d'utilisateurs simultanés
- **Extrêmement configurable** : adapté à tous les environnements
- **Cache intelligent** : algorithmes optimisés pour les performances
- **Support de l'authentification** : intégration LDAP, Active Directory
- **Journalisation complète** : audit et monitoring détaillés

### Installation de Squid

```bash
# Mettre à jour le système
sudo apt update

# Installer Squid et ses outils
sudo apt install squid squid-common squidclient

# Démarrer et activer le service
sudo systemctl start squid
sudo systemctl enable squid

# Vérifier l'installation
sudo systemctl status squid
```

### Comprendre la structure de configuration

Squid utilise principalement le fichier `/etc/squid/squid.conf`, mais sa structure peut paraître intimidante :

```bash
# Voir la taille du fichier de configuration par défaut
wc -l /etc/squid/squid.conf
# Résultat : environ 8000 lignes avec tous les commentaires !

# Pour débuter, sauvegardons l'original et créons un fichier propre
sudo cp /etc/squid/squid.conf /etc/squid/squid.conf.original
```

### Configuration de base simplifiée

```bash
# Créer une configuration propre et commentée
sudo nano /etc/squid/squid.conf
```

**Configuration de démarrage :**

```bash
#
# Configuration Squid pour monentreprise.local
# Version simplifiée pour débuter
#

# === PORTS ET INTERFACES ===
# Port d'écoute du proxy (standard : 3128)
http_port 3128

# Interface d'écoute (toutes les interfaces)
# http_port 192.168.1.10:3128  # Pour écouter sur une IP spécifique

# === RÉSEAUX AUTORISÉS ===
# Définir les réseaux locaux autorisés
acl localnet src 10.0.0.0/8      # RFC1918 possible internal network
acl localnet src 172.16.0.0/12   # RFC1918 possible internal network
acl localnet src 192.168.0.0/16  # RFC1918 possible internal network
acl localnet src fc00::/7         # RFC 4193 local private network range
acl localnet src fe80::/10        # RFC 4291 link-local range

# Réseau de votre entreprise (à adapter)
acl monreseau src 192.168.1.0/24

# === PORTS AUTORISÉS ===
# Ports standard pour HTTP et HTTPS
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# Méthode CONNECT (pour HTTPS)
acl CONNECT method CONNECT

# === RÈGLES D'ACCÈS ===
# Refuser les demandes vers des ports dangereux
http_access deny !Safe_ports

# Refuser CONNECT vers des ports autres que SSL
http_access deny CONNECT !SSL_ports

# Autoriser la gestion locale (pour squidclient)
http_access allow localhost manager
http_access deny manager

# Autoriser les réseaux locaux
http_access allow localnet
http_access allow monreseau

# Autoriser localhost
http_access allow localhost

# Refuser tout le reste
http_access deny all

# === CACHE ===
# Répertoire de cache (sera créé automatiquement)
cache_dir ufs /var/spool/squid 1000 16 256

# Taille mémoire pour les objets en cache (MB)
cache_mem 256 MB

# Taille max des objets en cache (KB)
maximum_object_size 10240 KB

# Taille max des objets en mémoire (KB)
maximum_object_size_in_memory 512 KB

# === LOGS ===
# Répertoire des logs
access_log /var/log/squid/access.log squid

# === COMPORTEMENT ===
# Masquer la version de Squid (sécurité)
httpd_suppress_version_string on

# Politique de refresh du cache
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# === RÉSEAU ===
# Nom d'hôte visible
visible_hostname proxy.monentreprise.local

# Ne pas servir de forward vers l'extérieur sauf réseaux autorisés
forwarded_for delete
```

**Explication des paramètres importants :**

- **http_port** : Port d'écoute du proxy (3128 est le standard)
- **acl** : Listes de contrôle d'accès (ACL = Access Control List)
- **http_access** : Règles d'autorisation (ordre important !)
- **cache_dir** : Emplacement et taille du cache disque
- **cache_mem** : Taille de la mémoire dédiée au cache

### Initialisation du cache

```bash
# Créer les répertoires de cache
sudo squid -z

# Vérifier les permissions
sudo chown -R proxy:proxy /var/spool/squid
sudo chmod -R 750 /var/spool/squid

# Redémarrer Squid
sudo systemctl restart squid

# Vérifier que Squid fonctionne
sudo systemctl status squid
```

### Test de base

```bash
# Vérifier que Squid écoute sur le bon port
sudo netstat -tlnp | grep 3128
# Devrait afficher : tcp 0 0 0.0.0.0:3128 0.0.0.0:* LISTEN PID/squid

# Tester avec un client simple
export http_proxy=http://192.168.1.10:3128
export https_proxy=http://192.168.1.10:3128
curl -I http://www.google.com

# Voir les logs en temps réel
sudo tail -f /var/log/squid/access.log
```

---

## 7.4.2 Configuration et ACL

### Comprendre les ACL (Access Control Lists)

Les ACL sont le cœur du contrôle d'accès dans Squid. Elles définissent **qui** peut accéder à **quoi** et **quand**.

**Syntaxe de base :**
```bash
acl nom_acl type_acl valeur
http_access allow/deny nom_acl
```

**Types d'ACL courants :**

| Type | Description | Exemple |
|------|-------------|---------|
| **src** | Adresse IP source | `acl bureaux src 192.168.1.0/24` |
| **dst** | Adresse IP destination | `acl serveurs_internes dst 192.168.10.0/24` |
| **port** | Port de destination | `acl ports_web port 80 443` |
| **dstdomain** | Domaine de destination | `acl sites_sociaux dstdomain facebook.com twitter.com` |
| **url_regex** | Expression régulière sur l'URL | `acl pub url_regex -i advertising` |
| **time** | Horaire | `acl heures_bureau time MTWHF 08:00-18:00` |
| **method** | Méthode HTTP | `acl methodes_post method POST PUT` |

### Configuration ACL avancée

```bash
# Éditer la configuration Squid
sudo nano /etc/squid/squid.conf
```

**Ajouter des ACL personnalisées :**

```bash
#
# === ACL PERSONNALISÉES ===
#

# === RÉSEAUX ===
acl direction src 192.168.1.20/32 192.168.1.21/32    # IP des dirigeants
acl employes src 192.168.1.100/26                     # Employés (100-163)
acl invites src 192.168.1.200/29                      # Invités (200-207)
acl serveurs src 192.168.10.0/24                      # Serveurs internes

# === HORAIRES ===
acl heures_bureau time MTWHF 08:00-18:00              # Lun-Ven 8h-18h
acl pause_dejeuner time MTWHF 12:00-14:00             # Pause déjeuner
acl weekend time SA 00:00-23:59                       # Samedi
acl weekend time SU 00:00-23:59                       # Dimanche

# === CATÉGORIES DE SITES ===
# Sites de travail (toujours autorisés)
acl sites_travail dstdomain .monentreprise.local
acl sites_travail dstdomain .github.com .stackoverflow.com .documentation.com

# Sites de news (autorisés aux heures de bureau)
acl sites_news dstdomain .lemonde.fr .bbc.com .reuters.com

# Sites sociaux (restreints)
acl sites_sociaux dstdomain .facebook.com .twitter.com .instagram.com .tiktok.com
acl sites_sociaux dstdomain .youtube.com .dailymotion.com

# Sites de streaming (très restreints)
acl sites_streaming dstdomain .netflix.com .amazon.com .hulu.com .disney.com

# Sites dangereux ou inappropriés
acl sites_interdits dstdomain "/etc/squid/listes/sites_interdits.txt"

# === TYPES DE FICHIERS ===
acl fichiers_executable url_regex -i \.exe$ \.msi$ \.dmg$
acl fichiers_video url_regex -i \.avi$ \.mp4$ \.mkv$ \.mov$
acl fichiers_audio url_regex -i \.mp3$ \.wav$ \.flac$

# === MOTS-CLÉS SUSPECTS ===
acl mots_cles_pub url_regex -i advertising ads banner popup
acl mots_cles_adult url_regex -i porn adult xxx sex

# === TAILLES DE FICHIERS ===
# Gros fichiers (> 100MB) - à restreindre
acl gros_fichiers rep_header Content-Length ^[1-9][0-9]{8,}

# === NAVIGATEURS ===
acl navigateurs_autorises browser -i mozilla firefox chrome safari
```

### Règles d'accès basées sur les ACL

```bash
#
# === RÈGLES D'ACCÈS (ordre important !) ===
#

# 1. Refus global des sites interdits
http_access deny sites_interdits

# 2. Refus des fichiers exécutables (sécurité)
http_access deny fichiers_executable

# 3. Refus du contenu adulte
http_access deny mots_cles_adult

# 4. Règles pour la direction (accès privilégié)
http_access allow direction heures_bureau
http_access allow direction sites_news
http_access deny direction sites_sociaux pause_dejeuner  # Même la direction !

# 5. Règles pour les employés en heures de bureau
http_access allow employes sites_travail
http_access allow employes sites_news heures_bureau
http_access allow employes sites_sociaux heures_bureau !pause_dejeuner
http_access deny employes sites_streaming
http_access deny employes gros_fichiers

# 6. Règles pour les employés hors heures de bureau
http_access allow employes sites_travail weekend
http_access deny employes sites_sociaux weekend
http_access deny employes sites_streaming weekend

# 7. Règles pour les invités (très restrictif)
http_access allow invites sites_travail heures_bureau
http_access deny invites sites_sociaux
http_access deny invites sites_streaming
http_access deny invites sites_news

# 8. Refuser les gros téléchargements sauf pour certains
http_access deny gros_fichiers !direction

# 9. Règles par défaut des réseaux locaux
http_access allow monreseau heures_bureau
http_access deny monreseau

# 10. Autoriser localhost (administration)
http_access allow localhost

# 11. Refuser tout le reste
http_access deny all
```

### Création de listes externes

**Créer des listes de sites à maintenir :**

```bash
# Créer le répertoire pour les listes
sudo mkdir -p /etc/squid/listes

# Liste des sites interdits
sudo nano /etc/squid/listes/sites_interdits.txt
```

```
# Sites de malware et phishing
badsite.com
malware-site.net
phishing-bank.org

# Sites de jeux en ligne
casino-online.com
poker-site.net

# Sites de téléchargement illégal
torrent-site.com
warez-download.net

# Sites de streaming illégal
streaming-illegal.tv
```

**Liste des domaines de publicité :**

```bash
# Créer une liste anti-pub
sudo nano /etc/squid/listes/publicite.txt
```

```
# Serveurs de publicité courants
doubleclick.net
googlesyndication.com
facebook.com/tr
google-analytics.com
scorecardresearch.com
adsystem.com
```

**Utiliser la liste dans la configuration :**

```bash
# Dans squid.conf
acl anti_pub dstdomain "/etc/squid/listes/publicite.txt"
http_access deny anti_pub
```

### ACL temporelles avancées

```bash
# ACL avec horaires complexes
acl matin time MTWHF 08:00-12:00
acl apres_midi time MTWHF 14:00-18:00
acl travail_combine time MTWHF 08:00-12:00,14:00-18:00

# ACL par jour spécifique
acl vendredi time F 00:00-23:59
acl fin_de_mois time 28,29,30,31 00:00-23:59

# Règles temporelles
http_access allow employes sites_sociaux vendredi apres_midi
http_access deny employes sites_sociaux !travail_combine
```

### ACL basées sur l'authentification

```bash
# ACL pour utilisateurs authentifiés (voir section LDAP plus loin)
acl utilisateurs_premium proxy_auth admin direction manager
acl utilisateurs_standard proxy_auth employe1 employe2 employe3

# Règles basées sur l'identité
http_access allow utilisateurs_premium
http_access allow utilisateurs_standard heures_bureau
http_access deny utilisateurs_standard sites_streaming
```

### Messages d'erreur personnalisés

```bash
# Créer des pages d'erreur personnalisées
sudo mkdir -p /etc/squid/errors/French

# Page d'erreur pour accès refusé
sudo nano /etc/squid/errors/French/ERR_ACCESS_DENIED
```

```html
<!DOCTYPE html>
<html>
<head>
    <title>Accès refusé - MonEntreprise</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>🚫 Accès refusé</h1>
    <p><strong>Le site que vous tentez de visiter est bloqué par la politique de sécurité de l'entreprise.</strong></p>

    <h2>Informations :</h2>
    <ul>
        <li><strong>URL demandée :</strong> %U</li>
        <li><strong>Votre adresse IP :</strong> %a</li>
        <li><strong>Date/Heure :</strong> %T</li>
    </ul>

    <h2>Que faire ?</h2>
    <p>Si vous pensez que ce blocage est une erreur, contactez :</p>
    <ul>
        <li>📧 <strong>Support IT :</strong> support@monentreprise.local</li>
        <li>📞 <strong>Téléphone :</strong> 01.23.45.67.89</li>
    </ul>

    <hr>
    <small>Proxy MonEntreprise - Politique d'utilisation Internet</small>
</body>
</html>
```

Configurer l'utilisation des messages personnalisés :

```bash
# Dans squid.conf
error_directory /etc/squid/errors/French
```

### Test et validation des ACL

```bash
# Recharger la configuration
sudo systemctl reload squid

# Tester une ACL spécifique
sudo squidclient -h localhost -p 3128 mgr:info

# Voir les ACL actives
sudo squidclient mgr:config | grep acl

# Tester l'accès depuis un client
# Depuis un poste du réseau :
export http_proxy=http://192.168.1.10:3128
curl -I http://facebook.com  # Devrait être bloqué selon vos règles
curl -I http://github.com    # Devrait être autorisé
```

---

## 7.4.3 Cache web et optimisation

### Comprendre le cache Squid

Le cache est l'une des fonctionnalités les plus importantes de Squid. Il stocke temporairement les contenus web fréquemment demandés pour améliorer les performances et réduire la bande passante.

**Types d'objets cachés :**
- **Pages HTML statiques** : pages qui ne changent pas souvent
- **Images** : photos, logos, icônes (très efficace)
- **Fichiers CSS/JavaScript** : feuilles de style et scripts
- **Vidéos** : contenu multimédia (attention à l'espace disque)
- **Documents** : PDF, documents Office

**Ce qui N'est PAS caché par défaut :**
- **Pages dynamiques** : résultats de recherche, données personnalisées
- **Contenu avec cookies** : sessions utilisateur
- **Contenu HTTPS** : respecte la confidentialité
- **Contenu avec en-têtes no-cache**

### Configuration avancée du cache

```bash
# Éditer la configuration Squid
sudo nano /etc/squid/squid.conf
```

**Configuration optimisée du cache :**

```bash
#
# === CONFIGURATION CACHE AVANCÉE ===
#

# === RÉPERTOIRES DE CACHE ===
# Cache principal (disque dur rapide recommandé)
cache_dir ufs /var/spool/squid 2048 16 256

# Cache secondaire sur SSD si disponible (optionnel)
# cache_dir ufs /var/cache/squid-ssd 1024 8 128

# Cache en mémoire (RAM) - très important pour les performances
cache_mem 512 MB

# === TAILLES D'OBJETS ===
# Taille maximale d'un objet sur disque (en KB)
maximum_object_size 100 MB

# Taille maximale d'un objet en mémoire (en KB)
maximum_object_size_in_memory 2048 KB

# Taille minimale pour mettre en cache
minimum_object_size 0 KB

# === POLITIQUE DE REMPLACEMENT ===
# Algorithme de remplacement du cache (LRU = Least Recently Used)
cache_replacement_policy lru
memory_replacement_policy lru

# === HIÉRARCHIES DE CACHE (optionnel) ===
# Si vous avez plusieurs proxies, définir les relations parent/enfant
# cache_peer proxy-parent.exemple.com parent 3128 0 no-query default
# cache_peer proxy-sibling.exemple.com sibling 3128 3130

# === REFRESH PATTERNS (très important) ===
# Définir combien de temps garder différents types de contenu

# Images et fichiers statiques (garde longtemps)
refresh_pattern -i \.(gif|png|jpg|jpeg|ico|bmp|tiff)$ 10080 80% 43200 override-expire ignore-no-cache

# Fichiers CSS et JavaScript (garde moyennement)
refresh_pattern -i \.(css|js)$ 1440 40% 10080 override-expire

# Documents (PDF, DOC, etc.) - garde longtemps
refresh_pattern -i \.(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar)$ 2880 60% 14400 override-expire

# Pages HTML - garde peu de temps
refresh_pattern -i \.html?$ 60 20% 1440

# Sites de news (actualisé souvent)
refresh_pattern -i (news|actualit|info) 30 10% 120

# Vidéos YouTube et similaires (garde très longtemps)
refresh_pattern -i (youtube\.com|youtu\.be|vimeo\.com) 10080 80% 43200 override-expire

# Sites de réseaux sociaux (pas de cache long)
refresh_pattern -i (facebook|twitter|instagram) 5 5% 60

# Moteurs de recherche (très court)
refresh_pattern -i (google\.com|bing\.com|yahoo\.com)/search 1 5% 30

# Règles générales par défaut (ordre important, du spécifique au général)
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0      # Pas de cache pour les scripts
refresh_pattern .               0       20%     4320   # Défaut pour tout le reste

# === OPTIMISATIONS AVANCÉES ===
# Nombre de threads pour les E/S disque
diskd_program /usr/lib/squid/diskd-daemon

# Préchargement des objets populaires
# offline_mode off

# === HIÉRARCHIE DE MÉMOIRE ===
# Distribution de la mémoire cache
cache_mem_low 90
cache_mem_high 95

# === OPTIMISATIONS RÉSEAU ===
# Connexions simultanées vers un même serveur
server_persistent_connections on
client_persistent_connections on

# Timeout pour les connexions
connect_timeout 30 seconds
read_timeout 15 minutes

# === COMPRESSION ===
# Activer la compression (économise de la bande passante)
# Nécessite squid compilé avec --enable-zph-qos
# compress_objects on
```

### Monitoring du cache

**Créer un script de surveillance du cache :**

```bash
sudo nano /usr/local/bin/squid-cache-monitor.sh
```

```bash
#!/bin/bash
#
# Monitoring du cache Squid
#

LOG_FILE="/var/log/squid-cache-monitor.log"
SQUID_HOST="localhost"
SQUID_PORT="3128"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log_message "=== Monitoring cache Squid ==="

# Statistiques générales du cache
CACHE_INFO=$(squidclient -h $SQUID_HOST -p $SQUID_PORT mgr:info 2>/dev/null)

# Extraire les informations importantes
if [ ! -z "$CACHE_INFO" ]; then
    # Ratio de hit/miss du cache
    HIT_RATIO=$(echo "$CACHE_INFO" | grep "Request Hit Ratios" -A 5 | grep "5min:" | awk '{print $2}')
    BYTE_RATIO=$(echo "$CACHE_INFO" | grep "Byte Hit Ratios" -A 5 | grep "5min:" | awk '{print $2}')

    # Objets en cache
    OBJECTS_COUNT=$(echo "$CACHE_INFO" | grep "Store Entries" | awk '{print $3}')

    # Utilisation disque
    DISK_USAGE=$(echo "$CACHE_INFO" | grep "Store Directory Statistics" -A 10 | grep "Size:" | awk '{print $2}')

    log_message "Hit Ratio: $HIT_RATIO% | Byte Ratio: $BYTE_RATIO%"
    log_message "Objets en cache: $OBJECTS_COUNT | Utilisation disque: $DISK_USAGE"

    # Alertes
    if [ "${HIT_RATIO%.*}" -lt 30 ]; then
        log_message "⚠ ATTENTION: Ratio de hit faible ($HIT_RATIO%)"
    fi
else
    log_message "❌ Impossible de contacter Squid"
fi

# Vérifier l'espace disque du cache
CACHE_DISK_USAGE=$(df /var/spool/squid | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $CACHE_DISK_USAGE -gt 85 ]; then
    log_message "⚠ ATTENTION: Disque cache plein à $CACHE_DISK_USAGE%"
fi

# Top des sites les plus consultés (depuis les logs)
if [ -f /var/log/squid/access.log ]; then
    TOP_SITES=$(tail -1000 /var/log/squid/access.log | awk '{print $7}' | grep -E '^http' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -5)
    log_message "Top 5 sites consultés dans les 1000 dernières requêtes:"
    echo "$TOP_SITES" | while read line; do
        log_message "  $line"
    done
fi

log_message "=== Fin monitoring cache ==="
```

```bash
sudo chmod +x /usr/local/bin/squid-cache-monitor.sh

# Exécuter toutes les heures
sudo crontab -e
# Ajouter : 0 * * * * /usr/local/bin/squid-cache-monitor.sh
```

### Optimisation des performances

**Réglages système pour Squid :**

```bash
# Optimiser les paramètres système pour Squid
sudo nano /etc/sysctl.d/squid.conf
```

```bash
# Optimisations réseau pour Squid
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# Optimisations pour les connexions multiples
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_tw_reuse = 1
net.core.netdev_max_backlog = 3000

# Optimisations pour les fichiers
fs.file-max = 100000
```

```bash
# Appliquer les changements
sudo sysctl -p /etc/sysctl.d/squid.conf
```

**Optimiser la configuration Squid pour les performances :**

```bash
# Ajouter dans squid.conf
# === OPTIMISATIONS PERFORMANCE ===

# Processus workers (pour machines multi-CPU)
workers 2

# Connexions maximales par worker
http_port 3128 workers=2

# Mémoire par worker
if ${process_number} = 1
    cache_mem 256 MB
endif
if ${process_number} = 2
    cache_mem 256 MB
endif

# File descriptors (connections simultanées)
max_filedescriptors 8192

# === OPTIMISATIONS I/O ===
# Opérations d'écriture asynchrones
cache_dir diskd /var/spool/squid 2048 16 256 Q1=72 Q2=64

# Buffer d'écriture
write_buffer_size 64 KB
```
### Maintenance du cache

**Script de maintenance automatique :**

```bash
sudo nano /usr/local/bin/squid-cache-maintenance.sh
```

```bash
#!/bin/bash
#
# Maintenance automatique du cache Squid
#

LOG_FILE="/var/log/squid-maintenance.log"
CACHE_DIR="/var/spool/squid"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log_message "=== Début maintenance cache Squid ==="

# Vérifier l'intégrité du cache
log_message "Vérification de l'intégrité du cache..."
if squid -k check 2>&1 | grep -q "FATAL"; then
    log_message "❌ Erreur détectée dans le cache"

    # Sauvegarder la configuration avant réparation
    cp /etc/squid/squid.conf /etc/squid/squid.conf.backup.$(date +%Y%m%d)

    # Arrêter Squid proprement
    systemctl stop squid
    sleep 5

    # Reconstruire le cache
    log_message "Reconstruction du cache en cours..."
    squid -z

    # Redémarrer Squid
    systemctl start squid
    log_message "Cache reconstruit et Squid redémarré"
else
    log_message "✓ Intégrité du cache OK"
fi

# Statistiques du cache
CACHE_SIZE=$(du -sh $CACHE_DIR 2>/dev/null | cut -f1)
CACHE_FILES=$(find $CACHE_DIR -type f 2>/dev/null | wc -l)
log_message "Taille du cache: $CACHE_SIZE | Fichiers: $CACHE_FILES"

# Nettoyage des logs anciens (garder 30 jours)
find /var/log/squid/ -name "*.log.*" -mtime +30 -delete 2>/dev/null
DELETED=$(find /var/log/squid/ -name "*.log.*" -mtime +30 2>/dev/null | wc -l)
if [ $DELETED -gt 0 ]; then
    log_message "Nettoyage: $DELETED anciens fichiers de logs supprimés"
fi

# Rotation manuelle des logs si trop volumineux
ACCESS_LOG_SIZE=$(stat -c%s /var/log/squid/access.log 2>/dev/null || echo 0)
if [ $ACCESS_LOG_SIZE -gt 104857600 ]; then  # 100MB
    log_message "Rotation des logs (taille: $(($ACCESS_LOG_SIZE/1024/1024))MB)"
    squid -k rotate
fi

# Vérifier l'espace disque disponible
DISK_USAGE=$(df $CACHE_DIR | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 90 ]; then
    log_message "⚠ ALERTE: Espace disque critique ($DISK_USAGE%)"

    # Purger les objets les plus anciens
    log_message "Purge d'urgence du cache..."
    squid -k shutdown
    sleep 10

    # Réduire temporairement la taille du cache
    sed -i.backup "s/cache_dir ufs.*$/cache_dir ufs $CACHE_DIR 1024 16 256/" /etc/squid/squid.conf
    squid -z
    systemctl start squid

    log_message "Taille du cache temporairement réduite"
elif [ $DISK_USAGE -gt 80 ]; then
    log_message "⚠ ATTENTION: Espace disque élevé ($DISK_USAGE%)"
fi

# Optimiser les performances du cache
log_message "Optimisation du cache..."
# Défragmentation légère (uniquement si nécessaire)
if [ $(find $CACHE_DIR -name "swap.state*" -size +50M | wc -l) -gt 0 ]; then
    log_message "Défragmentation du cache nécessaire"
    squid -k shutdown
    sleep 10
    squid -z
    systemctl start squid
    log_message "Défragmentation terminée"
fi

log_message "=== Fin maintenance cache Squid ==="
```

```bash
sudo chmod +x /usr/local/bin/squid-cache-maintenance.sh

# Programmer la maintenance (tous les dimanches à 3h du matin)
sudo crontab -e
# Ajouter : 0 3 * * 0 /usr/local/bin/squid-cache-maintenance.sh
```

### Cache pour sites spécifiques

**Configuration de règles de cache personnalisées :**

```bash
# Dans squid.conf - Section cache personnalisée
# === RÈGLES DE CACHE SPÉCIALISÉES ===

# Sites de streaming - cache agressif pour les métadonnées
refresh_pattern -i youtube\.com/.*\.(jpg|png|webp)$ 43200 80% 86400 override-expire
refresh_pattern -i youtube\.com/api/ 300 50% 1800

# Sites de développement - cache modéré
refresh_pattern -i (github\.com|gitlab\.com|stackoverflow\.com) 1440 40% 7200
refresh_pattern -i \.js$ 2880 60% 14400 override-expire ignore-reload
refresh_pattern -i \.css$ 2880 70% 14400 override-expire ignore-reload

# CDN et bibliothèques - cache très agressif
refresh_pattern -i (ajax\.googleapis\.com|cdn\.jsdelivr\.net|unpkg\.com) 10080 90% 43200 override-expire ignore-no-cache
refresh_pattern -i \.(woff|woff2|ttf|eot)$ 43200 95% 86400 override-expire ignore-no-cache

# Sites d'entreprise locaux - cache court mais présent
refresh_pattern -i \.monentreprise\.local 60 20% 300

# Sites de news - cache très court
refresh_pattern -i (cnn\.com|bbc\.com|lemonde\.fr) 5 10% 60

# Ne pas cacher les sites bancaires et de e-commerce
refresh_pattern -i (paypal\.com|amazon\.com|banque.*\.fr) 0 0% 0 no-cache
```

### Analyse des performances du cache

**Script d'analyse avancée :**

```bash
sudo nano /usr/local/bin/squid-analyze-performance.sh
```

```bash
#!/bin/bash
#
# Analyse des performances du cache Squid
#

REPORT_FILE="/var/log/squid-performance-report.log"
ACCESS_LOG="/var/log/squid/access.log"

generate_report() {
    echo "=== RAPPORT PERFORMANCE SQUID - $(date) ===" > $REPORT_FILE
    echo "" >> $REPORT_FILE

    # Analyse des hits/miss sur la dernière heure
    echo "=== ANALYSE CACHE (dernière heure) ===" >> $REPORT_FILE
    LAST_HOUR=$(date -d '1 hour ago' '+%d/%b/%Y:%H')

    if [ -f $ACCESS_LOG ]; then
        TOTAL_REQUESTS=$(grep "$LAST_HOUR" $ACCESS_LOG | wc -l)
        CACHE_HITS=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_HIT\|TCP_MEM_HIT\|TCP_REFRESH_HIT" | wc -l)
        CACHE_MISS=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_MISS" | wc -l)

        if [ $TOTAL_REQUESTS -gt 0 ]; then
            HIT_RATE=$(( $CACHE_HITS * 100 / $TOTAL_REQUESTS ))
            echo "Requêtes totales: $TOTAL_REQUESTS" >> $REPORT_FILE
            echo "Cache hits: $CACHE_HITS ($HIT_RATE%)" >> $REPORT_FILE
            echo "Cache miss: $CACHE_MISS" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
        fi

        # Top 10 des sites les plus consultés
        echo "=== TOP 10 SITES (dernière heure) ===" >> $REPORT_FILE
        grep "$LAST_HOUR" $ACCESS_LOG | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Top 10 des types de fichiers cachés
        echo "=== TOP 10 TYPES FICHIERS CACHÉS ===" >> $REPORT_FILE
        grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_HIT" | awk '{print $7}' | sed 's/.*\.//' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        # Analyse des erreurs
        echo "=== ERREURS ET PROBLÈMES ===" >> $REPORT_FILE
        ERROR_COUNT=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_DENIED\|ERR_" | wc -l)
        echo "Nombre d'erreurs: $ERROR_COUNT" >> $REPORT_FILE

        if [ $ERROR_COUNT -gt 0 ]; then
            echo "Détail des erreurs:" >> $REPORT_FILE
            grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_DENIED\|ERR_" | awk '{print $4}' | sort | uniq -c | sort -nr >> $REPORT_FILE
        fi
        echo "" >> $REPORT_FILE

        # Analyse de la bande passante économisée
        echo "=== ÉCONOMIES BANDE PASSANTE ===" >> $REPORT_FILE
        BYTES_FROM_CACHE=$(grep "$LAST_HOUR" $ACCESS_LOG | grep "TCP_HIT" | awk '{sum+=$5} END {print sum}')
        TOTAL_BYTES=$(grep "$LAST_HOUR" $ACCESS_LOG | awk '{sum+=$5} END {print sum}')

        if [ ! -z "$BYTES_FROM_CACHE" ] && [ ! -z "$TOTAL_BYTES" ] && [ $TOTAL_BYTES -gt 0 ]; then
            BANDWIDTH_SAVED=$(( $BYTES_FROM_CACHE * 100 / $TOTAL_BYTES ))
            echo "Données servies depuis le cache: $(($BYTES_FROM_CACHE/1024/1024)) MB" >> $REPORT_FILE
            echo "Total des données: $(($TOTAL_BYTES/1024/1024)) MB" >> $REPORT_FILE
            echo "Bande passante économisée: $BANDWIDTH_SAVED%" >> $REPORT_FILE
        fi
    fi

    echo "=== FIN RAPPORT ===" >> $REPORT_FILE
    echo "" >> $REPORT_FILE
}

# Générer le rapport
generate_report

# Envoyer le rapport par email si configuré
if command -v mail >/dev/null 2>&1; then
    mail -s "Rapport Performance Squid - $(hostname)" admin@monentreprise.local < $REPORT_FILE
fi

echo "Rapport généré: $REPORT_FILE"
```

```bash
sudo chmod +x /usr/local/bin/squid-analyze-performance.sh

# Générer un rapport quotidien
sudo crontab -e
# Ajouter : 0 8 * * * /usr/local/bin/squid-analyze-performance.sh
```

---

## 7.4.4 Authentification LDAP

L'authentification LDAP permet aux utilisateurs de s'identifier avec leur compte d'entreprise (Active Directory ou OpenLDAP) plutôt qu'avec des comptes locaux.

### Pourquoi utiliser LDAP ?

**Avantages de l'authentification LDAP :**
- **🔐 Centralisation** : Un seul annuaire pour tous les services
- **👥 Gestion simplifiée** : Ajout/suppression d'utilisateurs centralisée
- **🔄 Synchronisation** : Cohérence entre tous les services
- **📊 Audit** : Traçabilité des accès par utilisateur
- **🛡️ Sécurité** : Politiques de mots de passe centralisées

### Installation des composants LDAP

```bash
# Installer les outils d'authentification LDAP pour Squid
sudo apt install squid-ldap-auth ldap-utils

# Pour une authentification plus avancée, installer aussi
sudo apt install libldap2-dev
```

### Configuration LDAP basique

**Configuration pour Active Directory :**

```bash
# Éditer la configuration Squid
sudo nano /etc/squid/squid.conf
```

Ajouter la configuration d'authentification :

```bash
#
# === AUTHENTIFICATION LDAP ===
#

# Configuration de base pour Active Directory
auth_param basic program /usr/lib/squid/basic_ldap_auth \
    -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Users,dc=monentreprise,dc=local" \
    -s sub \
    -f "(&(objectClass=person)(sAMAccountName=%s))"

# Configuration pour OpenLDAP
# auth_param basic program /usr/lib/squid/basic_ldap_auth \
#     -H ldap://ldap.monentreprise.local:389 \
#     -D "cn=squid,ou=services,dc=monentreprise,dc=local" \
#     -w "MotDePasseServiceSquid" \
#     -b "ou=people,dc=monentreprise,dc=local" \
#     -s sub \
#     -f "(&(objectClass=inetOrgPerson)(uid=%s))"

# Nom du realm (affiché dans la popup d'authentification)
auth_param basic realm "Proxy MonEntreprise - Identifiez-vous"

# Nombre de processus d'authentification (performance)
auth_param basic children 20 startup=5 idle=5

# Durée de cache des authentifications (en secondes)
auth_param basic credentialsttl 2 hours

# === ACL POUR UTILISATEURS AUTHENTIFIÉS ===
# ACL pour tous les utilisateurs authentifiés
acl utilisateurs_authentifies proxy_auth REQUIRED

# ACL pour des utilisateurs spécifiques
acl admins proxy_auth admin direcion manager
acl power_users proxy_auth dev-team support-team
acl employees proxy_auth REQUIRED

# === GROUPES LDAP (optionnel, plus avancé) ===
# Authentification par groupe LDAP
# external_acl_type ldap_group children-max=10 %LOGIN /usr/lib/squid/ext_ldap_group_acl \
#     -H ldap://dc.monentreprise.local:389 \
#     -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
#     -w "MotDePasseServiceSquid" \
#     -b "ou=Groups,dc=monentreprise,dc=local" \
#     -f "(&(objectClass=group)(member=%u))"

# acl groupe_admin external ldap_group Administrateurs
# acl groupe_users external ldap_group Utilisateurs
```

**Explication des paramètres LDAP :**

- **-H** : URL du serveur LDAP
- **-D** : Distinguished Name du compte de service Squid
- **-w** : Mot de passe du compte de service
- **-b** : Base DN pour la recherche des utilisateurs
- **-s** : Scope de recherche (sub = sous-arbre)
- **-f** : Filtre LDAP pour trouver l'utilisateur

### Règles d'accès avec authentification LDAP

```bash
#
# === RÈGLES D'ACCÈS AVEC LDAP ===
#

# 1. Toujours refuser les sites interdits (même authentifiés)
http_access deny sites_interdits

# 2. Accès privilégié pour les administrateurs
http_access allow admins

# 3. Power users : accès étendu mais contrôlé
http_access allow power_users sites_travail
http_access allow power_users sites_news heures_bureau
http_access allow power_users sites_sociaux !pause_dejeuner
http_access deny power_users sites_streaming

# 4. Employés standard : accès contrôlé
http_access allow employees sites_travail
http_access allow employees sites_news heures_bureau !pause_dejeuner
http_access deny employees sites_sociaux weekend
http_access deny employees sites_streaming
http_access deny employees gros_fichiers

# 5. Refuser les utilisateurs non authentifiés des réseaux internes
http_access deny monreseau !utilisateurs_authentifies

# 6. Autoriser localhost pour l'administration
http_access allow localhost

# 7. Refuser tout le reste
http_access deny all
```

### Configuration avancée avec groupes LDAP

**Script d'aide pour tester la connectivité LDAP :**

```bash
sudo nano /usr/local/bin/test-ldap-squid.sh
```

```bash
#!/bin/bash
#
# Test de connectivité LDAP pour Squid
#

LDAP_SERVER="ldap://dc.monentreprise.local:389"
BIND_DN="cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local"
BIND_PASSWORD="MotDePasseServiceSquid"
BASE_DN="ou=Users,dc=monentreprise,dc=local"

echo "=== TEST CONNECTIVITÉ LDAP POUR SQUID ==="
echo ""

# Test 1: Connectivité de base
echo "1. Test de connectivité au serveur LDAP..."
if ldapsearch -x -H "$LDAP_SERVER" -s base > /dev/null 2>&1; then
    echo "✓ Serveur LDAP accessible"
else
    echo "✗ Impossible de contacter le serveur LDAP"
    exit 1
fi

# Test 2: Authentification du compte de service
echo ""
echo "2. Test d'authentification du compte de service..."
if ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -s base > /dev/null 2>&1; then
    echo "✓ Authentification du compte de service réussie"
else
    echo "✗ Échec d'authentification du compte de service"
    exit 1
fi

# Test 3: Recherche dans la base utilisateurs
echo ""
echo "3. Test de recherche dans la base utilisateurs..."
USER_COUNT=$(ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -b "$BASE_DN" "(objectClass=person)" | grep "dn:" | wc -l)
if [ $USER_COUNT -gt 0 ]; then
    echo "✓ $USER_COUNT utilisateurs trouvés dans la base"
else
    echo "✗ Aucun utilisateur trouvé"
    exit 1
fi

# Test 4: Test avec un utilisateur spécifique
echo ""
echo "4. Test avec un utilisateur spécifique:"
read -p "Nom d'utilisateur à tester: " TEST_USER
read -s -p "Mot de passe: " TEST_PASSWORD
echo ""

if ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -b "$BASE_DN" "(&(objectClass=person)(sAMAccountName=$TEST_USER))" | grep -q "dn:"; then
    echo "✓ Utilisateur $TEST_USER trouvé dans l'annuaire"

    # Test d'authentification de l'utilisateur
    USER_DN=$(ldapsearch -x -H "$LDAP_SERVER" -D "$BIND_DN" -w "$BIND_PASSWORD" -b "$BASE_DN" "(&(objectClass=person)(sAMAccountName=$TEST_USER))" | grep "dn:" | cut -d: -f2- | sed 's/^ *//')

    if ldapsearch -x -H "$LDAP_SERVER" -D "$USER_DN" -w "$TEST_PASSWORD" -s base > /dev/null 2>&1; then
        echo "✓ Authentification de $TEST_USER réussie"
    else
        echo "✗ Échec d'authentification de $TEST_USER"
    fi
else
    echo "✗ Utilisateur $TEST_USER non trouvé"
fi

echo ""
echo "=== FIN DES TESTS ==="
```

```bash
sudo chmod +x /usr/local/bin/test-ldap-squid.sh
```

### Authentification par groupes Active Directory

**Configuration avancée pour les groupes AD :**

```bash
# Dans squid.conf - Section authentification avancée
#
# === AUTHENTIFICATION PAR GROUPES ACTIVE DIRECTORY ===
#

# Authentification de base (comme précédemment)
auth_param basic program /usr/lib/squid/basic_ldap_auth \
    -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Users,dc=monentreprise,dc=local" \
    -s sub \
    -f "(&(objectClass=person)(sAMAccountName=%s))"

auth_param basic realm "Proxy MonEntreprise"
auth_param basic children 20 startup=5 idle=5
auth_param basic credentialsttl 2 hours

# Vérification des groupes via helper externe
external_acl_type check_ldap_group children-max=10 %LOGIN /usr/lib/squid/ext_ldap_group_acl \
    -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Groups,dc=monentreprise,dc=local" \
    -f "(&(objectClass=group)(member=%u))"

# Définir les ACL par groupes
acl groupe_admin external check_ldap_group "CN=Administrateurs IT,OU=Groups,DC=monentreprise,DC=local"
acl groupe_direction external check_ldap_group "CN=Direction,OU=Groups,DC=monentreprise,DC=local"
acl groupe_employes external check_ldap_group "CN=Employes,OU=Groups,DC=monentreprise,DC=local"
acl groupe_stagiaires external check_ldap_group "CN=Stagiaires,OU=Groups,DC=monentreprise,DC=local"

# ACL pour utilisateurs authentifiés
acl utilisateurs_authentifies proxy_auth REQUIRED

# === RÈGLES D'ACCÈS PAR GROUPES ===

# Administrateurs IT : accès total
http_access allow groupe_admin

# Direction : accès privilégié
http_access allow groupe_direction sites_travail
http_access allow groupe_direction sites_news
http_access allow groupe_direction sites_sociaux heures_bureau
http_access deny groupe_direction sites_streaming

# Employés : accès standard
http_access allow groupe_employes sites_travail
http_access allow groupe_employes sites_news heures_bureau
http_access allow groupe_employes sites_sociaux heures_bureau !pause_dejeuner
http_access deny groupe_employes sites_streaming
http_access deny groupe_employes gros_fichiers

# Stagiaires : accès restreint
http_access allow groupe_stagiaires sites_travail heures_bureau
http_access deny groupe_stagiaires sites_sociaux
http_access deny groupe_stagiaires sites_news
http_access deny groupe_stagiaires sites_streaming

# Refuser les utilisateurs non authentifiés
http_access deny monreseau !utilisateurs_authentifies

# Règles par défaut
http_access allow localhost
http_access deny all
```

### Logs et monitoring de l'authentification

**Configuration des logs d'authentification :**

```bash
# Dans squid.conf
# === LOGS AUTHENTIFICATION ===

# Log spécifique pour les authentifications
logformat authlog %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
access_log /var/log/squid/auth.log authlog !localhost

# Log des échecs d'authentification
logformat authfail %ts.%03tu %>a %Ss/%03>Hs %rm %ru FAILED_AUTH
access_log /var/log/squid/auth-failures.log authfail !localhost
```

**Script de monitoring des authentifications :**

```bash
sudo nano /usr/local/bin/squid-auth-monitor.sh
```

```bash
#!/bin/bash
#
# Monitoring des authentifications Squid
#

LOG_FILE="/var/log/squid-auth-monitor.log"
AUTH_LOG="/var/log/squid/auth.log"
FAILURE_LOG="/var/log/squid/auth-failures.log"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log_message "=== Monitoring authentification Squid ==="

# Statistiques de la dernière heure
LAST_HOUR=$(date -d '1 hour ago' '+%d/%b/%Y:%H')

if [ -f $AUTH_LOG ]; then
    # Compter les connexions par utilisateur
    echo "=== UTILISATEURS ACTIFS (dernière heure) ===" >> $LOG_FILE
    grep "$LAST_HOUR" $AUTH_LOG | awk '{print $8}' | grep -v "^-$" | sort | uniq -c | sort -nr | head -10 >> $LOG_FILE

    # Compter les connexions par IP
    echo "" >> $LOG_FILE
    echo "=== TOP IP SOURCES ===" >> $LOG_FILE
    grep "$LAST_HOUR" $AUTH_LOG | awk '{print $3}' | sort | uniq -c | sort -nr | head -10 >> $LOG_FILE

    # Sites les plus consultés par utilisateur authentifié
    echo "" >> $LOG_FILE
    echo "=== TOP SITES (utilisateurs authentifiés) ===" >> $LOG_FILE
    grep "$LAST_HOUR" $AUTH_LOG | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 >> $LOG_FILE
fi

# Analyser les échecs d'authentification
if [ -f $FAILURE_LOG ]; then
    FAILED_AUTH=$(grep "$LAST_HOUR" $FAILURE_LOG | wc -l)
    if [ $FAILED_AUTH -gt 0 ]; then
        log_message "⚠ $FAILED_AUTH échecs d'authentification détectés"

        # Top des IP avec échecs d'auth
        echo "" >> $LOG_FILE
        echo "=== ÉCHECS D'AUTHENTIFICATION ===" >> $LOG_FILE
        grep "$LAST_HOUR" $FAILURE_LOG | awk '{print $2}' | sort | uniq -c | sort -nr | head -5 >> $LOG_FILE

        # Alerter si trop d'échecs depuis une même IP
        grep "$LAST_HOUR" $FAILURE_LOG | awk '{print $2}' | sort | uniq -c | while read count ip; do
            if [ $count -gt 10 ]; then
                log_message "🚨 ALERTE: $count échecs d'authentification depuis $ip"
            fi
        done
    else
        log_message "✓ Aucun échec d'authentification"
    fi
fi

# Vérifier la connectivité LDAP
if command -v ldapsearch >/dev/null 2>&1; then
    if ldapsearch -x -H "ldap://dc.monentreprise.local:389" -s base >/dev/null 2>&1; then
        log_message "✓ Serveur LDAP accessible"
    else
        log_message "❌ Serveur LDAP inaccessible - authentification compromise!"
    fi
fi

log_message "=== Fin monitoring authentification ==="
```

```bash
sudo chmod +x /usr/local/bin/squid-auth-monitor.sh

# Surveiller toutes les heures
sudo crontab -e
# Ajouter : 0 * * * * /usr/local/bin/squid-auth-monitor.sh
```

### Dépannage des problèmes LDAP

**Problèmes courants et solutions :**

#### 1. Impossible de se connecter au serveur LDAP

```bash
# Vérifier la connectivité réseau
ping dc.monentreprise.local

# Tester le port LDAP
telnet dc.monentreprise.local 389

# Vérifier les logs Squid
sudo tail -f /var/log/squid/cache.log | grep -i ldap
```

#### 2. Authentification du compte de service échoue

```bash
# Tester manuellement
ldapsearch -x -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -s base

# Vérifier que le compte n'est pas verrouillé dans AD
```

#### 3. Utilisateurs trouvés mais authentification échoue

```bash
# Vérifier le filtre LDAP
ldapsearch -x -H ldap://dc.monentreprise.local:389 \
    -D "cn=squid-bind,ou=Service Accounts,dc=monentreprise,dc=local" \
    -w "MotDePasseServiceSquid" \
    -b "ou=Users,dc=monentreprise,dc=local" \
    "(&(objectClass=person)(sAMAccountName=nom_utilisateur))"

# Vérifier les logs d'authentification
sudo tail -f /var/log/squid/cache.log | grep -i "auth\|ldap"
```

### Configuration du client proxy

**Configuration automatique via PAC (Proxy Auto-Configuration) :**

```bash
# Créer le fichier PAC
sudo nano /var/www/html/proxy.pac
```

```javascript
function FindProxyForURL(url, host) {
    // Configuration proxy pour MonEntreprise

    // Adresse du serveur proxy
    var proxy = "PROXY proxy.monentreprise.local:3128";

    // Pas de proxy pour localhost et réseaux internes
    if (isPlainHostName(host) ||
        shExpMatch(host, "localhost") ||
        shExpMatch(host, "127.*") ||
        isInNet(host, "192.168.0.0", "255.255.0.0") ||
        isInNet(host, "10.0.0.0", "255.0.0.0") ||
        isInNet(host, "172.16.0.0", "255.240.0.0")) {
        return "DIRECT";
    }

    // Pas de proxy pour les domaines internes
    if (shExpMatch(host, "*.monentreprise.local") ||
        shExpMatch(host, "*.local")) {
        return "DIRECT";
    }

    // Sites qui doivent bypasser le proxy (ex: sites bancaires)
    if (shExpMatch(host, "*.banque-postale.fr") ||
        shExpMatch(host, "*.credit-agricole.fr") ||
        shExpMatch(host, "*.bnpparibas.net")) {
        return "DIRECT";
    }

    // Sites de mise à jour (accès direct pour éviter les problèmes)
    if (shExpMatch(host, "*.microsoft.com") ||
        shExpMatch(host, "*.windowsupdate.com") ||
        shExpMatch(host, "*.ubuntu.com") ||
        shExpMatch(host, "*.debian.org")) {
        return "DIRECT";
    }

    // Tout le reste via le proxy
    return proxy;
}
```

**Configurer Apache pour servir le fichier PAC :**

```bash
# Ajouter le type MIME pour PAC
sudo nano /etc/apache2/mods-available/mime.conf
```

Ajouter dans la section types :
```apache
# Proxy Auto-Configuration
AddType application/x-ns-proxy-autoconfig .pac
```

```bash
# Redémarrer Apache
sudo systemctl reload apache2

# Tester l'accès au fichier PAC
curl http://proxy.monentreprise.local/proxy.pac
```

**Instructions pour configurer les clients :**

```bash
# Créer une page d'aide pour les utilisateurs
sudo nano /var/www/html/configuration-proxy.html
```

```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configuration Proxy - MonEntreprise</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .config-box { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .warning { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>🌐 Configuration du Proxy MonEntreprise</h1>

    <div class="warning">
        <strong>⚠️ Important :</strong> Cette configuration est obligatoire pour accéder à Internet depuis le réseau de l'entreprise.
    </div>

    <h2>📝 Configuration Automatique (Recommandée)</h2>
    <div class="config-box">
        <strong>URL de configuration automatique :</strong><br>
        <code>http://proxy.monentreprise.local/proxy.pac</code>
    </div>

    <h2>🔧 Configuration Manuelle</h2>
    <div class="config-box">
        <strong>Serveur Proxy :</strong> proxy.monentreprise.local<br>
        <strong>Port :</strong> 3128<br>
        <strong>Authentification :</strong> Requise (vos identifiants réseau)
    </div>

    <h2>🖥️ Instructions par Navigateur</h2>

    <h3>Google Chrome / Microsoft Edge</h3>
    <ol>
        <li>Ouvrir les Paramètres</li>
        <li>Rechercher "proxy" dans la barre de recherche</li>
        <li>Cliquer sur "Paramètres proxy"</li>
        <li>Activer "Utiliser un script de configuration"</li>
        <li>URL : <code>http://proxy.monentreprise.local/proxy.pac</code></li>
    </ol>

    <h3>Mozilla Firefox</h3>
    <ol>
        <li>Menu → Paramètres → Général</li>
        <li>Descendre à "Paramètres réseau"</li>
        <li>Cliquer sur "Paramètres..."</li>
        <li>Sélectionner "URL de configuration automatique du proxy"</li>
        <li>URL : <code>http://proxy.monentreprise.local/proxy.pac</code></li>
    </ol>

    <h3>Safari (Mac)</h3>
    <ol>
        <li>Préférences Système → Réseau</li>
        <li>Sélectionner votre connexion → Avancé</li>
        <li>Onglet Proxies</li>
        <li>Cocher "Configuration automatique du proxy"</li>
        <li>URL : <code>http://proxy.monentreprise.local/proxy.pac</code></li>
    </ol>

    <h2>📱 Configuration Mobile</h2>

    <h3>Android</h3>
    <ol>
        <li>Paramètres → Wi-Fi</li>
        <li>Appui long sur le réseau de l'entreprise</li>
        <li>Modifier le réseau → Options avancées</li>
        <li>Proxy : Manuel</li>
        <li>Nom d'hôte : <code>proxy.monentreprise.local</code></li>
        <li>Port : <code>3128</code></li>
    </ol>

    <h3>iOS</h3>
    <ol>
        <li>Réglages → Wi-Fi</li>
        <li>Toucher le (i) à côté du réseau entreprise</li>
        <li>Faire défiler jusqu'à "Proxy HTTP"</li>
        <li>Sélectionner "Manuel"</li>
        <li>Serveur : <code>proxy.monentreprise.local</code></li>
        <li>Port : <code>3128</code></li>
        <li>Authentification : Activée</li>
    </ol>

    <h2>🆘 Support</h2>
    <div class="success">
        <strong>Besoin d'aide ?</strong><br>
        📧 Email : support@monentreprise.local<br>
        📞 Téléphone : 01.23.45.67.89<br>
        🕐 Horaires : Lun-Ven 8h-18h
    </div>

    <hr>
    <small>Service IT - MonEntreprise | Dernière mise à jour : $(date '+%d/%m/%Y')</small>
</body>
</html>
```

### Monitoring et reporting complets

**Script de rapport global du proxy :**

```bash
sudo nano /usr/local/bin/squid-report-complet.sh
```

```bash
#!/bin/bash
#
# Rapport complet du serveur proxy Squid
#

REPORT_DIR="/var/log/squid/reports"
REPORT_FILE="$REPORT_DIR/rapport-$(date +%Y%m%d).html"
ACCESS_LOG="/var/log/squid/access.log"

# Créer le répertoire de rapports
mkdir -p $REPORT_DIR

# Fonction pour générer le rapport HTML
generate_html_report() {
    cat > $REPORT_FILE << EOF
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport Proxy - $(date '+%d/%m/%Y')</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .metric { background: #e8f4f8; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .alert { background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; }
        .success { background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb; }
        .chart { text-align: center; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>📊 Rapport Proxy MonEntreprise</h1>
    <p><strong>Date :</strong> $(date '+%d/%m/%Y %H:%M:%S')</p>
    <p><strong>Période analysée :</strong> $(date -d '24 hours ago' '+%d/%m/%Y %H:%M') - $(date '+%d/%m/%Y %H:%M')</p>

    <hr>
EOF

    # Statistiques générales
    if [ -f $ACCESS_LOG ]; then
        YESTERDAY=$(date -d '1 day ago' '+%d/%b/%Y')
        TODAY=$(date '+%d/%b/%Y')

        # Compter les requêtes
        TOTAL_REQUESTS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | wc -l)
        CACHE_HITS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_HIT\|TCP_MEM_HIT" | wc -l)
        CACHE_MISS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_MISS" | wc -l)
        DENIED_REQUESTS=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_DENIED" | wc -l)

        # Calculer les pourcentages
        if [ $TOTAL_REQUESTS -gt 0 ]; then
            HIT_RATE=$(( $CACHE_HITS * 100 / $TOTAL_REQUESTS ))
            MISS_RATE=$(( $CACHE_MISS * 100 / $TOTAL_REQUESTS ))
            DENIED_RATE=$(( $DENIED_REQUESTS * 100 / $TOTAL_REQUESTS ))
        else
            HIT_RATE=0
            MISS_RATE=0
            DENIED_RATE=0
        fi

        # Bande passante
        TOTAL_BYTES=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | awk '{sum+=$5} END {print sum}')
        CACHED_BYTES=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_HIT\|TCP_MEM_HIT" | awk '{sum+=$5} END {print sum}')

        # Convertir en unités lisibles
        TOTAL_MB=$(( ${TOTAL_BYTES:-0} / 1024 / 1024 ))
        CACHED_MB=$(( ${CACHED_BYTES:-0} / 1024 / 1024 ))
        SAVED_MB=$(( $CACHED_MB ))

        cat >> $REPORT_FILE << EOF
    <h2>📈 Statistiques Générales</h2>
    <div class="metric">
        <strong>Requêtes totales :</strong> $TOTAL_REQUESTS<br>
        <strong>Cache hits :</strong> $CACHE_HITS ($HIT_RATE%)<br>
        <strong>Cache miss :</strong> $CACHE_MISS ($MISS_RATE%)<br>
        <strong>Requêtes refusées :</strong> $DENIED_REQUESTS ($DENIED_RATE%)<br>
        <strong>Bande passante totale :</strong> $TOTAL_MB MB<br>
        <strong>Bande passante économisée :</strong> $SAVED_MB MB<br>
    </div>
EOF

        # État du cache
        if [ $HIT_RATE -gt 50 ]; then
            echo '<div class="success">✅ <strong>Excellent :</strong> Taux de cache élevé ('$HIT_RATE'%)</div>' >> $REPORT_FILE
        elif [ $HIT_RATE -gt 30 ]; then
            echo '<div class="alert">⚠️ <strong>Moyen :</strong> Taux de cache acceptable ('$HIT_RATE'%)</div>' >> $REPORT_FILE
        else
            echo '<div class="alert">❌ <strong>Faible :</strong> Taux de cache à améliorer ('$HIT_RATE'%)</div>' >> $REPORT_FILE
        fi

        # Top 10 des sites consultés
        cat >> $REPORT_FILE << EOF
    <h2>🌐 Top 10 des Sites Consultés</h2>
    <table>
        <tr><th>Rang</th><th>Site</th><th>Requêtes</th><th>Pourcentage</th></tr>
EOF

        grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 | nl | while read rank count site; do
            percentage=$(( $count * 100 / $TOTAL_REQUESTS ))
            echo "<tr><td>$rank</td><td>$site</td><td>$count</td><td>$percentage%</td></tr>" >> $REPORT_FILE
        done

        echo '</table>' >> $REPORT_FILE

        # Top 10 des utilisateurs (si authentification LDAP activée)
        if grep -q "proxy_auth" /etc/squid/squid.conf; then
            cat >> $REPORT_FILE << EOF
    <h2>👥 Top 10 des Utilisateurs</h2>
    <table>
        <tr><th>Rang</th><th>Utilisateur</th><th>Requêtes</th></tr>
EOF

            grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | awk '{print $8}' | grep -v "^-$" | sort | uniq -c | sort -nr | head -10 | nl | while read rank count user; do
                echo "<tr><td>$rank</td><td>$user</td><td>$count</td></tr>" >> $REPORT_FILE
            done

            echo '</table>' >> $REPORT_FILE
        fi

        # Analyse par heure
        cat >> $REPORT_FILE << EOF
    <h2>🕐 Répartition par Heure</h2>
    <table>
        <tr><th>Heure</th><th>Requêtes</th><th>Cache Hits</th><th>Taux de Hit</th></tr>
EOF

        for hour in $(seq -f "%02g" 0 23); do
            hour_requests=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep ":$hour:" | wc -l)
            hour_hits=$(grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep ":$hour:" | grep "TCP_HIT\|TCP_MEM_HIT" | wc -l)
            if [ $hour_requests -gt 0 ]; then
                hour_hit_rate=$(( $hour_hits * 100 / $hour_requests ))
            else
                hour_hit_rate=0
            fi
            echo "<tr><td>${hour}h</td><td>$hour_requests</td><td>$hour_hits</td><td>$hour_hit_rate%</td></tr>" >> $REPORT_FILE
        done

        echo '</table>' >> $REPORT_FILE

        # Sites bloqués les plus demandés
        cat >> $REPORT_FILE << EOF
    <h2>🚫 Sites Bloqués les Plus Demandés</h2>
    <table>
        <tr><th>Site</th><th>Tentatives</th></tr>
EOF

        grep -E "($YESTERDAY|$TODAY)" $ACCESS_LOG | grep "TCP_DENIED" | awk '{print $7}' | sed 's|http[s]*://||' | sed 's|/.*||' | sort | uniq -c | sort -nr | head -10 | while read count site; do
            echo "<tr><td>$site</td><td>$count</td></tr>" >> $REPORT_FILE
        done

        echo '</table>' >> $REPORT_FILE
    fi

    # Informations système
    cat >> $REPORT_FILE << EOF
    <h2>🖥️ Informations Système</h2>
    <div class="metric">
        <strong>Serveur :</strong> $(hostname)<br>
        <strong>Version Squid :</strong> $(squid -v | head -1)<br>
        <strong>Uptime :</strong> $(uptime | cut -d',' -f1 | cut -d' ' -f4-)<br>
        <strong>Charge système :</strong> $(uptime | awk -F'load average:' '{print $2}')<br>
        <strong>Utilisation disque cache :</strong> $(df -h /var/spool/squid | tail -1 | awk '{print $3"/"$2" ("$5")"}')<br>
        <strong>Processus Squid :</strong> $(ps aux | grep squid | grep -v grep | wc -l) processus actifs<br>
    </div>

    <h2>⚙️ Configuration Active</h2>
    <div class="metric">
        <strong>Port d'écoute :</strong> $(grep "^http_port" /etc/squid/squid.conf | head -1)<br>
        <strong>Taille cache disque :</strong> $(grep "^cache_dir" /etc/squid/squid.conf | awk '{print $4" MB"}')<br>
        <strong>Mémoire cache :</strong> $(grep "^cache_mem" /etc/squid/squid.conf | awk '{print $2" "$3}')<br>
        <strong>Authentification :</strong> $(if grep -q "auth_param" /etc/squid/squid.conf; then echo "Activée (LDAP)"; else echo "Désactivée"; fi)<br>
    </div>

    <hr>
    <p><small>Rapport généré automatiquement le $(date '+%d/%m/%Y à %H:%M:%S') par le serveur $(hostname)</small></p>
</body>
</html>
EOF
}

# Générer le rapport
generate_html_report

# Compresser les anciens rapports (garder 30 jours)
find $REPORT_DIR -name "rapport-*.html" -mtime +30 -exec gzip {} \;

# Nettoyer les rapports compressés très anciens (garder 90 jours)
find $REPORT_DIR -name "rapport-*.html.gz" -mtime +90 -delete

echo "Rapport généré: $REPORT_FILE"

# Envoyer par email si configuré
if command -v mail >/dev/null 2>&1 && [ -f /etc/postfix/main.cf ]; then
    {
        echo "Rapport proxy quotidien en pièce jointe."
        echo ""
        echo "Résumé rapide:"
        echo "- Requêtes traitées: $TOTAL_REQUESTS"
        echo "- Taux de cache: $HIT_RATE%"
        echo "- Bande passante économisée: $SAVED_MB MB"
        echo ""
        echo "Consultez le rapport complet en pièce jointe."
    } | mail -s "Rapport Proxy $(date '+%d/%m/%Y')" -a $REPORT_FILE admin@monentreprise.local
fi
```

```bash
sudo chmod +x /usr/local/bin/squid-report-complet.sh

# Générer un rapport quotidien à 7h du matin
sudo crontab -e
# Ajouter : 0 7 * * * /usr/local/bin/squid-report-complet.sh
```

### Sauvegarde et récupération

**Script de sauvegarde complète :**

```bash
sudo nano /usr/local/bin/backup-squid.sh
```

```bash
#!/bin/bash
#
# Sauvegarde complète de la configuration Squid
#

BACKUP_DIR="/backup/squid"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="squid-backup-$DATE.tar.gz"

# Créer le répertoire de sauvegarde
mkdir -p $BACKUP_DIR

echo "=== Sauvegarde Squid - $DATE ==="

# Arrêter temporairement Squid pour cohérence
echo "Arrêt temporaire de Squid..."
systemctl stop squid

# Sauvegarder la configuration
echo "Sauvegarde de la configuration..."
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    /etc/squid/ \
    /var/log/squid/access.log \
    /var/log/squid/cache.log \
    /usr/local/bin/squid-*.sh \
    /etc/cron.d/*squid* 2>/dev/null

# Sauvegarder les statistiques du cache (pas le cache lui-même, trop volumineux)
squid -k shutdown 2>/dev/null || true
if [ -f /var/spool/squid/swap.state ]; then
    echo "Sauvegarde des métadonnées du cache..."
    tar -rzf $BACKUP_DIR/$BACKUP_FILE /var/spool/squid/swap.state* 2>/dev/null
fi

# Redémarrer Squid
echo "Redémarrage de Squid..."
systemctl start squid

# Vérifier que Squid fonctionne
if systemctl is-active --quiet squid; then
    echo "✅ Squid redémarré avec succès"
else
    echo "❌ Erreur: Squid ne redémarre pas!"
    exit 1
fi

# Nettoyer les anciennes sauvegardes (garder 14 jours)
find $BACKUP_DIR -name "squid-backup-*.tar.gz" -mtime +14 -delete

# Taille de la sauvegarde
BACKUP_SIZE=$(du -h $BACKUP_DIR/$BACKUP_FILE | cut -f1)
echo "✅ Sauvegarde terminée: $BACKUP_FILE ($BACKUP_SIZE)"

# Log de la sauvegarde
echo "[$(date)] Sauvegarde réalisée: $BACKUP_FILE ($BACKUP_SIZE)" >> /var/log/squid-backup.log
```

```bash
sudo chmod +x /usr/local/bin/backup-squid.sh

# Sauvegarde automatique tous les dimanches à 2h
sudo crontab -e
# Ajouter : 0 2 * * 0 /usr/local/bin/backup-squid.sh
```

**Script de restauration :**

```bash
sudo nano /usr/local/bin/restore-squid.sh
```

```bash
#!/bin/bash
#
# Restauration de la configuration Squid
#

BACKUP_DIR="/backup/squid"

if [ $# -eq 0 ]; then
    echo "Usage: $0 <fichier_sauvegarde>"
    echo ""
    echo "Sauvegardes disponibles:"
    ls -la $BACKUP_DIR/squid-backup-*.tar.gz 2>/dev/null || echo "Aucune sauvegarde trouvée"
    exit 1
fi

BACKUP_FILE="$1"

if [ ! -f "$BACKUP_FILE" ]; then
    echo "❌ Erreur: Fichier de sauvegarde non trouvé: $BACKUP_FILE"
    exit 1
fi

echo "=== Restauration Squid depuis $BACKUP_FILE ==="

# Confirmation
read -p "⚠️  Cette opération va remplacer la configuration actuelle. Continuer? (oui/non): " confirm
if [ "$confirm" != "oui" ]; then
    echo "Restauration annulée."
    exit 0
fi

# Sauvegarder la configuration actuelle
echo "Sauvegarde de la configuration actuelle..."
cp -r /etc/squid /etc/squid.backup.$(date +%Y%m%d_%H%M%S)

# Arrêter Squid
echo "Arrêt de Squid..."
systemctl stop squid

# Restaurer la configuration
echo "Restauration en cours..."
tar -xzf "$BACKUP_FILE" -C / --overwrite

# Vérifier la configuration restaurée
echo "Vérification de la configuration..."
if squid -k parse; then
    echo "✅ Configuration valide"
else
    echo "❌ Configuration invalide, restauration de la sauvegarde précédente..."
    rm -rf /etc/squid
    mv /etc/squid.backup.* /etc/squid
    systemctl start squid
    exit 1
fi

# Reconstruire le cache si nécessaire
echo "Reconstruction du cache..."
squid -z

# Redémarrer Squid
echo "Redémarrage de Squid..."
systemctl start squid

if systemctl is-active --quiet squid; then
    echo "✅ Restauration terminée avec succès"
    echo "[$(date)] Restauration réussie depuis $BACKUP_FILE" >> /var/log/squid-backup.log
else
    echo "❌ Erreur lors du redémarrage de Squid"
    exit 1
fi
```

```bash
sudo chmod +x /usr/local/bin/restore-squid.sh
```

---

## Résumé du chapitre Serveur Proxy et Cache

Dans cette section complète, nous avons configuré :

✅ **Squid proxy avancé** avec configuration optimisée et sécurisée
✅ **ACL sophistiquées** pour un contrôle d'accès granulaire par utilisateurs, groupes et horaires
✅ **Cache intelligent** avec règles personnalisées pour maximiser les performances
✅ **Authentification LDAP/Active Directory** pour une intégration entreprise
✅ **Configuration automatique** des clients via fichier PAC
✅ **Monitoring complet** avec rapports détaillés et alertes
✅ **Maintenance automatisée** avec sauvegarde et récupération

**Architecture finale du proxy :**

```
[Clients] ←→ [Authentification LDAP] ←→ [Squid Proxy] ←→ [Cache] ←→ [Internet]
    ↓              ↓                      ↓            ↓
[PAC Auto]    [Active Directory]    [ACL Rules]   [Performance]
    ↓              ↓                      ↓            ↓
[Navigateurs]  [Groupes AD]         [Filtrage]    [Bande passante]
```

**Points clés à retenir :**

- **🚀 Performance** : Le cache peut économiser 30-70% de bande passante
- **🛡️ Sécurité** : Filtrage des sites malveillants et contrôle d'accès
- **👥 Gouvernance** : Politique d'usage Internet centralisée et traçable
- **📊 Visibilité** : Monitoring complet de l'usage Internet
- **🔧 Maintenance** : Scripts automatisés pour un fonctionnement optimal
- **🏢 Intégration** : Authentification transparente avec l'annuaire d'entreprise

**Bénéfices business :**
- **Productivité** : Accès Internet plus rapide grâce au cache
- **Contrôle** : Respect de la politique d'usage et conformité légale
- **Sécurité** : Protection contre les sites malveillants et le malware
- **Économies** : Réduction des coûts de bande passante
- **Audit** : Traçabilité complète pour les exigences réglementaires

Votre serveur proxy est maintenant professionnel, performant et parfaitement intégré dans votre infrastructure d'entreprise. Il offre un équilibre optimal entre sécurité, performance et facilité d'usage pour tous les utilisateurs.

**Conseil final :**
Surveillez régulièrement les logs et les performances. Un proxy bien configuré et maintenu est un atout majeur pour votre infrastructure réseau, mais nécessite une attention continue pour rester optimal et sécurisé.

⏭️
