üîù Retour au [Sommaire](/SOMMAIRE.md)

# 7.2 Serveur DHCP

Le DHCP (Dynamic Host Configuration Protocol) est le service qui distribue automatiquement les adresses IP et les param√®tres r√©seau aux ordinateurs qui se connectent √† votre r√©seau. Sans DHCP, vous devriez configurer manuellement chaque ordinateur avec une adresse IP, un masque de sous-r√©seau, une passerelle et des serveurs DNS.

## Pourquoi utiliser DHCP ?

**Analogie simple :** Imaginez un h√¥tel o√π chaque client doit recevoir une chambre (adresse IP), les cl√©s d'acc√®s (param√®tres r√©seau), et les informations sur les services (DNS, passerelle). Sans DHCP, le r√©ceptionniste devrait noter manuellement chaque attribution. Avec DHCP, tout se fait automatiquement !

**Avantages du DHCP :**
- **Automatisation** : Plus besoin de configurer chaque machine manuellement
- **√âvite les conflits** : Pas de risque d'avoir deux machines avec la m√™me IP
- **Gestion centralis√©e** : Tous les param√®tres r√©seau depuis un seul endroit
- **Mobilit√©** : Les ordinateurs portables s'adaptent automatiquement
- **√âconomie d'adresses** : R√©utilisation des IP lib√©r√©es

**Comment fonctionne DHCP :**

1. **Client** : "Bonjour, j'ai besoin d'une adresse IP !" (DHCP Discover)
2. **Serveur** : "Je peux te proposer 192.168.1.100" (DHCP Offer)
3. **Client** : "J'accepte cette adresse !" (DHCP Request)
4. **Serveur** : "C'est confirm√©, voici tous tes param√®tres" (DHCP Acknowledgment)

---

## 7.2.1 ISC DHCP Server

### Qu'est-ce qu'ISC DHCP Server ?

ISC DHCP (Internet Systems Consortium DHCP) est le serveur DHCP de r√©f√©rence sur Linux. Il est gratuit, tr√®s stable, et offre toutes les fonctionnalit√©s professionnelles n√©cessaires.

**Pourquoi choisir ISC DHCP :**
- Gratuit et open source
- Tr√®s stable et √©prouv√©
- Configuration flexible et puissante
- Support du failover (haute disponibilit√©)
- Int√©gration DNS native
- Logs d√©taill√©s pour le d√©pannage

### Installation d'ISC DHCP Server

```bash
# Mettre √† jour la liste des paquets
sudo apt update

# Installer le serveur DHCP
sudo apt install isc-dhcp-server

# Le service ne d√©marre pas automatiquement car il faut d'abord le configurer
```

### Configuration de l'interface r√©seau

Avant de configurer DHCP, il faut sp√©cifier sur quelle interface r√©seau le serveur doit √©couter :

```bash
# √âditer le fichier de configuration des interfaces
sudo nano /etc/default/isc-dhcp-server
```

Modifier le contenu :

```bash
# Interface IPv4 sur laquelle DHCP doit fonctionner
INTERFACESv4="eth0"

# Interface IPv6 (laisser vide si pas utilis√©)
INTERFACESv6=""
```

**Note :** Remplacez `eth0` par le nom de votre interface r√©seau. Pour conna√Ætre vos interfaces :

```bash
# Lister les interfaces r√©seau
ip addr show

# ou plus simple
ip a
```

### Configuration de base du serveur DHCP

Le fichier principal de configuration est `/etc/dhcp/dhcpd.conf` :

```bash
# √âditer la configuration principale
sudo nano /etc/dhcp/dhcpd.conf
```

**Configuration de base compl√®te :**

```bash
#
# Configuration DHCP pour monentreprise.local
#

# Options globales
default-lease-time 600;          # Dur√©e par d√©faut (10 minutes)
max-lease-time 7200;             # Dur√©e maximale (2 heures)
authoritative;                   # Serveur DHCP autoritaire sur ce r√©seau

# Configuration DNS
option domain-name "monentreprise.local";
option domain-name-servers 192.168.1.10, 8.8.8.8;

# Configuration des logs
log-facility local7;

# Sous-r√©seau principal
subnet 192.168.1.0 netmask 255.255.255.0 {
    # Plage d'adresses IP √† distribuer
    range 192.168.1.100 192.168.1.200;

    # Passerelle par d√©faut
    option routers 192.168.1.1;

    # Serveurs DNS (r√©p√©t√© ici pour ce sous-r√©seau sp√©cifique)
    option domain-name-servers 192.168.1.10, 192.168.1.11;

    # Serveurs de temps (NTP)
    option ntp-servers 192.168.1.10;

    # Broadcast address
    option broadcast-address 192.168.1.255;

    # Dur√©es de bail pour ce sous-r√©seau
    default-lease-time 3600;     # 1 heure
    max-lease-time 86400;        # 24 heures
}
```

**Explication des param√®tres importants :**

- **default-lease-time** : Dur√©e par d√©faut pendant laquelle un client garde son adresse IP
- **max-lease-time** : Dur√©e maximale qu'un client peut demander
- **authoritative** : Indique que ce serveur est le seul serveur DHCP autoris√© sur ce r√©seau
- **range** : Plage d'adresses IP que DHCP peut distribuer
- **option routers** : La passerelle par d√©faut (g√©n√©ralement votre routeur/box)
- **option domain-name-servers** : Les serveurs DNS √† utiliser

### Configuration des logs DHCP

Pour faciliter le d√©pannage, configurons les logs DHCP :

```bash
# √âditer la configuration de rsyslog
sudo nano /etc/rsyslog.d/60-dhcp.conf
```

Ajouter :

```bash
# Logs DHCP dans un fichier s√©par√©
local7.*    /var/log/dhcp.log

# √âviter que les logs DHCP polluent syslog
local7.*    ~
```

Red√©marrer rsyslog :

```bash
sudo systemctl restart rsyslog
```

### V√©rification de la configuration

Avant de d√©marrer le service, v√©rifiez la configuration :

```bash
# Tester la syntaxe de la configuration
sudo dhcpd -t -cf /etc/dhcp/dhcpd.conf

# Si tout est OK, vous devriez voir :
# Internet Systems Consortium DHCP Server 4.4.1
# Copyright 2004-2018 Internet Systems Consortium.
# All rights reserved.
# For info, please visit https://www.isc.org/software/dhcp/
# Config file: /etc/dhcp/dhcpd.conf
# Database file: /var/lib/dhcp/dhcpd.leases
# PID file: /var/run/dhcpd.pid
```

### D√©marrage du service DHCP

```bash
# D√©marrer le service DHCP
sudo systemctl start isc-dhcp-server

# V√©rifier le statut
sudo systemctl status isc-dhcp-server

# Activer le d√©marrage automatique
sudo systemctl enable isc-dhcp-server
```

### Surveillance du service DHCP

```bash
# Voir les logs DHCP en temps r√©el
sudo tail -f /var/log/dhcp.log

# Voir les baux actifs
sudo cat /var/lib/dhcp/dhcpd.leases

# Voir les statistiques
sudo dhcp-lease-list
```

---

## 7.2.2 Configuration des plages et failover

### Configuration de plages multiples

Dans un r√©seau d'entreprise, vous pourriez avoir besoin de plusieurs plages d'adresses pour diff√©rents types d'√©quipements :

```bash
# √âditer la configuration DHCP
sudo nano /etc/dhcp/dhcpd.conf
```

**Configuration avec plusieurs plages :**

```bash
# Sous-r√©seau principal avec plusieurs plages
subnet 192.168.1.0 netmask 255.255.255.0 {
    # Plage pour les ordinateurs de bureau (9h-17h)
    pool {
        range 192.168.1.100 192.168.1.150;
        allow members of "desktop-computers";
        default-lease-time 28800;  # 8 heures
        max-lease-time 86400;      # 24 heures
    }

    # Plage pour les ordinateurs portables (plus courte)
    pool {
        range 192.168.1.151 192.168.1.200;
        allow members of "laptops";
        default-lease-time 3600;   # 1 heure
        max-lease-time 7200;       # 2 heures
    }

    # Plage pour les invit√©s (tr√®s courte)
    pool {
        range 192.168.1.201 192.168.1.220;
        allow members of "guests";
        default-lease-time 1800;   # 30 minutes
        max-lease-time 3600;       # 1 heure

        # Options sp√©cifiques aux invit√©s (pas de serveur de fichiers, etc.)
        option domain-name-servers 8.8.8.8, 8.8.4.4;
    }

    # Options communes √† tous
    option routers 192.168.1.1;
    option broadcast-address 192.168.1.255;
    option domain-name "monentreprise.local";
}

# D√©finition des classes d'√©quipements
class "desktop-computers" {
    match if substring(option vendor-class-identifier, 0, 9) = "PXEClient";
}

class "laptops" {
    match if substring(option vendor-class-identifier, 0, 8) = "MSFT 5.0";
}

class "guests" {
    match if substring(hardware, 1, 3) = aa:bb:cc;  # Pr√©fixe MAC sp√©cifique
}
```

### Configuration de sous-r√©seaux multiples

Si vous avez plusieurs VLANs ou sous-r√©seaux :

```bash
# Premier sous-r√©seau (employ√©s)
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option routers 192.168.1.1;
    option domain-name "interne.monentreprise.local";
    option domain-name-servers 192.168.1.10;
    default-lease-time 3600;
}

# Deuxi√®me sous-r√©seau (invit√©s)
subnet 192.168.2.0 netmask 255.255.255.0 {
    range 192.168.2.50 192.168.2.100;
    option routers 192.168.2.1;
    option domain-name "invites.monentreprise.local";
    option domain-name-servers 8.8.8.8, 8.8.4.4;
    default-lease-time 1800;  # Plus court pour les invit√©s
}

# Troisi√®me sous-r√©seau (serveurs - pas de DHCP, juste d√©claration)
subnet 192.168.10.0 netmask 255.255.255.0 {
    # Pas de range = pas d'attribution automatique
    # Seulement des r√©servations statiques
}
```

### Configuration du Failover (Haute Disponibilit√©)

Le failover DHCP permet d'avoir deux serveurs DHCP qui se synchronisent pour √©viter les interruptions de service.

**Architecture failover :**
- **Serveur primaire** : 192.168.1.10 (traite 80% des requ√™tes)
- **Serveur secondaire** : 192.168.1.11 (traite 20% des requ√™tes + backup)

#### Configuration sur le serveur primaire

```bash
# Sur le serveur primaire (192.168.1.10)
sudo nano /etc/dhcp/dhcpd.conf
```

Ajouter la configuration failover :

```bash
# Configuration failover
failover peer "dhcp-failover" {
    primary;                        # Ce serveur est le primaire
    address 192.168.1.10;          # IP de ce serveur
    port 647;                       # Port de communication failover
    peer address 192.168.1.11;     # IP du serveur secondaire
    peer port 647;                  # Port du serveur secondaire
    max-response-delay 30;          # D√©lai max d'attente du peer
    max-unacked-updates 10;         # Updates non confirm√©es max
    load balance max seconds 3;     # √âquilibrage de charge
    mclt 1800;                      # Maximum Client Lead Time (30 min)
    split 128;                      # R√©partition 50/50 (128/256)
    auto-partner-down 7200;         # Consid√©rer peer down apr√®s 2h
}

# Sous-r√©seau avec failover
subnet 192.168.1.0 netmask 255.255.255.0 {
    pool {
        range 192.168.1.100 192.168.1.200;
        failover peer "dhcp-failover";  # Utiliser le failover
    }

    option routers 192.168.1.1;
    option domain-name-servers 192.168.1.10, 192.168.1.11;
    option domain-name "monentreprise.local";
}
```

#### Configuration sur le serveur secondaire

```bash
# Sur le serveur secondaire (192.168.1.11)
sudo nano /etc/dhcp/dhcpd.conf
```

Configuration similaire mais en mode secondaire :

```bash
# Configuration failover
failover peer "dhcp-failover" {
    secondary;                      # Ce serveur est le secondaire
    address 192.168.1.11;          # IP de ce serveur
    port 647;                       # Port de communication failover
    peer address 192.168.1.10;     # IP du serveur primaire
    peer port 647;                  # Port du serveur primaire
    max-response-delay 30;
    max-unacked-updates 10;
    load balance max seconds 3;
}

# M√™me configuration de sous-r√©seau
subnet 192.168.1.0 netmask 255.255.255.0 {
    pool {
        range 192.168.1.100 192.168.1.200;
        failover peer "dhcp-failover";
    }

    option routers 192.168.1.1;
    option domain-name-servers 192.168.1.10, 192.168.1.11;
    option domain-name "monentreprise.local";
}
```

#### D√©marrage des serveurs en failover

```bash
# Sur chaque serveur, d√©marrer DHCP
sudo systemctl restart isc-dhcp-server

# V√©rifier les logs pour confirmer la synchronisation
sudo tail -f /var/log/dhcp.log
```

Vous devriez voir des messages comme :
```
dhcpd: failover peer dhcp-failover: I move from startup to normal
dhcpd: failover peer dhcp-failover: peer moves from startup to normal
```

### Surveillance du failover

```bash
# Script de surveillance du failover
sudo nano /usr/local/bin/check-dhcp-failover.sh
```

```bash
#!/bin/bash
LOG_FILE="/var/log/dhcp-failover-check.log"
PEER_IP="192.168.1.11"  # IP du serveur pair

# V√©rifier la connectivit√© avec le peer
if ping -c 3 $PEER_IP > /dev/null 2>&1; then
    echo "[$(date)] Peer $PEER_IP accessible" >> $LOG_FILE
else
    echo "[$(date)] ALERTE: Peer $PEER_IP inaccessible!" >> $LOG_FILE
    # Envoyer une alerte (mail, webhook, etc.)
fi

# V√©rifier si DHCP fonctionne
if systemctl is-active --quiet isc-dhcp-server; then
    echo "[$(date)] Service DHCP actif" >> $LOG_FILE
else
    echo "[$(date)] ALERTE: Service DHCP arr√™t√©!" >> $LOG_FILE
fi
```

---

## 7.2.3 R√©servations statiques

Les r√©servations statiques permettent d'attribuer toujours la m√™me adresse IP √† certains √©quipements, bas√© sur leur adresse MAC. C'est essentiel pour les serveurs, imprimantes, et √©quipements r√©seau.

### Principe des r√©servations statiques

**Quand utiliser les r√©servations :**
- **Serveurs** : Ont besoin d'adresses IP fixes pour les services
- **Imprimantes** : Pour que les utilisateurs les retrouvent toujours
- **√âquipements r√©seau** : Switches, points d'acc√®s Wi-Fi
- **Cam√©ras de s√©curit√©** : Pour un acc√®s constant
- **Stations de travail importantes** : Direction, serveur de sauvegarde

**Avantages vs IP fixe configur√©e manuellement :**
- **Gestion centralis√©e** : Toutes les IP dans un seul fichier
- **√âvite les erreurs** : Pas de configuration manuelle sur chaque machine
- **Flexibilit√©** : Possibilit√© de changer l'IP depuis le serveur DHCP
- **Coh√©rence** : M√™mes options (DNS, passerelle) pour tous

### Configuration des r√©servations statiques

```bash
# √âditer la configuration DHCP
sudo nano /etc/dhcp/dhcpd.conf
```

**Ajouter les r√©servations √† la fin du fichier :**

```bash
#
# R√©servations statiques
#

# Serveur web principal
host serveur-web {
    hardware ethernet 00:11:22:33:44:55;
    fixed-address 192.168.1.50;
    option host-name "www";
    # Options sp√©cifiques √† ce serveur
    option domain-name-servers 192.168.1.10, 8.8.8.8;
}

# Serveur de fichiers
host serveur-fichiers {
    hardware ethernet 00:11:22:33:44:56;
    fixed-address 192.168.1.51;
    option host-name "files";
    # Dur√©e de bail plus longue pour un serveur
    default-lease-time 604800;  # 1 semaine
    max-lease-time 604800;
}

# Imprimante r√©seau principale
host imprimante-direction {
    hardware ethernet 00:50:C2:12:34:56;
    fixed-address 192.168.1.80;
    option host-name "imprimante-dir";
    # Options sp√©cifiques aux imprimantes
    option time-offset -3600;  # Fuseau horaire
}

# Switch principal
host switch-principal {
    hardware ethernet 00:1B:21:12:34:57;
    fixed-address 192.168.1.20;
    option host-name "switch-01";
    # Dur√©e tr√®s longue pour √©quipement r√©seau
    default-lease-time 2592000;  # 30 jours
    max-lease-time 2592000;
}

# Ordinateur de la direction
host pc-direction {
    hardware ethernet 08:00:27:12:34:58;
    fixed-address 192.168.1.25;
    option host-name "pc-directeur";
    # Configuration DNS personnalis√©e
    option domain-name-servers 192.168.1.10;
    option domain-name "direction.monentreprise.local";
}

# Cam√©ra de s√©curit√©
host camera-entree {
    hardware ethernet 00:12:79:12:34:59;
    fixed-address 192.168.1.90;
    option host-name "cam-entree";
    # Pas de serveur DNS pour les cam√©ras
    option domain-name-servers 192.168.1.10;
}
```

### Trouver l'adresse MAC d'un √©quipement

**Depuis Windows :**
```cmd
# Ouvrir l'invite de commande et taper :
ipconfig /all

# Chercher "Adresse physique" pour votre carte r√©seau
```

**Depuis Linux :**
```bash
# Plusieurs m√©thodes :
ip addr show
# ou
ip link show
# ou
ifconfig
```

**Depuis Mac :**
```bash
# Terminal :
ifconfig
# ou dans Pr√©f√©rences Syst√®me > R√©seau > Avanc√© > Mat√©riel
```

**Depuis les logs DHCP :**
```bash
# Voir les requ√™tes DHCP avec les MAC
sudo grep "DHCPDISCOVER" /var/log/dhcp.log

# Exemple de ligne de log :
# DHCPDISCOVER from 08:00:27:12:34:58 via eth0
```

### R√©servations conditionnelles avanc√©es

```bash
# R√©servations avec conditions
host serveur-dev {
    hardware ethernet 00:11:22:33:44:60;
    fixed-address 192.168.1.60;

    # Condition : seulement si c'est demand√© par le bon nom d'h√¥te
    if option host-name = "dev-server" {
        option host-name "serveur-dev";
        option domain-name "dev.monentreprise.local";
    } else {
        # Refuser la demande si le nom ne correspond pas
        ignore booting;
    }
}

# R√©servation avec options diff√©rentes selon l'heure
host poste-mobile {
    hardware ethernet 00:11:22:33:44:61;
    fixed-address 192.168.1.65;

    # Configuration de base
    option host-name "mobile-01";

    # Dur√©e plus courte pour les postes mobiles
    default-lease-time 3600;    # 1 heure
    max-lease-time 7200;        # 2 heures maximum
}
```

### Gestion des r√©servations par groupe

Pour organiser les r√©servations, vous pouvez les regrouper :

```bash
#
# === SERVEURS ===
#
group {
    # Options communes aux serveurs
    default-lease-time 604800;   # 1 semaine
    max-lease-time 2592000;      # 30 jours
    option domain-name "serveurs.monentreprise.local";

    host serveur-web {
        hardware ethernet 00:11:22:33:44:55;
        fixed-address 192.168.1.50;
        option host-name "www";
    }

    host serveur-mail {
        hardware ethernet 00:11:22:33:44:56;
        fixed-address 192.168.1.51;
        option host-name "mail";
    }

    host serveur-dns {
        hardware ethernet 00:11:22:33:44:57;
        fixed-address 192.168.1.52;
        option host-name "dns";
    }
}

#
# === IMPRIMANTES ===
#
group {
    # Options communes aux imprimantes
    default-lease-time 86400;    # 24 heures
    option domain-name "imprimantes.monentreprise.local";

    host imprimante-etage1 {
        hardware ethernet 00:50:C2:12:34:56;
        fixed-address 192.168.1.80;
        option host-name "imp-etage1";
    }

    host imprimante-etage2 {
        hardware ethernet 00:50:C2:12:34:57;
        fixed-address 192.168.1.81;
        option host-name "imp-etage2";
    }
}

#
# === √âQUIPEMENTS R√âSEAU ===
#
group {
    # Options communes aux √©quipements r√©seau
    default-lease-time 2592000;  # 30 jours
    option domain-name "reseau.monentreprise.local";

    host switch-etage1 {
        hardware ethernet 00:1B:21:12:34:57;
        fixed-address 192.168.1.20;
        option host-name "sw-etage1";
    }

    host ap-wifi-accueil {
        hardware ethernet 00:24:A5:12:34:58;
        fixed-address 192.168.1.30;
        option host-name "wifi-accueil";
    }
}
```

---

## 7.2.4 Int√©gration DNS-DHCP

L'int√©gration DNS-DHCP permet de mettre √† jour automatiquement les enregistrements DNS quand DHCP attribue ou lib√®re une adresse IP. C'est tr√®s pratique pour avoir un DNS toujours √† jour !

### Principe de l'int√©gration

**Sans int√©gration :**
1. DHCP donne l'IP 192.168.1.100 √† l'ordinateur "portable-01"
2. L'enregistrement DNS doit √™tre ajout√© manuellement
3. Si l'ordinateur change d'IP, le DNS devient incorrect

**Avec int√©gration :**
1. DHCP donne l'IP 192.168.1.100 √† "portable-01"
2. DHCP met automatiquement √† jour le DNS
3. Si l'IP change, le DNS est automatiquement corrig√©

### Configuration c√¥t√© DNS (BIND9)

D'abord, il faut autoriser DHCP √† modifier le DNS. Nous utilisons la cl√© TSIG cr√©√©e pr√©c√©demment.

**Si vous n'avez pas encore cr√©√© de cl√© TSIG :**

```bash
# Cr√©er une cl√© pour l'int√©gration DHCP-DNS
sudo tsig-keygen -a HMAC-SHA256 dhcp-dns-key > /etc/bind/dhcp-dns.key

# S√©curiser le fichier
sudo chown root:bind /etc/bind/dhcp-dns.key
sudo chmod 640 /etc/bind/dhcp-dns.key
```

**Inclure la cl√© dans BIND :**

```bash
# √âditer named.conf
sudo nano /etc/bind/named.conf
```

Ajouter :

```bash
include "/etc/bind/dhcp-dns.key";
```

**Modifier les zones pour autoriser les mises √† jour :**

```bash
# √âditer named.conf.local
sudo nano /etc/bind/named.conf.local
```

Modifier vos zones :

```bash
# Zone directe
zone "monentreprise.local" {
    type master;
    file "/etc/bind/zones/db.monentreprise.local";
    allow-update { key "dhcp-dns-key"; };  # Autoriser DHCP
    notify yes;
    also-notify { 192.168.1.11; };        # Serveur DNS secondaire
};

# Zone inverse
zone "1.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.1";
    allow-update { key "dhcp-dns-key"; };  # Autoriser DHCP
    notify yes;
    also-notify { 192.168.1.11; };
};
```

**Red√©marrer BIND :**

```bash
sudo systemctl reload bind9
```

### Configuration c√¥t√© DHCP

**Copier la cl√© TSIG pour DHCP :**

```bash
# Copier la cl√© dans un fichier accessible par DHCP
sudo cp /etc/bind/dhcp-dns.key /etc/dhcp/dhcp-dns.key
sudo chown root:dhcpd /etc/dhcp/dhcp-dns.key
sudo chmod 640 /etc/dhcp/dhcp-dns.key
```

**Configurer DHCP pour les mises √† jour DNS :**

```bash
# √âditer la configuration DHCP
sudo nano /etc/dhcp/dhcpd.conf
```

Ajouter au d√©but du fichier :

```bash
#
# Configuration int√©gration DNS
#

# Inclure la cl√© TSIG
include "/etc/dhcp/dhcp-dns.key";

# Param√®tres DNS
ddns-update-style interim;           # Style de mise √† jour DNS
ddns-domainname "monentreprise.local";  # Domaine pour les updates
ddns-rev-domainname "in-addr.arpa";     # Domaine inverse

# Serveur DNS √† mettre √† jour
zone monentreprise.local. {
    primary 192.168.1.10;              # IP du serveur DNS primaire
    key dhcp-dns-key;                   # Cl√© √† utiliser
}

zone 1.168.192.in-addr.arpa. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}

# Options globales pour DNS
option domain-name "monentreprise.local";
option domain-name-servers 192.168.1.10, 192.168.1.11;

# Ignorer les updates des clients (on g√®re tout c√¥t√© serveur)
ignore client-updates;

# Toujours faire la mise √† jour DNS
ddns-updates on;
```

**Modifier la configuration du sous-r√©seau :**

```bash
# Dans la d√©claration du subnet
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;

    option routers 192.168.1.1;
    option domain-name-servers 192.168.1.10, 192.168.1.11;
    option domain-name "monentreprise.local";

    # Configuration DNS pour ce sous-r√©seau
    ddns-domainname "monentreprise.local";
    ddns-rev-domainname "in-addr.arpa";

    # Utiliser le nom d'h√¥te du client si fourni
    use-host-decl-names on;

    default-lease-time 3600;
    max-lease-time 86400;
}
```

### Configuration avanc√©e de l'int√©gration

**Gestion des noms d'h√¥tes :**

```bash
# Options pour la gestion des noms
# Dans la configuration globale

# Comment g√©n√©rer le nom si le client n'en fournit pas
ddns-hostname = concat ("dhcp-", binary-to-ascii(10, 8, "-", leased-address));

# Exemple : une machine avec IP 192.168.1.150 s'appellera "dhcp-192-168-1-150"

# Alternative : utiliser l'adresse MAC
# ddns-hostname = concat ("mac-",
#                        binary-to-ascii(16, 8, "",
#                        substring(hardware, 1, 1)),
#                        binary-to-ascii(16, 8, "",
#                        substring(hardware, 2, 1)),
#                        binary-to-ascii(16, 8, "",
#                        substring(hardware, 3, 1)),
#                        binary-to-ascii(16, 8, "",
#                        substring(hardware, 4, 1)),
#                        binary-to-ascii(16, 8, "",
#                        substring(hardware, 5, 1)),
#                        binary-to-ascii(16, 8, "",
#                        substring(hardware, 6, 1)));

# Version simplifi√©e pour les MAC
ddns-hostname = concat ("pc-",
                       binary-to-ascii(16, 8, "",
                       substring(hardware, 4, 2)));

# Exemple : MAC 00:11:22:33:44:55 donnera "pc-4455"
```

**Gestion des domaines selon les r√©seaux :**

```bash
# Configuration pour diff√©rents sous-r√©seaux avec domaines diff√©rents

# R√©seau employ√©s
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;
    option routers 192.168.1.1;

    # Domaine sp√©cifique aux employ√©s
    ddns-domainname "employes.monentreprise.local";
    option domain-name "employes.monentreprise.local";

    # Les machines auront des noms comme : pc-john.employes.monentreprise.local
}

# R√©seau invit√©s
subnet 192.168.2.0 netmask 255.255.255.0 {
    range 192.168.2.50 192.168.2.100;
    option routers 192.168.2.1;

    # Domaine sp√©cifique aux invit√©s
    ddns-domainname "invites.monentreprise.local";
    option domain-name "invites.monentreprise.local";

    # Dur√©e de bail plus courte pour les invit√©s
    default-lease-time 1800;  # 30 minutes
    max-lease-time 3600;      # 1 heure max
}

# R√©seau Wi-Fi
subnet 192.168.3.0 netmask 255.255.255.0 {
    range 192.168.3.10 192.168.3.100;
    option routers 192.168.3.1;

    # Domaine Wi-Fi
    ddns-domainname "wifi.monentreprise.local";
    option domain-name "wifi.monentreprise.local";

    # Noms automatiques bas√©s sur l'heure de connexion
    ddns-hostname = concat ("wifi-",
                           binary-to-ascii(10, 32, "", gethostbyaddr()));
}
```

### Gestion des zones DNS multiples

**D√©claration des zones DNS dans DHCP :**

```bash
# Zones DNS √† mettre √† jour

# Zone principale
zone monentreprise.local. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}

# Zone employ√©s
zone employes.monentreprise.local. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}

# Zone invit√©s
zone invites.monentreprise.local. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}

# Zone Wi-Fi
zone wifi.monentreprise.local. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}

# Zones inverses
zone 1.168.192.in-addr.arpa. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}

zone 2.168.192.in-addr.arpa. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}

zone 3.168.192.in-addr.arpa. {
    primary 192.168.1.10;
    key dhcp-dns-key;
}
```

### Gestion des conflits et nettoyage

**Configuration du nettoyage automatique :**

```bash
# Param√®tres de nettoyage DNS
# Dans la configuration globale

# Supprimer les anciens enregistrements quand l'adresse IP change
ddns-update-style interim;

# Dur√©e avant nettoyage des enregistrements DNS expir√©s
# (doit √™tre sup√©rieure √† max-lease-time)
min-lease-time 3600;

# Nettoyage automatique des enregistrements DNS
# quand un bail expire
on expiry {
    # Supprimer l'enregistrement A
    set noname = concat("dhcp-", binary-to-ascii(10, 8, "-", leased-address));
    set ClientName = pick-first-value(option fqdn.hostname, option host-name, noname);
    execute("/usr/local/bin/dhcp-dns-cleanup.sh", "expire", ClientName, binary-to-ascii(10, 8, ".", leased-address));
}

# Nettoyage quand un bail est lib√©r√©
on release {
    set noname = concat("dhcp-", binary-to-ascii(10, 8, "-", leased-address));
    set ClientName = pick-first-value(option fqdn.hostname, option host-name, noname);
    execute("/usr/local/bin/dhcp-dns-cleanup.sh", "release", ClientName, binary-to-ascii(10, 8, ".", leased-address));
}
```

**Script de nettoyage DNS :**

```bash
# Cr√©er le script de nettoyage
sudo nano /usr/local/bin/dhcp-dns-cleanup.sh
```

```bash
#!/bin/bash
#
# Script de nettoyage DNS pour DHCP
#

ACTION=$1      # expire, release, etc.
HOSTNAME=$2    # nom de l'h√¥te
IP_ADDRESS=$3  # adresse IP

LOG_FILE="/var/log/dhcp-dns-cleanup.log"
NSUPDATE_KEY="/etc/dhcp/dhcp-dns.key"
DNS_SERVER="192.168.1.10"

# Fonction de log
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $ACTION: $HOSTNAME ($IP_ADDRESS) - $1" >> $LOG_FILE
}

# V√©rifier les param√®tres
if [ -z "$ACTION" ] || [ -z "$HOSTNAME" ] || [ -z "$IP_ADDRESS" ]; then
    log_message "Param√®tres manquants"
    exit 1
fi

# Cr√©er le script nsupdate pour supprimer les enregistrements
cat > /tmp/dns-cleanup.nsupdate << EOF
server $DNS_SERVER
update delete $HOSTNAME.monentreprise.local A
update delete $HOSTNAME.employes.monentreprise.local A
update delete $HOSTNAME.invites.monentreprise.local A
update delete $HOSTNAME.wifi.monentreprise.local A
send

# Supprimer aussi l'enregistrement inverse
update delete $(echo $IP_ADDRESS | awk -F. '{print $4"."$3"."$2"."$1}').in-addr.arpa PTR
send
EOF

# Ex√©cuter la suppression DNS
if nsupdate -k $NSUPDATE_KEY /tmp/dns-cleanup.nsupdate; then
    log_message "Enregistrements DNS supprim√©s avec succ√®s"
else
    log_message "Erreur lors de la suppression DNS"
fi

# Nettoyer le fichier temporaire
rm -f /tmp/dns-cleanup.nsupdate
```

**Rendre le script ex√©cutable :**

```bash
sudo chmod +x /usr/local/bin/dhcp-dns-cleanup.sh
sudo chown root:root /usr/local/bin/dhcp-dns-cleanup.sh
```

### R√©servations statiques avec DNS

**R√©servations avec mise √† jour DNS automatique :**

```bash
# R√©servations statiques dans /etc/dhcp/dhcpd.conf

# Serveur web avec DNS automatique
host serveur-web {
    hardware ethernet 00:11:22:33:44:55;
    fixed-address 192.168.1.50;
    option host-name "www";

    # Forcer la mise √† jour DNS m√™me pour les r√©servations
    ddns-hostname "www";
    ddns-domainname "monentreprise.local";

    # S'assurer que DNS est mis √† jour
    on commit {
        set noname = concat("www");
        set ClientName = pick-first-value(option fqdn.hostname, option host-name, noname);
        execute("/usr/local/bin/dhcp-dns-update.sh", "commit", ClientName, binary-to-ascii(10, 8, ".", leased-address));
    }
}

# Imprimante avec domaine sp√©cifique
host imprimante-etage1 {
    hardware ethernet 00:50:C2:12:34:56;
    fixed-address 192.168.1.80;
    option host-name "imp-etage1";

    # Domaine sp√©cifique aux imprimantes
    ddns-hostname "imp-etage1";
    ddns-domainname "imprimantes.monentreprise.local";
}
```

**Script de mise √† jour DNS pour r√©servations :**

```bash
# Cr√©er le script de mise √† jour
sudo nano /usr/local/bin/dhcp-dns-update.sh
```

```bash
#!/bin/bash
#
# Script de mise √† jour DNS pour r√©servations DHCP
#

ACTION=$1      # commit, expire, release
HOSTNAME=$2    # nom de l'h√¥te
IP_ADDRESS=$3  # adresse IP

LOG_FILE="/var/log/dhcp-dns-update.log"
NSUPDATE_KEY="/etc/dhcp/dhcp-dns.key"
DNS_SERVER="192.168.1.10"

# Fonction de log
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $ACTION: $HOSTNAME ($IP_ADDRESS) - $1" >> $LOG_FILE
}

# V√©rifier les param√®tres
if [ -z "$ACTION" ] || [ -z "$HOSTNAME" ] || [ -z "$IP_ADDRESS" ]; then
    log_message "Param√®tres manquants"
    exit 1
fi

# D√©terminer le domaine selon l'IP
case $IP_ADDRESS in
    192.168.1.*)
        DOMAIN="employes.monentreprise.local"
        ;;
    192.168.2.*)
        DOMAIN="invites.monentreprise.local"
        ;;
    192.168.3.*)
        DOMAIN="wifi.monentreprise.local"
        ;;
    *)
        DOMAIN="monentreprise.local"
        ;;
esac

# Cr√©er le script nsupdate
cat > /tmp/dns-update.nsupdate << EOF
server $DNS_SERVER

# Supprimer d'abord les anciens enregistrements
update delete $HOSTNAME.$DOMAIN A
update delete $(echo $IP_ADDRESS | awk -F. '{print $4"."$3"."$2"."$1}').in-addr.arpa PTR
send

# Ajouter les nouveaux enregistrements
update add $HOSTNAME.$DOMAIN 3600 A $IP_ADDRESS
update add $(echo $IP_ADDRESS | awk -F. '{print $4"."$3"."$2"."$1}').in-addr.arpa 3600 PTR $HOSTNAME.$DOMAIN
send
EOF

# Ex√©cuter la mise √† jour DNS
if nsupdate -k $NSUPDATE_KEY /tmp/dns-update.nsupdate; then
    log_message "DNS mis √† jour avec succ√®s dans $DOMAIN"
else
    log_message "Erreur lors de la mise √† jour DNS"
fi

# Nettoyer le fichier temporaire
rm -f /tmp/dns-update.nsupdate
```

```bash
sudo chmod +x /usr/local/bin/dhcp-dns-update.sh
```

### Test et validation de l'int√©gration

**Red√©marrer les services :**

```bash
# Red√©marrer DHCP
sudo systemctl restart isc-dhcp-server

# V√©rifier le statut
sudo systemctl status isc-dhcp-server

# Red√©marrer DNS si n√©cessaire
sudo systemctl reload bind9
```

**Tester l'int√©gration :**

```bash
# 1. Lib√©rer le bail DHCP sur un client (depuis le client)
sudo dhclient -r

# 2. Demander une nouvelle IP
sudo dhclient

# 3. V√©rifier que le DNS a √©t√© mis √† jour
dig @192.168.1.10 dhcp-192-168-1-150.monentreprise.local

# 4. V√©rifier la r√©solution inverse
dig @192.168.1.10 -x 192.168.1.150
```

**Surveiller les logs :**

```bash
# Logs DHCP
sudo tail -f /var/log/dhcp.log

# Logs DNS
sudo tail -f /var/log/bind/query.log

# Logs de mise √† jour DNS
sudo tail -f /var/log/dhcp-dns-update.log
```

### D√©pannage des probl√®mes d'int√©gration

**Probl√®mes courants et solutions :**

#### 1. DHCP ne met pas √† jour le DNS

```bash
# V√©rifier les permissions de la cl√©
ls -la /etc/dhcp/dhcp-dns.key
# Doit √™tre : -rw-r----- root dhcpd

# V√©rifier que la cl√© est identique
diff /etc/bind/dhcp-dns.key /etc/dhcp/dhcp-dns.key

# Tester manuellement la cl√©
nsupdate -k /etc/dhcp/dhcp-dns.key
> server 192.168.1.10
> update add test.monentreprise.local 300 A 1.2.3.4
> send
> quit

# V√©rifier
dig @192.168.1.10 test.monentreprise.local
```

#### 2. Erreurs de permissions DNS

```bash
# V√©rifier les logs DNS
sudo grep "update failed" /var/log/bind/security.log

# V√©rifier la configuration des zones
sudo named-checkzone monentreprise.local /etc/bind/zones/db.monentreprise.local

# V√©rifier les permissions des fichiers de zones
ls -la /etc/bind/zones/
# Doivent √™tre : -rw-rw---- bind bind
```

#### 3. Conflits de noms

```bash
# Voir les conflits dans les logs DHCP
sudo grep "not authorized" /var/log/dhcp.log

# Nettoyer manuellement les enregistrements DNS
nsupdate -k /etc/dhcp/dhcp-dns.key
> server 192.168.1.10
> update delete nom-en-conflit.monentreprise.local A
> send
```

### Optimisation et maintenance

**Maintenance r√©guli√®re :**

```bash
# Script de maintenance quotidienne
sudo nano /usr/local/bin/dhcp-dns-maintenance.sh
```

```bash
#!/bin/bash
#
# Maintenance DHCP-DNS quotidienne
#

LOG_FILE="/var/log/dhcp-dns-maintenance.log"
DHCP_LEASES="/var/lib/dhcp/dhcpd.leases"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

log_message "=== D√©but maintenance DHCP-DNS ==="

# Statistiques des baux DHCP
ACTIVE_LEASES=$(grep -c "binding state active" $DHCP_LEASES)
EXPIRED_LEASES=$(grep -c "binding state expired" $DHCP_LEASES)
FREE_LEASES=$(grep -c "binding state free" $DHCP_LEASES)

log_message "Baux actifs: $ACTIVE_LEASES"
log_message "Baux expir√©s: $EXPIRED_LEASES"
log_message "Baux libres: $FREE_LEASES"

# V√©rifier la taille des fichiers de log
LOG_SIZE=$(du -m /var/log/dhcp.log | cut -f1)
if [ $LOG_SIZE -gt 50 ]; then
    log_message "Fichier de log DHCP volumineux ($LOG_SIZE MB), rotation n√©cessaire"
    logrotate /etc/logrotate.d/isc-dhcp-server
fi

# V√©rifier l'espace disque
DISK_USAGE=$(df /var | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    log_message "ALERTE: Espace disque faible ($DISK_USAGE%)"
fi

log_message "=== Fin maintenance DHCP-DNS ==="
```

**Ajouter au crontab :**

```bash
sudo chmod +x /usr/local/bin/dhcp-dns-maintenance.sh

# Ex√©cuter tous les jours √† 2h du matin
sudo crontab -e
# Ajouter : 0 2 * * * /usr/local/bin/dhcp-dns-maintenance.sh
```

### Monitoring et alertes

**Script de surveillance de l'int√©gration :**

```bash
sudo nano /usr/local/bin/monitor-dhcp-dns.sh
```

```bash
#!/bin/bash
#
# Monitoring de l'int√©gration DHCP-DNS
#

DNS_SERVER="192.168.1.10"
TEST_HOSTNAME="dhcp-test-$(date +%s)"
TEST_IP="192.168.1.99"
LOG_FILE="/var/log/dhcp-dns-monitor.log"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

# Test d'int√©gration DHCP-DNS
log_message "=== Test int√©gration DHCP-DNS ==="

# Cr√©er un enregistrement de test
nsupdate -k /etc/dhcp/dhcp-dns.key << EOF
server $DNS_SERVER
update add $TEST_HOSTNAME.monentreprise.local 60 A $TEST_IP
send
EOF

# V√©rifier que l'enregistrement existe
sleep 2
if dig @$DNS_SERVER $TEST_HOSTNAME.monentreprise.local +short | grep -q $TEST_IP; then
    log_message "Test DNS OK - Enregistrement cr√©√© et r√©solu"

    # Nettoyer l'enregistrement de test
    nsupdate -k /etc/dhcp/dhcp-dns.key << EOF
server $DNS_SERVER
update delete $TEST_HOSTNAME.monentreprise.local A
send
EOF

else
    log_message "ERREUR - Test DNS √©chou√©"
fi

# V√©rifier que DHCP fonctionne
if systemctl is-active --quiet isc-dhcp-server; then
    log_message "Service DHCP actif"
else
    log_message "ALERTE - Service DHCP arr√™t√©!"
fi

# V√©rifier que BIND fonctionne
if systemctl is-active --quiet bind9; then
    log_message "Service DNS actif"
else
    log_message "ALERTE - Service DNS arr√™t√©!"
fi

log_message "=== Fin test int√©gration ==="
```

**Ex√©cuter le monitoring toutes les 15 minutes :**

```bash
sudo chmod +x /usr/local/bin/monitor-dhcp-dns.sh

# Ajouter au crontab
sudo crontab -e
# Ajouter : */15 * * * * /usr/local/bin/monitor-dhcp-dns.sh
```

---

## R√©sum√© du chapitre DHCP

Dans cette section, nous avons couvert :

‚úÖ **Installation et configuration d'ISC DHCP Server** avec options de base
‚úÖ **Configuration des plages multiples** et du failover haute disponibilit√©
‚úÖ **R√©servations statiques** pour serveurs, imprimantes et √©quipements
‚úÖ **Int√©gration compl√®te DHCP-DNS** avec mise √† jour automatique
‚úÖ **Scripts de maintenance** et de surveillance automatis√©e
‚úÖ **D√©pannage** des probl√®mes courants d'int√©gration

**Points cl√©s √† retenir :**

- **DHCP simplifie √©norm√©ment** la gestion d'un parc informatique
- **Le failover** est essentiel en environnement professionnel
- **L'int√©gration DNS** maintient automatiquement la coh√©rence
- **Les r√©servations statiques** combinent flexibilit√© et pr√©visibilit√©
- **La surveillance** permet de d√©tecter les probl√®mes rapidement
- **Une bonne documentation** facilite la maintenance

Le serveur DHCP est maintenant configur√© et int√©gr√© avec DNS. Dans la section suivante, nous allons voir comment configurer un serveur mail complet avec Postfix et Dovecot !

**Conseil pratique :**
Testez toujours vos configurations sur un r√©seau de test avant de les d√©ployer en production. L'int√©gration DHCP-DNS peut sembler complexe, mais elle apporte une valeur √©norme en automatisant la gestion du r√©seau.

‚è≠Ô∏è
