üîù Retour au [Sommaire](/SOMMAIRE.md)

# 7.1 Serveur DNS

Le DNS (Domain Name System) est l'un des services les plus critiques d'un r√©seau. Il traduit les noms de domaine lisibles par l'homme (comme `www.exemple.com`) en adresses IP compr√©hensibles par les machines (comme `192.168.1.100`). Sans DNS, il faudrait m√©moriser les adresses IP de tous les sites web !

## Pourquoi DNS est-il si important ?

Imaginez si vous deviez retenir l'adresse de chaque ami au lieu de son nom. C'est exactement ce que fait le DNS pour Internet : il associe des noms faciles √† retenir aux adresses num√©riques r√©elles des serveurs.

**Exemple concret :**
- Vous tapez `www.google.com` dans votre navigateur
- Votre ordinateur demande au serveur DNS : "Quelle est l'adresse IP de google.com ?"
- Le serveur DNS r√©pond : "C'est 142.250.191.14"
- Votre navigateur se connecte alors √† cette adresse IP

---

## 7.1.1 BIND9 configuration avanc√©e

### Qu'est-ce que BIND9 ?

BIND9 (Berkeley Internet Name Domain version 9) est le serveur DNS le plus utilis√© au monde. Il existe depuis des d√©cennies et est extr√™mement stable et fiable.

**Pourquoi choisir BIND9 ?**
- Gratuit et open source
- Tr√®s stable et s√©curis√©
- Supporte toutes les fonctionnalit√©s DNS modernes
- Excellente documentation
- Utilis√© par la majorit√© des fournisseurs Internet

### Installation de BIND9

Sur Debian, l'installation est simple :

```bash
# Mettre √† jour la liste des paquets
sudo apt update

# Installer BIND9 et ses outils
sudo apt install bind9 bind9utils bind9-doc

# D√©marrer et activer le service
sudo systemctl start bind9
sudo systemctl enable bind9
```

### Structure des fichiers de configuration

BIND9 utilise plusieurs fichiers de configuration importants :

```
/etc/bind/
‚îú‚îÄ‚îÄ named.conf           # Configuration principale (point d'entr√©e)
‚îú‚îÄ‚îÄ named.conf.local     # Configuration locale (vos zones)
‚îú‚îÄ‚îÄ named.conf.options   # Options globales
‚îú‚îÄ‚îÄ named.conf.default-zones  # Zones par d√©faut
‚îî‚îÄ‚îÄ zones/               # Dossier pour vos fichiers de zones
    ‚îú‚îÄ‚îÄ db.exemple.com   # Zone directe
    ‚îî‚îÄ‚îÄ db.192.168.1     # Zone inverse
```

**Analogie simple :**
Pensez √† ces fichiers comme √† un carnet d'adresses :
- `named.conf` = la couverture qui renvoie aux autres sections
- `named.conf.options` = les param√®tres g√©n√©raux (police, format)
- `named.conf.local` = vos contacts personnels
- Les fichiers de zones = les pages d√©taill√©es de chaque contact

### Configuration de base dans named.conf.options

```bash
# √âditer le fichier des options
sudo nano /etc/bind/named.conf.options
```

Contenu recommand√© pour d√©buter :

```
options {
    // R√©pertoire de travail de BIND
    directory "/var/cache/bind";

    // Serveurs DNS vers lesquels rediriger les requ√™tes
    // que nous ne savons pas r√©soudre
    forwarders {
        8.8.8.8;        // DNS de Google
        8.8.4.4;        // DNS de Google (secondaire)
        1.1.1.1;        // DNS de Cloudflare
    };

    // Autoriser la r√©cursion (r√©solution pour les clients)
    recursion yes;

    // Qui peut faire des requ√™tes r√©cursives
    allow-recursion {
        127.0.0.1;      // localhost
        192.168.1.0/24; // r√©seau local (√† adapter)
    };

    // Sur quelle interface √©couter
    listen-on {
        127.0.0.1;      // localhost
        192.168.1.10;   // IP du serveur (√† adapter)
    };

    // √âcouter aussi en IPv6
    listen-on-v6 { any; };

    // Version BIND √† cacher (s√©curit√©)
    version none;

    // D√©sactiver les statistiques de requ√™tes
    query-source address * port 53;
};
```

**Explication simple des options importantes :**

- **forwarders** : Si votre serveur ne conna√Æt pas une adresse (comme facebook.com), il demande √† ces serveurs DNS publics
- **recursion** : Permet √† votre serveur de faire le travail de recherche pour les clients
- **allow-recursion** : D√©finit qui peut utiliser votre serveur pour r√©soudre des noms
- **listen-on** : Sur quelles adresses IP votre serveur √©coute les demandes

### Configuration des logs

Pour diagnostiquer les probl√®mes, il est important de configurer les logs :

```bash
# Ajouter dans named.conf.options, apr√®s le bloc options
logging {
    channel default_debug {
        file "data/named.run";
        severity dynamic;
    };

    channel query_log {
        file "/var/log/bind/query.log" versions 3 size 5m;
        severity info;
        print-time yes;
        print-severity yes;
        print-category yes;
    };

    category queries { query_log; };
    category default { default_debug; };
};
```

Cr√©er le r√©pertoire de logs :

```bash
sudo mkdir -p /var/log/bind
sudo chown bind:bind /var/log/bind
```

---

## 7.1.2 Zones et enregistrements

### Comprendre les zones DNS

Une **zone DNS** est comme un annuaire t√©l√©phonique pour un quartier sp√©cifique. Chaque zone contient les informations de correspondance nom ‚Üî adresse IP pour un domaine particulier.

**Types de zones :**

1. **Zone directe** : Nom ‚Üí Adresse IP
   - `www.exemple.com` ‚Üí `192.168.1.100`

2. **Zone inverse** : Adresse IP ‚Üí Nom
   - `192.168.1.100` ‚Üí `www.exemple.com`

### Cr√©ation d'une zone directe

Supposons que vous voulez cr√©er la zone pour le domaine `monentreprise.local`.

#### √âtape 1 : D√©clarer la zone

√âditer `/etc/bind/named.conf.local` :

```bash
sudo nano /etc/bind/named.conf.local
```

Ajouter :

```
// Zone directe pour monentreprise.local
zone "monentreprise.local" {
    type master;                    // Serveur principal pour cette zone
    file "/etc/bind/zones/db.monentreprise.local";  // Fichier de la zone
    allow-update { none; };         // Pas de mise √† jour dynamique pour l'instant
};
```

#### √âtape 2 : Cr√©er le fichier de zone

```bash
# Cr√©er le r√©pertoire
sudo mkdir -p /etc/bind/zones

# Cr√©er le fichier de zone
sudo nano /etc/bind/zones/db.monentreprise.local
```

Contenu du fichier de zone :

```
;
; Fichier de zone pour monentreprise.local
;
$TTL    86400    ; Dur√©e de vie par d√©faut (24 heures)

; Enregistrement SOA (Start of Authority)
@   IN  SOA ns1.monentreprise.local. admin.monentreprise.local. (
    2024080701  ; Serial (YYYYMMDDNN)
    3600        ; Refresh (1 heure)
    1800        ; Retry (30 minutes)
    1209600     ; Expire (2 semaines)
    86400       ; Negative Cache TTL (24 heures)
)

; Serveurs de noms
@               IN  NS      ns1.monentreprise.local.
@               IN  NS      ns2.monentreprise.local.

; Adresses des serveurs de noms
ns1             IN  A       192.168.1.10
ns2             IN  A       192.168.1.11

; Serveurs
@               IN  A       192.168.1.10    ; Le domaine lui-m√™me
www             IN  A       192.168.1.100   ; Serveur web
mail            IN  A       192.168.1.101   ; Serveur mail
ftp             IN  A       192.168.1.102   ; Serveur FTP

; Alias (CNAME)
web             IN  CNAME   www.monentreprise.local.
intranet        IN  CNAME   www.monentreprise.local.

; Enregistrement MX pour le mail
@               IN  MX  10  mail.monentreprise.local.
```

**Explication des enregistrements :**

- **SOA** : Informations sur la zone (qui en est responsable, fr√©quence de mise √† jour, etc.)
- **NS** : Serveurs de noms autoritaires pour cette zone
- **A** : Association nom ‚Üí adresse IPv4
- **CNAME** : Alias (nom alternatif pointant vers un autre nom)
- **MX** : Serveur de mail (le chiffre 10 est la priorit√©)

#### Comprendre le format des enregistrements

```
nom     TTL  IN  TYPE    valeur
www     3600 IN  A       192.168.1.100
```

- **nom** : Le nom √† r√©soudre (www)
- **TTL** : Dur√©e de cache (3600 secondes = 1 heure)
- **IN** : Classe Internet (toujours IN)
- **TYPE** : Type d'enregistrement (A, CNAME, MX, etc.)
- **valeur** : La r√©ponse √† donner

### Cr√©ation d'une zone inverse

La zone inverse permet de trouver le nom √† partir de l'adresse IP.

Ajouter dans `/etc/bind/named.conf.local` :

```
// Zone inverse pour 192.168.1.0/24
zone "1.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.1";
    allow-update { none; };
};
```

Cr√©er le fichier `/etc/bind/zones/db.192.168.1` :

```
;
; Zone inverse pour 192.168.1.0/24
;
$TTL    86400

@   IN  SOA ns1.monentreprise.local. admin.monentreprise.local. (
    2024080701  ; Serial
    3600        ; Refresh
    1800        ; Retry
    1209600     ; Expire
    86400       ; Negative Cache TTL
)

; Serveurs de noms
@               IN  NS      ns1.monentreprise.local.
@               IN  NS      ns2.monentreprise.local.

; R√©solution inverse
10              IN  PTR     ns1.monentreprise.local.
11              IN  PTR     ns2.monentreprise.local.
100             IN  PTR     www.monentreprise.local.
101             IN  PTR     mail.monentreprise.local.
102             IN  PTR     ftp.monentreprise.local.
```

**Note importante :** Dans une zone inverse, on √©crit seulement le dernier octet de l'IP (10 pour 192.168.1.10).

### V√©rification de la configuration

Avant de red√©marrer BIND, v√©rifiez vos configurations :

```bash
# V√©rifier la syntaxe g√©n√©rale
sudo named-checkconf

# V√©rifier une zone sp√©cifique
sudo named-checkzone monentreprise.local /etc/bind/zones/db.monentreprise.local
sudo named-checkzone 1.168.192.in-addr.arpa /etc/bind/zones/db.192.168.1

# Recharger la configuration
sudo systemctl reload bind9

# V√©rifier le statut
sudo systemctl status bind9
```

### Types d'enregistrements DNS courants

| Type | Usage | Exemple |
|------|-------|---------|
| **A** | Nom vers IPv4 | `www IN A 192.168.1.100` |
| **AAAA** | Nom vers IPv6 | `www IN AAAA 2001:db8::1` |
| **CNAME** | Alias | `ftp IN CNAME www.exemple.com.` |
| **MX** | Serveur mail | `@ IN MX 10 mail.exemple.com.` |
| **TXT** | Texte libre | `@ IN TXT "v=spf1 mx -all"` |
| **PTR** | IP vers nom (inverse) | `100 IN PTR www.exemple.com.` |
| **SRV** | Services | `_http._tcp IN SRV 10 5 80 www` |

---

## 7.1.3 DNS dynamique et DNSSEC

### DNS Dynamique (DDNS)

Le DNS dynamique permet aux enregistrements DNS d'√™tre mis √† jour automatiquement. C'est tr√®s utile quand des machines obtiennent leurs adresses IP via DHCP.

**Cas d'usage courants :**
- Ordinateurs portables qui changent d'IP
- Serveurs virtualis√©s avec IP variables
- Int√©gration DHCP-DNS automatique

#### Configuration du DNS dynamique

Cr√©er une cl√© de mise √† jour s√©curis√©e :

```bash
# G√©n√©rer une cl√© TSIG (Transaction Signature)
sudo tsig-keygen -a HMAC-SHA256 ddns-key > /etc/bind/ddns.key

# S√©curiser le fichier
sudo chown root:bind /etc/bind/ddns.key
sudo chmod 640 /etc/bind/ddns.key
```

Inclure la cl√© dans la configuration principale :

```bash
# √âditer named.conf
sudo nano /etc/bind/named.conf
```

Ajouter au d√©but :

```
include "/etc/bind/ddns.key";
```

Modifier la zone pour autoriser les mises √† jour :

```bash
# Dans named.conf.local
zone "monentreprise.local" {
    type master;
    file "/etc/bind/zones/db.monentreprise.local";
    allow-update { key "ddns-key"; };  // Autoriser avec la cl√©
    notify yes;                         // Notifier les serveurs esclaves
};
```

#### Tester le DNS dynamique

```bash
# Installer les outils de test
sudo apt install dnsutils

# Tester une mise √† jour dynamique
nsupdate -k /etc/bind/ddns.key
> server 192.168.1.10
> zone monentreprise.local
> update add test.monentreprise.local 300 A 192.168.1.50
> send
> quit

# V√©rifier que l'enregistrement existe
dig @192.168.1.10 test.monentreprise.local
```

### DNSSEC (DNS Security Extensions)

DNSSEC ajoute une couche de s√©curit√© cryptographique au DNS pour garantir l'authenticit√© et l'int√©grit√© des r√©ponses.

**Pourquoi DNSSEC ?**
- Emp√™che l'empoisonnement du cache DNS
- Garantit que les r√©ponses viennent vraiment du serveur l√©gitime
- Prot√®ge contre les attaques de type "man-in-the-middle"

**Analogie simple :** DNSSEC, c'est comme mettre un sceau officiel sur chaque r√©ponse DNS pour prouver qu'elle n'a pas √©t√© falsifi√©e.

#### Activation de DNSSEC

**√âtape 1 : G√©n√©rer les cl√©s de zone**

```bash
# Aller dans le r√©pertoire des zones
cd /etc/bind/zones

# G√©n√©rer la cl√© KSK (Key Signing Key)
sudo dnssec-keygen -a RSASHA256 -b 2048 -f KSK monentreprise.local

# G√©n√©rer la cl√© ZSK (Zone Signing Key)
sudo dnssec-keygen -a RSASHA256 -b 1024 monentreprise.local

# Lister les cl√©s g√©n√©r√©es
ls -la K*
```

**√âtape 2 : Inclure les cl√©s dans la zone**

```bash
# Ajouter les cl√©s √† la fin du fichier de zone
sudo nano /etc/bind/zones/db.monentreprise.local
```

Ajouter √† la fin :

```
; Cl√©s DNSSEC
$INCLUDE Kmonentreprise.local.+008+xxxxx.key  ; KSK
$INCLUDE Kmonentreprise.local.+008+yyyyy.key  ; ZSK
```

**√âtape 3 : Signer la zone**

```bash
# Signer la zone
sudo dnssec-signzone -o monentreprise.local -k Kmonentreprise.local.+008+xxxxx db.monentreprise.local

# Cela g√©n√®re un fichier .signed
```

**√âtape 4 : Modifier la configuration**

```bash
# Modifier named.conf.local pour utiliser la zone sign√©e
zone "monentreprise.local" {
    type master;
    file "/etc/bind/zones/db.monentreprise.local.signed";  // Fichier sign√©
    allow-update { key "ddns-key"; };
    auto-dnssec maintain;  // Maintenance automatique des signatures
};
```

**√âtape 5 : Red√©marrer et v√©rifier**

```bash
# Recharger BIND
sudo systemctl reload bind9

# V√©rifier DNSSEC
dig @192.168.1.10 monentreprise.local DNSKEY +dnssec
```

#### Validation DNSSEC c√¥t√© client

Pour que les clients v√©rifient DNSSEC, modifier `/etc/bind/named.conf.options` :

```
options {
    // ... autres options ...

    // Activer la validation DNSSEC
    dnssec-enable yes;
    dnssec-validation auto;

    // Cl√©s de confiance (trust anchors)
    trusted-keys-file "/etc/bind/managed-keys.bind";
};
```

---

## 7.1.4 S√©curit√© DNS

La s√©curit√© du DNS est cruciale car une compromission peut rediriger tout le trafic de vos utilisateurs vers des serveurs malveillants.

### Principes de base de la s√©curit√© DNS

#### 1. Limitation d'acc√®s

```bash
# Dans named.conf.options
options {
    // Limiter qui peut faire des requ√™tes
    allow-query {
        127.0.0.1;
        192.168.1.0/24;  // Votre r√©seau local seulement
    };

    // Limiter qui peut faire de la r√©cursion
    allow-recursion {
        127.0.0.1;
        192.168.1.0/24;
    };

    // Interdire les transferts de zone par d√©faut
    allow-transfer { none; };

    // Interdire les requ√™tes de version
    version none;
    hostname none;
};
```

#### 2. Protection contre l'empoisonnement de cache

```bash
options {
    // Randomisation des ports sources
    query-source address * port 53;

    // Utiliser des identifiants de requ√™te al√©atoires
    query-source-v6 address * port 53;

    // Taille minimale des r√©ponses UDP
    minimal-responses yes;
};
```

#### 3. Limitation des requ√™tes (Rate Limiting)

```bash
options {
    // Limiter le nombre de requ√™tes par seconde
    rate-limit {
        responses-per-second 10;
        window 5;

        // Actions en cas de d√©passement
        log-only no;
        qps-scale 250;
    };
};
```

### Configuration de listes de contr√¥le d'acc√®s (ACL)

Les ACL permettent de d√©finir des groupes d'adresses IP r√©utilisables :

```bash
# Dans named.conf.options (avant le bloc options)
acl "reseau-interne" {
    127.0.0.1;
    192.168.1.0/24;
    192.168.2.0/24;
};

acl "serveurs-dns" {
    192.168.1.10;  // DNS primaire
    192.168.1.11;  // DNS secondaire
};

options {
    allow-query { reseau-interne; };
    allow-recursion { reseau-interne; };
    allow-transfer { serveurs-dns; };
};
```

### Surveillance et logging de s√©curit√©

#### Configuration des logs de s√©curit√©

```bash
# Dans named.conf.options
logging {
    channel security_log {
        file "/var/log/bind/security.log" versions 3 size 10m;
        severity info;
        print-time yes;
        print-severity yes;
        print-category yes;
    };

    channel query_log {
        file "/var/log/bind/queries.log" versions 5 size 20m;
        severity info;
        print-time yes;
    };

    // Cat√©gories √† surveiller
    category security { security_log; };
    category queries { query_log; };
    category lame-servers { security_log; };
    category config { security_log; };
};
```

#### Cr√©er les r√©pertoires et permissions

```bash
sudo mkdir -p /var/log/bind
sudo chown bind:bind /var/log/bind
sudo chmod 755 /var/log/bind
```

### Rotation des logs

```bash
# Cr√©er la configuration de rotation
sudo nano /etc/logrotate.d/bind
```

Contenu :

```
/var/log/bind/*.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    postrotate
        /usr/sbin/rndc reload > /dev/null 2>&1 || true
    endscript
}
```

### Monitoring et alertes

#### Script de surveillance basique

```bash
# Cr√©er un script de v√©rification
sudo nano /usr/local/bin/check-dns.sh
```

Contenu :

```bash
#!/bin/bash
# Script de v√©rification DNS

LOG_FILE="/var/log/dns-check.log"
DNS_SERVER="127.0.0.1"
TEST_DOMAIN="monentreprise.local"

# Fonction de log
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

# Test de r√©solution
if dig @$DNS_SERVER $TEST_DOMAIN +short > /dev/null 2>&1; then
    log_message "DNS OK - $TEST_DOMAIN resolved successfully"
else
    log_message "DNS ERROR - Failed to resolve $TEST_DOMAIN"
    # Ici, vous pourriez envoyer une alerte (mail, webhook, etc.)
fi

# V√©rifier si BIND fonctionne
if systemctl is-active --quiet bind9; then
    log_message "BIND9 service OK"
else
    log_message "BIND9 service ERROR - Service not running"
fi
```

Rendre le script ex√©cutable et l'ajouter au cron :

```bash
sudo chmod +x /usr/local/bin/check-dns.sh

# Ajouter au crontab (v√©rification toutes les 5 minutes)
sudo crontab -e
# Ajouter la ligne :
# */5 * * * * /usr/local/bin/check-dns.sh
```

### S√©curisation du syst√®me

#### Mise √† jour automatique de BIND

```bash
# Configurer les mises √† jour automatiques de s√©curit√©
sudo nano /etc/apt/apt.conf.d/20auto-upgrades
```

Contenu :

```
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
```

#### Pare-feu pour DNS

```bash
# R√®gles UFW pour DNS
sudo ufw allow from 192.168.1.0/24 to any port 53
sudo ufw allow from 192.168.1.0/24 to any port 953  # RNDC
sudo ufw deny 53
sudo ufw deny 953
```

### Sauvegarde et r√©cup√©ration

#### Script de sauvegarde

```bash
# Cr√©er un script de sauvegarde
sudo nano /usr/local/bin/backup-dns.sh
```

Contenu :

```bash
#!/bin/bash
BACKUP_DIR="/backup/dns"
DATE=$(date +%Y%m%d_%H%M%S)

# Cr√©er le r√©pertoire de sauvegarde
mkdir -p $BACKUP_DIR

# Sauvegarder la configuration
tar -czf $BACKUP_DIR/bind-config-$DATE.tar.gz /etc/bind/

# Sauvegarder les zones
tar -czf $BACKUP_DIR/bind-zones-$DATE.tar.gz /etc/bind/zones/

# Nettoyer les anciennes sauvegardes (garder 30 jours)
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Sauvegarde DNS termin√©e : $DATE"
```

### Bonnes pratiques de s√©curit√© DNS

1. **Principe de moindre privil√®ge** : N'accordez que les permissions strictement n√©cessaires

2. **S√©paration des r√¥les** :
   - Serveurs DNS internes pour les requ√™tes locales
   - Serveurs DNS publics pour les zones publiques

3. **Monitoring continu** :
   - Surveillez les logs r√©guli√®rement
   - Alertes en cas d'anomalies

4. **Mises √† jour r√©guli√®res** :
   - BIND et le syst√®me d'exploitation
   - Signatures DNSSEC

5. **Tests r√©guliers** :
   - V√©rifiez que vos configurations fonctionnent
   - Testez vos proc√©dures de sauvegarde

6. **Documentation** :
   - Documentez toutes vos configurations
   - Proc√©dures de r√©cup√©ration d'urgence

---

## R√©sum√© du chapitre DNS

Dans cette section, nous avons couvert :

‚úÖ **Installation et configuration de BIND9** avec les options de base
‚úÖ **Cr√©ation de zones DNS** directes et inverses
‚úÖ **Gestion des enregistrements** (A, CNAME, MX, PTR, etc.)
‚úÖ **DNS dynamique** pour les mises √† jour automatiques
‚úÖ **DNSSEC** pour s√©curiser les r√©ponses DNS
‚úÖ **S√©curisation compl√®te** du serveur DNS
‚úÖ **Monitoring et maintenance** pour une exploitation fiable

Le DNS est maintenant configur√© et s√©curis√©. Dans la section suivante, nous allons voir comment int√©grer un serveur DHCP qui pourra automatiquement mettre √† jour vos enregistrements DNS !

**Points cl√©s √† retenir :**
- Le DNS est un service critique qui n√©cessite une attention particuli√®re √† la s√©curit√©
- DNSSEC n'est pas optionnel dans un environnement professionnel
- La surveillance et les sauvegardes sont essentielles
- Les permissions doivent √™tre restrictives par d√©faut

‚è≠Ô∏è
