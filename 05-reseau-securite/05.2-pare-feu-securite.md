üîù Retour au [Sommaire](/SOMMAIRE.md)

# 5.2 Pare-feu et s√©curit√©
*Module 5 : R√©seau et s√©curit√© - Formation Debian Desktop et Server*

## Introduction aux pare-feu et √† la s√©curit√© r√©seau

La s√©curit√© r√©seau est l'un des aspects les plus critiques de l'administration syst√®me moderne. Un pare-feu constitue votre premi√®re ligne de d√©fense contre les menaces externes et permet de contr√¥ler finement les communications r√©seau de vos syst√®mes.

### Pourquoi un pare-feu est-il indispensable ?

Dans un monde connect√© o√π les cyberattaques sont quotidiennes, un pare-feu vous permet de :

- **Filtrer le trafic** entrant et sortant selon des r√®gles pr√©cises
- **Bloquer les acc√®s non autoris√©s** √† vos services
- **Limiter l'exposition** de vos applications aux menaces
- **Contr√¥ler les communications** entre diff√©rentes zones de votre r√©seau
- **D√©tecter et pr√©venir** certains types d'attaques

### Types de pare-feu

**Pare-feu r√©seau (Network Firewall) :**
- Prot√®ge un r√©seau entier
- G√©n√©ralement sur un √©quipement d√©di√©
- Contr√¥le le trafic entre r√©seaux

**Pare-feu h√¥te (Host Firewall) :**
- Prot√®ge une machine sp√©cifique
- Int√©gr√© au syst√®me d'exploitation
- Focus de cette section

### Concepts fondamentaux

**Politique par d√©faut :**
- **DENY (Interdire)** : Tout est bloqu√© sauf ce qui est explicitement autoris√© (recommand√©)
- **ALLOW (Autoriser)** : Tout est autoris√© sauf ce qui est explicitement bloqu√©

**Direction du trafic :**
- **INPUT** : Trafic entrant vers la machine
- **OUTPUT** : Trafic sortant de la machine
- **FORWARD** : Trafic transitant par la machine (routage)

**Actions possibles :**
- **ACCEPT** : Autoriser le paquet
- **DROP** : Ignorer silencieusement le paquet
- **REJECT** : Refuser et notifier l'exp√©diteur

---

## 5.2.1 iptables et nftables

### iptables : Le pare-feu traditionnel de Linux

**iptables** est le syst√®me de pare-feu standard de Linux depuis de nombreuses ann√©es. Il fonctionne au niveau du noyau Linux et offre un contr√¥le tr√®s fin du trafic r√©seau.

#### Architecture d'iptables

**Tables principales :**
- **filter** : Filtrage des paquets (table par d√©faut)
- **nat** : Translation d'adresses (NAT)
- **mangle** : Modification des paquets
- **raw** : Configuration avant le suivi de connexion

**Cha√Ænes principales (table filter) :**
- **INPUT** : Paquets destin√©s √† la machine locale
- **OUTPUT** : Paquets g√©n√©r√©s par la machine locale
- **FORWARD** : Paquets rout√©s √† travers la machine

#### Installation et v√©rification

```bash
# V√©rifier si iptables est install√©
which iptables

# Installation si n√©cessaire
sudo apt update
sudo apt install iptables

# Version install√©e
iptables --version

# Voir les r√®gles actuelles
sudo iptables -L -v -n
```

#### Commandes de base iptables

**Syntaxe g√©n√©rale :**
```bash
iptables [-t table] -[operation] [cha√Æne] [crit√®res] -j [action]
```

**Op√©rations principales :**
- `-A` : Ajouter une r√®gle √† la fin
- `-I` : Ins√©rer une r√®gle √† une position
- `-D` : Supprimer une r√®gle
- `-L` : Lister les r√®gles
- `-F` : Vider toutes les r√®gles

#### Exemples de r√®gles iptables de base

**Voir la configuration actuelle :**
```bash
# Liste simple
sudo iptables -L

# Liste d√©taill√©e avec compteurs
sudo iptables -L -v -n

# Liste avec num√©ros de ligne
sudo iptables -L --line-numbers
```

**R√®gles d'autorisation simples :**
```bash
# Autoriser tout le trafic loopback
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT

# Autoriser les connexions SSH (port 22)
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Autoriser HTTP (port 80) et HTTPS (port 443)
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# Autoriser les connexions √©tablies et li√©es
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```

**D√©finir les politiques par d√©faut :**
```bash
# Politique restrictive (recommand√©e pour INPUT)
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP

# Politique permissive pour OUTPUT (ajuster selon les besoins)
sudo iptables -P OUTPUT ACCEPT
```

#### Configuration compl√®te d'iptables

**Script de configuration type :**
```bash
#!/bin/bash
# Configuration basique d'iptables

# Vider toutes les r√®gles existantes
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X

# Politiques par d√©faut
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Loopback (toujours autoriser)
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Connexions √©tablies et li√©es
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSH (adapter le port si n√©cessaire)
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# HTTP/HTTPS pour un serveur web
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# DNS (si serveur DNS)
iptables -A INPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p tcp --dport 53 -j ACCEPT

# Ping (ICMP) - limit√© pour √©viter les attaques
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT

# Logging des paquets rejet√©s (optionnel)
iptables -A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables-denied: "

# Sauvegarder les r√®gles
iptables-save > /etc/iptables/rules.v4
```

#### Gestion avanc√©e avec iptables

**Crit√®res de filtrage avanc√©s :**
```bash
# Filtrage par adresse source
sudo iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT

# Filtrage par interface
sudo iptables -A INPUT -i eth0 -p tcp --dport 80 -j ACCEPT

# Limitation de taux (rate limiting)
sudo iptables -A INPUT -p tcp --dport 22 -m limit --limit 3/min -j ACCEPT

# Filtrage par heure
sudo iptables -A INPUT -p tcp --dport 80 -m time --timestart 08:00 --timestop 18:00 -j ACCEPT

# Correspondance de cha√Ænes (string matching)
sudo iptables -A INPUT -p tcp --dport 80 -m string --string "attack" --algo bm -j DROP
```

#### Sauvegarde et restauration

```bash
# Sauvegarder les r√®gles
sudo iptables-save > /etc/iptables/rules.v4
sudo ip6tables-save > /etc/iptables/rules.v6

# Restaurer les r√®gles
sudo iptables-restore < /etc/iptables/rules.v4
sudo ip6tables-restore < /etc/iptables/rules.v6

# Installation du package pour la persistance
sudo apt install iptables-persistent

# Sauvegarder via le service
sudo netfilter-persistent save
sudo netfilter-persistent reload
```

### nftables : Le successeur moderne d'iptables

**nftables** est le successeur d'iptables, con√ßu pour √™tre plus simple, plus coh√©rent et plus performant.

#### Avantages de nftables

- **Syntaxe unifi√©e** : IPv4, IPv6, ARP, et bridge dans un seul outil
- **Performance am√©lior√©e** : Moins d'appels syst√®me
- **Configuration plus simple** : Syntaxe plus intuitive
- **Atomicit√©** : Changements appliqu√©s de mani√®re atomique
- **Meilleure int√©gration** : Avec les conteneurs et la virtualisation

#### Installation et activation

```bash
# Installation
sudo apt update
sudo apt install nftables

# Activer le service
sudo systemctl enable nftables
sudo systemctl start nftables

# V√©rifier le statut
sudo systemctl status nftables
```

#### Concepts de base nftables

**Hi√©rarchie nftables :**
```
Tables ‚Üí Cha√Ænes ‚Üí R√®gles
```

**Types de tables :**
- **ip** : IPv4
- **ip6** : IPv6
- **inet** : IPv4 et IPv6 (dual-stack)
- **arp** : ARP
- **bridge** : Bridge/switching

#### Commandes de base nftables

**Syntaxe g√©n√©rale :**
```bash
nft [add|delete|list|flush] [table|chain|rule] [sp√©cifications]
```

**Gestion des tables :**
```bash
# Lister toutes les tables
sudo nft list tables

# Cr√©er une table
sudo nft add table inet filter

# Supprimer une table
sudo nft delete table inet filter

# Vider une table
sudo nft flush table inet filter
```

#### Configuration de base avec nftables

**Cr√©ation d'une configuration compl√®te :**
```bash
#!/usr/sbin/nft -f
# Configuration nftables de base

# Vider toute la configuration
flush ruleset

# Table principale pour IPv4 et IPv6
table inet filter {
    # Cha√Æne pour le trafic entrant
    chain input {
        type filter hook input priority 0; policy drop;

        # Loopback
        iif lo accept

        # Connexions √©tablies et li√©es
        ct state established,related accept

        # SSH
        tcp dport ssh accept

        # HTTP/HTTPS
        tcp dport { http, https } accept

        # ICMP (ping)
        icmp type echo-request limit rate 1/second accept
        icmpv6 type { echo-request, nd-neighbor-solicit, nd-neighbor-advert, nd-router-solicit, nd-router-advert } accept

        # Logging des paquets rejet√©s
        limit rate 5/minute log prefix "nftables-dropped: "
    }

    # Cha√Æne pour le trafic sortant
    chain output {
        type filter hook output priority 0; policy accept;
    }

    # Cha√Æne pour le forwarding
    chain forward {
        type filter hook forward priority 0; policy drop;
    }
}
```

#### Gestion des r√®gles nftables

**Ajouter des r√®gles :**
```bash
# R√®gle simple
sudo nft add rule inet filter input tcp dport 80 accept

# R√®gle avec crit√®res multiples
sudo nft add rule inet filter input ip saddr 192.168.1.0/24 tcp dport 22 accept

# R√®gle avec limitation de d√©bit
sudo nft add rule inet filter input tcp dport 22 limit rate 3/minute accept
```

**Lister et g√©rer :**
```bash
# Lister toutes les r√®gles
sudo nft list ruleset

# Lister une table sp√©cifique
sudo nft list table inet filter

# Lister avec handles (pour suppression)
sudo nft -a list table inet filter

# Supprimer une r√®gle par handle
sudo nft delete rule inet filter input handle 5
```

#### Sauvegarde et restauration nftables

```bash
# Sauvegarder la configuration
sudo nft list ruleset > /etc/nftables.conf

# Restaurer la configuration
sudo nft -f /etc/nftables.conf

# Configuration au d√©marrage
sudo systemctl enable nftables
```

#### Comparaison iptables vs nftables

| Aspect | iptables | nftables |
|--------|----------|----------|
| **Syntaxe** | Complexe, r√©p√©titive | Simple, coh√©rente |
| **Performance** | Bonne | Meilleure |
| **IPv6** | ip6tables s√©par√© | Int√©gr√© (inet) |
| **Atomicit√©** | Non | Oui |
| **Maintenance** | En maintenance | D√©veloppement actif |
| **Compatibilit√©** | Universel | Plus r√©cent |

---

## 5.2.2 ufw (Uncomplicated Firewall)

### Introduction √† ufw

**ufw** (Uncomplicated Firewall) est une interface simplifi√©e pour iptables, con√ßue pour rendre la configuration de pare-feu accessible aux utilisateurs moins exp√©riment√©s.

#### Avantages d'ufw

- **Simplicit√©** : Syntaxe intuitive et commands simples
- **S√©curit√© par d√©faut** : Configuration s√©curis√©e d√®s l'installation
- **Logging int√©gr√©** : Journalisation facile √† configurer
- **Profils d'applications** : R√®gles pr√©configur√©es pour les services courants
- **IPv6** : Support automatique d'IPv4 et IPv6

#### Installation et activation

```bash
# Installation (g√©n√©ralement d√©j√† pr√©sent sur Ubuntu/Debian)
sudo apt update
sudo apt install ufw

# V√©rifier le statut
sudo ufw status

# Activer ufw
sudo ufw enable

# D√©sactiver ufw
sudo ufw disable

# Statut d√©taill√©
sudo ufw status verbose
```

### Configuration de base avec ufw

#### Politiques par d√©faut

```bash
# D√©finir les politiques par d√©faut (recommand√©)
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw default deny forward

# V√©rifier la configuration
sudo ufw status verbose
```

#### R√®gles de base

**Autorisations simples :**
```bash
# SSH (important : √† faire avant d'activer ufw !)
sudo ufw allow ssh
# ou
sudo ufw allow 22

# HTTP et HTTPS
sudo ufw allow http
sudo ufw allow https
# ou
sudo ufw allow 80
sudo ufw allow 443

# Plage de ports
sudo ufw allow 6000:6007/tcp

# Port sp√©cifique avec protocole
sudo ufw allow 53/udp
```

**Autorisations par adresse IP :**
```bash
# Autoriser une IP sp√©cifique
sudo ufw allow from 192.168.1.100

# Autoriser un sous-r√©seau
sudo ufw allow from 192.168.1.0/24

# Autoriser une IP vers un port sp√©cifique
sudo ufw allow from 192.168.1.100 to any port 22

# Autoriser vers une interface sp√©cifique
sudo ufw allow in on eth0 from 192.168.1.0/24
```

#### R√®gles de refus

```bash
# Bloquer un port
sudo ufw deny 23

# Bloquer une IP
sudo ufw deny from 10.0.0.5

# Bloquer un service
sudo ufw deny telnet
```

### Gestion avanc√©e avec ufw

#### Profils d'applications

```bash
# Lister les profils disponibles
sudo ufw app list

# Informations sur un profil
sudo ufw app info "Apache Full"

# Autoriser un profil
sudo ufw allow "Apache Full"

# Profils courants
sudo ufw allow "OpenSSH"
sudo ufw allow "Nginx Full"
sudo ufw allow "Apache"
```

#### R√®gles num√©rot√©es

```bash
# Lister avec num√©ros
sudo ufw status numbered

# Ins√©rer une r√®gle √† une position
sudo ufw insert 1 allow from 192.168.1.0/24

# Supprimer une r√®gle par num√©ro
sudo ufw delete 2

# Supprimer une r√®gle par sp√©cification
sudo ufw delete allow ssh
```

#### Logging et monitoring

```bash
# Activer le logging
sudo ufw logging on

# Niveaux de logging
sudo ufw logging low      # Connexions bloqu√©es
sudo ufw logging medium   # + paquets invalides, nouvelles connexions
sudo ufw logging high     # + tous les paquets (verbeux)
sudo ufw logging full     # Equivalent √† high

# Voir les logs
sudo tail -f /var/log/ufw.log

# D√©sactiver le logging
sudo ufw logging off
```

### Configuration avanc√©e ufw

#### R√®gles par interface

```bash
# Autoriser sur une interface sp√©cifique
sudo ufw allow in on eth0 to any port 80

# Bloquer sur une interface
sudo ufw deny in on eth1

# R√®gles pour le forwarding
sudo ufw route allow in on eth0 out on eth1
```

#### Limitation de d√©bit (rate limiting)

```bash
# Limiter les tentatives SSH (6 connexions en 30 secondes)
sudo ufw limit ssh

# Limitation personnalis√©e (dans /etc/ufw/user.rules)
# Cette fonctionnalit√© n√©cessite l'√©dition manuelle des fichiers
```

#### Configuration IPv6

```bash
# V√©rifier le support IPv6 dans /etc/default/ufw
sudo nano /etc/default/ufw

# Rechercher et s'assurer que :
IPV6=yes

# Red√©marrer ufw
sudo ufw disable
sudo ufw enable
```

### Scripts et automatisation ufw

#### Script de configuration type

```bash
#!/bin/bash
# Configuration ufw pour serveur web

echo "Configuration du pare-feu avec ufw..."

# R√©initialiser ufw
sudo ufw --force reset

# Politiques par d√©faut
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Services essentiels
sudo ufw allow ssh
sudo ufw limit ssh

# Services web
sudo ufw allow http
sudo ufw allow https

# DNS (si serveur DNS)
sudo ufw allow 53

# R√®gles sp√©cifiques par IP
sudo ufw allow from 192.168.1.0/24 to any port 22

# Activer le logging
sudo ufw logging medium

# Activer ufw
sudo ufw --force enable

# Afficher le statut
sudo ufw status verbose

echo "Configuration termin√©e."
```

#### Sauvegarde et restauration

```bash
# Les r√®gles ufw sont automatiquement sauvegard√©es dans :
# /etc/ufw/user.rules (IPv4)
# /etc/ufw/user6.rules (IPv6)

# Sauvegarde manuelle
sudo cp /etc/ufw/user.rules /backup/ufw-rules-$(date +%Y%m%d).bak
sudo cp /etc/ufw/user6.rules /backup/ufw6-rules-$(date +%Y%m%d).bak

# Script de sauvegarde
#!/bin/bash
BACKUP_DIR="/backup/ufw"
DATE=$(date +%Y%m%d-%H%M%S)

mkdir -p $BACKUP_DIR

# Sauvegarder la configuration
sudo ufw status verbose > "$BACKUP_DIR/ufw-status-$DATE.txt"
sudo cp /etc/ufw/user.rules "$BACKUP_DIR/user.rules-$DATE"
sudo cp /etc/ufw/user6.rules "$BACKUP_DIR/user6.rules-$DATE"

echo "Sauvegarde cr√©√©e dans $BACKUP_DIR"
```

---

## 5.2.3 Configuration de base et r√®gles avanc√©es

### Strat√©gies de s√©curit√© par couches

Une s√©curit√© efficace repose sur une approche multicouche, o√π chaque niveau apporte sa protection sp√©cifique.

#### Mod√®le de s√©curit√© en profondeur

**Couche 1 - R√©seau :**
- Pare-feu p√©rim√©trique
- Segmentation r√©seau (VLAN)
- D√©tection d'intrusion r√©seau

**Couche 2 - H√¥te :**
- Pare-feu local (focus de cette section)
- Syst√®me de d√©tection d'intrusion h√¥te
- Antimalware

**Couche 3 - Application :**
- Configuration s√©curis√©e des services
- Authentification forte
- Chiffrement des donn√©es

#### Principe du moindre privil√®ge

```bash
# Exemple : serveur web avec acc√®s minimal
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Uniquement les ports n√©cessaires
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 22/tcp    # SSH (depuis r√©seau admin uniquement)

# SSH limit√© au r√©seau d'administration
sudo ufw delete allow 22/tcp
sudo ufw allow from 192.168.100.0/24 to any port 22
```

### Configurations type par r√¥le de serveur

#### Serveur web (Apache/Nginx)

```bash
#!/bin/bash
# Configuration pare-feu pour serveur web

# R√©initialisation
sudo ufw --force reset

# Politiques par d√©faut
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Services web essentiels
sudo ufw allow 80/tcp comment 'HTTP'
sudo ufw allow 443/tcp comment 'HTTPS'

# SSH s√©curis√© (r√©seau admin uniquement)
sudo ufw allow from 192.168.100.0/24 to any port 22 comment 'SSH Admin'

# Monitoring (si Nagios/Zabbix)
sudo ufw allow from 192.168.100.10 to any port 5666 comment 'NRPE'

# Logs d√©taill√©s
sudo ufw logging medium

# Activation
sudo ufw --force enable

echo "Pare-feu configur√© pour serveur web"
```

#### Serveur de base de donn√©es

```bash
#!/bin/bash
# Configuration pare-feu pour serveur BDD

sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing

# SSH admin uniquement
sudo ufw allow from 192.168.100.0/24 to any port 22

# MySQL/MariaDB (serveurs web uniquement)
sudo ufw allow from 192.168.1.10 to any port 3306 comment 'MySQL Web1'
sudo ufw allow from 192.168.1.11 to any port 3306 comment 'MySQL Web2'

# PostgreSQL
sudo ufw allow from 192.168.1.0/24 to any port 5432 comment 'PostgreSQL'

# Backup server
sudo ufw allow from 192.168.100.20 to any port 22 comment 'Backup SSH'

sudo ufw logging high
sudo ufw --force enable

echo "Pare-feu configur√© pour serveur BDD"
```

#### Serveur mail

```bash
#!/bin/bash
# Configuration pare-feu pour serveur mail

sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Services mail essentiels
sudo ufw allow 25/tcp comment 'SMTP'
sudo ufw allow 465/tcp comment 'SMTPS'
sudo ufw allow 587/tcp comment 'Submission'
sudo ufw allow 993/tcp comment 'IMAPS'
sudo ufw allow 995/tcp comment 'POP3S'

# DNS pour r√©solution MX
sudo ufw allow out 53

# SSH admin
sudo ufw allow from 192.168.100.0/24 to any port 22

# Webmail (si install√©)
sudo ufw allow 80/tcp comment 'Webmail HTTP'
sudo ufw allow 443/tcp comment 'Webmail HTTPS'

sudo ufw --force enable
```

### R√®gles avanc√©es et techniques sp√©cialis√©es

#### Gestion des connexions par √©tat

```bash
# Avec iptables : autoriser uniquement les connexions √©tablies
sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A INPUT -m state --state NEW -p tcp --dport 80 -j ACCEPT

# Avec nftables
sudo nft add rule inet filter input ct state established,related accept
sudo nft add rule inet filter input ct state new tcp dport 80 accept
```

#### Limitation de d√©bit avanc√©e

```bash
# iptables : limiter les nouvelles connexions SSH
sudo iptables -A INPUT -p tcp --dport 22 -m state --state NEW \
    -m recent --set --name SSH

sudo iptables -A INPUT -p tcp --dport 22 -m state --state NEW \
    -m recent --update --seconds 60 --hitcount 3 --name SSH -j DROP

# nftables : limitation avec compteurs
sudo nft add rule inet filter input tcp dport 22 \
    limit rate over 3/minute drop
```

#### Protection contre les attaques DDoS

```bash
# Limitation des connexions simultan√©es (iptables)
sudo iptables -A INPUT -p tcp --dport 80 -m connlimit \
    --connlimit-above 10 --connlimit-mask 32 -j DROP

# Protection SYN flood
sudo iptables -A INPUT -p tcp --syn -m limit \
    --limit 1/second --limit-burst 3 -j ACCEPT

sudo iptables -A INPUT -p tcp --syn -j DROP

# Avec nftables
sudo nft add rule inet filter input tcp flags \& \(fin\|syn\|rst\|ack\) == syn \
    limit rate over 1/second drop
```

#### Logging avanc√© et analyse

```bash
# Logging personnalis√© avec iptables
sudo iptables -A INPUT -m limit --limit 5/min -j LOG \
    --log-prefix "FW-DROP: " --log-level 4

# Cr√©er une cha√Æne de logging personnalis√©e
sudo iptables -N LOGGING
sudo iptables -A INPUT -j LOGGING
sudo iptables -A LOGGING -m limit --limit 2/min -j LOG \
    --log-prefix "IPTables Packet Dropped: " --log-level 7
sudo iptables -A LOGGING -j DROP

# Script d'analyse des logs
#!/bin/bash
# Analyser les logs de pare-feu

LOG_FILE="/var/log/syslog"
TEMP_FILE="/tmp/fw-analysis.tmp"

echo "=== Analyse des logs pare-feu ==="
echo "Date: $(date)"
echo

# Extraire les entr√©es du pare-feu des derni√®res 24h
grep "$(date '+%b %d')" $LOG_FILE | grep -E "(FW-DROP|iptables|ufw)" > $TEMP_FILE

# Top 10 des IPs bloqu√©es
echo "Top 10 des adresses IP bloqu√©es:"
grep -oE "SRC=[0-9.]+" $TEMP_FILE | cut -d= -f2 | sort | uniq -c | sort -nr | head -10

echo
# Top 10 des ports cibl√©s
echo "Top 10 des ports cibl√©s:"
grep -oE "DPT=[0-9]+" $TEMP_FILE | cut -d= -f2 | sort | uniq -c | sort -nr | head -10

echo
# R√©sum√© par protocole
echo "Trafic par protocole:"
grep -oE "PROTO=[A-Z]+" $TEMP_FILE | cut -d= -f2 | sort | uniq -c | sort -nr

rm -f $TEMP_FILE
```

### G√©olocalisation et blocage par pays

#### Installation et configuration de GeoIP

```bash
# Installation des outils GeoIP
sudo apt update
sudo apt install geoip-bin geoip-database xtables-addons-common

# Mise √† jour de la base de donn√©es
sudo mkdir -p /usr/share/xt_geoip
sudo /usr/lib/xtables-addons/xt_geoip_dl
sudo /usr/lib/xtables-addons/xt_geoip_build -D /usr/share/xt_geoip *.csv

# Exemple de blocage par pays (iptables)
# Bloquer tout le trafic depuis la Chine (CN) et la Russie (RU)
sudo iptables -A INPUT -m geoip --src-cc CN,RU -j DROP

# Autoriser uniquement certains pays pour SSH
sudo iptables -A INPUT -p tcp --dport 22 -m geoip --src-cc FR,DE,GB -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 22 -j DROP
```

### Configuration par environnement

#### Environnement de d√©veloppement

```bash
#!/bin/bash
# Pare-feu pour environnement de d√©veloppement

sudo ufw --force reset
sudo ufw default allow outgoing
sudo ufw default deny incoming

# Services de d√©veloppement
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 3000/tcp  # Node.js dev
sudo ufw allow 8000/tcp  # Django dev
sudo ufw allow 8080/tcp  # Alternative HTTP

# Base de donn√©es locale
sudo ufw allow from 127.0.0.1 to any port 3306  # MySQL
sudo ufw allow from 127.0.0.1 to any port 5432  # PostgreSQL

# Docker (si utilis√©)
sudo ufw allow 2376/tcp  # Docker daemon

sudo ufw --force enable
```

#### Environnement de production

```bash
#!/bin/bash
# Pare-feu pour environnement de production

sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default deny forward
sudo ufw default allow outgoing

# SSH strictement limit√©
sudo ufw allow from $ADMIN_NETWORK to any port 22

# Services publics uniquement
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Monitoring et backup
sudo ufw allow from $MONITORING_SERVER to any port 5666  # NRPE
sudo ufw allow from $BACKUP_SERVER to any port 22        # Backup SSH

# Logging maximal
sudo ufw logging full

sudo ufw --force enable

# Notification de configuration
echo "Pare-feu production configur√© - $(date)" | \
mail -s "Firewall Configuration" admin@example.com
```

---

# 5.2.4 fail2ban et protection contre les intrusions (suite)
*Module 5 : R√©seau et s√©curit√© - Formation Debian Desktop et Server*

## Introduction √† fail2ban

**fail2ban** est un syst√®me de pr√©vention contre les intrusions qui analyse les logs syst√®me et bloque automatiquement les adresses IP pr√©sentant des comportements suspects ou malveillants.

### Principe de fonctionnement

1. **Surveillance** : fail2ban surveille les fichiers de logs sp√©cifi√©s
2. **D√©tection** : Il utilise des expressions r√©guli√®res pour identifier les tentatives d'intrusion
3. **Action** : Lors d'un nombre d√©fini d'√©checs, il bannit l'IP pour une dur√©e d√©termin√©e
4. **Int√©gration** : Il s'interface avec iptables, ufw, ou d'autres pare-feu

### Avantages de fail2ban

- **Protection automatique** : R√©action imm√©diate aux attaques
- **Flexibilit√©** : Configuration adaptable selon les services
- **Logging d√©taill√©** : Tra√ßabilit√© compl√®te des actions
- **Int√©gration native** : Compatible avec la plupart des services Linux
- **D√©bannissement automatique** : Les IPs sont lib√©r√©es apr√®s la p√©riode de ban

### Architecture de fail2ban

**Composants principaux :**
- **Jails** : Conteneurs de r√®gles pour chaque service
- **Filters** : Expressions r√©guli√®res pour d√©tecter les tentatives d'intrusion
- **Actions** : Commandes ex√©cut√©es lors d'un bannissement
- **Backend** : M√©thode de surveillance des logs (polling, gamin, pyinotify)

## Installation et configuration de base

### Installation

```bash
# Mise √† jour des paquets
sudo apt update

# Installation de fail2ban
sudo apt install fail2ban

# V√©rifier l'installation
fail2ban-client version

# D√©marrer et activer le service
sudo systemctl start fail2ban
sudo systemctl enable fail2ban

# V√©rifier le statut
sudo systemctl status fail2ban
```

### Structure de configuration

Les fichiers de configuration de fail2ban se trouvent dans `/etc/fail2ban/` :

```bash
# Structure des r√©pertoires
/etc/fail2ban/
‚îú‚îÄ‚îÄ fail2ban.conf       # Configuration g√©n√©rale
‚îú‚îÄ‚îÄ jail.conf           # Jails par d√©faut (NE PAS MODIFIER)
‚îú‚îÄ‚îÄ jail.local          # Personnalisations locales
‚îú‚îÄ‚îÄ filter.d/           # Filtres de d√©tection
‚îú‚îÄ‚îÄ action.d/           # Actions √† ex√©cuter
‚îî‚îÄ‚îÄ jail.d/             # Jails personnalis√©es
```

### Configuration de base

#### Cr√©ation du fichier jail.local

```bash
# Cr√©er le fichier de configuration local
sudo nano /etc/fail2ban/jail.local
```

**Configuration de base recommand√©e :**
```ini
[DEFAULT]
# Dur√©e de bannissement (en secondes)
bantime = 3600

# P√©riode d'observation pour les √©checs (en secondes)
findtime = 600

# Nombre maximum d'√©checs avant bannissement
maxretry = 3

# Backend de surveillance des logs
backend = auto

# Action par d√©faut (bannir et envoyer un email)
action = %(action_mw)s

# Email de notification (optionnel)
destemail = admin@example.com
sender = fail2ban@example.com

# Adresses IP √† ignorer (whitelist)
ignoreip = 127.0.0.1/8 ::1 192.168.1.0/24

# Interface r√©seau par d√©faut
banaction = iptables-multiport
banaction_allports = iptables-allports

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
```

#### Activation et v√©rification

```bash
# Red√©marrer fail2ban
sudo systemctl restart fail2ban

# V√©rifier les jails actives
sudo fail2ban-client status

# D√©tail d'une jail sp√©cifique
sudo fail2ban-client status sshd
```

## Configuration avanc√©e des jails

### Jails pr√©d√©finies communes

#### Protection SSH avanc√©e

```ini
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 86400
findtime = 600

# Protection contre les attaques de brute force SSH plus sophistiqu√©es
[sshd-ddos]
enabled = true
port = ssh
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 2
bantime = 86400
findtime = 120
```

#### Protection des services web

```ini
[apache-auth]
enabled = true
port = http,https
filter = apache-auth
logpath = /var/log/apache2/error.log
maxretry = 3
bantime = 3600

[apache-badbots]
enabled = true
port = http,https
filter = apache-badbots
logpath = /var/log/apache2/access.log
maxretry = 2
bantime = 86400

[apache-noscript]
enabled = true
port = http,https
filter = apache-noscript
logpath = /var/log/apache2/access.log
maxretry = 6
bantime = 3600

[apache-overflows]
enabled = true
port = http,https
filter = apache-overflows
logpath = /var/log/apache2/access.log
maxretry = 2
bantime = 86400

[nginx-http-auth]
enabled = true
port = http,https
filter = nginx-http-auth
logpath = /var/log/nginx/error.log
maxretry = 3
bantime = 3600

[nginx-noscript]
enabled = true
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/access.log
maxretry = 6
bantime = 3600
```

#### Protection des services mail

```ini
[postfix]
enabled = true
port = smtp,465,submission
filter = postfix
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600

[dovecot]
enabled = true
port = pop3,pop3s,imap,imaps,submission,465,sieve
filter = dovecot
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600

[postfix-sasl]
enabled = true
port = smtp,465,submission,imap3,imaps,pop3,pop3s
filter = postfix-sasl
logpath = /var/log/mail.log
maxretry = 3
bantime = 3600
```

### Cr√©ation de filtres personnalis√©s

#### Filtre pour application web personnalis√©e

```bash
# Cr√©er un filtre personnalis√©
sudo nano /etc/fail2ban/filter.d/webapp-auth.conf
```

```ini
# Filtre pour application web personnalis√©e
[Definition]
# Expressions r√©guli√®res pour d√©tecter les √©checs d'authentification
failregex = ^<HOST> -.*"POST /login.*" 401
            ^<HOST> -.*"POST /admin.*" 403
            ^.*Authentication failed.*<HOST>
            ^.*Invalid login attempt from <HOST>

# Expression pour ignorer certaines entr√©es
ignoreregex = ^.*Internal health check.*
```

#### Jail correspondante

```ini
[webapp-auth]
enabled = true
port = http,https
filter = webapp-auth
logpath = /var/log/webapp/access.log
maxretry = 5
bantime = 7200
findtime = 300
```

### Actions personnalis√©es

#### Action avec notification email avanc√©e

```bash
# Cr√©er une action personnalis√©e
sudo nano /etc/fail2ban/action.d/mail-notification.conf
```

```ini
[Definition]
# Commande de bannissement
actionstart = printf %%b "Subject: [Fail2Ban] <name>: started
              Date: `LC_ALL=C date +"%%a, %%d %%h %%Y %%T %%z"`
              From: Fail2Ban <<sender>>
              To: <dest>\n
              Hi,\n
              The jail <name> has been started successfully.\n
              Regards,\n
              Fail2Ban" | /usr/sbin/sendmail -f <sender> <dest>

actionstop = printf %%b "Subject: [Fail2Ban] <name>: stopped
             Date: `LC_ALL=C date +"%%a, %%d %%h %%Y %%T %%z"`
             From: Fail2Ban <<sender>>
             To: <dest>\n
             Hi,\n
             The jail <name> has been stopped.\n
             Regards,\n
             Fail2Ban" | /usr/sbin/sendmail -f <sender> <dest>

actionban = iptables -I f2b-<name> 1 -s <ip> -j <blocktype>
            printf %%b "Subject: [Fail2Ban] <name>: banned <ip>
            Date: `LC_ALL=C date +"%%a, %%d %%h %%Y %%T %%z"`
            From: Fail2Ban <<sender>>
            To: <dest>\n
            Hi,\n
            The IP <ip> has just been banned by Fail2Ban after
            <failures> attempts against <name>.\n
            Lines containing IP in log file:\n
            <matches>\n
            Regards,\n
            Fail2Ban" | /usr/sbin/sendmail -f <sender> <dest>

actionunban = iptables -D f2b-<name> -s <ip> -j <blocktype>

[Init]
blocktype = DROP
dest = admin@example.com
sender = fail2ban@example.com
```

### Gestion et monitoring de fail2ban

#### Commandes de gestion essentielles

```bash
# √âtat g√©n√©ral
sudo fail2ban-client status

# √âtat d'une jail sp√©cifique
sudo fail2ban-client status sshd

# Lister les IPs bannies
sudo fail2ban-client get sshd banip

# D√©bannir une IP manuellement
sudo fail2ban-client set sshd unbanip 192.168.1.100

# Bannir une IP manuellement
sudo fail2ban-client set sshd banip 192.168.1.200

# Recharger la configuration
sudo fail2ban-client reload

# Red√©marrer une jail sp√©cifique
sudo fail2ban-client reload sshd

# Arr√™ter fail2ban
sudo fail2ban-client stop
```

#### Monitoring des logs fail2ban

```bash
# Logs de fail2ban
sudo tail -f /var/log/fail2ban.log

# Filtrer les bannissements
sudo grep "Ban " /var/log/fail2ban.log

# Filtrer les d√©bannissements
sudo grep "Unban " /var/log/fail2ban.log

# Statistiques journali√®res
sudo grep "$(date '+%Y-%m-%d')" /var/log/fail2ban.log | grep "Ban " | wc -l
```

#### Script de monitoring automatis√©

```bash
#!/bin/bash
# /usr/local/bin/fail2ban-report.sh

# G√©n√©rer un rapport fail2ban

DATE=$(date '+%Y-%m-%d')
REPORT_FILE="/tmp/fail2ban-report-$DATE.txt"

echo "=== Rapport Fail2ban du $DATE ===" > $REPORT_FILE
echo >> $REPORT_FILE

# √âtat des jails
echo "=== √âtat des jails ===" >> $REPORT_FILE
fail2ban-client status >> $REPORT_FILE 2>&1
echo >> $REPORT_FILE

# D√©tail pour chaque jail active
for jail in $(fail2ban-client status | grep "Jail list" | cut -d: -f2 | tr -d ' ' | tr ',' ' '); do
    echo "=== Jail: $jail ===" >> $REPORT_FILE
    fail2ban-client status $jail >> $REPORT_FILE 2>&1
    echo >> $REPORT_FILE
done

# Statistiques du jour
echo "=== Statistiques du jour ===" >> $REPORT_FILE
echo "Bannissements: $(grep "$DATE" /var/log/fail2ban.log | grep -c "Ban ")" >> $REPORT_FILE
echo "D√©bannissements: $(grep "$DATE" /var/log/fail2ban.log | grep -c "Unban ")" >> $REPORT_FILE
echo >> $REPORT_FILE

# Top 10 des IPs bannies
echo "=== Top 10 des IPs bannies aujourd'hui ===" >> $REPORT_FILE
grep "$DATE" /var/log/fail2ban.log | grep "Ban " | \
awk '{print $NF}' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE

# Envoyer le rapport par email (optionnel)
# mail -s "Rapport Fail2ban $DATE" admin@example.com < $REPORT_FILE

echo "Rapport g√©n√©r√©: $REPORT_FILE"
```

```bash
# Rendre le script ex√©cutable
sudo chmod +x /usr/local/bin/fail2ban-report.sh

# Ajouter au cron pour rapport quotidien
echo "0 8 * * * /usr/local/bin/fail2ban-report.sh" | sudo crontab -
```

## Int√©gration avec les syst√®mes de notification

### Notifications Slack

```bash
# Cr√©er une action Slack
sudo nano /etc/fail2ban/action.d/slack-notification.conf
```

```ini
[Definition]
actionban = curl -X POST -H 'Content-type: application/json' \
           --data '{"text":"üö´ Fail2Ban: IP <ip> banned on <name> after <failures> attempts"}' \
           <slack_webhook_url>

actionunban = curl -X POST -H 'Content-type: application/json' \
             --data '{"text":"‚úÖ Fail2Ban: IP <ip> unbanned from <name>"}' \
             <slack_webhook_url>

[Init]
slack_webhook_url = https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

### Notifications Discord

```bash
# Cr√©er une action Discord
sudo nano /etc/fail2ban/action.d/discord-notification.conf
```

```ini
[Definition]
actionban = curl -H "Content-Type: application/json" \
           -d '{"content":"üõ°Ô∏è **Fail2Ban Alert**: IP `<ip>` banned on **<name>** after **<failures>** attempts"}' \
           <discord_webhook_url>

[Init]
discord_webhook_url = https://discord.com/api/webhooks/YOUR/WEBHOOK/URL
```

## Optimisation et tuning

### Performance et ressources

#### Configuration pour serveur haute charge

```ini
[DEFAULT]
# Augmenter les performances pour serveur haute charge
backend = pyinotify  # Plus efficace que polling
maxretry = 5         # Plus tol√©rant
findtime = 300       # Fen√™tre plus courte
bantime = 1800       # Ban plus court mais efficace

# Limiter l'utilisation m√©moire
dbmaxmatches = 10    # Limite les correspondances stock√©es
dbpurgeage = 86400   # Purge quotidienne de la DB
```

#### Gestion des logs volumineux

```bash
# Configuration logrotate pour fail2ban
sudo nano /etc/logrotate.d/fail2ban-custom
```

```
/var/log/fail2ban.log {
    weekly
    missingok
    rotate 52
    compress
    delaycompress
    postrotate
        /usr/bin/fail2ban-client flushlogs >/dev/null 2>&1 || true
    endscript
}
```

### Patterns de d√©tection avanc√©s

#### D√©tection d'attaques sophistiqu√©es

```bash
# Filtre pour d√©tecter les scans de ports
sudo nano /etc/fail2ban/filter.d/port-scan.conf
```

```ini
[Definition]
# D√©tection de scan de ports via logs iptables
failregex = kernel.*IN=.*OUT=.*SRC=<HOST>.*DPT=(22|80|443|21|25|53|110|143|993|995)
ignoreregex =

[Init]
# Nombre de ports scann√©s avant ban
maxlines = 1
```

```ini
# Jail correspondante dans jail.local
[port-scan]
enabled = true
filter = port-scan
logpath = /var/log/syslog
maxretry = 10
findtime = 60
bantime = 86400
```

#### D√©tection d'attaques par d√©ni de service

```bash
# Filtre pour d√©tecter les attaques DoS HTTP
sudo nano /etc/fail2ban/filter.d/http-dos.conf
```

```ini
[Definition]
# D√©tection de requ√™tes excessives
failregex = ^<HOST> -.*"(GET|POST).*" (200|404) .*$

[Init]
# Configuration pour d√©tecter les attaques DoS
# Plus de 100 requ√™tes en 1 minute = DoS potentiel
maxlines = 1
```

```ini
# Jail DoS dans jail.local
[http-dos]
enabled = true
port = http,https
filter = http-dos
logpath = /var/log/apache2/access.log
maxretry = 100
findtime = 60
bantime = 3600
```

## Whitelist et gestion des exceptions

### Configuration des listes blanches

#### Whitelist globale

```ini
[DEFAULT]
# IPs et r√©seaux √† ne jamais bannir
ignoreip = 127.0.0.1/8 ::1
          192.168.0.0/16
          10.0.0.0/8
          172.16.0.0/12
          203.0.113.0/24  # R√©seau bureau
          198.51.100.50   # IP admin sp√©cifique
```

#### Whitelist par service

```ini
[sshd]
enabled = true
ignoreip = 127.0.0.1/8 ::1 192.168.1.0/24 203.0.113.10
# Cette jail ignorera les IPs list√©es en plus de la whitelist globale
```

#### Whitelist dynamique

```bash
# Script pour ajouter temporairement √† la whitelist
#!/bin/bash
# /usr/local/bin/temp-whitelist.sh

IP=$1
JAIL=${2:-sshd}
DURATION=${3:-3600}  # 1 heure par d√©faut

if [ -z "$IP" ]; then
    echo "Usage: $0 <IP> [jail] [duration_seconds]"
    exit 1
fi

# D√©bannir si d√©j√† banni
fail2ban-client set $JAIL unbanip $IP 2>/dev/null

# Ajouter √† la whitelist temporaire
fail2ban-client set $JAIL addignoreip $IP

echo "IP $IP ajout√©e √† la whitelist de $JAIL"

# Programmer la suppression
echo "sleep $DURATION && fail2ban-client set $JAIL delignoreip $IP" | at now

echo "Suppression programm√©e dans $(( $DURATION / 60 )) minutes"
```

## Int√©gration avec d'autres syst√®mes de s√©curit√©

### Int√©gration avec OSSEC/Wazuh

```bash
# Configuration pour envoyer les alertes fail2ban √† OSSEC
sudo nano /etc/fail2ban/action.d/ossec-alert.conf
```

```ini
[Definition]
actionban = /var/ossec/bin/ossec-control alert local \
           "Fail2ban: IP <ip> banned on <name> after <failures> attempts"

actionunban = /var/ossec/bin/ossec-control alert local \
             "Fail2ban: IP <ip> unbanned from <name>"
```

### Synchronisation multi-serveurs

```bash
# Script de synchronisation des bans entre serveurs
#!/bin/bash
# /usr/local/bin/sync-fail2ban.sh

SERVERS="server1.example.com server2.example.com"
JAIL_NAME="sshd"

# Obtenir les IPs bannies localement
LOCAL_BANS=$(fail2ban-client get $JAIL_NAME banip | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}')

for SERVER in $SERVERS; do
    echo "Synchronisation avec $SERVER..."

    for IP in $LOCAL_BANS; do
        # Bannir l'IP sur le serveur distant
        ssh root@$SERVER "fail2ban-client set $JAIL_NAME banip $IP" 2>/dev/null
    done

    echo "Synchronisation termin√©e avec $SERVER"
done
```

## D√©pannage et r√©solution de probl√®mes

### Probl√®mes courants

#### Fail2ban ne d√©marre pas

```bash
# V√©rifier la configuration
sudo fail2ban-client -t

# V√©rifier les logs d'erreurs
sudo journalctl -u fail2ban -n 50

# Test de configuration sp√©cifique
sudo fail2ban-client -t -c /etc/fail2ban/jail.local
```

#### Les IPs ne sont pas bannies

```bash
# V√©rifier que la jail est active
sudo fail2ban-client status

# V√©rifier les logs surveill√©s
sudo fail2ban-client get sshd logpath

# Tester le filtre manuellement
sudo fail2ban-regex /var/log/auth.log /etc/fail2ban/filter.d/sshd.conf

# V√©rifier les r√®gles iptables
sudo iptables -L -n | grep f2b
```

#### Performance d√©grad√©e

```bash
# V√©rifier l'utilisation CPU
top -p $(pgrep fail2ban-server)

# Optimiser le backend
sudo nano /etc/fail2ban/jail.local
# Changer backend = auto vers backend = pyinotify

# R√©duire la verbosit√© des logs
sudo fail2ban-client set logtarget /var/log/fail2ban.log
```

### Scripts de diagnostic

```bash
#!/bin/bash
# /usr/local/bin/fail2ban-diagnostic.sh

echo "=== Diagnostic Fail2ban ==="
echo "Date: $(date)"
echo

# Version et statut
echo "Version: $(fail2ban-client version)"
echo "Statut service: $(systemctl is-active fail2ban)"
echo

# Configuration
echo "=== Test de configuration ==="
if fail2ban-client -t; then
    echo "‚úì Configuration valide"
else
    echo "‚úó Erreurs de configuration d√©tect√©es"
fi
echo

# Jails actives
echo "=== Jails actives ==="
fail2ban-client status
echo

# Utilisation des ressources
echo "=== Utilisation des ressources ==="
echo "Processus fail2ban:"
ps aux | grep fail2ban | grep -v grep
echo

echo "M√©moire utilis√©e:"
ps -o pid,vsz,rss,comm -p $(pgrep fail2ban-server)
echo

# R√®gles iptables
echo "=== R√®gles iptables actives ==="
iptables -L | grep f2b | wc -l
echo "Nombre de r√®gles fail2ban actives"
echo

# Logs r√©cents
echo "=== Logs r√©cents (derni√®res 10 lignes) ==="
tail -10 /var/log/fail2ban.log
```

## Bonnes pratiques et recommandations

### Strat√©gie de s√©curit√© multicouche

1. **Fail2ban** : Protection automatique contre les attaques par force brute
2. **Pare-feu** : Filtrage du trafic r√©seau
3. **SSH s√©curis√©** : Cl√©s publiques, port non-standard, restrictions IP
4. **Monitoring** : Surveillance continue des tentatives d'intrusion
5. **Mises √† jour** : Syst√®me et applications toujours √† jour

### Configuration recommand√©e pour production

```ini
[DEFAULT]
# Configuration production robuste
bantime = 86400       # 24h de ban
findtime = 3600       # Fen√™tre d'1 heure
maxretry = 3          # 3 tentatives maximum
backend = pyinotify   # Backend performant
destemail = security@example.com
action = %(action_mwl)s  # Ban + email + whois

# Whitelist des r√©seaux de confiance
ignoreip = 127.0.0.1/8 ::1 192.168.0.0/16 10.0.0.0/8

[sshd]
enabled = true
maxretry = 3
bantime = 86400
findtime = 600

[apache-auth]
enabled = true
maxretry = 3
bantime = 3600

[postfix]
enabled = true
maxretry = 2
bantime = 86400
```

### Maintenance r√©guli√®re

```bash
#!/bin/bash
# Script de maintenance hebdomadaire fail2ban

# Nettoyer les anciennes entr√©es de la base
fail2ban-client unban --all

# Analyser les statistiques
echo "=== Statistiques de la semaine ===" > /tmp/f2b-weekly.txt
grep "$(date -d '7 days ago' '+%Y-%m-%d')" /var/log/fail2ban.log | \
grep "Ban " | wc -l >> /tmp/f2b-weekly.txt

# V√©rifier la configuration
fail2ban-client -t

# Red√©marrer si n√©cessaire
if ! systemctl is-active --quiet fail2ban; then
    systemctl restart fail2ban
    echo "Fail2ban red√©marr√©" | mail -s "Maintenance Fail2ban" admin@example.com
fi
```

---

## Conclusion de la section 5.2

La mise en place d'un syst√®me de pare-feu et de protection contre les intrusions constitue un √©l√©ment fondamental de la s√©curit√© de votre infrastructure Debian. Cette section vous a pr√©sent√© :

### Comp√©tences acquises

- **Ma√Ætrise des pare-feu** : iptables, nftables, et ufw selon vos besoins
- **Configuration s√©curis√©e** : R√®gles adapt√©es par type de serveur
- **Protection automatis√©e** : fail2ban pour la d√©tection et r√©action aux intrusions
- **Monitoring avanc√©** : Surveillance et analyse des tentatives d'attaque
- **Int√©gration syst√®me** : Coordination entre diff√©rents composants de s√©curit√©

### Points cl√©s √† retenir

1. **Principe de moindre privil√®ge** : N'ouvrir que les ports strictement n√©cessaires
2. **D√©fense en profondeur** : Combiner plusieurs couches de protection
3. **Monitoring continu** : Surveiller et analyser les logs de s√©curit√©
4. **Maintenance r√©guli√®re** : Mettre √† jour les r√®gles et configurations
5. **Documentation** : Maintenir une documentation √† jour des r√®gles et exceptions

### Prochaines √©tapes

Ces fondations de s√©curit√© vous pr√©parent aux sections suivantes :
- **5.3 SSH et acc√®s distant** : S√©curisation des connexions distantes
- **5.4 VPN et chiffrement** : Protection des communications

La s√©curit√© r√©seau √©tant un domaine en constante √©volution, il est essentiel de maintenir une veille technologique et d'adapter r√©guli√®rement vos configurations aux nouvelles menaces.

‚è≠Ô∏è
