üîù Retour au [Sommaire](/SOMMAIRE.md)

# 5.1 Configuration r√©seau avanc√©e
*Module 5 : R√©seau et s√©curit√© - Formation Debian Desktop et Server*

## Introduction √† la configuration r√©seau avanc√©e

La configuration r√©seau est l'un des aspects les plus critiques de l'administration syst√®me. Dans cette section, nous allons explorer les techniques avanc√©es qui vous permettront de cr√©er des infrastructures r√©seau robustes, performantes et adapt√©es aux besoins modernes.

**Pourquoi "avanc√©e" ?** Contrairement aux configurations r√©seau de base (une interface, une adresse IP), nous allons voir comment :
- Combiner plusieurs interfaces pour la redondance et les performances
- G√©rer simultan√©ment IPv4 et IPv6
- Cr√©er des r√©seaux virtuels isol√©s
- Choisir les bons outils selon le contexte

---

## 5.1.1 Interfaces r√©seau et bonding/teaming

### Comprendre les interfaces r√©seau

Une **interface r√©seau** est le point de connexion entre votre syst√®me et le r√©seau. Sur Debian, elles sont nomm√©es selon des conventions pr√©cises :

**Nommage traditionnel (ancien) :**
- `eth0`, `eth1` : Interfaces Ethernet
- `wlan0`, `wlan1` : Interfaces WiFi
- `lo` : Interface de loopback (toujours pr√©sente)

**Nommage pr√©dictible (moderne) :**
- `enp0s3` : Ethernet PCI slot 0, function 3
- `eno1` : Ethernet on-board, port 1
- `wlp2s0` : WiFi PCI slot 2, function 0

### Lister les interfaces disponibles

```bash
# Voir toutes les interfaces (actives et inactives)
ip link show

# Voir uniquement les interfaces actives avec leurs adresses
ip addr show

# M√©thode alternative (plus traditionnelle)
ifconfig -a
```

### Le bonding : combiner plusieurs interfaces

Le **bonding** permet de combiner plusieurs interfaces physiques en une seule interface logique. Les avantages :

- **Redondance** : Si une interface tombe, les autres continuent
- **Performance** : Agr√©gation de bande passante
- **√âquilibrage de charge** : Distribution du trafic

#### Types de bonding principaux

**Mode 0 - Round Robin :**
- Distribue les paquets s√©quentiellement sur toutes les interfaces
- Bon pour la performance, mais peut cr√©er des probl√®mes d'ordre

**Mode 1 - Active-Backup :**
- Une interface active, les autres en standby
- Basculement automatique en cas de panne
- Id√©al pour la redondance sans complexit√©

**Mode 4 - 802.3ad (LACP) :**
- Standard IEEE pour l'agr√©gation de liens
- N√©cessite un switch compatible
- Combine performance et redondance

#### Configuration du bonding

**1. Charger le module kernel :**
```bash
# V√©rifier si le module est charg√©
lsmod | grep bonding

# Charger le module si n√©cessaire
sudo modprobe bonding

# Rendre permanent le chargement
echo "bonding" | sudo tee -a /etc/modules
```

**2. Configuration dans `/etc/network/interfaces` :**
```bash
# Interface bond0 en mode active-backup
auto bond0
iface bond0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    bond-mode active-backup
    bond-miimon 100
    bond-slaves eth0 eth1

# Configuration des interfaces esclaves
auto eth0
iface eth0 inet manual
    bond-master bond0

auto eth1
iface eth1 inet manual
    bond-master bond0
```

**3. Param√®tres importants du bonding :**

- `bond-mode` : Type de bonding (0-6)
- `bond-miimon 100` : Surveillance des liens toutes les 100ms
- `bond-slaves` : Liste des interfaces √† agr√©ger
- `bond-primary eth0` : Interface pr√©f√©r√©e en mode active-backup

### Le teaming : alternative moderne au bonding

Le **teaming** est une approche plus r√©cente et flexible que le bonding traditionnel.

**Avantages du teaming :**
- Configuration plus simple via JSON
- Meilleure observabilit√©
- Chargement de modules plus l√©ger
- Scripts de contr√¥le avanc√©s

#### Installation et configuration du teaming

**1. Installation :**
```bash
sudo apt update
sudo apt install libteam-utils
```

**2. Cr√©ation d'une configuration team :**
```json
# Fichier /etc/teamd/team0.conf
{
    "device": "team0",
    "runner": {
        "name": "activebackup"
    },
    "link_watch": {
        "name": "ethtool"
    },
    "ports": {
        "eth0": {},
        "eth1": {}
    }
}
```

**3. Configuration dans `/etc/network/interfaces` :**
```bash
auto team0
iface team0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    pre-up teamd -d -c /etc/teamd/team0.conf
    post-down teamd -k -t team0
```

### Surveillance et gestion

**V√©rifier l'√©tat du bonding :**
```bash
# √âtat d√©taill√© du bond
cat /proc/net/bonding/bond0

# Statistiques des interfaces
ip -s link show bond0
```

**V√©rifier l'√©tat du teaming :**
```bash
# √âtat de l'√©quipe
teamdctl team0 state

# Configuration active
teamdctl team0 config dump
```

---

## 5.1.2 Configuration statique et DHCP

### Comprendre les types de configuration IP

**Configuration statique :**
- Adresse IP fixe d√©finie manuellement
- Utilis√©e pour les serveurs et √©quipements critiques
- N√©cessite une gestion manuelle mais offre un contr√¥le total

**Configuration dynamique (DHCP) :**
- Adresse IP attribu√©e automatiquement par un serveur DHCP
- Id√©ale pour les postes clients et environnements changeants
- Simplifie la gestion mais offre moins de contr√¥le

### Configuration IP statique

#### M√©thode 1 : Via `/etc/network/interfaces`

**Configuration IPv4 basique :**
```bash
# Interface principale
auto eno1
iface eno1 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4
    dns-search example.local
```

**Configuration avec plusieurs adresses :**
```bash
auto eno1
iface eno1 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4

# Adresse secondaire
auto eno1:1
iface eno1:1 inet static
    address 192.168.1.101
    netmask 255.255.255.0
```

#### M√©thode 2 : Via la commande `ip`

**Configuration temporaire :**
```bash
# Ajouter une adresse IP
sudo ip addr add 192.168.1.100/24 dev eno1

# Configurer la passerelle
sudo ip route add default via 192.168.1.1

# Activer l'interface
sudo ip link set eno1 up
```

**Avantages et inconv√©nients :**
- ‚úÖ Configuration imm√©diate
- ‚ùå Perdue au red√©marrage
- üéØ Id√©ale pour les tests et le d√©pannage

### Configuration DHCP

#### Configuration client DHCP standard

```bash
# Dans /etc/network/interfaces
auto eno1
iface eno1 inet dhcp
```

#### Configuration DHCP avec options avanc√©es

```bash
auto eno1
iface eno1 inet dhcp
    # Nom d'h√¥te envoy√© au serveur DHCP
    hostname mon-serveur
    # Client ID personnalis√©
    client-id 01:aa:bb:cc:dd:ee:ff
    # Options DHCP sp√©cifiques
    dhcp-option domain-name "example.local"
    dhcp-option domain-name-servers "8.8.8.8,8.8.4.4"
```

### Client DHCP avanc√© avec dhclient

Le d√©mon `dhclient` g√®re les requ√™tes DHCP de mani√®re sophistiqu√©e.

#### Configuration dans `/etc/dhcp/dhclient.conf`

```bash
# Options par d√©faut
option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;

# Demander des options sp√©cifiques
request subnet-mask, broadcast-address, time-offset, routers,
        domain-name, domain-name-servers, domain-search, host-name,
        dhcp6.name-servers, dhcp6.domain-search, dhcp6.fqdn, dhcp6.sntp-servers,
        netbios-name-servers, netbios-scope, interface-mtu,
        rfc3442-classless-static-routes, ntp-servers;

# Configuration pour une interface sp√©cifique
interface "eno1" {
    send host-name "mon-serveur";
    send dhcp-client-identifier 01:aa:bb:cc:dd:ee:ff;
    request subnet-mask, broadcast-address, routers, domain-name-servers;
}
```

#### Scripts de hooks DHCP

Les scripts dans `/etc/dhcp/dhclient-enter-hooks.d/` et `/etc/dhcp/dhclient-exit-hooks.d/` permettent d'ex√©cuter des actions lors des √©v√©nements DHCP.

**Exemple - Script de notification :**
```bash
#!/bin/bash
# /etc/dhcp/dhclient-exit-hooks.d/notify

case $reason in
    BOUND|RENEW|REBIND)
        echo "$(date): Nouvelle IP obtenue: $new_ip_address" >> /var/log/dhcp-changes.log
        ;;
    EXPIRE|FAIL|STOP)
        echo "$(date): Perte de bail DHCP" >> /var/log/dhcp-changes.log
        ;;
esac
```

### Gestion des routes

#### Routes statiques

```bash
# Ajouter une route temporaire
sudo ip route add 10.0.0.0/8 via 192.168.1.254

# Route permanente dans /etc/network/interfaces
auto eno1
iface eno1 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    # Route vers r√©seau distant
    up ip route add 10.0.0.0/8 via 192.168.1.254
    down ip route del 10.0.0.0/8 via 192.168.1.254
```

#### Table de routage

```bash
# Voir la table de routage
ip route show

# Table d√©taill√©e
route -n

# Routes IPv6
ip -6 route show
```

---

## 5.1.3 IPv6 et dual-stack

### Introduction √† IPv6

IPv6 (Internet Protocol version 6) est la nouvelle g√©n√©ration du protocole Internet, con√ßu pour remplacer IPv4 et r√©soudre la p√©nurie d'adresses.

**Pourquoi IPv6 ?**
- **Espace d'adressage** : 340 undecillions d'adresses (vs 4 milliards pour IPv4)
- **S√©curit√© int√©gr√©e** : IPSec natif
- **Configuration automatique** : D√©couverte automatique des voisins
- **Pas de NAT n√©cessaire** : Adressage de bout en bout

### Format des adresses IPv6

**Structure d'une adresse IPv6 :**
- 128 bits organis√©s en 8 groupes de 16 bits
- Notation hexad√©cimale s√©par√©e par `:`
- Exemple : `2001:0db8:85a3:0000:0000:8a2e:0370:7334`

**R√®gles de compression :**
```bash
# Adresse compl√®te
2001:0db8:85a3:0000:0000:8a2e:0370:7334

# Suppression des z√©ros en t√™te
2001:db8:85a3:0:0:8a2e:370:7334

# Compression des z√©ros cons√©cutifs (une seule fois)
2001:db8:85a3::8a2e:370:7334
```

### Types d'adresses IPv6

**Adresses unicast :**
- `::1/128` : Loopback (√©quivalent √† 127.0.0.1)
- `fe80::/10` : Link-local (communication sur le m√™me segment)
- `2000::/3` : Unicast global (Internet)
- `fc00::/7` : Unique local (√©quivalent √† 10.0.0.0/8)

**Adresses multicast :**
- `ff02::1` : Tous les n≈ìuds du lien local
- `ff02::2` : Tous les routeurs du lien local

### Configuration IPv6 sur Debian

#### V√©rifier le support IPv6

```bash
# V√©rifier que IPv6 est activ√©
cat /proc/sys/net/ipv6/conf/all/disable_ipv6

# 0 = activ√©, 1 = d√©sactiv√©

# Voir les adresses IPv6
ip -6 addr show
```

#### Configuration statique IPv6

```bash
# Dans /etc/network/interfaces
auto eno1
iface eno1 inet6 static
    address 2001:db8:1::100
    netmask 64
    gateway 2001:db8:1::1
    dns-nameservers 2001:4860:4860::8888 2001:4860:4860::8844
```

#### Configuration automatique IPv6

```bash
# Autoconfiguration SLAAC (Stateless Address Auto-Configuration)
auto eno1
iface eno1 inet6 auto

# Avec des options sp√©cifiques
auto eno1
iface eno1 inet6 auto
    # Accepter les Router Advertisements
    accept_ra 1
    # G√©n√©rer des adresses temporaires (privacy)
    autoconf 1
    privext 2
```

### Configuration dual-stack (IPv4 + IPv6)

Le **dual-stack** permet d'utiliser simultan√©ment IPv4 et IPv6 sur la m√™me interface.

```bash
# Configuration dual-stack dans /etc/network/interfaces
auto eno1

# Configuration IPv4
iface eno1 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4

# Configuration IPv6 sur la m√™me interface
iface eno1 inet6 static
    address 2001:db8:1::100
    netmask 64
    gateway 2001:db8:1::1
    dns-nameservers 2001:4860:4860::8888
```

### Outils de diagnostic IPv6

```bash
# Ping IPv6
ping6 2001:db8:1::1

# Traceroute IPv6
traceroute6 ipv6.google.com

# Informations des voisins IPv6
ip -6 neigh show

# Table de routage IPv6
ip -6 route show
```

### S√©curit√© IPv6

**Consid√©rations importantes :**
- Les firewalls doivent g√©rer IPv6 (ip6tables)
- Les adresses link-local sont toujours pr√©sentes
- Les tunnels IPv6 peuvent contourner les protections IPv4

```bash
# D√©sactiver IPv6 si n√©cessaire (non recommand√©)
echo 'net.ipv6.conf.all.disable_ipv6 = 1' >> /etc/sysctl.conf
echo 'net.ipv6.conf.default.disable_ipv6 = 1' >> /etc/sysctl.conf
```

---

## 5.1.4 VLAN et r√©seaux virtuels

### Comprendre les VLAN

Un **VLAN** (Virtual Local Area Network) permet de cr√©er des r√©seaux logiques s√©par√©s sur une m√™me infrastructure physique.

**Avantages des VLAN :**
- **Segmentation logique** : Isolation du trafic sans infrastructure suppl√©mentaire
- **S√©curit√©** : S√©paration des domaines de diffusion
- **Flexibilit√©** : R√©organisation sans modification physique
- **Performance** : R√©duction des domaines de collision

### Types de VLAN

**VLAN bas√©s sur les ports :**
- Configuration au niveau du switch
- Un port = un VLAN
- Simple mais peu flexible

**VLAN tagg√©s (802.1Q) :**
- Marquage des trames avec un ID VLAN
- Plusieurs VLAN sur un m√™me port
- Standard IEEE 802.1Q

### Configuration VLAN sur Debian

#### Pr√©requis : Installation du support VLAN

```bash
# Installer les outils VLAN
sudo apt update
sudo apt install vlan

# Charger le module 8021q
sudo modprobe 8021q

# Rendre permanent le chargement
echo "8021q" | sudo tee -a /etc/modules
```

#### Configuration de base d'un VLAN

```bash
# Dans /etc/network/interfaces

# Interface physique (trunk)
auto eth0
iface eth0 inet manual

# VLAN 10 - R√©seau administration
auto eth0.10
iface eth0.10 inet static
    address 192.168.10.100
    netmask 255.255.255.0
    vlan-raw-device eth0

# VLAN 20 - R√©seau utilisateurs
auto eth0.20
iface eth0.20 inet static
    address 192.168.20.100
    netmask 255.255.255.0
    vlan-raw-device eth0

# VLAN 30 - R√©seau DMZ
auto eth0.30
iface eth0.30 inet static
    address 192.168.30.100
    netmask 255.255.255.0
    vlan-raw-device eth0
```

#### Configuration VLAN avec NetworkManager

```bash
# Cr√©er un VLAN via nmcli
sudo nmcli connection add type vlan con-name vlan10 ifname eth0.10 dev eth0 id 10

# Configurer l'adresse IP
sudo nmcli connection modify vlan10 ipv4.addresses 192.168.10.100/24
sudo nmcli connection modify vlan10 ipv4.method manual

# Activer la connexion
sudo nmcli connection up vlan10
```

### Gestion des VLAN en ligne de commande

```bash
# Cr√©er un VLAN temporairement
sudo ip link add link eth0 name eth0.10 type vlan id 10
sudo ip addr add 192.168.10.100/24 dev eth0.10
sudo ip link set eth0.10 up

# Supprimer un VLAN
sudo ip link set eth0.10 down
sudo ip link delete eth0.10
```

### VLAN et s√©curit√©

**Bonnes pratiques :**
- S√©parer les r√©seaux par fonction (admin, users, DMZ)
- Utiliser des VLAN diff√©rents pour les services critiques
- Documenter le plan d'adressage VLAN
- Configurer le routage inter-VLAN de mani√®re s√©curis√©e

**Exemple de segmentation :**
```bash
# VLAN 10 - Administration (192.168.10.0/24)
# VLAN 20 - Utilisateurs (192.168.20.0/24)
# VLAN 30 - Serveurs (192.168.30.0/24)
# VLAN 40 - DMZ (192.168.40.0/24)
# VLAN 50 - Invit√©s (192.168.50.0/24)
```

### Bridges et r√©seaux virtuels

#### Cr√©ation d'un bridge Linux

Un **bridge** fonctionne comme un switch virtuel, connectant plusieurs interfaces.

```bash
# Installer les outils bridge
sudo apt install bridge-utils

# Cr√©er un bridge
sudo brctl addbr br0

# Ajouter des interfaces au bridge
sudo brctl addif br0 eth0
sudo brctl addif br0 eth1

# Activer le bridge
sudo ip link set br0 up

# Configuration IP du bridge
sudo ip addr add 192.168.1.100/24 dev br0
```

#### Configuration permanente du bridge

```bash
# Dans /etc/network/interfaces
auto br0
iface br0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    bridge_ports eth0 eth1
    bridge_stp off
    bridge_fd 0
    bridge_maxwait 0
```

---

## 5.1.5 NetworkManager vs systemd-networkd

### Comprendre les diff√©rents gestionnaires r√©seau

Debian propose plusieurs approches pour la gestion r√©seau, chacune avec ses avantages selon le contexte d'utilisation.

### Configuration traditionnelle (/etc/network/interfaces)

**Avantages :**
- Simple et direct
- Contr√¥le total sur la configuration
- Bien document√© et stable
- Id√©al pour les serveurs

**Inconv√©nients :**
- Pas de gestion dynamique
- Pas d'interface graphique
- Red√©marrage n√©cessaire pour les changements

```bash
# Exemple de configuration traditionnelle
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4
```

### NetworkManager

NetworkManager est un service qui g√®re automatiquement les connexions r√©seau, particuli√®rement adapt√© aux environnements desktop et mobiles.

#### Avantages de NetworkManager

- **Gestion dynamique** : Connexion/d√©connexion automatique
- **Interface utilisateur** : GUI et CLI int√©gr√©es
- **Support √©tendu** : WiFi, VPN, mobile, etc.
- **Profiles multiples** : Gestion de diff√©rentes configurations
- **D√©tection automatique** : D√©couverte des r√©seaux disponibles

#### Installation et activation

```bash
# Installation (g√©n√©ralement d√©j√† install√© sur desktop)
sudo apt update
sudo apt install network-manager

# V√©rifier le statut
sudo systemctl status NetworkManager

# Activer au d√©marrage
sudo systemctl enable NetworkManager
```

#### Utilisation de nmcli (NetworkManager CLI)

**Commandes de base :**
```bash
# Voir l'√©tat g√©n√©ral
nmcli general status

# Lister les connexions
nmcli connection show

# Lister les p√©riph√©riques
nmcli device status

# Informations d√©taill√©es sur une connexion
nmcli connection show "Wired connection 1"
```

**Gestion des connexions filaires :**
```bash
# Cr√©er une nouvelle connexion statique
sudo nmcli connection add type ethernet con-name "Bureau" ifname eth0 \
    ipv4.addresses 192.168.1.100/24 \
    ipv4.gateway 192.168.1.1 \
    ipv4.dns "8.8.8.8,8.8.4.4" \
    ipv4.method manual

# Cr√©er une connexion DHCP
sudo nmcli connection add type ethernet con-name "DHCP-Home" ifname eth0

# Activer une connexion
sudo nmcli connection up "Bureau"

# D√©sactiver une connexion
sudo nmcli connection down "Bureau"
```

**Gestion WiFi :**
```bash
# Scanner les r√©seaux WiFi
nmcli device wifi list

# Se connecter √† un r√©seau WiFi
sudo nmcli device wifi connect "MonReseauWiFi" password "motdepasse"

# Cr√©er un profil WiFi
sudo nmcli connection add type wifi con-name "MonWiFi" ifname wlan0 \
    ssid "MonReseauWiFi" wifi-sec.key-mgmt wpa-psk wifi-sec.psk "motdepasse"
```

#### Configuration avanc√©e avec NetworkManager

**VLAN avec NetworkManager :**
```bash
# Cr√©er un VLAN
sudo nmcli connection add type vlan con-name vlan-admin ifname eth0.10 \
    dev eth0 id 10 ip4 192.168.10.100/24

# Bridge avec NetworkManager
sudo nmcli connection add type bridge con-name br0 ifname br0
sudo nmcli connection add type bridge-slave con-name br0-eth0 ifname eth0 master br0
```

### systemd-networkd

systemd-networkd est le gestionnaire r√©seau int√©gr√© √† systemd, con√ßu pour √™tre l√©ger et efficace.

#### Avantages de systemd-networkd

- **Int√©gration systemd** : Coh√©rence avec l'√©cosyst√®me systemd
- **Performance** : L√©ger et rapide
- **Configuration d√©clarative** : Fichiers de configuration clairs
- **Id√©al pour serveurs** : Pas d'interface graphique, focus sur la stabilit√©

#### Activation de systemd-networkd

```bash
# D√©sactiver NetworkManager (si n√©cessaire)
sudo systemctl disable NetworkManager
sudo systemctl stop NetworkManager

# Activer systemd-networkd
sudo systemctl enable systemd-networkd
sudo systemctl start systemd-networkd

# Activer la r√©solution DNS
sudo systemctl enable systemd-resolved
sudo systemctl start systemd-resolved
```

#### Configuration avec systemd-networkd

Les fichiers de configuration sont dans `/etc/systemd/network/`.

**Configuration d'interface statique :**
```bash
# /etc/systemd/network/10-eth0.network
[Match]
Name=eth0

[Network]
Address=192.168.1.100/24
Gateway=192.168.1.1
DNS=8.8.8.8
DNS=8.8.4.4
```

**Configuration DHCP :**
```bash
# /etc/systemd/network/20-dhcp.network
[Match]
Name=eth*

[Network]
DHCP=ipv4
```

**Configuration VLAN :**
```bash
# /etc/systemd/network/10-eth0.netdev
[NetDev]
Name=vlan10
Kind=vlan

[VLAN]
Id=10

# /etc/systemd/network/11-vlan10.network
[Match]
Name=vlan10

[Network]
Address=192.168.10.100/24
```

#### Gestion et diagnostic

```bash
# Red√©marrer la configuration r√©seau
sudo systemctl restart systemd-networkd

# Voir l'√©tat des interfaces
networkctl status

# D√©tails d'une interface sp√©cifique
networkctl status eth0

# Recharger la configuration
sudo networkctl reload
```

### Comparaison et choix

| Crit√®re | /etc/network/interfaces | NetworkManager | systemd-networkd |
|---------|-------------------------|----------------|------------------|
| **Simplicit√©** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **Fonctionnalit√©s** | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê |
| **Performance** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **Desktop/Mobile** | ‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê |
| **Serveur** | ‚≠ê‚≠ê‚≠ê | ‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **WiFi/VPN** | ‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê |

**Recommandations :**
- **Serveurs stables** : `/etc/network/interfaces` ou `systemd-networkd`
- **Desktops/Laptops** : `NetworkManager`
- **Conteneurs/Cloud** : `systemd-networkd`
- **Environnements mixtes** : `NetworkManager` avec nmcli

---

## 5.1.6 Diagnostic r√©seau

Le diagnostic r√©seau est une comp√©tence essentielle pour tout administrateur syst√®me. Cette section couvre les outils et techniques pour identifier et r√©soudre les probl√®mes r√©seau.

### M√©thodologie de diagnostic

#### Approche en couches (mod√®le OSI)

**Couche 1 - Physique :**
- C√¢bles, connecteurs, liens
- √âtat des interfaces r√©seau

**Couche 2 - Liaison :**
- Adresses MAC, switches
- VLAN, bridges

**Couche 3 - R√©seau :**
- Adresses IP, routage
- Passerelles, sous-r√©seaux

**Couche 4 - Transport :**
- Ports TCP/UDP
- Connexions √©tablies

### Outils de diagnostic de base

#### Commande ip (remplace ifconfig)

```bash
# Voir toutes les interfaces
ip link show

# Voir les adresses IP
ip addr show

# Voir les routes
ip route show

# Statistiques des interfaces
ip -s link show

# Voir les voisins ARP
ip neigh show
```

#### Tests de connectivit√©

**ping - Test de connectivit√© de base :**
```bash
# Test local
ping 127.0.0.1

# Test passerelle
ping 192.168.1.1

# Test DNS
ping google.com

# Options utiles
ping -c 4 google.com          # 4 paquets seulement
ping -i 0.2 google.com        # Intervalle de 0.2s
ping -s 1472 google.com       # Taille de paquet sp√©cifique
```

**traceroute - Tracer le chemin r√©seau :**
```bash
# Installation
sudo apt install traceroute

# Tracer vers une destination
traceroute google.com

# Avec num√©ros de ports
traceroute -n google.com

# UDP (par d√©faut) vs ICMP vs TCP
traceroute -I google.com      # ICMP
traceroute -T -p 80 google.com # TCP port 80
```

#### R√©solution DNS

```bash
# Test de r√©solution DNS
nslookup google.com

# Outil plus moderne
dig google.com

# Test inverse (IP vers nom)
dig -x 8.8.8.8

# Requ√™te sp√©cifique
dig @8.8.8.8 google.com MX    # Enregistrements mail via serveur 8.8.8.8

# Trace compl√®te de r√©solution
dig +trace google.com

# R√©ponse courte
dig +short google.com

# Tous les types d'enregistrements
dig google.com ANY
```

**host - Alternative simple :**
```bash
# R√©solution basique
host google.com

# Type sp√©cifique
host -t MX google.com

# Serveur DNS sp√©cifique
host google.com 8.8.8.8
```

### Outils d'analyse r√©seau avanc√©s

#### netstat - Statistiques r√©seau

```bash
# Connexions TCP actives
netstat -tuln

# Avec les processus
sudo netstat -tulnp

# Statistiques des interfaces
netstat -i

# Table de routage
netstat -rn

# Statistiques par protocole
netstat -s
```

**Options importantes :**
- `-t` : Connexions TCP
- `-u` : Connexions UDP
- `-l` : Ports en √©coute
- `-n` : Affichage num√©rique (pas de r√©solution DNS)
- `-p` : Afficher les PID/noms des processus

#### ss - Rempla√ßant moderne de netstat

```bash
# Toutes les connexions
ss -tuln

# Connexions √©tablies
ss -o state established

# Connexions par processus
ss -p

# Filtrage avanc√©
ss -t state established '( dport = :ssh or sport = :ssh )'

# Statistiques d√©taill√©es
ss -s
```

#### lsof - Voir les fichiers ouverts (y compris r√©seau)

```bash
# Installation
sudo apt install lsof

# Connexions r√©seau d'un processus
lsof -i -p 1234

# Qui utilise un port sp√©cifique
sudo lsof -i :80

# Connexions d'un utilisateur
lsof -u www-data -i

# Toutes les connexions r√©seau
lsof -i
```

### Analyse du trafic r√©seau

#### tcpdump - Capture de paquets en ligne de commande

```bash
# Installation
sudo apt install tcpdump

# Capture basique sur toutes les interfaces
sudo tcpdump

# Capture sur une interface sp√©cifique
sudo tcpdump -i eth0

# Sauvegarder dans un fichier
sudo tcpdump -i eth0 -w capture.pcap

# Lire un fichier de capture
tcpdump -r capture.pcap

# Filtres courants
sudo tcpdump -i eth0 host 192.168.1.100          # Trafic d'un h√¥te
sudo tcpdump -i eth0 port 80                     # Trafic HTTP
sudo tcpdump -i eth0 tcp and port 22             # SSH uniquement
sudo tcpdump -i eth0 icmp                        # Ping seulement
sudo tcpdump -i eth0 -c 100                      # 100 paquets maximum
```

**Filtres avanc√©s :**
```bash
# Trafic entre deux h√¥tes
sudo tcpdump -i eth0 host 192.168.1.10 and host 192.168.1.20

# Exclusion du trafic SSH (pour √©viter la boucle)
sudo tcpdump -i eth0 not port 22

# Trafic HTTP avec contenu
sudo tcpdump -i eth0 -A port 80

# Nouveaux √©tablissements de connexion TCP
sudo tcpdump -i eth0 'tcp[tcpflags] & (tcp-syn) != 0'
```

#### Wireshark - Analyse graphique de paquets

```bash
# Installation
sudo apt update
sudo apt install wireshark

# Permettre aux utilisateurs non-root d'utiliser Wireshark
sudo usermod -a -G wireshark $USER

# D√©marrage
wireshark
```

**Avantages de Wireshark :**
- Interface graphique intuitive
- D√©codage automatique des protocoles
- Filtres visuels puissants
- Analyse statistique avanc√©e
- Export dans de nombreux formats

### Diagnostic des performances r√©seau

#### iperf3 - Test de bande passante

```bash
# Installation
sudo apt install iperf3

# Serveur (machine de destination)
iperf3 -s

# Client (test depuis cette machine)
iperf3 -c 192.168.1.100

# Test UDP avec bande passante sp√©cifique
iperf3 -c 192.168.1.100 -u -b 100M

# Test bidirectionnel
iperf3 -c 192.168.1.100 --bidir

# Test avec plusieurs connexions parall√®les
iperf3 -c 192.168.1.100 -P 4

# Dur√©e de test personnalis√©e
iperf3 -c 192.168.1.100 -t 60
```

#### mtr - Combinaison de ping et traceroute

```bash
# Installation
sudo apt install mtr

# Test interactif
mtr google.com

# Rapport apr√®s 10 cycles
mtr --report --report-cycles 10 google.com

# Sans r√©solution DNS
mtr -n google.com

# Intervalle personnalis√©
mtr -i 0.1 google.com
```

### Diagnostic des probl√®mes courants

#### Probl√®me de connectivit√© - Approche syst√©matique

**1. V√©rifier l'interface physique :**
```bash
# √âtat de l'interface
ip link show eth0

# Si l'interface est DOWN
sudo ip link set eth0 up

# V√©rifier les c√¢bles (si possible)
ethtool eth0
```

**2. V√©rifier la configuration IP :**
```bash
# Adresse IP pr√©sente ?
ip addr show eth0

# Si pas d'adresse, relancer DHCP
sudo dhclient eth0

# Ou configurer manuellement
sudo ip addr add 192.168.1.100/24 dev eth0
```

**3. Tester la connectivit√© locale :**
```bash
# Test loopback
ping 127.0.0.1

# Test interface locale
ping 192.168.1.100

# Test passerelle
ping 192.168.1.1
```

**4. Tester la r√©solution DNS :**
```bash
# Test avec IP
ping 8.8.8.8

# Test avec nom
ping google.com

# Si DNS ne fonctionne pas
dig @8.8.8.8 google.com
```

#### Probl√®mes de performance - Diagnostic

**1. Identifier les goulots d'√©tranglement :**
```bash
# Utilisation des interfaces
sudo iftop

# Connexions actives par bande passante
sudo nethogs

# Statistiques en temps r√©el
ip -s -h monitor link
```

**2. V√©rifier la latence :**
```bash
# Latence vers la passerelle
ping -c 10 192.168.1.1

# Latence vers Internet
ping -c 10 8.8.8.8

# Variation de latence (jitter)
mtr --report --report-cycles 100 8.8.8.8
```

**3. Tester la bande passante :**
```bash
# Test local (entre deux machines)
# Machine A (serveur)
iperf3 -s

# Machine B (client)
iperf3 -c <IP-machine-A>

# Test Internet (avec serveurs publics)
curl -o /dev/null http://speedtest.wdc01.softlayer.com/downloads/test500.zip
```

### Outils de monitoring r√©seau

#### Installation des outils essentiels

```bash
# Suite compl√®te d'outils r√©seau
sudo apt update
sudo apt install \
    net-tools \
    iproute2 \
    iputils-ping \
    traceroute \
    tcpdump \
    nmap \
    iftop \
    nethogs \
    ethtool \
    mtr-tiny \
    dnsutils
```

#### iftop - Monitoring du trafic par connexion

```bash
# Installation
sudo apt install iftop

# Utilisation basique
sudo iftop

# Interface sp√©cifique
sudo iftop -i eth0

# R√©solution DNS d√©sactiv√©e
sudo iftop -n

# Affichage des ports
sudo iftop -P
```

#### nethogs - Monitoring par processus

```bash
# Installation
sudo apt install nethogs

# Utilisation basique
sudo nethogs

# Interface sp√©cifique
sudo nethogs eth0

# D√©lai de rafra√Æchissement
sudo nethogs -d 1
```

#### nmap - Scan r√©seau et audit de s√©curit√©

```bash
# Installation
sudo apt install nmap

# Scan de base d'un h√¥te
nmap 192.168.1.100

# Scan d'un sous-r√©seau
nmap 192.168.1.0/24

# Scan des ports les plus courants
nmap -F 192.168.1.100

# D√©tection du syst√®me d'exploitation
sudo nmap -O 192.168.1.100

# Scan complet avec scripts
sudo nmap -A 192.168.1.100

# Scan sans ping (h√¥tes qui ne r√©pondent pas au ping)
nmap -Pn 192.168.1.100
```

### Scripts de diagnostic automatis√©

#### Script de test de connectivit√©

```bash
#!/bin/bash
# /usr/local/bin/network-test.sh

echo "=== Test de connectivit√© r√©seau ==="
echo "Date: $(date)"
echo

# Test de l'interface
echo "1. √âtat des interfaces:"
ip link show | grep -E "^[0-9]+:" | awk '{print $2}' | tr -d ':'

echo
echo "2. Adresses IP:"
ip addr show | grep -E "inet " | grep -v "127.0.0.1"

# Test de connectivit√©
echo
echo "3. Test de connectivit√©:"

# Passerelle par d√©faut
GW=$(ip route | grep default | awk '{print $3}' | head -1)
if [ -n "$GW" ]; then
    echo -n "Passerelle ($GW): "
    if ping -c 1 -W 2 $GW >/dev/null 2>&1; then
        echo "OK"
    else
        echo "ECHEC"
    fi
fi

# DNS
echo -n "DNS (8.8.8.8): "
if ping -c 1 -W 2 8.8.8.8 >/dev/null 2>&1; then
    echo "OK"
else
    echo "ECHEC"
fi

# R√©solution DNS
echo -n "R√©solution DNS: "
if dig +short google.com >/dev/null 2>&1; then
    echo "OK"
else
    echo "ECHEC"
fi

echo
echo "4. Table de routage:"
ip route show

echo
echo "=== Fin du test ==="
```

```bash
# Rendre le script ex√©cutable
sudo chmod +x /usr/local/bin/network-test.sh

# Utilisation
sudo /usr/local/bin/network-test.sh
```

#### Script de diagnostic approfondi

```bash
#!/bin/bash
# /usr/local/bin/network-diagnostic.sh

LOG_FILE="/var/log/network-diagnostic.log"

echo "=== Diagnostic r√©seau approfondi ===" | tee -a $LOG_FILE
echo "Date: $(date)" | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Informations syst√®me
echo "=== Informations syst√®me ===" | tee -a $LOG_FILE
uname -a | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Interfaces r√©seau
echo "=== Interfaces r√©seau ===" | tee -a $LOG_FILE
ip link show | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Adresses IP
echo "=== Adresses IP ===" | tee -a $LOG_FILE
ip addr show | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Routes
echo "=== Table de routage ===" | tee -a $LOG_FILE
ip route show | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# DNS
echo "=== Configuration DNS ===" | tee -a $LOG_FILE
cat /etc/resolv.conf | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Connexions actives
echo "=== Connexions actives ===" | tee -a $LOG_FILE
ss -tuln | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Statistiques r√©seau
echo "=== Statistiques des interfaces ===" | tee -a $LOG_FILE
ip -s link show | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

echo "Diagnostic sauvegard√© dans $LOG_FILE"
```

### Logs r√©seau et troubleshooting

#### Localisation des logs importants

```bash
# Logs syst√®me g√©n√©raux
sudo tail -f /var/log/syslog

# Logs kernel (incluant r√©seau)
sudo dmesg | grep -i network

# Logs NetworkManager
sudo journalctl -u NetworkManager -f

# Logs DHCP client
sudo journalctl -u dhclient -f

# Logs systemd-networkd
sudo journalctl -u systemd-networkd -f
```

#### Activation du debug pour NetworkManager

```bash
# √âditer la configuration
sudo nano /etc/NetworkManager/NetworkManager.conf

# Ajouter la section debug
[logging]
level=DEBUG
domains=ALL

# Red√©marrer NetworkManager
sudo systemctl restart NetworkManager

# Voir les logs d√©taill√©s
sudo journalctl -u NetworkManager -f
```

### D√©pannage par sympt√¥mes

#### "Pas d'acc√®s Internet"

**1. V√©rifications de base :**
```bash
# Interface active ?
ip link show

# Adresse IP attribu√©e ?
ip addr show

# Passerelle configur√©e ?
ip route show | grep default
```

**2. Tests de connectivit√© progressifs :**
```bash
# Local
ping 127.0.0.1

# Passerelle
ping $(ip route | grep default | awk '{print $3}' | head -1)

# DNS public
ping 8.8.8.8

# R√©solution DNS
ping google.com
```

#### "Lenteur r√©seau"

**1. Mesurer les performances :**
```bash
# Bande passante
iperf3 -c speedtest.example.com

# Latence
ping -c 100 8.8.8.8

# Perte de paquets
mtr --report --report-cycles 100 8.8.8.8
```

**2. Identifier les consommateurs :**
```bash
# Par processus
sudo nethogs

# Par connexion
sudo iftop

# Statistiques interfaces
ip -s link show
```

#### "Connexions qui se ferment"

**1. V√©rifier les timeouts :**
```bash
# Param√®tres TCP
cat /proc/sys/net/ipv4/tcp_keepalive_time
cat /proc/sys/net/ipv4/tcp_keepalive_probes

# Connexions en timeout
ss -o state time-wait
```

**2. Analyser avec tcpdump :**
```bash
# Capture des RST/FIN
sudo tcpdump -i any 'tcp[tcpflags] & (tcp-rst|tcp-fin) != 0'
```

### Outils de validation et test

#### Validation de la configuration

```bash
#!/bin/bash
# Script de validation r√©seau

echo "=== Validation de la configuration r√©seau ==="

# Fonction de test
test_connectivity() {
    local host=$1
    local desc=$2

    if ping -c 1 -W 2 $host >/dev/null 2>&1; then
        echo "‚úì $desc ($host) - OK"
        return 0
    else
        echo "‚úó $desc ($host) - ECHEC"
        return 1
    fi
}

# Tests
ERRORS=0

# Interface active
if ip link show | grep -q "state UP"; then
    echo "‚úì Au moins une interface active - OK"
else
    echo "‚úó Aucune interface active - ECHEC"
    ((ERRORS++))
fi

# Adresse IP
if ip addr show | grep -q "inet.*scope global"; then
    echo "‚úì Adresse IP configur√©e - OK"
else
    echo "‚úó Pas d'adresse IP - ECHEC"
    ((ERRORS++))
fi

# Passerelle
GW=$(ip route | grep default | awk '{print $3}' | head -1)
if [ -n "$GW" ]; then
    test_connectivity $GW "Passerelle par d√©faut" || ((ERRORS++))
else
    echo "‚úó Pas de passerelle par d√©faut - ECHEC"
    ((ERRORS++))
fi

# DNS
test_connectivity "8.8.8.8" "Serveur DNS public" || ((ERRORS++))

# R√©solution DNS
if nslookup google.com >/dev/null 2>&1; then
    echo "‚úì R√©solution DNS - OK"
else
    echo "‚úó R√©solution DNS - ECHEC"
    ((ERRORS++))
fi

# Internet
test_connectivity "google.com" "Acc√®s Internet" || ((ERRORS++))

echo
if [ $ERRORS -eq 0 ]; then
    echo "üéâ Tous les tests sont pass√©s avec succ√®s !"
    exit 0
else
    echo "‚ö†Ô∏è $ERRORS erreur(s) d√©tect√©e(s)"
    exit 1
fi
```

### Bonnes pratiques de diagnostic

#### M√©thodologie syst√©matique

**1. Collecter les informations :**
- Sympt√¥mes exacts
- Moment d'apparition
- Changements r√©cents
- Environnement r√©seau

**2. Reproduire le probl√®me :**
- Dans un environnement contr√¥l√©
- Avec des outils de mesure
- En documentant les observations

**3. Isoler la cause :**
- Tests par couches (OSI)
- √âlimination progressive
- Comparaison avec un syst√®me fonctionnel

**4. Appliquer la solution :**
- Test en environnement de d√©veloppement
- Application progressive
- Validation compl√®te

#### Documentation des probl√®mes

```bash
# Template de rapport d'incident r√©seau
cat > /tmp/incident-template.md << 'EOF'
# Rapport d'incident r√©seau

## Informations g√©n√©rales
- **Date/Heure:**
- **Dur√©e:**
- **Impact:**
- **Priorit√©:**

## Description du probl√®me
- **Sympt√¥mes observ√©s:**
- **Syst√®mes affect√©s:**
- **Utilisateurs impact√©s:**

## Environnement
- **OS:** $(uname -a)
- **R√©seau:**
- **Mat√©riel:**

## Investigation
### Tests effectu√©s
```bash
# Commandes de diagnostic utilis√©es

```

### R√©sultats
```

### Cause identifi√©e


## Solution appliqu√©e


## Pr√©vention
- **Actions pr√©ventives:**
- **Monitoring ajout√©:**
- **Documentation mise √† jour:**

## Suivi
- [ ] Solution valid√©e
- [ ] Monitoring en place
- [ ] Documentation mise √† jour
- [ ] Post-mortem planifi√©
EOF
```

### Ressources et r√©f√©rences

#### Documentation officielle
- **Debian Network Configuration:** https://wiki.debian.org/NetworkConfiguration
- **ip command manual:** `man ip`
- **NetworkManager documentation:** https://networkmanager.dev/

#### Outils recommand√©s
- **Diagnostic de base:** ip, ping, traceroute, dig
- **Analyse avanc√©e:** tcpdump, wireshark, nmap
- **Monitoring:** iftop, nethogs, mtr
- **Performance:** iperf3, speedtest-cli

#### Commandes de r√©f√©rence rapide

```bash
# Diagnostic rapide
ip a                          # Adresses IP
ip r                          # Routes
ss -tuln                      # Ports ouverts
ping -c 3 8.8.8.8            # Test connectivit√©
dig google.com                # Test DNS

# Analyse approfondie
sudo tcpdump -i any icmp      # Capture ping
sudo netstat -i               # Statistiques interfaces
mtr google.com                # Test latence/perte
nmap -sn 192.168.1.0/24      # Scan r√©seau local
```

---

## Conclusion de la section 5.1

La configuration r√©seau avanc√©e constitue la fondation de toute infrastructure moderne. Les concepts et outils pr√©sent√©s dans cette section vous permettront de :

### Comp√©tences acquises
- **Ma√Ætriser** les interfaces r√©seau complexes (bonding, teaming, VLAN)
- **Configurer** efficacement IPv4 et IPv6 en dual-stack
- **Choisir** le bon gestionnaire r√©seau selon le contexte
- **Diagnostiquer** rapidement les probl√®mes de connectivit√©
- **Monitorer** les performances r√©seau

### Prochaines √©tapes
Ces fondations vous pr√©parent aux sections suivantes du Module 5 :
- **5.2 Pare-feu et s√©curit√©** : Protection de votre infrastructure r√©seau
- **5.3 SSH et acc√®s distant** : Connexions s√©curis√©es
- **5.4 VPN et chiffrement** : Communications s√©curis√©es

La ma√Ætrise de cette section est essentielle pour aborder sereinement l'administration de services r√©seau avanc√©s dans les modules suivants.

‚è≠Ô∏è
