üîù Retour au [Sommaire](/SOMMAIRE.md)

# 4.2 Dpkg et paquets .deb

Dpkg (Debian Package) est le gestionnaire de paquets de bas niveau qui constitue la fondation du syst√®me de paquets Debian. Si APT est comme un chef d'orchestre qui coordonne tout, dpkg est comme le musicien qui joue r√©ellement les notes. Comprendre dpkg vous permettra d'avoir un contr√¥le plus fin sur votre syst√®me et de r√©soudre des probl√®mes complexes.

## Qu'est-ce que dpkg ?

Dpkg est l'outil fondamental qui :
- **Installe** et **supprime** les paquets .deb
- **Maintient** la base de donn√©es des paquets install√©s
- **G√®re** les scripts de pr√©/post-installation
- **V√©rifie** l'int√©grit√© des paquets

### Relation entre APT et dpkg

```
Utilisateur
    ‚Üì (commande apt install)
  APT
    ‚Üì (r√©solution des d√©pendances, t√©l√©chargement)
  dpkg
    ‚Üì (installation r√©elle)
Syst√®me de fichiers
```

APT utilise dpkg en arri√®re-plan, mais vous pouvez aussi utiliser dpkg directement pour des op√©rations sp√©cifiques.

## Structure d'un paquet .deb

Un fichier .deb est en r√©alit√© une archive qui contient :

```bash
# Voir le contenu d'un paquet .deb
dpkg -c paquet.deb

# Structure interne :
# control.tar.gz  ‚Üí M√©tadonn√©es et scripts
# data.tar.gz     ‚Üí Fichiers √† installer
# debian-binary   ‚Üí Version du format
```

### M√©tadonn√©es importantes

```bash
# Voir les informations d'un paquet
dpkg -I paquet.deb

# Informations typiques :
# Package: nom-du-paquet
# Version: 1.0.0-1
# Architecture: amd64
# Maintainer: D√©veloppeur <email@exemple.com>
# Depends: libc6, libssl1.1
# Description: Description du paquet
```

## 4.2.1 Installation manuelle de paquets

### Installation de base avec dpkg

```bash
# Installer un paquet .deb
sudo dpkg -i paquet.deb

# Installer plusieurs paquets
sudo dpkg -i paquet1.deb paquet2.deb paquet3.deb

# Installer depuis un r√©pertoire
sudo dpkg -i /chemin/vers/paquets/*.deb
```

### Options utiles pour l'installation

```bash
# Installation forc√©e (attention, dangereuse !)
sudo dpkg -i --force-depends paquet.deb

# Simulation (voir ce qui serait fait)
dpkg --simulate -i paquet.deb

# Installation avec verbosit√©
sudo dpkg -i --debug=1 paquet.deb
```

### V√©rification avant installation

```bash
# Examiner le contenu d'un paquet
dpkg -c paquet.deb

# Voir les informations d√©taill√©es
dpkg -I paquet.deb

# V√©rifier l'architecture
dpkg -I paquet.deb | grep Architecture

# V√©rifier les d√©pendances
dpkg -I paquet.deb | grep Depends
```

### Gestion des erreurs d'installation

#### Probl√®me de d√©pendances

```bash
# Erreur typique :
# dpkg: dependency problems prevent configuration of paquet:
#  paquet depends on libexemple; however:
#   Package libexemple is not installed.

# Solutions :
# 1. Installer les d√©pendances manuellement
sudo apt install libexemple

# 2. Utiliser apt pour r√©soudre automatiquement
sudo apt install -f

# 3. Utiliser gdebi (voir section 4.2.4)
sudo gdebi paquet.deb
```

#### Paquet partiellement install√©

```bash
# Voir les paquets avec probl√®mes
dpkg -l | grep "^.i"

# Reconfigurer un paquet probl√©matique
sudo dpkg --configure nom-du-paquet

# Reconfigurer tous les paquets non configur√©s
sudo dpkg --configure -a
```

### Suppression de paquets

```bash
# Supprimer un paquet (garder la configuration)
sudo dpkg -r nom-du-paquet

# Purger compl√®tement (supprimer aussi la configuration)
sudo dpkg -P nom-du-paquet

# Forcer la suppression (attention !)
sudo dpkg --force-remove-essential -r paquet-syst√®me
```

### Consultation des paquets install√©s

```bash
# Lister tous les paquets install√©s
dpkg -l

# Rechercher un paquet sp√©cifique
dpkg -l | grep firefox

# Voir les d√©tails d'un paquet install√©
dpkg -s nom-du-paquet

# Voir les fichiers install√©s par un paquet
dpkg -L nom-du-paquet

# Trouver quel paquet contient un fichier
dpkg -S /usr/bin/firefox
```

### √âtats des paquets

| Code | √âtat | Description |
|------|------|-------------|
| ii | Install√© correctement | Paquet install√© et configur√© |
| rc | Supprim√©, config restante | Paquet supprim√©, configuration pr√©sente |
| pn | Purg√© | Paquet compl√®tement supprim√© |
| iU | Install√©, non configur√© | Installation incompl√®te |
| iF | Installation √©chou√©e | Probl√®me pendant l'installation |

## 4.2.2 Cr√©ation de paquets personnalis√©s

### Pourquoi cr√©er ses propres paquets ?

- **Standardisation** : D√©ploiement uniforme sur plusieurs machines
- **Maintenance** : Mises √† jour et suppressions propres
- **Documentation** : M√©tadonn√©es int√©gr√©es
- **D√©pendances** : Gestion automatique des pr√©requis

### Structure d'un projet de paquet

```bash
# Cr√©er la structure de base
mkdir mon-paquet-1.0.0
cd mon-paquet-1.0.0
mkdir -p DEBIAN usr/local/bin usr/share/doc/mon-paquet

# Structure finale :
mon-paquet-1.0.0/
‚îú‚îÄ‚îÄ DEBIAN/
‚îÇ   ‚îú‚îÄ‚îÄ control          # M√©tadonn√©es du paquet
‚îÇ   ‚îú‚îÄ‚îÄ preinst          # Script avant installation
‚îÇ   ‚îú‚îÄ‚îÄ postinst         # Script apr√®s installation
‚îÇ   ‚îú‚îÄ‚îÄ prerm            # Script avant suppression
‚îÇ   ‚îî‚îÄ‚îÄ postrm           # Script apr√®s suppression
‚îî‚îÄ‚îÄ usr/
    ‚îú‚îÄ‚îÄ local/bin/       # Ex√©cutables
    ‚îî‚îÄ‚îÄ share/doc/mon-paquet/  # Documentation
```

### Fichier control (obligatoire)

```bash
# Cr√©er le fichier de contr√¥le
nano DEBIAN/control

# Contenu exemple :
Package: mon-paquet
Version: 1.0.0-1
Section: utils
Priority: optional
Architecture: all
Depends: bash (>= 4.0), curl
Maintainer: Votre Nom <votre@email.com>
Description: Mon paquet personnalis√©
 Une description plus longue de ce que fait
 le paquet, avec des d√©tails sur ses fonctionnalit√©s
 et son utilisation.
Homepage: https://github.com/votrecompte/mon-paquet
```

### Champs importants du fichier control

| Champ | Description | Exemple |
|-------|-------------|---------|
| Package | Nom unique du paquet | mon-application |
| Version | Num√©ro de version | 1.2.3-1 |
| Architecture | Architecture cible | all, amd64, i386 |
| Depends | D√©pendances obligatoires | bash, python3 |
| Recommends | D√©pendances recommand√©es | curl, wget |
| Suggests | D√©pendances sugg√©r√©es | git, vim |
| Conflicts | Paquets incompatibles | ancien-paquet |
| Replaces | Paquets remplac√©s | vieux-paquet |

### Scripts de maintenance

#### Script postinst (apr√®s installation)

```bash
# DEBIAN/postinst
#!/bin/bash
set -e

case "$1" in
    configure)
        # Cr√©ation d'un utilisateur syst√®me si n√©cessaire
        if ! getent passwd mon-service >/dev/null; then
            useradd -r -s /bin/false -d /var/lib/mon-service mon-service
        fi

        # Cr√©ation des r√©pertoires
        mkdir -p /var/log/mon-service
        chown mon-service:mon-service /var/log/mon-service

        # Configuration du service
        systemctl daemon-reload
        systemctl enable mon-service
        systemctl start mon-service
        ;;
esac

exit 0
```

#### Script prerm (avant suppression)

```bash
# DEBIAN/prerm
#!/bin/bash
set -e

case "$1" in
    remove)
        # Arr√™ter le service
        systemctl stop mon-service || true
        systemctl disable mon-service || true
        ;;
esac

exit 0
```

#### Script postrm (apr√®s suppression)

```bash
# DEBIAN/postrm
#!/bin/bash
set -e

case "$1" in
    purge)
        # Suppression compl√®te des donn√©es
        rm -rf /var/lib/mon-service
        rm -rf /var/log/mon-service

        # Suppression de l'utilisateur
        if getent passwd mon-service >/dev/null; then
            userdel mon-service
        fi
        ;;
esac

exit 0
```

### Ajout des fichiers du programme

```bash
# Copier votre script principal
cp mon-script.sh usr/local/bin/mon-script
chmod 755 usr/local/bin/mon-script

# Ajouter la documentation
echo "Mon paquet version 1.0.0" > usr/share/doc/mon-paquet/README
cp CHANGELOG usr/share/doc/mon-paquet/
cp LICENSE usr/share/doc/mon-paquet/copyright
```

### Construction du paquet

```bash
# V√©rifier les permissions
chmod 755 DEBIAN/postinst DEBIAN/prerm DEBIAN/postrm

# Construire le paquet
dpkg-deb --build mon-paquet-1.0.0

# Le fichier mon-paquet-1.0.0.deb est cr√©√©
```

### V√©rification du paquet cr√©√©

```bash
# V√©rifier la structure
dpkg -c mon-paquet-1.0.0.deb

# V√©rifier les m√©tadonn√©es
dpkg -I mon-paquet-1.0.0.deb

# Tester l'installation
sudo dpkg -i mon-paquet-1.0.0.deb
```

### Outils avanc√©s pour la cr√©ation

#### debhelper (pour des paquets complexes)

```bash
# Installer les outils de d√©veloppement
sudo apt install build-essential devscripts debhelper

# Cr√©er un squelette de paquet
dh_make --single --native --packagename mon-paquet_1.0.0

# Construction avec debuild
debuild -us -uc
```

## 4.2.3 R√©solution des d√©pendances

### Comprendre les d√©pendances

Les d√©pendances sont les autres paquets n√©cessaires au bon fonctionnement d'un paquet. C'est comme une recette de cuisine : vous avez besoin de tous les ingr√©dients pour r√©ussir le plat.

### Types de d√©pendances

```bash
# Dans le fichier control :
Depends: paquet-obligatoire (>= 1.0)          # Obligatoire
Pre-Depends: paquet-avant-installation        # Obligatoire avant m√™me l'installation
Recommends: paquet-recommande                 # Fortement recommand√©
Suggests: paquet-suggere                      # Peut √™tre utile
Enhances: paquet-ameliore                     # Am√©liore un autre paquet
Conflicts: paquet-incompatible                # Incompatible
Breaks: paquet-casse (< 2.0)                 # Casse une version sp√©cifique
Replaces: ancien-paquet                       # Remplace un autre paquet
```

### Probl√®mes de d√©pendances courants

#### D√©pendances non satisfaites

```bash
# Erreur typique :
# Errors were encountered while processing:
#  /var/cache/apt/archives/paquet_1.0_amd64.deb
# E: Sub-process /usr/bin/dpkg returned an error code (1)

# Diagnostic :
sudo apt --fix-broken install

# Ou forcer l'installation (risqu√©) :
sudo dpkg -i --force-depends paquet.deb
```

#### Conflits de paquets

```bash
# Quand deux paquets sont incompatibles
# Erreur : paquet-a conflicts with paquet-b

# Solutions :
# 1. Supprimer le paquet conflictuel
sudo apt remove paquet-b
sudo dpkg -i paquet-a.deb

# 2. V√©rifier s'il existe une alternative
apt search "alternative √† paquet-b"
```

#### D√©pendances circulaires

```bash
# Quand A d√©pend de B et B d√©pend de A
# Solution : installer simultan√©ment
sudo dpkg -i paquet-a.deb paquet-b.deb
```

### Outils de diagnostic des d√©pendances

```bash
# Voir l'arbre des d√©pendances
apt-cache depends --recurse --no-recommends firefox

# Voir quels paquets d√©pendent d'un paquet
apt-cache rdepends libc6

# V√©rifier les d√©pendances cass√©es
sudo apt check

# Simuler une installation pour voir les probl√®mes
apt install --simulate paquet-problematique
```

### R√©solution manuelle des d√©pendances

```bash
# 1. Identifier les d√©pendances manquantes
dpkg -I paquet.deb | grep Depends

# 2. Installer les d√©pendances une par une
sudo apt install dependance1 dependance2

# 3. Installer le paquet principal
sudo dpkg -i paquet.deb

# 4. R√©soudre les probl√®mes restants
sudo apt install -f
```

### For√ßage des installations (√† utiliser avec pr√©caution)

```bash
# Options de for√ßage courantes :
--force-depends        # Ignorer les d√©pendances
--force-conflicts      # Ignorer les conflits
--force-overwrite      # √âcraser les fichiers existants
--force-downgrade      # Permettre la r√©trogradation

# Exemple (DANGEREUX) :
sudo dpkg -i --force-depends --force-conflicts paquet.deb
```

## 4.2.4 Outils compl√©mentaires (gdebi, dpkg-reconfigure)

### Gdebi - Installateur graphique intelligent

Gdebi est un outil qui combine la simplicit√© de dpkg avec l'intelligence d'APT pour r√©soudre automatiquement les d√©pendances.

#### Installation de gdebi

```bash
# Version en ligne de commande
sudo apt install gdebi-core

# Version graphique (pour environnements de bureau)
sudo apt install gdebi
```

#### Utilisation de gdebi

```bash
# Installation avec r√©solution automatique des d√©pendances
sudo gdebi paquet.deb

# Simulation pour voir ce qui serait install√©
gdebi --option=APT::Get::Simulate=true paquet.deb

# Installation non-interactive
sudo gdebi -n paquet.deb
```

#### Avantages de gdebi

- **R√©solution automatique** des d√©pendances via APT
- **V√©rification** de l'int√©grit√© du paquet
- **Interface conviviale** (graphique ou texte)
- **S√©curit√©** : refuse d'installer si les d√©pendances ne peuvent pas √™tre satisfaites

### dpkg-reconfigure - Reconfiguration interactive

Dpkg-reconfigure permet de reconfigurer des paquets d√©j√† install√©s de mani√®re interactive.

#### Utilisation courante

```bash
# Reconfigurer les param√®tres r√©gionaux
sudo dpkg-reconfigure locales

# Reconfigurer le fuseau horaire
sudo dpkg-reconfigure tzdata

# Reconfigurer le clavier
sudo dpkg-reconfigure keyboard-configuration

# Reconfigurer le serveur graphique
sudo dpkg-reconfigure xserver-xorg
```

#### Options de dpkg-reconfigure

```bash
# Priorit√© des questions (all, high, medium, low, critical)
sudo dpkg-reconfigure -p high paquet

# Interface utilisateur (dialog, readline, gnome, kde)
sudo dpkg-reconfigure --frontend dialog paquet

# Voir toutes les questions possibles
sudo dpkg-reconfigure --force paquet
```

#### Cas d'usage pratiques

```bash
# Probl√®me d'affichage des caract√®res
sudo dpkg-reconfigure locales

# Clavier mal configur√©
sudo dpkg-reconfigure keyboard-configuration

# R√©solution d'√©cran incorrecte
sudo dpkg-reconfigure xserver-xorg-video-intel

# Reconfigurer un serveur de base de donn√©es
sudo dpkg-reconfigure mysql-server
```

### Autres outils utiles

#### apt-file - Recherche de fichiers dans les paquets

```bash
# Installation
sudo apt install apt-file

# Mise √† jour de la base de donn√©es
sudo apt-file update

# Trouver quel paquet contient un fichier
apt-file search /usr/bin/gcc

# Lister les fichiers d'un paquet non install√©
apt-file list build-essential
```

#### debsums - V√©rification de l'int√©grit√©

```bash
# Installation
sudo apt install debsums

# V√©rifier l'int√©grit√© de tous les paquets
sudo debsums -c

# V√©rifier un paquet sp√©cifique
debsums firefox

# G√©n√©rer les sommes manquantes
sudo debsums -g
```

#### dpkg-query - Requ√™tes avanc√©es

```bash
# Format personnalis√© de sortie
dpkg-query -W -f='${Package} ${Version} ${Architecture}\n'

# Lister les paquets par taille
dpkg-query -W -f='${Installed-Size}\t${Package}\n' | sort -n

# Paquets install√©s manuellement
dpkg-query -W -f='${Package} ${Priority}\n' | grep -v 'required\|important\|standard'
```

#### equivs - Cr√©ation de paquets factices

```bash
# Installation
sudo apt install equivs

# Cr√©er un paquet factice pour satisfaire une d√©pendance
equivs-control mon-paquet-factice
# √âditer le fichier g√©n√©r√©
nano mon-paquet-factice

# Construire le paquet
equivs-build mon-paquet-factice

# Utilise pour satisfaire des d√©pendances sans installer le vrai paquet
```

### Maintenance et diagnostic

#### V√©rification de la coh√©rence du syst√®me

```bash
# V√©rifier la base de donn√©es dpkg
sudo dpkg --audit

# V√©rifier les fichiers modifi√©s
sudo debsums -c

# Nettoyer les paquets partiellement install√©s
sudo dpkg --configure -a

# R√©parer les paquets cass√©s
sudo apt install -f
```

#### Sauvegarde et restauration

```bash
# Sauvegarder la liste des paquets install√©s
dpkg --get-selections > paquets-installes.txt

# Restaurer sur un autre syst√®me
sudo dpkg --set-selections < paquets-installes.txt
sudo apt-get dselect-upgrade

# Sauvegarder avec les versions exactes
dpkg -l > liste-complete-paquets.txt
```

#### Scripts de maintenance

```bash
#!/bin/bash
# Script de maintenance des paquets

echo "=== V√©rification de l'int√©grit√© du syst√®me ==="
sudo dpkg --audit

echo "=== Paquets avec des probl√®mes ==="
dpkg -l | grep "^.i"

echo "=== Nettoyage des paquets orphelins ==="
sudo apt autoremove

echo "=== V√©rification des sommes de contr√¥le ==="
sudo debsums -c | head -20

echo "=== Espace utilis√© par le cache ==="
du -sh /var/cache/apt/archives/
```

### Bonnes pratiques avec dpkg

1. **Toujours v√©rifier** les d√©pendances avant installation manuelle
2. **Utiliser gdebi** plut√¥t que dpkg pour les .deb externes
3. **Documenter** les paquets install√©s manuellement
4. **Tester** dans un environnement isol√© d'abord
5. **Sauvegarder** la liste des paquets r√©guli√®rement
6. **√âviter** les options --force sauf cas d'urgence
7. **Reconfigurer** plut√¥t que r√©installer quand possible

Cette ma√Ætrise de dpkg et des outils compl√©mentaires vous donnera un contr√¥le pr√©cis sur votre syst√®me de paquets Debian, vous permettant de r√©soudre des probl√®mes complexes et de personnaliser votre installation selon vos besoins exacts.

‚è≠Ô∏è
