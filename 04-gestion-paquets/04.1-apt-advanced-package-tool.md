üîù Retour au [Sommaire](/SOMMAIRE.md)

# 4.1 APT (Advanced Package Tool)

APT est le c≈ìur du syst√®me de gestion des paquets Debian. Imaginez-le comme votre assistant personnel pour g√©rer tous vos logiciels : il sait o√π les trouver, comment les installer, quelles d√©pendances sont n√©cessaires, et comment tout maintenir √† jour. C'est l'outil que vous utiliserez le plus souvent au quotidien.

## Qu'est-ce qu'APT ?

APT (Advanced Package Tool) est une suite d'outils qui simplifie la gestion des paquets sur Debian. Il agit comme un interm√©diaire intelligent entre vous et les d√©p√¥ts de logiciels, g√©rant automatiquement les t√¢ches complexes comme la r√©solution des d√©pendances et les mises √† jour.

### Avantages d'APT

- **Simplicit√©** : Une commande pour installer un logiciel
- **Intelligence** : R√©solution automatique des d√©pendances
- **S√©curit√©** : V√©rification des signatures et de l'int√©grit√©
- **Efficacit√©** : T√©l√©chargement et mise en cache optimis√©s
- **Tra√ßabilit√©** : Historique de toutes les op√©rations

## 4.1.1 Configuration d'APT

### Architecture de configuration APT

La configuration d'APT est distribu√©e dans plusieurs fichiers et r√©pertoires :

```bash
/etc/apt/                    # R√©pertoire principal de configuration
‚îú‚îÄ‚îÄ apt.conf                 # Configuration principale (optionnel)
‚îú‚îÄ‚îÄ apt.conf.d/              # Fragments de configuration
‚îú‚îÄ‚îÄ sources.list             # Liste des d√©p√¥ts principaux
‚îú‚îÄ‚îÄ sources.list.d/          # Fichiers de d√©p√¥ts additionnels
‚îú‚îÄ‚îÄ preferences              # Priorit√©s des paquets (optionnel)
‚îú‚îÄ‚îÄ preferences.d/           # Fragments de pr√©f√©rences
‚îî‚îÄ‚îÄ trusted.gpg.d/           # Cl√©s de confiance GPG
```

### Fichier de configuration principal

Le fichier `/etc/apt/apt.conf` (s'il existe) contient la configuration globale d'APT :

```bash
# Voir la configuration actuelle
apt-config dump

# Cr√©er ou √©diter la configuration principale
sudo nano /etc/apt/apt.conf
```

### Configuration courante dans apt.conf

```bash
# Exemple de configuration basique
APT::Default-Release "stable";
APT::Cache-Limit 50000000;
APT::Install-Recommends "true";
APT::Install-Suggests "false";

# Configuration du proxy (si n√©cessaire)
Acquire::http::Proxy "http://proxy.exemple.com:3128/";
Acquire::https::Proxy "http://proxy.exemple.com:3128/";

# Configuration des t√©l√©chargements
Acquire::Retries "3";
Acquire::http::Timeout "30";
```

### Configuration par fragments

Il est recommand√© d'utiliser des fichiers dans `/etc/apt/apt.conf.d/` :

```bash
# Exemple : /etc/apt/apt.conf.d/99local
# Configuration personnalis√©e locale
APT::Install-Recommends "false";
APT::AutoRemove::RecommendsImportant "false";
APT::AutoRemove::SuggestsImportant "false";

# Garder les paquets t√©l√©charg√©s
APT::Keep-Downloaded-Packages "true";
```

### Options importantes de configuration

| Option | Description | Valeur par d√©faut |
|--------|-------------|-------------------|
| `Install-Recommends` | Installer les paquets recommand√©s | true |
| `Install-Suggests` | Installer les paquets sugg√©r√©s | false |
| `AutoRemove::RecommendsImportant` | Consid√©rer les recommandations comme importantes | true |
| `Cache-Limit` | Limite de la taille du cache (octets) | Dynamique |
| `Default-Release` | Version par d√©faut √† utiliser | stable |

### V√©rification de la configuration

```bash
# V√©rifier la syntaxe de la configuration
sudo apt-config check

# Afficher la configuration compl√®te
apt-config dump | less

# V√©rifier une option sp√©cifique
apt-config dump APT::Install-Recommends
```

## 4.1.2 Sources.list et d√©p√¥ts

### Le fichier sources.list

Le fichier `/etc/apt/sources.list` d√©finit o√π APT peut trouver les paquets. C'est comme l'annuaire de vos magasins d'applications pr√©f√©r√©s.

```bash
# Voir le contenu actuel
cat /etc/apt/sources.list

# √âditer le fichier (avec pr√©caution !)
sudo nano /etc/apt/sources.list
```

### Format d'une ligne de d√©p√¥t

```bash
# Format g√©n√©ral :
# deb [options] URI distribution composants

# Exemples concrets :
deb http://deb.debian.org/debian bookworm main
deb-src http://deb.debian.org/debian bookworm main
deb http://security.debian.org/debian-security bookworm-security main
deb http://deb.debian.org/debian bookworm-updates main
```

### Explication des √©l√©ments

- **deb** : Paquets binaires (programmes compil√©s)
- **deb-src** : Paquets sources (code source)
- **URI** : Adresse du d√©p√¥t (http, https, ftp, file)
- **distribution** : Version Debian (bookworm, bullseye, etc.)
- **composants** : Cat√©gories de paquets (main, contrib, non-free)

### Les composants Debian

| Composant | Description | Exemples |
|-----------|-------------|----------|
| **main** | Logiciels libres officiellement support√©s | Firefox, LibreOffice, Apache |
| **contrib** | Logiciels libres avec d√©pendances non-libres | Wine, VirtualBox DKMS |
| **non-free** | Logiciels propri√©taires | Firmware propri√©taires, Steam |

### Exemple de sources.list complet

```bash
# Sources.list pour Debian 12 (Bookworm)

# D√©p√¥t principal
deb http://deb.debian.org/debian bookworm main contrib non-free
deb-src http://deb.debian.org/debian bookworm main contrib non-free

# Mises √† jour de s√©curit√©
deb http://security.debian.org/debian-security bookworm-security main contrib non-free
deb-src http://security.debian.org/debian-security bookworm-security main contrib non-free

# Mises √† jour stables
deb http://deb.debian.org/debian bookworm-updates main contrib non-free
deb-src http://deb.debian.org/debian bookworm-updates main contrib non-free

# Backports (versions plus r√©centes)
deb http://deb.debian.org/debian bookworm-backports main contrib non-free
deb-src http://deb.debian.org/debian bookworm-backports main contrib non-free
```

### Miroirs g√©ographiques

Pour am√©liorer les performances, utilisez un miroir proche :

```bash
# France
deb http://ftp.fr.debian.org/debian bookworm main contrib non-free

# Suisse
deb http://ftp.ch.debian.org/debian bookworm main contrib non-free

# D√©tection automatique du meilleur miroir
deb http://httpredir.debian.org/debian bookworm main contrib non-free
```

### D√©p√¥ts dans sources.list.d

Pour une meilleure organisation, utilisez des fichiers s√©par√©s :

```bash
# Cr√©er un d√©p√¥t pour un logiciel sp√©cifique
sudo nano /etc/apt/sources.list.d/vscode.list

# Contenu du fichier :
deb [signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main
```

### Gestion des d√©p√¥ts avec add-apt-repository

```bash
# Installer l'outil (si pas d√©j√† pr√©sent)
sudo apt install software-properties-common

# Ajouter un PPA (Personal Package Archive) - Ubuntu/d√©riv√©s
sudo add-apt-repository ppa:exemple/mon-logiciel

# Supprimer un d√©p√¥t
sudo add-apt-repository --remove ppa:exemple/mon-logiciel
```

## 4.1.3 Commandes apt et apt-get

### Diff√©rence entre apt et apt-get

- **apt** : Interface moderne, conviviale, color√©e (recommand√©e pour l'usage interactif)
- **apt-get** : Interface traditionnelle, plus stable (recommand√©e pour les scripts)

### Mise √† jour de la liste des paquets

```bash
# Mettre √† jour la liste des paquets disponibles
sudo apt update

# √âquivalent avec apt-get
sudo apt-get update

# La commande t√©l√©charge les informations des d√©p√¥ts mais n'installe rien
```

### Installation de paquets

```bash
# Installer un paquet
sudo apt install firefox

# Installer plusieurs paquets
sudo apt install vim git htop

# Installer depuis un fichier .deb local
sudo apt install ./mon-paquet.deb

# Installer une version sp√©cifique
sudo apt install firefox=100.0-1

# Installation avec apt-get
sudo apt-get install firefox
```

### Recherche de paquets

```bash
# Rechercher un paquet
apt search "navigateur web"
apt search firefox

# Recherche plus pr√©cise
apt search --names-only firefox

# Avec apt-cache (plus d'options)
apt-cache search firefox
apt-cache search --names-only firefox
```

### Informations sur les paquets

```bash
# Informations d√©taill√©es sur un paquet
apt show firefox

# Voir les d√©pendances d'un paquet
apt depends firefox

# Voir quels paquets d√©pendent d'un paquet
apt rdepends firefox

# Avec apt-cache
apt-cache show firefox
apt-cache depends firefox
apt-cache rdepends firefox
```

### Mise √† jour des paquets

```bash
# Mettre √† jour tous les paquets install√©s
sudo apt upgrade

# Mise √† jour intelligente (peut supprimer des paquets)
sudo apt full-upgrade

# Mise √† jour avec apt-get
sudo apt-get upgrade
sudo apt-get dist-upgrade  # √âquivalent de full-upgrade
```

### Suppression de paquets

```bash
# Supprimer un paquet (garder les fichiers de configuration)
sudo apt remove firefox

# Supprimer compl√®tement (avec fichiers de configuration)
sudo apt purge firefox

# Supprimer avec apt-get
sudo apt-get remove firefox
sudo apt-get purge firefox

# Supprimer les paquets inutiles (d√©pendances orphelines)
sudo apt autoremove

# Supprimer les paquets ET leurs fichiers de configuration
sudo apt autoremove --purge
```

### Gestion du cache

```bash
# Nettoyer le cache des paquets t√©l√©charg√©s
sudo apt clean

# Nettoyer partiellement (garder les versions actuelles)
sudo apt autoclean

# Voir la taille du cache
du -sh /var/cache/apt/archives/

# Avec apt-get
sudo apt-get clean
sudo apt-get autoclean
```

### Commandes de diagnostic

```bash
# Lister les paquets install√©s
apt list --installed

# Lister les paquets pouvant √™tre mis √† jour
apt list --upgradable

# V√©rifier l'√©tat des paquets
sudo apt check

# R√©parer les paquets cass√©s
sudo apt --fix-broken install

# Reconfigurer les paquets partiellement install√©s
sudo dpkg --configure -a
```

### Options utiles

```bash
# Simulation (ne fait rien, montre ce qui serait fait)
apt install --dry-run firefox
apt-get install -s firefox

# Installation sans interaction (r√©pondre oui automatiquement)
sudo apt install -y firefox

# T√©l√©charger seulement (ne pas installer)
apt-get download firefox

# Montrer les d√©tails pendant l'installation
sudo apt install -V firefox
```

## 4.1.4 Gestion des cl√©s GPG

### Pourquoi les cl√©s GPG ?

Les cl√©s GPG (GNU Privacy Guard) garantissent que :
- Les paquets proviennent bien de la source d√©clar√©e (authenticit√©)
- Ils n'ont pas √©t√© modifi√©s pendant le transport (int√©grit√©)
- Personne ne peut usurper l'identit√© d'un d√©p√¥t (non-r√©pudiation)

### Architecture des cl√©s APT

```bash
/etc/apt/trusted.gpg          # Ancien fichier de cl√©s (d√©pr√©ci√©)
/etc/apt/trusted.gpg.d/       # R√©pertoire des cl√©s syst√®me
/usr/share/keyrings/          # Cl√©s fournies par les paquets
/etc/apt/keyrings/            # Cl√©s ajout√©es manuellement (recommand√©)
```

### Voir les cl√©s actuelles

```bash
# Lister toutes les cl√©s de confiance
apt-key list

# M√©thode moderne (recommand√©e)
ls -la /etc/apt/trusted.gpg.d/
ls -la /etc/apt/keyrings/

# Voir les d√©tails d'une cl√©
gpg --show-keys /etc/apt/keyrings/exemple.gpg
```

### Ajouter une cl√© GPG (m√©thode moderne)

```bash
# 1. T√©l√©charger la cl√© du d√©p√¥t
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg

# 2. V√©rifier la cl√© (optionnel mais recommand√©)
gpg --show-keys microsoft.gpg

# 3. Installer la cl√©
sudo mv microsoft.gpg /etc/apt/keyrings/

# 4. R√©f√©rencer la cl√© dans sources.list
echo "deb [signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | sudo tee /etc/apt/sources.list.d/vscode.list
```

### M√©thode alternative avec curl

```bash
# T√©l√©charger et installer en une commande
curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg
```

### Ancienne m√©thode (d√©conseill√©e mais encore utilis√©e)

```bash
# Ajouter directement avec apt-key (d√©pr√©ci√©)
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -

# Ou depuis un fichier
sudo apt-key add /chemin/vers/cle.asc

# Supprimer une cl√©
sudo apt-key del IDDEDELACLE
```

### V√©rification et diagnostic des cl√©s

```bash
# Mettre √† jour et voir les erreurs de cl√©s
sudo apt update

# Exemple d'erreur typique :
# W: GPG error: https://repo.exemple.com stable InRelease:
# The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 1234567890ABCDEF

# R√©cup√©rer une cl√© manquante par son ID
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 1234567890ABCDEF
```

### Cl√©s pour les d√©p√¥ts courants

#### Google Chrome

```bash
# T√©l√©charger et installer la cl√© Google
wget -qO- https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg

# Ajouter le d√©p√¥t
echo "deb [signed-by=/etc/apt/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
```

#### Docker

```bash
# Cl√© Docker
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# D√©p√¥t Docker
echo "deb [signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
```

#### Node.js (NodeSource)

```bash
# Cl√© NodeSource
curl -fsSL https://deb.nodesource.com/gpgkey/nodesource.gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg

# D√©p√¥t Node.js 18.x
echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_18.x bookworm main" | sudo tee /etc/apt/sources.list.d/nodesource.list
```

### Bonnes pratiques pour les cl√©s GPG

#### 1. Utilisez le r√©pertoire /etc/apt/keyrings/

```bash
# Cr√©er le r√©pertoire s'il n'existe pas
sudo mkdir -p /etc/apt/keyrings/
```

#### 2. V√©rifiez toujours les cl√©s

```bash
# V√©rifier l'empreinte d'une cl√©
gpg --show-keys /etc/apt/keyrings/exemple.gpg

# Comparer avec l'empreinte officielle publi√©e par l'√©diteur
```

#### 3. Utilisez signed-by dans sources.list

```bash
# Format moderne avec cl√© sp√©cifique
deb [signed-by=/etc/apt/keyrings/exemple.gpg] https://repo.exemple.com stable main

# Au lieu de l'ancien format global
deb https://repo.exemple.com stable main
```

#### 4. Documentez vos ajouts

```bash
# Cr√©er un fichier de documentation
sudo nano /etc/apt/keyrings/README.txt

# Contenu :
# microsoft.gpg - Cl√© pour Visual Studio Code
# Ajout√©e le : 2024-01-15
# Source : https://packages.microsoft.com/keys/microsoft.asc
# Empreinte : BC52 8686 B50D 79E3 39D3  721C EB3E 94AD BE12 29CF
```

### R√©solution de probl√®mes courants

#### Cl√© expir√©e

```bash
# Erreur typique :
# W: GPG error: ... The following signatures were invalid: EXPKEYSIG

# Solution : T√©l√©charger la nouvelle cl√©
wget -qO- https://repo.exemple.com/cle.asc | sudo gpg --dearmor -o /etc/apt/keyrings/exemple.gpg
```

#### Cl√© manquante

```bash
# Erreur : NO_PUBKEY 1234567890ABCDEF
# Solution : Ajouter la cl√© manquante
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 1234567890ABCDEF
```

#### Conflit de cl√©s

```bash
# Nettoyer les anciennes cl√©s
sudo apt-key del ANCIENNECLE

# Ou r√©installer proprement le d√©p√¥t
```

### Migration des anciennes cl√©s

Si vous avez des cl√©s dans l'ancien syst√®me, migrez-les :

```bash
# Exporter une cl√© de l'ancien keyring
sudo apt-key export IDCLE | sudo gpg --dearmor -o /etc/apt/keyrings/nouvelle-cle.gpg

# Mettre √† jour sources.list pour utiliser signed-by
# Puis supprimer l'ancienne cl√©
sudo apt-key del IDCLE
```

Cette gestion rigoureuse des cl√©s GPG assure la s√©curit√© de votre syst√®me en garantissant que vous n'installez que des paquets authentiques et non modifi√©s.

‚è≠Ô∏è
