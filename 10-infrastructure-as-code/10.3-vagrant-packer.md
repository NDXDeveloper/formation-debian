üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.3 Vagrant et Packer

## Introduction √† Vagrant et Packer

**Vagrant** et **Packer** sont deux outils compl√©mentaires de HashiCorp qui r√©volutionnent la gestion des environnements de d√©veloppement et la cr√©ation d'images syst√®me.

**Vagrant** vous permet de cr√©er et configurer des environnements de d√©veloppement l√©gers, reproductibles et portables. Il automatise la cr√©ation de machines virtuelles avec une configuration d√©finie dans un fichier simple appel√© `Vagrantfile`.

**Packer** est un outil de construction d'images automatis√© qui peut cr√©er des images identiques pour de multiples plateformes √† partir d'une seule configuration source. Il est parfait pour cr√©er des images de machines virtuelles, des conteneurs Docker, ou des AMIs AWS.

### Pourquoi utiliser Vagrant et Packer ?

**Vagrant :**
- Environnements de d√©veloppement identiques pour toute l'√©quipe
- Isolation compl√®te des projets
- Facilit√© de partage et de reproduction
- Support de multiples providers (VirtualBox, VMware, Docker, cloud)

**Packer :**
- Images identiques sur multiples plateformes
- Processus de build automatis√© et reproductible
- Int√©gration avec les outils d'Infrastructure as Code
- Optimisation et s√©curisation des images

## 10.3.1 Environnements de d√©veloppement

### Installation de Vagrant sur Debian

#### Installation via le package officiel

```bash
# T√©l√©chargement du package Vagrant
wget https://releases.hashicorp.com/vagrant/2.4.0/vagrant_2.4.0-1_amd64.deb

# Installation du package
sudo dpkg -i vagrant_2.4.0-1_amd64.deb

# Installation des d√©pendances si n√©cessaire
sudo apt-get install -f

# V√©rification de l'installation
vagrant --version
```

#### Installation via le d√©p√¥t HashiCorp

```bash
# Ajout de la cl√© GPG et du d√©p√¥t HashiCorp
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg

echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list

# Mise √† jour et installation
sudo apt update
sudo apt install vagrant
```

#### Installation de VirtualBox (provider par d√©faut)

```bash
# Installation de VirtualBox
sudo apt update
sudo apt install virtualbox virtualbox-ext-pack

# Ajout de l'utilisateur au groupe vboxusers
sudo usermod -aG vboxusers $USER

# Red√©marrage de session
newgrp vboxusers

# V√©rification
vboxmanage --version
```

### Premiers pas avec Vagrant

#### Cr√©ation d'un environnement basique

```bash
# Cr√©ation d'un r√©pertoire pour le projet
mkdir mon-projet-vagrant
cd mon-projet-vagrant

# Initialisation avec une box Debian
vagrant init debian/bookworm64

# D√©marrage de la machine virtuelle
vagrant up

# Connexion SSH √† la VM
vagrant ssh

# Arr√™t de la VM
vagrant halt

# Destruction de la VM
vagrant destroy
```

#### Le fichier Vagrantfile basique

```ruby
# Vagrantfile

# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Box de base (image de r√©f√©rence)
  config.vm.box = "debian/bookworm64"

  # Configuration du nom de la machine
  config.vm.hostname = "dev-debian"

  # Configuration r√©seau
  config.vm.network "private_network", ip: "192.168.56.10"

  # Partage de r√©pertoires
  config.vm.synced_folder ".", "/vagrant"

  # Configuration du provider VirtualBox
  config.vm.provider "virtualbox" do |vb|
    vb.name = "Debian-Dev"
    vb.memory = "2048"
    vb.cpus = 2
  end

  # Provisioning avec un script shell
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y git curl vim
  SHELL
end
```

### Environnements de d√©veloppement avanc√©s

#### Multi-machines avec diff√©rents r√¥les

```ruby
# Vagrantfile pour infrastructure compl√®te

Vagrant.configure("2") do |config|
  # Configuration globale
  config.vm.box = "debian/bookworm64"

  # Serveur web
  config.vm.define "web" do |web|
    web.vm.hostname = "web-server"
    web.vm.network "private_network", ip: "192.168.56.10"
    web.vm.network "forwarded_port", guest: 80, host: 8080

    web.vm.provider "virtualbox" do |vb|
      vb.name = "WebServer"
      vb.memory = "1024"
      vb.cpus = 1
    end

    web.vm.provision "shell", path: "scripts/install-nginx.sh"
  end

  # Serveur de base de donn√©es
  config.vm.define "db" do |db|
    db.vm.hostname = "db-server"
    db.vm.network "private_network", ip: "192.168.56.11"

    db.vm.provider "virtualbox" do |vb|
      vb.name = "DatabaseServer"
      vb.memory = "2048"
      vb.cpus = 2
    end

    db.vm.provision "shell", path: "scripts/install-postgresql.sh"
  end

  # Serveur de monitoring
  config.vm.define "monitor" do |monitor|
    monitor.vm.hostname = "monitor-server"
    monitor.vm.network "private_network", ip: "192.168.56.12"
    monitor.vm.network "forwarded_port", guest: 3000, host: 3000

    monitor.vm.provider "virtualbox" do |vb|
      vb.name = "MonitorServer"
      vb.memory = "1536"
      vb.cpus = 1
    end

    monitor.vm.provision "ansible" do |ansible|
      ansible.playbook = "provisioning/monitor.yml"
      ansible.inventory_path = "provisioning/inventory"
    end
  end
end
```

#### Scripts de provisioning

```bash
#!/bin/bash
# scripts/install-nginx.sh

# Mise √† jour du syst√®me
apt-get update

# Installation de Nginx
apt-get install -y nginx

# Configuration d'un site par d√©faut
cat > /var/www/html/index.html << EOF
<!DOCTYPE html>
<html>
<head>
    <title>Serveur Web Vagrant</title>
</head>
<body>
    <h1>Bienvenue sur votre serveur web Vagrant !</h1>
    <p>Serveur : $(hostname)</p>
    <p>IP : $(hostname -I)</p>
    <p>Date : $(date)</p>
</body>
</html>
EOF

# D√©marrage et activation de Nginx
systemctl start nginx
systemctl enable nginx

# Configuration du firewall
ufw allow 22/tcp
ufw allow 80/tcp
ufw --force enable

echo "Installation Nginx termin√©e"
```

```bash
#!/bin/bash
# scripts/install-postgresql.sh

# Mise √† jour du syst√®me
apt-get update

# Installation de PostgreSQL
apt-get install -y postgresql postgresql-contrib

# Configuration de PostgreSQL
sudo -u postgres psql << EOF
CREATE USER vagrant WITH PASSWORD 'vagrant';
CREATE DATABASE vagrant_dev;
GRANT ALL PRIVILEGES ON DATABASE vagrant_dev TO vagrant;
\q
EOF

# Configuration de l'acc√®s r√©seau
echo "host all all 192.168.56.0/24 md5" >> /etc/postgresql/*/main/pg_hba.conf
echo "listen_addresses = '*'" >> /etc/postgresql/*/main/postgresql.conf

# Red√©marrage de PostgreSQL
systemctl restart postgresql

echo "Installation PostgreSQL termin√©e"
```

#### Provisioning avec Ansible

```yaml
# provisioning/monitor.yml

---
- name: Configuration du serveur de monitoring
  hosts: all
  become: yes

  vars:
    grafana_admin_password: admin123

  tasks:
    - name: Mise √† jour du syst√®me
      apt:
        update_cache: yes
        upgrade: dist

    - name: Installation des d√©pendances
      apt:
        name:
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Ajout de la cl√© GPG Grafana
      apt_key:
        url: https://packages.grafana.com/gpg.key
        state: present

    - name: Ajout du d√©p√¥t Grafana
      apt_repository:
        repo: "deb https://packages.grafana.com/oss/deb stable main"
        state: present

    - name: Installation de Grafana
      apt:
        name: grafana
        update_cache: yes
        state: present

    - name: Configuration de Grafana
      template:
        src: grafana.ini.j2
        dest: /etc/grafana/grafana.ini
        backup: yes
      notify: restart grafana

    - name: D√©marrage et activation de Grafana
      systemd:
        name: grafana-server
        state: started
        enabled: yes

  handlers:
    - name: restart grafana
      systemd:
        name: grafana-server
        state: restarted
```

```ini
# provisioning/templates/grafana.ini.j2

[server]
http_addr = 0.0.0.0
http_port = 3000

[security]
admin_user = admin
admin_password = {{ grafana_admin_password }}

[users]
allow_sign_up = false

[auth.anonymous]
enabled = false
```

### Gestion avanc√©e avec Vagrant

#### Configuration avec variables d'environnement

```ruby
# Vagrantfile avec configuration flexible

# Configuration via variables d'environnement
VM_MEMORY = ENV['VM_MEMORY'] || "2048"
VM_CPUS = ENV['VM_CPUS'] || "2"
VM_BOX = ENV['VM_BOX'] || "debian/bookworm64"
PRIVATE_IP = ENV['PRIVATE_IP'] || "192.168.56.10"

Vagrant.configure("2") do |config|
  config.vm.box = VM_BOX
  config.vm.hostname = "dev-server"
  config.vm.network "private_network", ip: PRIVATE_IP

  config.vm.provider "virtualbox" do |vb|
    vb.memory = VM_MEMORY
    vb.cpus = VM_CPUS
    vb.name = "DevServer-#{Time.now.to_i}"
  end

  # Provisioning conditionnel
  if File.exist?("provisioning/site.yml")
    config.vm.provision "ansible" do |ansible|
      ansible.playbook = "provisioning/site.yml"
    end
  else
    config.vm.provision "shell", inline: <<-SHELL
      apt-get update
      apt-get install -y build-essential git curl
    SHELL
  end
end
```

#### Utilisation

```bash
# Variables d'environnement pour personnaliser la VM
export VM_MEMORY=4096
export VM_CPUS=4
export PRIVATE_IP=192.168.56.20

# D√©marrage avec la configuration personnalis√©e
vagrant up

# R√©approvisioning sans recr√©er la VM
vagrant provision

# Rechargement avec nouvelle configuration
vagrant reload
```

#### Snapshots et gestion d'√©tat

```bash
# Cr√©ation d'un snapshot
vagrant snapshot save "clean-install"

# Liste des snapshots
vagrant snapshot list

# Restauration d'un snapshot
vagrant snapshot restore "clean-install"

# Suppression d'un snapshot
vagrant snapshot delete "clean-install"

# Informations sur l'√©tat des VMs
vagrant status

# Informations globales sur toutes les VMs Vagrant
vagrant global-status
```

## 10.3.2 Images personnalis√©es

### Introduction √† Packer

Packer automatise la cr√©ation d'images de machines en utilisant un fichier de configuration JSON ou HCL. Il peut cr√©er des images pour de multiples plateformes simultan√©ment.

### Installation de Packer sur Debian

```bash
# M√©thode 1 : Via le d√©p√¥t HashiCorp (recommand√©)
wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg

echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list

sudo apt update
sudo apt install packer

# M√©thode 2 : Installation manuelle
PACKER_VERSION="1.9.4"
wget https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip
unzip packer_${PACKER_VERSION}_linux_amd64.zip
sudo mv packer /usr/local/bin/

# V√©rification
packer version
```

### Cr√©ation d'une image Debian personnalis√©e

#### Configuration Packer basique

```hcl
# debian-base.pkr.hcl

# Variables
variable "vm_name" {
  type    = string
  default = "debian-base"
}

variable "disk_size" {
  type    = string
  default = "20G"
}

variable "memory" {
  type    = string
  default = "2048"
}

variable "cpus" {
  type    = string
  default = "2"
}

# Sources (builders)
source "virtualbox-iso" "debian" {
  # Configuration de la VM
  vm_name              = var.vm_name
  guest_os_type        = "Debian_64"
  disk_size            = var.disk_size
  memory               = var.memory
  cpus                 = var.cpus

  # ISO source
  iso_url              = "https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-12.2.0-amd64-netinst.iso"
  iso_checksum         = "sha256:23ab444503069d9ef681e3028016250289a33cc7bab079259b73100daee0af66"

  # Configuration r√©seau et SSH
  ssh_username         = "packer"
  ssh_password         = "packer"
  ssh_timeout         = "20m"

  # Configuration du boot
  boot_wait           = "10s"
  boot_command        = [
    "<esc><wait>",
    "install <wait>",
    "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg <wait>",
    "debian-installer=en_US.UTF-8 <wait>",
    "auto <wait>",
    "locale=en_US.UTF-8 <wait>",
    "kbd-chooser/method=us <wait>",
    "keyboard-configuration/xkb-keymap=us <wait>",
    "netcfg/get_hostname={{ .Name }} <wait>",
    "netcfg/get_domain=vagrantup.com <wait>",
    "fb=false <wait>",
    "debconf/frontend=noninteractive <wait>",
    "console-setup/ask_detect=false <wait>",
    "console-keymaps-at/keymap=us <wait>",
    "grub-installer/bootdev=/dev/sda <wait>",
    "<enter><wait>"
  ]

  # Serveur HTTP pour les fichiers de preseed
  http_directory       = "http"

  # Configuration de l'arr√™t
  shutdown_command     = "echo 'packer' | sudo -S shutdown -P now"

  # Format de sortie
  format               = "ova"
}

# Build
build {
  sources = ["source.virtualbox-iso.debian"]

  # Attente que SSH soit disponible
  provisioner "shell" {
    inline = ["echo 'SSH is now available'"]
  }

  # Mise √† jour du syst√®me
  provisioner "shell" {
    script = "scripts/update.sh"
  }

  # Installation des outils de base
  provisioner "shell" {
    script = "scripts/install-base.sh"
  }

  # Configuration Vagrant
  provisioner "shell" {
    script = "scripts/vagrant.sh"
  }

  # Nettoyage
  provisioner "shell" {
    script = "scripts/cleanup.sh"
  }

  # Post-processeur pour cr√©er une box Vagrant
  post-processor "vagrant" {
    output = "builds/{{.Provider}}/debian-base.box"
  }
}
```

#### Fichier preseed pour l'installation automatique

```bash
# http/preseed.cfg

# Configuration locale
d-i debian-installer/locale string en_US.UTF-8
d-i localechooser/supported-locales multiselect en_US.UTF-8

# Configuration clavier
d-i keyboard-configuration/xkb-keymap select us

# Configuration r√©seau
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string debian
d-i netcfg/get_domain string localdomain

# Configuration des comptes utilisateurs
d-i passwd/root-login boolean false
d-i passwd/user-fullname string Packer User
d-i passwd/username string packer
d-i passwd/user-password password packer
d-i passwd/user-password-again password packer
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

# Configuration de l'horloge
d-i clock-setup/utc boolean true
d-i time/zone string UTC

# Partitionnement
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# S√©lection des paquets
tasksel tasksel/first multiselect standard, ssh-server
d-i pkgsel/include string sudo curl wget vim git
d-i pkgsel/upgrade select full-upgrade

# Installation du bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/sda

# Finalisation
d-i finish-install/reboot_in_progress note

# Configuration sudo pour l'utilisateur packer
d-i preseed/late_command string \
    echo 'packer ALL=(ALL) NOPASSWD: ALL' > /target/etc/sudoers.d/packer ; \
    in-target chmod 440 /etc/sudoers.d/packer
```

#### Scripts de provisioning

```bash
#!/bin/bash
# scripts/update.sh

set -e

echo "Mise √† jour du syst√®me..."

# Mise √† jour des listes de paquets
apt-get update

# Mise √† jour compl√®te du syst√®me
apt-get -y dist-upgrade

# Installation des outils de base
apt-get -y install \
    curl \
    wget \
    vim \
    git \
    htop \
    tree \
    unzip \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release

echo "Syst√®me mis √† jour avec succ√®s"
```

```bash
#!/bin/bash
# scripts/install-base.sh

set -e

echo "Installation des outils de d√©veloppement..."

# Build tools
apt-get -y install \
    build-essential \
    dkms \
    linux-headers-$(uname -r)

# Python et pip
apt-get -y install \
    python3 \
    python3-pip \
    python3-venv

# Node.js (via NodeSource)
curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
apt-get -y install nodejs

# Docker
curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

apt-get update
apt-get -y install docker-ce docker-ce-cli containerd.io

# Ajout de l'utilisateur packer au groupe docker
usermod -aG docker packer

echo "Installation des outils termin√©e"
```

```bash
#!/bin/bash
# scripts/vagrant.sh

set -e

echo "Configuration pour Vagrant..."

# Installation de la cl√© publique Vagrant
mkdir -p /home/packer/.ssh
chmod 0700 /home/packer/.ssh

curl -fsSL 'https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub' > /home/packer/.ssh/authorized_keys
chmod 0600 /home/packer/.ssh/authorized_keys
chown -R packer:packer /home/packer/.ssh

# Configuration SSH pour Vagrant
cat >> /etc/ssh/sshd_config << 'EOF'

# Configuration optimis√©e pour Vagrant
UseDNS no
GSSAPIAuthentication no
EOF

echo "Configuration Vagrant termin√©e"
```

```bash
#!/bin/bash
# scripts/cleanup.sh

set -e

echo "Nettoyage du syst√®me..."

# Nettoyage des paquets
apt-get -y autoremove
apt-get -y autoclean
apt-get -y clean

# Suppression des logs
find /var/log -type f -exec truncate -s 0 {} \;

# Suppression de l'historique bash
rm -f /home/packer/.bash_history
rm -f /root/.bash_history

# Nettoyage du cache
rm -rf /tmp/*
rm -rf /var/tmp/*

# Suppression des cl√©s SSH de l'h√¥te (seront r√©g√©n√©r√©es au premier boot)
rm -f /etc/ssh/ssh_host_*

# Z√©ros sur l'espace libre pour compresser l'image
dd if=/dev/zero of=/EMPTY bs=1M || true
rm -f /EMPTY

echo "Nettoyage termin√©"
```

#### Construction de l'image

```bash
# Validation de la configuration
packer validate debian-base.pkr.hcl

# Construction de l'image
packer build debian-base.pkr.hcl

# Construction avec variables personnalis√©es
packer build \
  -var 'vm_name=debian-dev' \
  -var 'memory=4096' \
  -var 'cpus=4' \
  debian-base.pkr.hcl
```

### Images sp√©cialis√©es avec Packer

#### Image pour d√©veloppement web

```hcl
# web-dev.pkr.hcl

variable "base_image" {
  type    = string
  default = "debian-base.box"
}

source "vagrant" "web-dev" {
  source_path = var.base_image
  provider    = "virtualbox"
}

build {
  sources = ["source.vagrant.web-dev"]

  # Installation de LAMP stack
  provisioner "shell" {
    script = "scripts/install-lamp.sh"
  }

  # Configuration de Nginx
  provisioner "shell" {
    script = "scripts/configure-nginx.sh"
  }

  # Installation des outils de d√©veloppement web
  provisioner "shell" {
    script = "scripts/install-web-tools.sh"
  }

  post-processor "vagrant" {
    output = "builds/web-dev-{{.Provider}}.box"
  }
}
```

```bash
#!/bin/bash
# scripts/install-lamp.sh

set -e

echo "Installation du stack LAMP..."

# Mise √† jour
apt-get update

# Installation de Nginx
apt-get -y install nginx

# Installation de PHP
apt-get -y install \
    php8.2-fpm \
    php8.2-mysql \
    php8.2-curl \
    php8.2-gd \
    php8.2-mbstring \
    php8.2-xml \
    php8.2-xmlrpc \
    php8.2-soap \
    php8.2-intl \
    php8.2-zip

# Installation de MariaDB
apt-get -y install mariadb-server mariadb-client

# S√©curisation de MariaDB
mysql_secure_installation << EOF

y
vagrant
vagrant
y
y
y
y
EOF

# Configuration de PHP-FPM
sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php/8.2/fpm/php.ini

# Red√©marrage des services
systemctl restart php8.2-fpm
systemctl restart nginx
systemctl restart mariadb

# Activation au d√©marrage
systemctl enable php8.2-fpm
systemctl enable nginx
systemctl enable mariadb

echo "Stack LAMP install√© avec succ√®s"
```

## 10.3.3 Int√©gration avec cloud providers

### Packer avec AWS

#### Configuration pour cr√©ation d'AMI

```hcl
# aws-debian.pkr.hcl

# Variables pour AWS
variable "aws_region" {
  type    = string
  default = "eu-west-1"
}

variable "instance_type" {
  type    = string
  default = "t3.micro"
}

variable "vpc_id" {
  type    = string
  default = ""
}

variable "subnet_id" {
  type    = string
  default = ""
}

# Source AMI de base
data "amazon-ami" "debian" {
  filters = {
    name                = "debian-12-amd64-*"
    root-device-type    = "ebs"
    virtualization-type = "hvm"
  }
  most_recent = true
  owners      = ["136693071363"] # Debian official
  region      = var.aws_region
}

# Builder AWS
source "amazon-ebs" "debian" {
  ami_name      = "debian-custom-{{timestamp}}"
  instance_type = var.instance_type
  region        = var.aws_region

  # Configuration r√©seau
  vpc_id    = var.vpc_id
  subnet_id = var.subnet_id

  # AMI de base
  source_ami = data.amazon-ami.debian.id

  # Configuration SSH
  ssh_username = "admin"

  # Tags
  tags = {
    Name         = "Debian Custom"
    Environment  = "production"
    CreatedBy    = "packer"
    CreatedDate  = "{{timestamp}}"
  }

  # Snapshot tags
  snapshot_tags = {
    Name        = "Debian Custom Snapshot"
    CreatedBy   = "packer"
    CreatedDate = "{{timestamp}}"
  }
}

# Build process
build {
  sources = ["source.amazon-ebs.debian"]

  # Mise √† jour du syst√®me
  provisioner "shell" {
    inline = [
      "sudo apt-get update",
      "sudo apt-get -y upgrade"
    ]
  }

  # Installation des outils AWS
  provisioner "shell" {
    script = "scripts/install-aws-tools.sh"
  }

  # Configuration CloudWatch
  provisioner "shell" {
    script = "scripts/configure-cloudwatch.sh"
  }

  # Installation des agents de monitoring
  provisioner "shell" {
    script = "scripts/install-monitoring.sh"
  }

  # Nettoyage sp√©cifique AWS
  provisioner "shell" {
    script = "scripts/aws-cleanup.sh"
  }
}
```

```bash
#!/bin/bash
# scripts/install-aws-tools.sh

set -e

echo "Installation des outils AWS..."

# Installation d'AWS CLI v2
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
rm -rf aws awscliv2.zip

# Installation de l'agent Systems Manager
wget https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/debian_amd64/amazon-ssm-agent.deb
sudo dpkg -i amazon-ssm-agent.deb
sudo systemctl enable amazon-ssm-agent

# Installation de l'agent CloudWatch
wget https://amazoncloudwatch-agent.s3.amazonaws.com/debian/amd64/latest/amazon-cloudwatch-agent.deb
sudo dpkg -i amazon-cloudwatch-agent.deb

echo "Outils AWS install√©s avec succ√®s"
```

#### Utilisation avec variables d'environnement

```bash
# Configuration des credentials AWS
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
export AWS_DEFAULT_REGION="eu-west-1"

# Construction de l'AMI
packer build \
  -var 'aws_region=eu-west-1' \
  -var 'instance_type=t3.small' \
  -var 'vpc_id=vpc-12345678' \
  -var 'subnet_id=subnet-12345678' \
  aws-debian.pkr.hcl
```

### Packer avec Azure

```hcl
# azure-debian.pkr.hcl

# Variables Azure
variable "subscription_id" {
  type = string
}

variable "resource_group" {
  type    = string
  default = "rg-packer-images"
}

variable "location" {
  type    = string
  default = "West Europe"
}

variable "vm_size" {
  type    = string
  default = "Standard_B2s"
}

# Builder Azure
source "azure-arm" "debian" {
  # Authentification
  subscription_id = var.subscription_id

  # Configuration de l'image
  image_publisher = "Debian"
  image_offer     = "debian-12"
  image_sku       = "12-gen2"

  # Configuration de la VM temporaire
  location                      = var.location
  vm_size                       = var.vm_size

  # Groupe de ressources pour les images
  managed_image_resource_group_name = var.resource_group
  managed_image_name               = "debian-custom-{{timestamp}}"

  # Configuration OS
  os_type = "Linux"

  # Tags
  azure_tags = {
    Environment = "production"
    CreatedBy   = "packer"
    Project     = "infrastructure"
    CostCenter  = "IT"
  }
}

# Build process
build {
  sources = ["source.azure-arm.debian"]

  # Attente de l'initialisation cloud-init
  provisioner "shell" {
    inline = [
      "cloud-init status --wait",
      "sudo apt-get update"
    ]
  }

  # Mise √† jour du syst√®me
  provisioner "shell" {
    inline = [
      "sudo apt-get -y upgrade",
      "sudo apt-get -y dist-upgrade"
    ]
  }

  # Installation des outils Azure
  provisioner "shell" {
    script = "scripts/install-azure-tools.sh"
  }

  # Configuration sp√©cifique Azure
  provisioner "shell" {
    script = "scripts/configure-azure.sh"
  }

  # Nettoyage et pr√©paration
  provisioner "shell" {
    script = "scripts/azure-cleanup.sh"
  }

  # D√©provisionning Azure (requis)
  provisioner "shell" {
    inline = [
      "sudo /usr/sbin/waagent -force -deprovision+user",
      "export HISTSIZE=0",
      "sync"
    ]
  }
}
```

#### Scripts de configuration Azure

```bash
#!/bin/bash
# scripts/install-azure-tools.sh

set -e

echo "Installation des outils Azure..."

# Installation d'Azure CLI
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

# Installation de l'agent Azure (waagent)
sudo apt-get -y install walinuxagent

# Configuration de waagent
sudo sed -i 's/Provisioning.Enabled=y/Provisioning.Enabled=n/g' /etc/waagent.conf
sudo sed -i 's/Provisioning.UseCloudInit=n/Provisioning.UseCloudInit=y/g' /etc/waagent.conf
sudo sed -i 's/ResourceDisk.Format=y/ResourceDisk.Format=n/g' /etc/waagent.conf
sudo sed -i 's/ResourceDisk.EnableSwap=y/ResourceDisk.EnableSwap=n/g' /etc/waagent.conf

# Installation des extensions Azure
sudo apt-get -y install azure-cli

echo "Outils Azure install√©s avec succ√®s"
```

```bash
#!/bin/bash
# scripts/configure-azure.sh

set -e

echo "Configuration sp√©cifique Azure..."

# Configuration cloud-init pour Azure
sudo tee /etc/cloud/cloud.cfg.d/91-azure_datasource.cfg > /dev/null << EOF
datasource_list: [Azure]
datasource:
  Azure:
    apply_network_config: false
EOF

# Configuration du service de m√©tadonn√©es Azure
sudo tee /etc/systemd/system/azure-metadata.service > /dev/null << EOF
[Unit]
Description=Azure Instance Metadata Service Client
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/bin/curl -H "Metadata:true" http://169.254.169.254/metadata/instance?api-version=2021-02-01
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable azure-metadata.service

# Configuration du monitoring Azure
sudo tee /etc/rsyslog.d/50-azure.conf > /dev/null << EOF
# Azure monitoring logs
*.info;mail.none;authpriv.none;cron.none /var/log/azure.log
EOF

sudo systemctl restart rsyslog

echo "Configuration Azure termin√©e"
```

#### Authentification et utilisation

```bash
# Authentification Azure CLI
az login

# Ou via Service Principal
export ARM_CLIENT_ID="your-client-id"
export ARM_CLIENT_SECRET="your-client-secret"
export ARM_SUBSCRIPTION_ID="your-subscription-id"
export ARM_TENANT_ID="your-tenant-id"

# Construction de l'image Azure
packer build \
  -var 'subscription_id=your-subscription-id' \
  -var 'resource_group=rg-custom-images' \
  -var 'location=France Central' \
  azure-debian.pkr.hcl
```

### Packer avec Google Cloud Platform

```hcl
# gcp-debian.pkr.hcl

# Variables GCP
variable "project_id" {
  type = string
}

variable "zone" {
  type    = string
  default = "europe-west1-b"
}

variable "machine_type" {
  type    = string
  default = "e2-medium"
}

variable "source_image_family" {
  type    = string
  default = "debian-12"
}

# Builder GCP
source "googlecompute" "debian" {
  # Configuration du projet
  project_id = var.project_id

  # Configuration de l'instance temporaire
  zone         = var.zone
  machine_type = var.machine_type

  # Image de base
  source_image_family = var.source_image_family

  # Configuration de l'image finale
  image_name        = "debian-custom-{{timestamp}}"
  image_description = "Custom Debian image built with Packer"
  image_family      = "debian-custom"

  # Configuration SSH
  ssh_username = "packer"

  # Configuration r√©seau
  use_internal_ip = false

  # Tags et labels
  tags = ["packer", "debian"]

  image_labels = {
    environment = "production"
    created_by  = "packer"
    os_family   = "debian"
  }
}

# Build process
build {
  sources = ["source.googlecompute.debian"]

  # Mise √† jour du syst√®me
  provisioner "shell" {
    inline = [
      "sudo apt-get update",
      "sudo apt-get -y upgrade"
    ]
  }

  # Installation des outils GCP
  provisioner "shell" {
    script = "scripts/install-gcp-tools.sh"
  }

  # Configuration monitoring et logging
  provisioner "shell" {
    script = "scripts/configure-stackdriver.sh"
  }

  # Nettoyage GCP
  provisioner "shell" {
    script = "scripts/gcp-cleanup.sh"
  }
}
```

```bash
#!/bin/bash
# scripts/install-gcp-tools.sh

set -e

echo "Installation des outils Google Cloud..."

# Installation de Google Cloud SDK
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list

curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -

sudo apt-get update
sudo apt-get -y install google-cloud-sdk

# Installation de l'agent Ops (Stackdriver)
curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
sudo bash add-google-cloud-ops-agent-repo.sh --also-install

# Installation de l'agent de monitoring
sudo apt-get -y install stackdriver-agent

echo "Outils Google Cloud install√©s avec succ√®s"
```

### Multi-provider avec Packer

```hcl
# multi-cloud.pkr.hcl

# Variables communes
variable "image_version" {
  type    = string
  default = "1.0.0"
}

variable "base_name" {
  type    = string
  default = "debian-app"
}

# Variables AWS
variable "aws_region" {
  type    = string
  default = "eu-west-1"
}

# Variables Azure
variable "azure_subscription_id" {
  type = string
}

variable "azure_resource_group" {
  type    = string
  default = "rg-images"
}

# Variables GCP
variable "gcp_project_id" {
  type = string
}

variable "gcp_zone" {
  type    = string
  default = "europe-west1-b"
}

# Source AWS
source "amazon-ebs" "debian" {
  ami_name      = "${var.base_name}-aws-${var.image_version}"
  instance_type = "t3.micro"
  region        = var.aws_region

  source_ami_filter {
    filters = {
      name                = "debian-12-amd64-*"
      root-device-type    = "ebs"
      virtualization-type = "hvm"
    }
    most_recent = true
    owners      = ["136693071363"]
  }

  ssh_username = "admin"

  tags = {
    Name        = var.base_name
    Version     = var.image_version
    Platform    = "AWS"
    Environment = "production"
  }
}

# Source Azure
source "azure-arm" "debian" {
  subscription_id = var.azure_subscription_id

  managed_image_resource_group_name = var.azure_resource_group
  managed_image_name               = "${var.base_name}-azure-${var.image_version}"

  image_publisher = "Debian"
  image_offer     = "debian-12"
  image_sku       = "12-gen2"

  location = "West Europe"
  vm_size  = "Standard_B2s"
  os_type  = "Linux"

  azure_tags = {
    Name        = var.base_name
    Version     = var.image_version
    Platform    = "Azure"
    Environment = "production"
  }
}

# Source GCP
source "googlecompute" "debian" {
  project_id = var.gcp_project_id

  image_name        = "${var.base_name}-gcp-${var.image_version}"
  image_description = "Multi-cloud Debian image"
  image_family      = "${var.base_name}-family"

  source_image_family = "debian-12"
  zone               = var.gcp_zone
  machine_type       = "e2-medium"
  ssh_username       = "packer"

  image_labels = {
    name        = var.base_name
    version     = var.image_version
    platform    = "gcp"
    environment = "production"
  }
}

# Build commun pour tous les providers
build {
  sources = [
    "source.amazon-ebs.debian",
    "source.azure-arm.debian",
    "source.googlecompute.debian"
  ]

  # Installation des applications communes
  provisioner "shell" {
    scripts = [
      "scripts/update-system.sh",
      "scripts/install-common.sh",
      "scripts/configure-app.sh"
    ]
  }

  # Configuration sp√©cifique par provider
  provisioner "shell" {
    script = "scripts/configure-aws.sh"
    only   = ["amazon-ebs.debian"]
  }

  provisioner "shell" {
    script = "scripts/configure-azure.sh"
    only   = ["azure-arm.debian"]
  }

  provisioner "shell" {
    script = "scripts/configure-gcp.sh"
    only   = ["googlecompute.debian"]
  }

  # Nettoyage final
  provisioner "shell" {
    script = "scripts/final-cleanup.sh"
  }
}
```

## 10.3.4 Templates Debian optimis√©s

### Template Debian pour d√©veloppement

```hcl
# debian-dev-template.pkr.hcl

# Variables de configuration
variable "debian_version" {
  type    = string
  default = "12.2.0"
}

variable "vm_name" {
  type    = string
  default = "debian-dev-optimized"
}

variable "output_directory" {
  type    = string
  default = "builds"
}

variable "headless" {
  type    = bool
  default = true
}

# Source de base optimis√©e
source "virtualbox-iso" "debian-dev" {
  # Configuration VM optimis√©e
  vm_name              = var.vm_name
  guest_os_type        = "Debian_64"
  memory               = "4096"
  cpus                 = "4"
  disk_size            = "40960"
  hard_drive_interface = "sata"
  iso_interface        = "sata"
  headless             = var.headless

  # Performance optimizations
  vboxmanage = [
    ["modifyvm", "{{.Name}}", "--vram", "32"],
    ["modifyvm", "{{.Name}}", "--accelerate3d", "on"],
    ["modifyvm", "{{.Name}}", "--clipboard", "bidirectional"],
    ["modifyvm", "{{.Name}}", "--draganddrop", "bidirectional"],
    ["modifyvm", "{{.Name}}", "--paravirtprovider", "kvm"],
    ["modifyvm", "{{.Name}}", "--nestedpaging", "on"],
    ["modifyvm", "{{.Name}}", "--largepages", "on"],
    ["modifyvm", "{{.Name}}", "--vtxvpid", "on"],
    ["modifyvm", "{{.Name}}", "--vtxux", "on"],
    ["modifyvm", "{{.Name}}", "--ioapic", "on"]
  ]

  # ISO configuration
  iso_url      = "https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-${var.debian_version}-amd64-netinst.iso"
  iso_checksum = "sha256:23ab444503069d9ef681e3028016250289a33cc7bab079259b73100daee0af66"

  # SSH configuration optimis√©e
  ssh_username     = "devuser"
  ssh_password     = "devuser"
  ssh_timeout     = "30m"
  ssh_pty         = true

  # Boot configuration optimis√©e
  boot_wait = "5s"
  boot_command = [
    "<esc><wait>",
    "install <wait>",
    "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed-dev.cfg <wait>",
    "debian-installer=en_US.UTF-8 <wait>",
    "auto <wait>",
    "locale=en_US.UTF-8 <wait>",
    "kbd-chooser/method=us <wait>",
    "<enter><wait>"
  ]

  # HTTP directory pour preseed
  http_directory = "http"

  # Output configuration
  output_directory = "${var.output_directory}/virtualbox"
  format          = "ova"

  # Shutdown command
  shutdown_command = "echo 'devuser' | sudo -S shutdown -P now"
}

# Build optimis√© pour d√©veloppement
build {
  sources = ["source.virtualbox-iso.debian-dev"]

  # Mise √† jour initiale rapide
  provisioner "shell" {
    inline = [
      "sudo apt-get update",
      "sudo apt-get -y install curl wget git"
    ]
  }

  # Configuration syst√®me optimis√©e
  provisioner "shell" {
    script = "scripts/optimize-system.sh"
  }

  # Installation stack de d√©veloppement complet
  provisioner "shell" {
    script = "scripts/install-dev-stack.sh"
  }

  # Configuration environnement d√©veloppeur
  provisioner "shell" {
    script = "scripts/configure-dev-env.sh"
  }

  # Installation et configuration Docker
  provisioner "shell" {
    script = "scripts/install-docker-optimized.sh"
  }

  # Installation Kubernetes tools
  provisioner "shell" {
    script = "scripts/install-k8s-tools.sh"
  }

  # Configuration dotfiles et environnement
  provisioner "shell" {
    script = "scripts/setup-dotfiles.sh"
  }

  # Optimisations finales
  provisioner "shell" {
    script = "scripts/final-optimizations.sh"
  }

  # Post-processor Vagrant optimis√©
  post-processor "vagrant" {
    output = "${var.output_directory}/{{.Provider}}/${var.vm_name}.box"
    vagrantfile_template = "templates/Vagrantfile.template"
  }
}
```

#### Fichier preseed optimis√© pour d√©veloppement

```bash
# http/preseed-dev.cfg

# Configuration locale optimis√©e
d-i debian-installer/locale string en_US.UTF-8
d-i localechooser/supported-locales multiselect en_US.UTF-8, fr_FR.UTF-8

# Configuration clavier
d-i keyboard-configuration/xkb-keymap select us
d-i keyboard-configuration/toggle select No toggling

# Configuration r√©seau optimis√©e
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string debian-dev
d-i netcfg/get_domain string dev.local
d-i netcfg/wireless_wep string

# Configuration compte d√©veloppeur
d-i passwd/root-login boolean false
d-i passwd/user-fullname string Developer User
d-i passwd/username string devuser
d-i passwd/user-password password devuser
d-i passwd/user-password-again password devuser
d-i user-setup/allow-password-weak boolean true
d-i user-setup/encrypt-home boolean false

# Configuration horloge
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true

# Partitionnement optimis√© pour d√©veloppement
d-i partman-auto/method string lvm
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string debian-dev-vg
d-i partman-auto/choose_recipe select atomic
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# S√©lection des paquets optimis√©e
tasksel tasksel/first multiselect standard, ssh-server
d-i pkgsel/include string \
    sudo curl wget git vim build-essential \
    software-properties-common apt-transport-https \
    ca-certificates gnupg lsb-release unzip \
    htop tree tmux zsh

# Pas de mises √† jour automatiques (pour √©viter les interruptions)
d-i pkgsel/upgrade select none

# Bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/sda

# Finalisation
d-i finish-install/reboot_in_progress note

# Configuration sudo pour devuser
d-i preseed/late_command string \
    echo 'devuser ALL=(ALL) NOPASSWD: ALL' > /target/etc/sudoers.d/devuser ; \
    in-target chmod 440 /etc/sudoers.d/devuser ; \
    in-target chsh -s /bin/bash devuser
```

#### Scripts d'optimisation syst√®me

```bash
#!/bin/bash
# scripts/optimize-system.sh

set -e

echo "Optimisation du syst√®me pour le d√©veloppement..."

# Configuration du kernel pour de meilleures performances
cat >> /etc/sysctl.conf << 'EOF'

# Optimisations pour d√©veloppement
vm.swappiness=10
vm.dirty_ratio=15
vm.dirty_background_ratio=5
vm.vfs_cache_pressure=50
net.core.rmem_max=134217728
net.core.wmem_max=134217728
net.ipv4.tcp_rmem=4096 87380 134217728
net.ipv4.tcp_wmem=4096 65536 134217728
fs.file-max=2097152
EOF

# Configuration optimis√©e des limites
cat >> /etc/security/limits.conf << 'EOF'

# Limites optimis√©es pour d√©veloppement
devuser soft nofile 65536
devuser hard nofile 65536
devuser soft nproc 65536
devuser hard nproc 65536
EOF

# Configuration optimis√©e de systemd
mkdir -p /etc/systemd/system.conf.d
cat > /etc/systemd/system.conf.d/10-dev-optimizations.conf << 'EOF'
[Manager]
DefaultTimeoutStartSec=30s
DefaultTimeoutStopSec=15s
DefaultRestartSec=5s
DefaultLimitNOFILE=65536
DefaultLimitNPROC=65536
EOF

# Optimisation des services de boot
systemctl disable apt-daily.service
systemctl disable apt-daily.timer
systemctl disable apt-daily-upgrade.timer
systemctl disable apt-daily-upgrade.service

echo "Optimisations syst√®me termin√©es"
```

```bash
#!/bin/bash
# scripts/install-dev-stack.sh

set -e

echo "Installation du stack de d√©veloppement complet..."

# Mise √† jour du syst√®me
apt-get update
apt-get -y upgrade

# Installation des outils de build
apt-get -y install \
    build-essential \
    make \
    cmake \
    autoconf \
    automake \
    libtool \
    pkg-config \
    git-core \
    subversion \
    mercurial

# Installation de langages de programmation
# Python avec pip et venv
apt-get -y install \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    python3-setuptools

# Node.js et npm (version LTS)
curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
apt-get -y install nodejs

# Java (OpenJDK)
apt-get -y install \
    openjdk-17-jdk \
    openjdk-17-jre \
    maven \
    gradle

# Go
GO_VERSION="1.21.5"
wget https://golang.org/dl/go${GO_VERSION}.linux-amd64.tar.gz
tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz
rm go${GO_VERSION}.linux-amd64.tar.gz

# Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

# Outils de base de donn√©es
apt-get -y install \
    postgresql-client \
    mysql-client \
    sqlite3 \
    redis-tools

# Outils de conteneurisation
# Docker sera install√© par un script s√©par√©
# Installation de docker-compose
pip3 install docker-compose

# Outils de monitoring et debugging
apt-get -y install \
    htop \
    iotop \
    nethogs \
    tcpdump \
    wireshark-common \
    strace \
    ltrace \
    gdb \
    valgrind

# √âditeurs et IDEs en ligne de commande
apt-get -y install \
    vim \
    neovim \
    emacs-nox \
    nano

# Installation de VS Code
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/
echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/trusted.gpg.d/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list

apt-get update
apt-get -y install code

echo "Stack de d√©veloppement install√© avec succ√®s"
```

```bash
#!/bin/bash
# scripts/install-k8s-tools.sh

set -e

echo "Installation des outils Kubernetes..."

# kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
mv kubectl /usr/local/bin/

# Helm
curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | tee /usr/share/keyrings/helm.gpg > /dev/null
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | tee /etc/apt/sources.list.d/helm-stable-debian.list
apt-get update
apt-get -y install helm

# k9s
K9S_VERSION=$(curl -s https://api.github.com/repos/derailed/k9s/releases/latest | grep tag_name | cut -d '"' -f 4)
wget https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_amd64.tar.gz
tar -C /usr/local/bin -xzf k9s_Linux_amd64.tar.gz k9s
rm k9s_Linux_amd64.tar.gz

# kubectx et kubens
git clone https://github.com/ahmetb/kubectx /opt/kubectx
ln -s /opt/kubectx/kubectx /usr/local/bin/kubectx
ln -s /opt/kubectx/kubens /usr/local/bin/kubens

# kind (Kubernetes in Docker)
KIND_VERSION=$(curl -s https://api.github.com/repos/kubernetes-sigs/kind/releases/latest | grep tag_name | cut -d '"' -f 4)
curl -Lo /usr/local/bin/kind https://github.com/kubernetes-sigs/kind/releases/download/${KIND_VERSION}/kind-linux-amd64
chmod +x /usr/local/bin/kind

# minikube
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
install minikube-linux-amd64 /usr/local/bin/minikube
rm minikube-linux-amd64

# Autocompl√©tion kubectl pour bash et zsh
echo 'source <(kubectl completion bash)' >> /home/devuser/.bashrc
echo 'source <(kubectl completion zsh)' >> /home/devuser/.zshrc

echo "Outils Kubernetes install√©s avec succ√®s"
```

#### Template Vagrantfile optimis√©

```ruby
# templates/Vagrantfile.template

# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Configuration optimis√©e pour le d√©veloppement
  config.vm.provider "virtualbox" do |vb|
    # Performances optimis√©es
    vb.memory = ENV['VM_MEMORY'] || "4096"
    vb.cpus = ENV['VM_CPUS'] || "4"

    # Optimisations VirtualBox
    vb.customize ["modifyvm", :id, "--vram", "32"]
    vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
    vb.customize ["modifyvm", :id, "--clipboard", "bidirectional"]
    vb.customize ["modifyvm", :id, "--draganddrop", "bidirectional"]
    vb.customize ["modifyvm", :id, "--paravirtprovider", "kvm"]
    vb.customize ["modifyvm", :id, "--nestedpaging", "on"]
    vb.customize ["modifyvm", :id, "--largepages", "on"]
    vb.customize ["modifyvm", :id, "--ioapic", "on"]

    # Configuration r√©seau optimis√©e
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
    vb.customize ["modifyvm", :id, "--nictype1", "virtio"]
    vb.customize ["modifyvm", :id, "--nictype2", "virtio"]
  end

  # Configuration r√©seau
  config.vm.network "private_network", type: "dhcp"

  # Ports couramment utilis√©s en d√©veloppement
  config.vm.network "forwarded_port", guest: 3000, host: 3000   # React/Express
  config.vm.network "forwarded_port", guest: 8080, host: 8080   # Tomcat/Spring
  config.vm.network "forwarded_port", guest: 5000, host: 5000   # Flask
  config.vm.network "forwarded_port", guest: 8000, host: 8000   # Django
  config.vm.network "forwarded_port", guest: 9000, host: 9000   # SonarQube
  config.vm.network "forwarded_port", guest: 3306, host: 3306   # MySQL
  config.vm.network "forwarded_port", guest: 5432, host: 5432   # PostgreSQL
  config.vm.network "forwarded_port", guest: 6379, host: 6379   # Redis
  config.vm.network "forwarded_port", guest: 9200, host: 9200   # Elasticsearch

  # Partage de dossiers optimis√©
  config.vm.synced_folder ".", "/vagrant", type: "virtualbox",
    mount_options: ["dmode=755", "fmode=644"]

  # Dossier partag√© pour les projets
  if File.directory?("../projects")
    config.vm.synced_folder "../projects", "/home/devuser/projects",
      type: "virtualbox",
      mount_options: ["dmode=755", "fmode=644"],
      owner: "devuser",
      group: "devuser"
  end

  # Cache des packages pour acc√©l√©rer les provisions
  if Vagrant.has_plugin?("vagrant-cachier")
    config.cache.scope = :box
    config.cache.auto_detect = true
    config.cache.enable :apt
    config.cache.enable :npm
    config.cache.enable :pip
  end

  # Configuration SSH optimis√©e
  config.ssh.forward_agent = true
  config.ssh.forward_x11 = true
  config.ssh.keep_alive = true
  config.ssh.connect_timeout = 30

  # Provisioning conditionnel pour mise √† jour
  if ENV['VAGRANT_UPDATE'] == 'true'
    config.vm.provision "shell", inline: <<-SHELL
      echo "Mise √† jour du syst√®me..."
      apt-get update
      apt-get -y upgrade
      docker system prune -f
    SHELL
  end

  # Synchronisation de l'heure
  config.vm.provision "shell", inline: <<-SHELL
    timedatectl set-timezone UTC
    systemctl restart ntp
  SHELL

  # Message de bienvenue
  config.vm.provision "shell", run: "always", inline: <<-SHELL
    echo "==========================================="
    echo "  Environnement de d√©veloppement Debian"
    echo "==========================================="
    echo "IP: $(hostname -I | awk '{print $2}')"
    echo "Hostname: $(hostname)"
    echo "Uptime: $(uptime -p)"
    echo "Docker: $(docker --version 2>/dev/null || echo 'Non disponible')"
    echo "Kubernetes: $(kubectl version --client 2>/dev/null | grep 'Client Version' || echo 'kubectl non disponible')"
    echo "==========================================="
  SHELL
end
```

### Template Debian pour production

```hcl
# debian-production-template.pkr.hcl

# Variables de configuration production
variable "debian_version" {
  type        = string
  default     = "12.2.0"
  description = "Version de Debian √† utiliser"
}

variable "vm_name" {
  type        = string
  default     = "debian-production-optimized"
  description = "Nom de la VM de base"
}

variable "output_directory" {
  type        = string
  default     = "builds/production"
  description = "R√©pertoire de sortie des images"
}

variable "environment" {
  type        = string
  default     = "production"
  description = "Environnement cible"
}

variable "hardening_level" {
  type        = string
  default     = "high"
  description = "Niveau de durcissement (low, medium, high)"
}

# Source de base s√©curis√©e
source "virtualbox-iso" "debian-production" {
  # Configuration VM production
  vm_name              = var.vm_name
  guest_os_type        = "Debian_64"
  memory               = "2048"
  cpus                 = "2"
  disk_size            = "20480"
  hard_drive_interface = "sata"
  iso_interface        = "sata"
  headless             = true

  # Optimisations s√©curit√©
  vboxmanage = [
    ["modifyvm", "{{.Name}}", "--vram", "16"],
    ["modifyvm", "{{.Name}}", "--accelerate3d", "off"],
    ["modifyvm", "{{.Name}}", "--clipboard", "disabled"],
    ["modifyvm", "{{.Name}}", "--draganddrop", "disabled"],
    ["modifyvm", "{{.Name}}", "--usb", "off"],
    ["modifyvm", "{{.Name}}", "--audio", "none"],
    ["modifyvm", "{{.Name}}", "--paravirtprovider", "kvm"],
    ["modifyvm", "{{.Name}}", "--nestedpaging", "on"],
    ["modifyvm", "{{.Name}}", "--ioapic", "on"]
  ]

  # ISO configuration
  iso_url      = "https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-${var.debian_version}-amd64-netinst.iso"
  iso_checksum = "sha256:23ab444503069d9ef681e3028016250289a33cc7bab079259b73100daee0af66"

  # SSH configuration s√©curis√©e
  ssh_username    = "sysadmin"
  ssh_password    = "temp_password"
  ssh_timeout    = "30m"
  ssh_pty        = false

  # Boot configuration
  boot_wait = "10s"
  boot_command = [
    "<esc><wait>",
    "install <wait>",
    "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed-production.cfg <wait>",
    "debian-installer=en_US.UTF-8 <wait>",
    "auto <wait>",
    "locale=en_US.UTF-8 <wait>",
    "kbd-chooser/method=us <wait>",
    "<enter><wait>"
  ]

  # HTTP directory
  http_directory = "http"

  # Output configuration
  output_directory = "${var.output_directory}/virtualbox"
  format          = "ova"

  # Shutdown command
  shutdown_command = "echo 'sysadmin' | sudo -S shutdown -P now"
}

# Build production s√©curis√©
build {
  sources = ["source.virtualbox-iso.debian-production"]

  # Mise √† jour s√©curis√©e
  provisioner "shell" {
    script = "scripts/secure-update.sh"
  }

  # Configuration syst√®me de base
  provisioner "shell" {
    script = "scripts/configure-base-system.sh"
  }

  # Durcissement s√©curit√©
  provisioner "shell" {
    script = "scripts/security-hardening.sh"
    environment_vars = [
      "HARDENING_LEVEL=${var.hardening_level}",
      "ENVIRONMENT=${var.environment}"
    ]
  }

  # Installation outils monitoring
  provisioner "shell" {
    script = "scripts/install-monitoring-agents.sh"
  }

  # Configuration logging
  provisioner "shell" {
    script = "scripts/configure-logging.sh"
  }

  # Installation et configuration fail2ban
  provisioner "shell" {
    script = "scripts/configure-fail2ban.sh"
  }

  # Configuration firewall
  provisioner "shell" {
    script = "scripts/configure-firewall.sh"
  }

  # Audit et compliance
  provisioner "shell" {
    script = "scripts/setup-audit.sh"
  }

  # Nettoyage s√©curis√©
  provisioner "shell" {
    script = "scripts/secure-cleanup.sh"
  }

  # Validation s√©curit√©
  provisioner "shell" {
    script = "scripts/security-validation.sh"
  }

  # Post-processor pour diff√©rents formats
  post-processor "vagrant" {
    output = "${var.output_directory}/{{.Provider}}/debian-production.box"
    vagrantfile_template = "templates/Vagrantfile.production"
  }

  post-processor "manifest" {
    output = "${var.output_directory}/manifest.json"
    strip_path = true
    custom_data = {
      debian_version   = var.debian_version
      hardening_level  = var.hardening_level
      build_date      = "{{ timestamp }}"
      environment     = var.environment
    }
  }
}
```

#### Preseed pour production

```bash
# http/preseed-production.cfg

# Configuration s√©curis√©e pour production
d-i debian-installer/locale string en_US.UTF-8
d-i localechooser/supported-locales multiselect en_US.UTF-8

# Configuration clavier
d-i keyboard-configuration/xkb-keymap select us

# Configuration r√©seau s√©curis√©e
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string debian-prod
d-i netcfg/get_domain string production.local
d-i netcfg/hostname string debian-prod

# Configuration utilisateurs s√©curis√©e
d-i passwd/root-login boolean false
d-i passwd/user-fullname string System Administrator
d-i passwd/username string sysadmin
d-i passwd/user-password password temp_password
d-i passwd/user-password-again password temp_password
d-i user-setup/allow-password-weak boolean false
d-i user-setup/encrypt-home boolean true

# Configuration horloge
d-i clock-setup/utc boolean true
d-i time/zone string UTC
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string pool.ntp.org

# Partitionnement s√©curis√© avec chiffrement
d-i partman-auto/method string crypto
d-i partman-auto-lvm/guided_size string max
d-i partman-auto-lvm/new_vg_name string secure-vg

# Configuration du chiffrement
d-i partman-crypto/passphrase password securepassphrase
d-i partman-crypto/passphrase-again password securepassphrase

# Schema de partitionnement s√©curis√©
d-i partman-auto/expert_recipe string                           \
      secure ::                                                 \
              256 256 256 ext4                                  \
                      $primary{ } $bootable{ }                 \
                      method{ format } format{ }               \
                      use_filesystem{ } filesystem{ ext4 }     \
                      mountpoint{ /boot }                      \
              .                                                 \
              4096 4096 4096 linux-swap                        \
                      $lvmok{ }                                 \
                      method{ swap } format{ }                 \
              .                                                 \
              4096 4096 8192 ext4                              \
                      $lvmok{ }                                 \
                      method{ format } format{ }               \
                      use_filesystem{ } filesystem{ ext4 }     \
                      mountpoint{ / }                          \
              .                                                 \
              2048 2048 4096 ext4                              \
                      $lvmok{ }                                 \
                      method{ format } format{ }               \
                      use_filesystem{ } filesystem{ ext4 }     \
                      mountpoint{ /var }                       \
              .                                                 \
              1024 1024 2048 ext4                              \
                      $lvmok{ }                                 \
                      method{ format } format{ }               \
                      use_filesystem{ } filesystem{ ext4 }     \
                      mountpoint{ /var/log }                   \
              .                                                 \
              512 512 1024 ext4                                \
                      $lvmok{ }                                 \
                      method{ format } format{ }               \
                      use_filesystem{ } filesystem{ ext4 }     \
                      mountpoint{ /tmp }                       \
              .

d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# S√©lection minimale des paquets
tasksel tasksel/first multiselect standard
d-i pkgsel/include string \
    openssh-server sudo vim curl wget \
    fail2ban ufw unattended-upgrades \
    aide rkhunter chkrootkit logrotate \
    rsyslog ntp

# Pas de desktop environment
d-i pkgsel/upgrade select safe-upgrade

# Configuration bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/sda

# Configuration post-installation s√©curis√©e
d-i preseed/late_command string \
    echo 'sysadmin ALL=(ALL) NOPASSWD: ALL' > /target/etc/sudoers.d/sysadmin ; \
    in-target chmod 440 /etc/sudoers.d/sysadmin ; \
    in-target chage -M 90 sysadmin ; \
    in-target chage -W 7 sysadmin

# Finalisation
d-i finish-install/reboot_in_progress note
```

#### Scripts de durcissement s√©curitaire

```bash
#!/bin/bash
# scripts/security-hardening.sh

set -e

HARDENING_LEVEL=${HARDENING_LEVEL:-medium}
ENVIRONMENT=${ENVIRONMENT:-production}

echo "Application du durcissement s√©curitaire niveau: $HARDENING_LEVEL"

# Configuration sysctl s√©curis√©e
cat >> /etc/sysctl.d/99-security.conf << 'EOF'
# D√©sactivation des redirections ICMP
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# D√©sactivation du source routing
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# Protection contre les attaques de type martian
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Protection contre les ping de la mort
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Protection SYN flood
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.tcp_synack_retries = 3

# D√©sactivation de l'IP forwarding
net.ipv4.ip_forward = 0
net.ipv6.conf.all.forwarding = 0

# Protection contre les d√©bordements de buffer
kernel.exec-shield = 1
kernel.randomize_va_space = 2

# Restriction des core dumps
fs.suid_dumpable = 0
kernel.core_uses_pid = 1
EOF

# Application des param√®tres sysctl
sysctl -p /etc/sysctl.d/99-security.conf

# Configuration SSH s√©curis√©e
cat > /etc/ssh/sshd_config << 'EOF'
# Configuration SSH durcie pour production

# Protocol et chiffrement
Protocol 2
Port 22
AddressFamily inet

# Authentification
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
ChallengeResponseAuthentication no
UsePAM yes

# Restrictions utilisateurs
AllowUsers sysadmin
DenyUsers root

# Chiffrement fort
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group16-sha512

# Param√®tres de connexion
LoginGraceTime 30
MaxAuthTries 3
MaxSessions 2
ClientAliveInterval 300
ClientAliveCountMax 2

# D√©sactivation des fonctionnalit√©s non n√©cessaires
X11Forwarding no
AllowTcpForwarding no
AllowAgentForwarding no
PermitTunnel no
GatewayPorts no

# Logging
SyslogFacility AUTH
LogLevel VERBOSE

# Banner
Banner /etc/ssh/banner
EOF

# Cr√©ation du banner SSH
cat > /etc/ssh/banner << 'EOF'
***************************************************************************
*                           AVERTISSEMENT                                *
***************************************************************************
* Ce syst√®me est destin√© uniquement aux utilisateurs autoris√©s.          *
* Toute utilisation est surveill√©e et enregistr√©e.                       *
* L'acc√®s non autoris√© est strictement interdit.                         *
***************************************************************************
EOF

# Configuration des permissions strictes
chmod 600 /etc/ssh/sshd_config
chmod 644 /etc/ssh/banner

# Durcissement des mots de passe
cat >> /etc/pam.d/common-password << 'EOF'
# Configuration PAM durcie
password required pam_pwquality.so retry=3 minlen=12 difok=3 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1
password required pam_unix.so use_authtok remember=5 sha512
EOF

# Configuration des limites de connexion
cat >> /etc/security/limits.conf << 'EOF'
# Limites s√©curis√©es
* hard maxlogins 2
* hard core 0
* hard nproc 1000
EOF

# Configuration de l'audit syst√®me si niveau high
if [ "$HARDENING_LEVEL" = "high" ]; then
    echo "Configuration audit syst√®me avanc√©e..."

    # Installation et configuration auditd
    apt-get -y install auditd audispd-plugins

    cat > /etc/audit/rules.d/audit.rules << 'EOF'
# R√®gles d'audit pour production

# Suppression des r√®gles existantes
-D

# Buffer
-b 8192

# Surveillance des changements de configuration
-w /etc/passwd -p wa -k passwd_changes
-w /etc/group -p wa -k group_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/sudoers -p wa -k sudoers_changes

# Surveillance des modifications syst√®me
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /etc/hosts -p wa -k network_config
-w /etc/hostname -p wa -k network_config

# Surveillance des connexions
-w /var/log/lastlog -p wa -k logins
-w /var/run/faillock -p wa -k logins

# Surveillance des commandes privil√©gi√©es
-a always,exit -F arch=b64 -S execve -F euid=0 -k root_commands
-a always,exit -F arch=b32 -S execve -F euid=0 -k root_commands

# Immutable
-e 2
EOF

    systemctl enable auditd
    systemctl start auditd
fi

# D√©sactivation des services non n√©cessaires
systemctl disable --now bluetooth
systemctl disable --now cups
systemctl disable --now avahi-daemon || true
systemctl disable --now network-manager || true

# Configuration des permissions sur les fichiers sensibles
chmod 700 /root
chmod 700 /home/sysadmin
chmod 600 /etc/shadow
chmod 600 /etc/gshadow
chmod 644 /etc/passwd
chmod 644 /etc/group

# Suppression des packages non n√©cessaires
apt-get -y autoremove
apt-get -y purge telnet rsh-client talk finger

echo "Durcissement s√©curitaire appliqu√© avec succ√®s"
```

#### Configuration du monitoring

```bash
#!/bin/bash
# scripts/install-monitoring-agents.sh

set -e

echo "Installation des agents de monitoring pour production..."

# Installation de Prometheus Node Exporter
NODE_EXPORTER_VERSION="1.6.1"
useradd --no-create-home --shell /bin/false node_exporter

cd /tmp
wget https://github.com/prometheus/node_exporter/releases/download/v${NODE_EXPORTER_VERSION}/node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
tar xvf node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz
cp node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64/node_exporter /usr/local/bin/
chown node_exporter:node_exporter /usr/local/bin/node_exporter

# Service systemd pour Node Exporter
cat > /etc/systemd/system/node_exporter.service << 'EOF'
[Unit]
Description=Node Exporter
Wants=network-online.target
After=network-online.target

[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter \
    --web.listen-address=0.0.0.0:9100 \
    --collector.systemd \
    --collector.processes

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable node_exporter
systemctl start node_exporter

# Installation de Filebeat pour les logs
curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.11.0-amd64.deb
dpkg -i filebeat-8.11.0-amd64.deb

# Configuration Filebeat basique
cat > /etc/filebeat/filebeat.yml << 'EOF'
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/*.log
    - /var/log/auth.log
    - /var/log/syslog
    - /var/log/audit/audit.log

output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOST:localhost:9200}"]

processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
EOF

systemctl enable filebeat

# Installation d'OSSEC HIDS pour la d√©tection d'intrusion
cd /tmp
wget -U ossec https://github.com/ossec/ossec-hids/archive/3.6.0.tar.gz
tar xvf 3.6.0.tar.gz
cd ossec-hids-3.6.0

# Installation automatis√©e d'OSSEC
echo "en" | ./install.sh

# Configuration OSSEC
cat >> /var/ossec/etc/ossec.conf << 'EOF'
<ossec_config>
  <global>
    <email_notification>no</email_notification>
    <logall>yes</logall>
    <logall_json>yes</logall_json>
  </global>

  <syscheck>
    <frequency>7200</frequency>
    <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
    <directories check_all="yes">/bin,/sbin,/boot</directories>
  </syscheck>

  <rootcheck>
    <rootkit_files>/var/ossec/etc/shared/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>/var/ossec/etc/shared/rootkit_trojans.txt</rootkit_trojans>
    <system_audit>/var/ossec/etc/shared/system_audit_rcl.txt</system_audit>
    <system_audit>/var/ossec/etc/shared/cis_debian_linux_rcl.txt</system_audit>
  </rootcheck>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/auth.log</location>
  </localfile>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/log/syslog</location>
  </localfile>

  <localfile>
    <log_format>command</log_format>
    <command>df -P</command>
    <frequency>360</frequency>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>netstat -tulpn | sed 's/\([[:alnum:]]\+\)\ \+[[:digit:]]\+\ \+[[:digit:]]\+\ \+\(.*\):\([[:digit:]]*\)\ \+\([0-9\.\:\*]\+\).\+\ \([[:digit:]]*\/[[:alnum:]\-]*\).*/\1 \2 == \3 == \4 \5/' | sort -k 4 -g | sed 's/ == / /g'</command>
    <alias>netstat listening ports</alias>
    <frequency>360</frequency>
  </localfile>
</ossec_config>
EOF

/var/ossec/bin/ossec-control start
/var/ossec/bin/ossec-control enable

echo "Agents de monitoring install√©s avec succ√®s"
```

### Workflow d'automatisation complet

```bash
#!/bin/bash
# build-and-deploy.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUILD_DIR="$SCRIPT_DIR/builds"
LOG_FILE="$BUILD_DIR/build-$(date +%Y%m%d-%H%M%S).log"

# Configuration
ENVIRONMENTS=("dev" "staging" "production")
VAGRANT_CLOUD_ORG="mon-organisation"

# Fonctions utilitaires
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" | tee -a "$LOG_FILE" >&2
    exit 1
}

success() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS: $1" | tee -a "$LOG_FILE"
}

# Cr√©ation des r√©pertoires
mkdir -p "$BUILD_DIR"

# Validation Packer
validate_templates() {
    log "Validation des templates Packer..."

    for template in *.pkr.hcl; do
        if [[ -f "$template" ]]; then
            log "Validation de $template"
            packer validate "$template" || error "√âchec de validation pour $template"
        fi
    done

    success "Tous les templates sont valides"
}

# Construction des images

build_images() {
    local environment=$1
    log "Construction des images pour l'environnement: $environment"

    case $environment in
        "dev")
            log "Construction image d√©veloppement..."
            packer build \
                -var "vm_name=debian-dev-$(date +%Y%m%d)" \
                -var "output_directory=$BUILD_DIR/dev" \
                debian-dev-template.pkr.hcl
            ;;
        "staging")
            log "Construction image staging..."
            packer build \
                -var "vm_name=debian-staging-$(date +%Y%m%d)" \
                -var "hardening_level=medium" \
                -var "environment=staging" \
                -var "output_directory=$BUILD_DIR/staging" \
                debian-production-template.pkr.hcl
            ;;
        "production")
            log "Construction image production..."
            packer build \
                -var "vm_name=debian-production-$(date +%Y%m%d)" \
                -var "hardening_level=high" \
                -var "environment=production" \
                -var "output_directory=$BUILD_DIR/production" \
                debian-production-template.pkr.hcl
            ;;
    esac

    success "Image $environment construite avec succ√®s"
}

# Tests de validation des images
test_images() {
    local environment=$1
    log "Tests de validation pour l'environnement: $environment"

    local box_file="$BUILD_DIR/$environment/virtualbox/debian-$environment-$(date +%Y%m%d).box"

    if [[ ! -f "$box_file" ]]; then
        error "Box file non trouv√©: $box_file"
    fi

    # Cr√©ation d'un r√©pertoire de test temporaire
    local test_dir="/tmp/vagrant-test-$environment-$$"
    mkdir -p "$test_dir"
    cd "$test_dir"

    log "Test de la box dans $test_dir"

    # Ajout de la box √† Vagrant
    vagrant box add "test-$environment" "$box_file" --force

    # Initialisation et test
    vagrant init "test-$environment"

    # Configuration de test sp√©cifique
    cat > Vagrantfile << EOF
Vagrant.configure("2") do |config|
  config.vm.box = "test-$environment"
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "1024"
    vb.cpus = "1"
    vb.gui = false
  end

  # Test de connectivit√©
  config.vm.provision "shell", inline: <<-SHELL
    echo "Test de l'environnement $environment"
    uname -a
    df -h
    free -h
    systemctl status ssh
  SHELL
end
EOF

    # D√©marrage et test
    timeout 600 vagrant up || error "√âchec du d√©marrage de la VM de test"

    # Tests sp√©cifiques par environnement
    case $environment in
        "dev")
            log "Tests environnement d√©veloppement..."
            vagrant ssh -c "docker --version" || error "Docker non disponible"
            vagrant ssh -c "kubectl version --client" || error "kubectl non disponible"
            vagrant ssh -c "node --version" || error "Node.js non disponible"
            vagrant ssh -c "python3 --version" || error "Python3 non disponible"
            ;;
        "production")
            log "Tests environnement production..."
            vagrant ssh -c "sudo systemctl status fail2ban" || error "fail2ban non actif"
            vagrant ssh -c "sudo ufw status" || error "UFW non configur√©"
            vagrant ssh -c "sudo systemctl status node_exporter" || error "Node exporter non actif"
            ;;
    esac

    # Nettoyage
    vagrant destroy -f
    cd "$SCRIPT_DIR"
    rm -rf "$test_dir"
    vagrant box remove "test-$environment" --force

    success "Tests de validation r√©ussis pour $environment"
}

# Publication vers Vagrant Cloud
publish_to_cloud() {
    local environment=$1
    local version=$(date +%Y.%m.%d)

    log "Publication vers Vagrant Cloud pour $environment (version $version)"

    local box_file="$BUILD_DIR/$environment/virtualbox/debian-$environment-$(date +%Y%m%d).box"
    local box_name="$VAGRANT_CLOUD_ORG/debian-$environment"

    if [[ ! -f "$box_file" ]]; then
        error "Box file non trouv√© pour publication: $box_file"
    fi

    # V√©rification des credentials Vagrant Cloud
    if [[ -z "$VAGRANT_CLOUD_TOKEN" ]]; then
        error "VAGRANT_CLOUD_TOKEN non d√©fini"
    fi

    # Cr√©ation de la version
    log "Cr√©ation de la version $version pour $box_name"
    vagrant cloud version create "$box_name" "$version" || true

    # Upload de la box
    log "Upload de la box vers Vagrant Cloud..."
    vagrant cloud provider upload \
        "$box_name" \
        virtualbox \
        "$version" \
        "$box_file"

    # Release de la version
    log "Release de la version $version"
    vagrant cloud version release "$box_name" "$version"

    success "Box $box_name:$version publi√©e avec succ√®s"
}

# G√©n√©ration du rapport de build
generate_report() {
    log "G√©n√©ration du rapport de build..."

    local report_file="$BUILD_DIR/build-report-$(date +%Y%m%d-%H%M%S).html"

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>Rapport de Build - $(date)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { background-color: #f4f4f4; padding: 20px; border-radius: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .log-section { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; }
        pre { background-color: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Rapport de Build Vagrant/Packer</h1>
        <p><strong>Date:</strong> $(date)</p>
        <p><strong>Build ID:</strong> $(date +%Y%m%d-%H%M%S)</p>
        <p><strong>Utilisateur:</strong> $(whoami)</p>
        <p><strong>Syst√®me:</strong> $(uname -a)</p>
    </div>

    <h2>R√©sum√© du Build</h2>
    <table>
        <tr>
            <th>Environnement</th>
            <th>Statut</th>
            <th>Taille</th>
            <th>Checksum</th>
        </tr>
EOF

    # Ajout des informations pour chaque environnement
    for env in "${ENVIRONMENTS[@]}"; do
        local box_file="$BUILD_DIR/$env/virtualbox/debian-$env-$(date +%Y%m%d).box"
        if [[ -f "$box_file" ]]; then
            local size=$(du -h "$box_file" | cut -f1)
            local checksum=$(sha256sum "$box_file" | cut -d' ' -f1)
            echo "        <tr>" >> "$report_file"
            echo "            <td>$env</td>" >> "$report_file"
            echo "            <td class=\"success\">‚úì Succ√®s</td>" >> "$report_file"
            echo "            <td>$size</td>" >> "$report_file"
            echo "            <td><code>$checksum</code></td>" >> "$report_file"
            echo "        </tr>" >> "$report_file"
        else
            echo "        <tr>" >> "$report_file"
            echo "            <td>$env</td>" >> "$report_file"
            echo "            <td class=\"error\">‚úó √âchec</td>" >> "$report_file"
            echo "            <td>-</td>" >> "$report_file"
            echo "            <td>-</td>" >> "$report_file"
            echo "        </tr>" >> "$report_file"
        fi
    done

    cat >> "$report_file" << EOF
    </table>

    <h2>D√©tails Techniques</h2>
    <div class="log-section">
        <h3>Versions des Outils</h3>
        <pre>$(packer version)</pre>
        <pre>$(vagrant --version)</pre>
        <pre>$(vboxmanage --version)</pre>
    </div>

    <div class="log-section">
        <h3>Logs de Build</h3>
        <pre>$(tail -50 "$LOG_FILE")</pre>
    </div>

    <h2>Instructions d'Utilisation</h2>
    <div class="log-section">
        <h3>Installation des Boxes</h3>
        <pre>
# Environnement de d√©veloppement
vagrant box add mon-organisation/debian-dev

# Environnement de production
vagrant box add mon-organisation/debian-production

# Utilisation dans un Vagrantfile
Vagrant.configure("2") do |config|
  config.vm.box = "mon-organisation/debian-dev"
end
        </pre>
    </div>

    <div class="log-section">
        <h3>V√©rification des Checksums</h3>
        <pre>
# V√©rification locale
sha256sum builds/*/virtualbox/*.box

# Comparaison avec ce rapport
        </pre>
    </div>

    <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
        <p>Rapport g√©n√©r√© automatiquement par build-and-deploy.sh</p>
        <p>Syst√®me de build Vagrant/Packer - Infrastructure as Code</p>
    </footer>
</body>
</html>
EOF

    success "Rapport g√©n√©r√©: $report_file"
}

# Nettoyage des anciennes builds
cleanup_old_builds() {
    log "Nettoyage des anciennes builds..."

    # Garder seulement les 5 derni√®res builds
    find "$BUILD_DIR" -name "*.box" -type f -mtime +5 -delete
    find "$BUILD_DIR" -name "*.log" -type f -mtime +30 -delete

    # Nettoyage des manifests anciens
    find "$BUILD_DIR" -name "manifest.json" -type f -mtime +30 -delete

    success "Nettoyage termin√©"
}

# Sauvegarde des artefacts
backup_artifacts() {
    log "Sauvegarde des artefacts..."

    local backup_dir="/backup/vagrant-boxes/$(date +%Y/%m)"
    local backup_file="backup-$(date +%Y%m%d-%H%M%S).tar.gz"

    mkdir -p "$backup_dir"

    # Cr√©ation de l'archive
    tar -czf "$backup_dir/$backup_file" \
        -C "$BUILD_DIR" \
        --exclude="*.log" \
        .

    # Chiffrement de la sauvegarde si GPG disponible
    if command -v gpg &> /dev/null && [[ -n "$BACKUP_GPG_RECIPIENT" ]]; then
        log "Chiffrement de la sauvegarde..."
        gpg --encrypt --recipient "$BACKUP_GPG_RECIPIENT" "$backup_dir/$backup_file"
        rm "$backup_dir/$backup_file"
        success "Sauvegarde chiffr√©e: $backup_dir/$backup_file.gpg"
    else
        success "Sauvegarde cr√©√©e: $backup_dir/$backup_file"
    fi
}

# Notification des r√©sultats
send_notification() {
    local status=$1
    local message=$2

    log "Envoi de notification: $status"

    # Notification Slack si webhook configur√©
    if [[ -n "$SLACK_WEBHOOK_URL" ]]; then
        local color="good"
        local icon=":white_check_mark:"

        if [[ "$status" != "success" ]]; then
            color="danger"
            icon=":x:"
        fi

        curl -X POST -H 'Content-type: application/json' \
            --data "{
                \"attachments\": [{
                    \"color\": \"$color\",
                    \"title\": \"Build Vagrant/Packer $status\",
                    \"text\": \"$message\",
                    \"fields\": [
                        {
                            \"title\": \"Serveur\",
                            \"value\": \"$(hostname)\",
                            \"short\": true
                        },
                        {
                            \"title\": \"Utilisateur\",
                            \"value\": \"$(whoami)\",
                            \"short\": true
                        },
                        {
                            \"title\": \"Date\",
                            \"value\": \"$(date)\",
                            \"short\": false
                        }
                    ]
                }]
            }" \
            "$SLACK_WEBHOOK_URL"
    fi

    # Notification par email si configur√©
    if [[ -n "$EMAIL_RECIPIENT" ]] && command -v mail &> /dev/null; then
        echo "$message" | mail -s "Build Vagrant/Packer $status" "$EMAIL_RECIPIENT"
    fi
}

# Fonction principale
main() {
    log "D√©marrage du processus de build automatis√©"

    # V√©rification des pr√©requis
    if ! command -v packer &> /dev/null; then
        error "Packer n'est pas install√©"
    fi

    if ! command -v vagrant &> /dev/null; then
        error "Vagrant n'est pas install√©"
    fi

    if ! command -v vboxmanage &> /dev/null; then
        error "VirtualBox n'est pas install√©"
    fi

    # Gestion des arguments
    local action=${1:-"all"}
    local target_env=${2:-""}

    case $action in
        "validate")
            validate_templates
            ;;
        "build")
            if [[ -n "$target_env" ]]; then
                validate_templates
                build_images "$target_env"
                test_images "$target_env"
            else
                error "Environnement requis pour l'action build"
            fi
            ;;
        "test")
            if [[ -n "$target_env" ]]; then
                test_images "$target_env"
            else
                error "Environnement requis pour l'action test"
            fi
            ;;
        "publish")
            if [[ -n "$target_env" ]]; then
                publish_to_cloud "$target_env"
            else
                error "Environnement requis pour l'action publish"
            fi
            ;;
        "all")
            validate_templates

            # Build pour tous les environnements
            for env in "${ENVIRONMENTS[@]}"; do
                build_images "$env"
                test_images "$env"

                # Publication automatique pour dev et staging
                if [[ "$env" != "production" ]]; then
                    publish_to_cloud "$env"
                fi
            done

            generate_report
            cleanup_old_builds
            backup_artifacts

            send_notification "success" "Build complet r√©ussi pour tous les environnements"
            ;;
        "cleanup")
            cleanup_old_builds
            ;;
        "report")
            generate_report
            ;;
        *)
            echo "Usage: $0 {validate|build|test|publish|all|cleanup|report} [environment]"
            echo ""
            echo "Actions:"
            echo "  validate  - Valide tous les templates Packer"
            echo "  build     - Construit l'image pour un environnement"
            echo "  test      - Teste l'image d'un environnement"
            echo "  publish   - Publie l'image vers Vagrant Cloud"
            echo "  all       - Ex√©cute le processus complet"
            echo "  cleanup   - Nettoie les anciennes builds"
            echo "  report    - G√©n√®re un rapport de build"
            echo ""
            echo "Environnements: ${ENVIRONMENTS[*]}"
            echo ""
            echo "Variables d'environnement optionnelles:"
            echo "  VAGRANT_CLOUD_TOKEN    - Token pour Vagrant Cloud"
            echo "  SLACK_WEBHOOK_URL      - URL webhook Slack pour notifications"
            echo "  EMAIL_RECIPIENT        - Email pour les notifications"
            echo "  BACKUP_GPG_RECIPIENT   - Destinataire GPG pour chiffrement sauvegarde"
            exit 1
            ;;
    esac

    success "Processus termin√© avec succ√®s"
}

# Gestion des erreurs et signaux
trap 'error "Script interrompu par signal"' INT TERM

# Point d'entr√©e
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
```

### Configuration CI/CD avec GitLab

```yaml
# .gitlab-ci.yml

stages:
  - validate
  - build
  - test
  - deploy
  - notify

variables:
  DEBIAN_FRONTEND: noninteractive
  PACKER_VERSION: "1.9.4"
  VAGRANT_VERSION: "2.4.0"

# Template pour les jobs Packer
.packer_job: &packer_job
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq curl unzip wget
    - wget https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip
    - unzip packer_${PACKER_VERSION}_linux_amd64.zip
    - mv packer /usr/local/bin/
    - packer version

# Validation des templates
validate_templates:
  <<: *packer_job
  stage: validate
  script:
    - ./build-and-deploy.sh validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build environnement de d√©veloppement
build_dev:
  <<: *packer_job
  stage: build
  script:
    - ./build-and-deploy.sh build dev
  artifacts:
    paths:
      - builds/dev/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Build environnement de staging
build_staging:
  <<: *packer_job
  stage: build
  script:
    - ./build-and-deploy.sh build staging
  artifacts:
    paths:
      - builds/staging/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Build environnement de production
build_production:
  <<: *packer_job
  stage: build
  script:
    - ./build-and-deploy.sh build production
  artifacts:
    paths:
      - builds/production/
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"
  when: manual

# Tests automatis√©s
test_dev:
  image: ubuntu:22.04
  stage: test
  needs: ["build_dev"]
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget virtualbox vagrant
  script:
    - ./build-and-deploy.sh test dev
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test_staging:
  image: ubuntu:22.04
  stage: test
  needs: ["build_staging"]
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget virtualbox vagrant
  script:
    - ./build-and-deploy.sh test staging
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# D√©ploiement vers Vagrant Cloud
deploy_dev:
  <<: *packer_job
  stage: deploy
  needs: ["test_dev"]
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget vagrant
  script:
    - ./build-and-deploy.sh publish dev
  environment:
    name: vagrant-cloud-dev
    url: https://app.vagrantup.com/mon-organisation/boxes/debian-dev
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

deploy_staging:
  <<: *packer_job
  stage: deploy
  needs: ["test_staging"]
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget vagrant
  script:
    - ./build-and-deploy.sh publish staging
  environment:
    name: vagrant-cloud-staging
    url: https://app.vagrantup.com/mon-organisation/boxes/debian-staging
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

deploy_production:
  <<: *packer_job
  stage: deploy
  needs: ["build_production"]
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget vagrant
  script:
    - ./build-and-deploy.sh publish production
  environment:
    name: vagrant-cloud-production
    url: https://app.vagrantup.com/mon-organisation/boxes/debian-production
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual

# G√©n√©ration du rapport
generate_report:
  <<: *packer_job
  stage: notify
  script:
    - ./build-and-deploy.sh report
  artifacts:
    reports:
      junit: builds/build-report-*.html
    paths:
      - builds/build-report-*.html
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Nettoyage p√©riodique
cleanup:
  <<: *packer_job
  stage: notify
  script:
    - ./build-and-deploy.sh cleanup
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
```

### Bonnes pratiques et recommandations

#### S√©curit√© des builds

```bash
#!/bin/bash
# security-checks.sh

set -e

echo "V√©rifications de s√©curit√© des images..."

# V√©rification des CVE
check_vulnerabilities() {
    local image_path=$1

    echo "Scan de vuln√©rabilit√©s pour $image_path"

    # Extraction temporaire pour analyse
    local temp_dir="/tmp/security-scan-$$"
    mkdir -p "$temp_dir"

    # Montage de l'image pour analyse (exemple avec guestmount)
    if command -v guestmount &> /dev/null; then
        guestmount -a "$image_path" -i "$temp_dir"

        # Scan avec Lynis si disponible
        if command -v lynis &> /dev/null; then
            lynis audit system --rootdir "$temp_dir" --report-file "/tmp/lynis-report-$$.txt"
        fi

        # V√©rification des packages vuln√©rables
        if [[ -f "$temp_dir/var/lib/dpkg/status" ]]; then
            echo "V√©rification des packages install√©s..."
            grep "^Package:" "$temp_dir/var/lib/dpkg/status" | wc -l
        fi

        # D√©montage
        guestunmount "$temp_dir"
    fi

    rm -rf "$temp_dir"
}

# V√©rification des checksums
verify_checksums() {
    local manifest_file=$1

    if [[ -f "$manifest_file" ]]; then
        echo "V√©rification des checksums depuis $manifest_file"
        # Logique de v√©rification des checksums
    fi
}

# Audit des configurations
audit_configurations() {
    echo "Audit des configurations de s√©curit√©..."

    # V√©rification des templates Packer
    grep -r "password" *.pkr.hcl || echo "Aucun mot de passe en dur trouv√©"
    grep -r "secret" *.pkr.hcl || echo "Aucun secret en dur trouv√©"

    # V√©rification des scripts
    find scripts/ -name "*.sh" -exec shellcheck {} \;
}

# Ex√©cution des v√©rifications
audit_configurations
for build_dir in builds/*/; do
    if [[ -d "$build_dir" ]]; then
        find "$build_dir" -name "*.box" -exec check_vulnerabilities {} \;
        find "$build_dir" -name "manifest.json" -exec verify_checksums {} \;
    fi
done

echo "V√©rifications de s√©curit√© termin√©es"
```

#### Monitoring et m√©triques

```bash
#!/bin/bash
# monitoring.sh

# Collecte de m√©triques de build
collect_build_metrics() {
    local build_start_time=$1
    local build_end_time=$2
    local environment=$3

    local duration=$((build_end_time - build_start_time))

    # Envoi vers InfluxDB si configur√©
    if [[ -n "$INFLUXDB_URL" ]]; then
        curl -XPOST "$INFLUXDB_URL/write?db=vagrant_builds" \
            --data-binary "build_duration,environment=$environment value=$duration"

        # Taille des images
        local box_file="builds/$environment/virtualbox/*.box"
        if [[ -f $box_file ]]; then
            local size=$(stat -c%s "$box_file")
            curl -XPOST "$INFLUXDB_URL/write?db=vagrant_builds" \
                --data-binary "box_size,environment=$environment value=$size"
        fi
    fi

    # Logs structur√©s pour analyse
    echo "{
        \"timestamp\": \"$(date -Iseconds)\",
        \"environment\": \"$environment\",
        \"duration_seconds\": $duration,
        \"status\": \"success\",
        \"build_node\": \"$(hostname)\"
    }" >> "$BUILD_DIR/metrics.jsonl"
}

# Dashboard de monitoring
generate_dashboard() {
    cat > "$BUILD_DIR/dashboard.html" << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Vagrant/Packer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 10px 0;
            display: inline-block;
            width: 300px;
        }
        .metric-title { font-size: 14px; color: #6c757d; }
        .metric-value { font-size: 24px; font-weight: bold; color: #28a745; }
    </style>
</head>
<body>
    <h1>Dashboard Builds Vagrant/Packer</h1>

    <div class="metric-card">
        <div class="metric-title">Builds R√©ussis (7j)</div>
        <div class="metric-value" id="successful-builds">-</div>
    </div>

    <div class="metric-card">
        <div class="metric-title">Temps Moyen Build</div>
        <div class="metric-value" id="average-time">-</div>
    </div>

    <div class="metric-card">
        <div class="metric-title">Taille Moyenne Images</div>
        <div class="metric-value" id="average-size">-</div>
    </div>

    <canvas id="build-chart" width="800" height="400"></canvas>

    <script>
        // Chargement et affichage des m√©triques
        // (logique JavaScript pour parser metrics.jsonl et afficher les graphiques)
    </script>
</body>
</html>
EOF
}
```

Cette section compl√®te le module 10.3 en montrant comment automatiser compl√®tement le processus de build et de d√©ploiement des images Vagrant/Packer, avec des pratiques de s√©curit√©, monitoring et CI/CD int√©gr√©s.

‚è≠Ô∏è
