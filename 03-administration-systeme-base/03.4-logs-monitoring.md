üîù Retour au [Sommaire](/SOMMAIRE.md)

# 3.4 Logs et monitoring

Les logs (journaux) sont comme le carnet de bord de votre syst√®me : ils enregistrent tout ce qui se passe, les erreurs, les connexions, les services qui d√©marrent ou s'arr√™tent. Savoir les lire et les analyser est essentiel pour maintenir un syst√®me en bonne sant√© et r√©soudre les probl√®mes rapidement.

## Pourquoi les logs sont-ils importants ?

Imaginez votre syst√®me comme une voiture : les logs sont comme le tableau de bord qui vous indique si tout va bien, s'il y a un probl√®me moteur, si vous manquez d'essence, etc. Sans ces informations, vous rouleriez √† l'aveugle !

### Les logs vous permettent de :

- **Diagnostiquer les probl√®mes** : Comprendre pourquoi quelque chose ne fonctionne pas
- **Surveiller la s√©curit√©** : D√©tecter les tentatives d'intrusion
- **Optimiser les performances** : Identifier les goulots d'√©tranglement
- **Auditer les actions** : Savoir qui a fait quoi et quand
- **Planifier la maintenance** : Anticiper les pannes

## 3.4.1 Syst√®me de logs (rsyslog, journald)

### Architecture des logs sous Debian

Debian utilise deux syst√®mes de logs principaux qui coexistent :

1. **rsyslog** : Syst√®me traditionnel, stocke dans des fichiers texte
2. **journald** : Syst√®me moderne de systemd, stockage binaire

### Rsyslog - Le syst√®me traditionnel

#### Fichiers de logs principaux

```bash
# R√©pertoire principal des logs
ls -la /var/log/

# Logs les plus importants :
/var/log/syslog          # Journal syst√®me g√©n√©ral
/var/log/auth.log        # Authentifications (sudo, ssh, login)
/var/log/kern.log        # Messages du noyau Linux
/var/log/daemon.log      # Services syst√®me (daemons)
/var/log/mail.log        # Serveur de messagerie
/var/log/apache2/        # Serveur web Apache
/var/log/nginx/          # Serveur web Nginx
/var/log/mysql/          # Base de donn√©es MySQL
/var/log/dpkg.log        # Installation/suppression de paquets
/var/log/apt/            # Gestionnaire de paquets APT
```

#### Structure d'une ligne de log

```bash
# Exemple typique :
Jan 15 14:30:25 monserveur sshd[1234]: Accepted password for marie from 192.168.1.100 port 22 ssh2

# D√©composition :
# Jan 15 14:30:25    : Date et heure
# monserveur         : Nom de la machine
# sshd[1234]         : Service et PID
# Accepted password... : Message du service
```

#### Configuration de rsyslog

```bash
# Fichier de configuration principal
sudo nano /etc/rsyslog.conf

# R√©pertoire des configurations suppl√©mentaires
ls /etc/rsyslog.d/

# Red√©marrer rsyslog apr√®s modification
sudo systemctl restart rsyslog
```

#### Exemple de configuration rsyslog

```bash
# Dans /etc/rsyslog.d/50-custom.conf
# Envoyer tous les logs d'Apache dans un fichier d√©di√©
:programname, isequal, "apache2" /var/log/apache2/custom.log

# Filtrer par niveau de priorit√©
*.err                           /var/log/errors.log
mail.*                          /var/log/mail.log
```

### Journald - Le syst√®me moderne

#### Comprendre journald

Journald fait partie de systemd et stocke les logs dans un format binaire optimis√©. Il compl√®te rsyslog en offrant des fonctionnalit√©s avanc√©es.

#### Avantages de journald

- **Indexation rapide** : Recherche plus efficace
- **M√©tadonn√©es riches** : Plus d'informations sur chaque entr√©e
- **Int√©gration systemd** : Liens directs avec les services
- **Compression automatique** : √âconomie d'espace disque
- **Horodatage pr√©cis** : Microseconde de pr√©cision

#### Configuration de journald

```bash
# Fichier de configuration
sudo nano /etc/systemd/journald.conf

# Options importantes :
[Journal]
Storage=persistent          # Stockage permanent
Compress=yes               # Compression des logs
SystemMaxUse=100M         # Limite d'utilisation disque
MaxRetentionSec=1month    # Dur√©e de r√©tention
ForwardToSyslog=yes       # Envoi vers rsyslog
```

#### Consultation avec journalctl

```bash
# Voir tous les logs
journalctl

# Logs depuis le dernier d√©marrage
journalctl -b

# Logs d'un service sp√©cifique
journalctl -u apache2
journalctl -u ssh

# Suivre les logs en temps r√©el
journalctl -f

# Logs d'une p√©riode sp√©cifique
journalctl --since "2024-01-15 10:00:00"
journalctl --since "1 hour ago"
journalctl --until "2024-01-15 12:00:00"

# Logs par priorit√©
journalctl -p err          # Erreurs uniquement
journalctl -p warning      # Avertissements et plus grave
journalctl -p info         # Informations et plus grave

# Logs d'un utilisateur
journalctl _UID=1000

# Logs d'un processus
journalctl _PID=1234
```

### Niveaux de priorit√© des logs

| Priorit√© | Nom | Description | Exemple |
|----------|-----|-------------|---------|
| 0 | emerg | Urgence syst√®me | Syst√®me inutilisable |
| 1 | alert | Action imm√©diate | Base de donn√©es corrompue |
| 2 | crit | Critique | Disque dur d√©faillant |
| 3 | err | Erreur | Service qui ne d√©marre pas |
| 4 | warning | Avertissement | Espace disque faible |
| 5 | notice | Notice | Service red√©marr√© |
| 6 | info | Information | Utilisateur connect√© |
| 7 | debug | Debug | D√©tails techniques |

## 3.4.2 Analyse des logs (grep, awk, sed)

### Grep - Recherche dans les logs

Grep est votre meilleur ami pour trouver des informations sp√©cifiques dans les logs.

#### Utilisation de base

```bash
# Rechercher une cha√Æne simple
grep "error" /var/log/syslog

# Recherche insensible √† la casse
grep -i "error" /var/log/syslog

# Compter les occurrences
grep -c "failed" /var/log/auth.log

# Afficher les num√©ros de ligne
grep -n "ssh" /var/log/auth.log

# Recherche dans plusieurs fichiers
grep "marie" /var/log/auth.log /var/log/syslog
```

#### Recherches avanc√©es avec grep

```bash
# Expressions r√©guli√®res
grep "Jan 1[5-9]" /var/log/syslog     # Dates du 15 au 19 janvier
grep "192\.168\.1\.[0-9]+" /var/log/auth.log  # Adresses IP du r√©seau local

# Exclure des lignes
grep -v "INFO" /var/log/syslog        # Tout sauf les INFO

# Contexte autour des r√©sultats
grep -A 3 -B 3 "error" /var/log/syslog  # 3 lignes avant et apr√®s

# Recherchez r√©cursive dans un r√©pertoire
grep -r "failed login" /var/log/

# Surligner les r√©sultats
grep --color=always "error" /var/log/syslog
```

#### Cas d'usage pratiques avec grep

```bash
# Tentatives de connexion √©chou√©es
grep "Failed password" /var/log/auth.log

# Connexions SSH r√©ussies
grep "Accepted password" /var/log/auth.log

# Erreurs dans les logs syst√®me
grep -i "error\|fail\|critical" /var/log/syslog

# Analyser les installations de paquets
grep "install" /var/log/dpkg.log

# Surveillance des red√©marrages
grep "kernel" /var/log/syslog | grep "Linux version"
```

### Awk - Traitement avanc√© des logs

Awk excelle dans le traitement de donn√©es structur√©es comme les logs.

#### Concepts de base awk

```bash
# Afficher une colonne sp√©cifique
awk '{print $1}' /var/log/auth.log    # Premi√®re colonne (mois)
awk '{print $1, $2, $3}' /var/log/auth.log  # Date compl√®te

# Avec des s√©parateurs personnalis√©s
awk -F: '{print $1}' /etc/passwd      # Utiliser : comme s√©parateur
```

#### Exemples pratiques avec awk

```bash
# Extraire les heures de connexion
awk '/Accepted password/ {print $1, $2, $3, $9}' /var/log/auth.log

# Compter les connexions par utilisateur
awk '/Accepted password/ {print $9}' /var/log/auth.log | sort | uniq -c

# Statistiques d'erreurs par heure
awk '/error/ {print $3}' /var/log/syslog | cut -d: -f1 | sort | uniq -c

# Analyser la consommation de bande passante Apache
awk '{print $1, $7, $10}' /var/log/apache2/access.log

# Filtrer par conditions
awk '$10 > 10000 {print $1, $7, $10}' /var/log/apache2/access.log  # R√©ponses > 10KB
```

### Sed - √âdition et transformation

Sed permet de modifier et nettoyer les logs √† la vol√©e.

#### Utilisation de base

```bash
# Remplacer du texte
sed 's/error/ERROR/g' /var/log/syslog

# Supprimer des lignes vides
sed '/^$/d' /var/log/syslog

# Afficher seulement certaines lignes
sed -n '100,200p' /var/log/syslog     # Lignes 100 √† 200

# Supprimer les lignes contenant un motif
sed '/DEBUG/d' /var/log/syslog
```

#### Cas pratiques avec sed

```bash
# Nettoyer les adresses IP pour l'anonymisation
sed 's/192\.168\.[0-9]\+\.[0-9]\+/XXX.XXX.XXX.XXX/g' /var/log/auth.log

# Extraire seulement l'heure des logs
sed 's/^.*\([0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}\).*$/\1/' /var/log/syslog

# Formater les logs pour un rapport
sed 's/^/[LOG] /' /var/log/syslog | head -10
```

### Combinaison d'outils - Pipelines puissants

```bash
# Top 10 des IP qui tentent de se connecter
grep "Failed password" /var/log/auth.log | awk '{print $11}' | sort | uniq -c | sort -nr | head -10

# Analyser les erreurs par service
grep -i error /var/log/syslog | awk '{print $5}' | sed 's/\[.*\]//' | sort | uniq -c | sort -nr

# Statistiques horaires de connexions SSH
grep "Accepted password" /var/log/auth.log | awk '{print $3}' | cut -d: -f1 | sort | uniq -c

# G√©n√©rer un rapport quotidien
{
  echo "=== Rapport de logs du $(date) ==="
  echo "Connexions r√©ussies: $(grep -c "Accepted password" /var/log/auth.log)"
  echo "Tentatives √©chou√©es: $(grep -c "Failed password" /var/log/auth.log)"
  echo "Erreurs syst√®me: $(grep -c -i error /var/log/syslog)"
} > rapport_quotidien.txt
```

## 3.4.3 Outils de monitoring (nagios, zabbix)

### Introduction au monitoring

Le monitoring consiste √† surveiller votre syst√®me en continu pour d√©tecter les probl√®mes avant qu'ils n'impactent les utilisateurs.

### Types de monitoring

1. **Infrastructure** : CPU, m√©moire, disque, r√©seau
2. **Services** : Apache, MySQL, SSH, etc.
3. **Applications** : Temps de r√©ponse, erreurs m√©tier
4. **S√©curit√©** : Tentatives d'intrusion, anomalies

### Outils de monitoring simples int√©gr√©s

#### Htop et outils syst√®me

```bash
# Installation d'outils de base
sudo apt update
sudo apt install htop iotop nethogs

# Surveillance en temps r√©el
htop           # Processus et ressources
iotop          # Activit√© disque
nethogs        # Utilisation r√©seau par processus
```

#### Outils en ligne de commande

```bash
# Surveillance ressources
watch -n 1 'free -h && df -h'  # M√©moire et disque toutes les secondes

# Surveillance r√©seau
ss -tuln       # Ports ouverts
netstat -i     # Statistiques interfaces r√©seau

# Surveillance des services
systemctl status --all | grep failed  # Services en √©chec
```

### Nagios - Monitoring traditionnel

#### Qu'est-ce que Nagios ?

Nagios est un syst√®me de monitoring v√©n√©rable et tr√®s utilis√© qui surveille vos h√¥tes et services, et envoie des alertes quand quelque chose va mal.

#### Installation de Nagios

```bash
# Installation des pr√©requis
sudo apt update
sudo apt install apache2 apache2-utils php libapache2-mod-php

# Installation de Nagios
sudo apt install nagios4 nagios-plugins

# Configuration Apache pour Nagios
sudo a2enmod cgi
sudo systemctl restart apache2

# Cr√©er un utilisateur pour l'interface web
sudo htpasswd -c /etc/nagios4/htpasswd.users nagiosadmin
```

#### Configuration de base Nagios

```bash
# Fichiers de configuration principaux
/etc/nagios4/nagios.cfg          # Configuration principale
/etc/nagios4/conf.d/             # Configurations sp√©cifiques
/etc/nagios4/objects/            # D√©finitions d'objets

# V√©rifier la configuration
sudo nagios4 -v /etc/nagios4/nagios.cfg

# Red√©marrer Nagios
sudo systemctl restart nagios4
```

#### Exemple de configuration d'h√¥te

```bash
# Cr√©er /etc/nagios4/conf.d/serveur-web.cfg
define host {
    use                     linux-server
    host_name               serveur-web
    alias                   Serveur Web Principal
    address                 192.168.1.100
    max_check_attempts      3
    check_period           24x7
    notification_interval   30
    notification_period     24x7
}

define service {
    use                     generic-service
    host_name               serveur-web
    service_description     HTTP
    check_command           check_http
}
```

### Zabbix - Monitoring moderne

#### Avantages de Zabbix

- **Interface web moderne** et intuitive
- **Auto-d√©couverte** des services
- **M√©triques personnalis√©es** facilement
- **Graphiques avanc√©s** et tableaux de bord
- **API REST** pour l'automatisation

#### Installation de Zabbix

```bash
# Ajouter le d√©p√¥t Zabbix
wget https://repo.zabbix.com/zabbix/6.4/debian/pool/main/z/zabbix-release/zabbix-release_6.4-1+debian12_all.deb
sudo dpkg -i zabbix-release_6.4-1+debian12_all.deb
sudo apt update

# Installation du serveur Zabbix
sudo apt install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabbix-sql-scripts zabbix-agent

# Installation de MariaDB
sudo apt install mariadb-server

# Configuration de la base de donn√©es
sudo mysql -u root -p
CREATE DATABASE zabbix character set utf8mb4 collate utf8mb4_bin;
CREATE USER 'zabbix'@'localhost' IDENTIFIED BY 'motdepasse_fort';
GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# Import du sch√©ma
zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql --default-character-set=utf8mb4 -uzabbix -p zabbix
```

#### Configuration Zabbix

```bash
# Configuration serveur
sudo nano /etc/zabbix/zabbix_server.conf
# Modifier :
# DBPassword=motdepasse_fort

# Configuration Apache
sudo nano /etc/zabbix/apache.conf
# D√©commenter et ajuster le timezone :
# php_value date.timezone Europe/Paris

# D√©marrer les services
sudo systemctl restart zabbix-server zabbix-agent apache2
sudo systemctl enable zabbix-server zabbix-agent apache2
```

### Alternatives plus simples

#### Netdata - Monitoring en temps r√©el

```bash
# Installation simple
bash <(curl -Ss https://my-netdata.io/kickstart.sh)

# Interface web disponible sur http://localhost:19999
# Monitoring automatique de tout le syst√®me
```

#### Glances - Top avanc√©

```bash
# Installation
sudo apt install glances

# Utilisation
glances           # Interface locale
glances -w        # Interface web sur port 61208
glances -s        # Mode serveur
```

## 3.4.4 Alertes et notifications

### Types d'alertes

1. **Critiques** : Syst√®me down, espace disque plein
2. **Avertissements** : Charge √©lev√©e, m√©moire faible
3. **Informations** : Service red√©marr√©, mise √† jour install√©e

### M√©thodes de notification

#### Email avec sendmail/postfix

```bash
# Installation d'un serveur mail simple
sudo apt install postfix mailutils

# Configuration minimale pour envoi local
sudo dpkg-reconfigure postfix
# Choisir "Local only"

# Test d'envoi
echo "Test d'alerte" | mail -s "Test syst√®me" admin@localhost
```

#### Scripts d'alerte personnalis√©s

```bash
# Script d'alerte espace disque
#!/bin/bash
# /usr/local/bin/alert-disk.sh

THRESHOLD=80
USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')

if [ $USAGE -gt $THRESHOLD ]; then
    echo "ALERTE: Espace disque √† ${USAGE}% sur $(hostname)" | \
    mail -s "Alerte espace disque" admin@exemple.com
fi
```

#### Int√©gration avec des services modernes

```bash
# Webhook Slack/Discord
#!/bin/bash
# Fonction d'envoi vers Slack
send_slack_alert() {
    local message="$1"
    curl -X POST -H 'Content-type: application/json' \
    --data "{\"text\":\"$message\"}" \
    https://hooks.slack.com/services/VOTRE/WEBHOOK/URL
}

# Utilisation
send_slack_alert "Serveur $(hostname): Charge syst√®me √©lev√©e"
```

### Configuration d'alertes avec systemd

#### Services de surveillance personnalis√©s

```bash
# Cr√©er un service de surveillance
sudo nano /etc/systemd/system/disk-monitor.service

[Unit]
Description=Surveillance espace disque
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/alert-disk.sh

[Install]
WantedBy=multi-user.target
```

```bash
# Timer pour ex√©cution p√©riodique
sudo nano /etc/systemd/system/disk-monitor.timer

[Unit]
Description=Surveillance espace disque toutes les heures
Requires=disk-monitor.service

[Timer]
OnCalendar=hourly
Persistent=true

[Install]
WantedBy=timers.target
```

```bash
# Activer le timer
sudo systemctl daemon-reload
sudo systemctl enable --now disk-monitor.timer
```

### Alertes avec fail2ban

```bash
# Installation
sudo apt install fail2ban

# Configuration des alertes email
sudo nano /etc/fail2ban/jail.local

[DEFAULT]
destemail = admin@exemple.com
sender = fail2ban@exemple.com
mta = sendmail
action = %(action_mwl)s  # Mail avec logs

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
```

### Surveillance proactive avec scripts

#### Script de sant√© syst√®me

```bash
#!/bin/bash
# /usr/local/bin/system-health.sh

# Configuration
EMAIL="admin@exemple.com"
HOSTNAME=$(hostname)
LOG_FILE="/var/log/system-health.log"

# Fonction de log
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# V√©rifications
check_disk_space() {
    USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $USAGE -gt 80 ]; then
        echo "CRITIQUE: Espace disque √† ${USAGE}%"
        return 1
    fi
    return 0
}

check_memory() {
    MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ $MEM_USAGE -gt 90 ]; then
        echo "CRITIQUE: Utilisation m√©moire √† ${MEM_USAGE}%"
        return 1
    fi
    return 0
}

check_load() {
    LOAD=$(uptime | awk '{print $10}' | cut -d, -f1)
    CORES=$(nproc)
    if (( $(echo "$LOAD > $CORES" | bc -l) )); then
        echo "AVERTISSEMENT: Charge syst√®me √©lev√©e: $LOAD"
        return 1
    fi
    return 0
}

# Ex√©cution des v√©rifications
ALERTS=""
if ! check_disk_space; then ALERTS="$ALERTS$(check_disk_space)\n"; fi
if ! check_memory; then ALERTS="$ALERTS$(check_memory)\n"; fi
if ! check_load; then ALERTS="$ALERTS$(check_load)\n"; fi

# Envoi des alertes
if [ -n "$ALERTS" ]; then
    echo -e "Alertes syst√®me pour $HOSTNAME:\n\n$ALERTS" | \
    mail -s "Alerte syst√®me - $HOSTNAME" $EMAIL
    log_message "Alertes envoy√©es: $ALERTS"
else
    log_message "Syst√®me OK"
fi
```

### Tableau de bord simple

```bash
#!/bin/bash
# /usr/local/bin/dashboard.sh
# Tableau de bord syst√®me simple

clear
echo "=== TABLEAU DE BORD SYST√àME ==="
echo "Serveur: $(hostname)"
echo "Date: $(date)"
echo "Uptime: $(uptime -p)"
echo ""

echo "=== RESSOURCES ==="
echo "CPU: $(top -bn1 | grep load | awk '{printf "%.2f%%", $(NF-2)*100}')"
echo "M√©moire: $(free | awk 'NR==2{printf "%.0f%%", $3*100/$2}')"
echo "Disque: $(df -h / | awk 'NR==2{print $5}')"
echo ""

echo "=== SERVICES ==="
systemctl is-active ssh apache2 mysql | paste <(echo -e "SSH\nApache\nMySQL") -
echo ""

echo "=== LOGS R√âCENTS ==="
echo "Erreurs (derni√®re heure):"
journalctl --since "1 hour ago" -p err --no-pager -n 5
```

### Conseils pour un bon monitoring

1. **Commencez simple** : Surveillez d'abord l'essentiel (CPU, m√©moire, disque)
2. **√âvitez les fausses alertes** : Ajustez les seuils progressivement
3. **Documentez vos seuils** : Expliquez pourquoi 80% pour le disque
4. **Testez vos alertes** : V√©rifiez qu'elles arrivent bien
5. **Automatisez la r√©solution** : Scripts de nettoyage automatique
6. **Gardez un historique** : Tendances sur plusieurs mois
7. **Surveillez les surveillants** : Le monitoring doit √™tre monitor√© !

Cette approche progressive du monitoring vous permettra de maintenir un syst√®me stable et de r√©soudre les probl√®mes avant qu'ils n'impactent vos utilisateurs.

‚è≠Ô∏è
