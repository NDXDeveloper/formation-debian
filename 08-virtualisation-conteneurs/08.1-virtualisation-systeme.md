üîù Retour au [Sommaire](/SOMMAIRE.md)

# 8.1 Virtualisation syst√®me

## Introduction

La virtualisation syst√®me permet de faire fonctionner plusieurs syst√®mes d'exploitation complets sur une m√™me machine physique. Contrairement aux conteneurs qui partagent le noyau, chaque machine virtuelle (VM) poss√®de son propre syst√®me d'exploitation isol√©.

**Pourquoi utiliser la virtualisation ?**
- **Optimisation des ressources** : une machine physique peut h√©berger plusieurs VMs
- **Isolation compl√®te** : chaque VM est totalement ind√©pendante
- **Flexibilit√©** : tester diff√©rents OS sans impacter le syst√®me h√¥te
- **S√©curit√©** : isolation forte entre les environnements
- **√âconomies** : r√©duction du nombre de serveurs physiques

---

## 8.1.1 KVM et QEMU

### Qu'est-ce que KVM et QEMU ?

**KVM (Kernel-based Virtual Machine)** est un module du noyau Linux qui transforme votre syst√®me Debian en hyperviseur. Il utilise les extensions de virtualisation du processeur (Intel VT-x ou AMD-V).

**QEMU (Quick Emulator)** est un √©mulateur qui, combin√© avec KVM, fournit une virtualisation haute performance.

**L'alliance KVM + QEMU** offre :
- Performance quasi-native (95-98% des performances physiques)
- Support de tous les types d'OS invit√©s
- Gestion avanc√©e de la m√©moire et du CPU
- Virtualisation assist√©e par mat√©riel

### V√©rification du support mat√©riel

Avant d'installer KVM, v√©rifiez que votre processeur supporte la virtualisation :

```bash
# V√©rifier les extensions de virtualisation
egrep -c '(vmx|svm)' /proc/cpuinfo

# Si le r√©sultat est > 0, la virtualisation est support√©e
# vmx = Intel VT-x
# svm = AMD-V

# V√©rification plus d√©taill√©e
lscpu | grep Virtualization
```

**Note pour d√©butants :** Si ces commandes ne retournent rien, votre processeur ne supporte pas la virtualisation mat√©rielle, ou celle-ci est d√©sactiv√©e dans le BIOS/UEFI.

### Installation de KVM et QEMU

```bash
# Mise √† jour du syst√®me
sudo apt update

# Installation des paquets essentiels
sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils

# V√©rification que KVM fonctionne
sudo systemctl status libvirtd

# Ajouter votre utilisateur au groupe libvirt
sudo usermod -aG libvirt $USER
sudo usermod -aG kvm $USER

# Red√©marrer la session pour appliquer les groupes
# ou utiliser : newgrp libvirt
```

**Explication des paquets :**
- `qemu-kvm` : √©mulateur QEMU avec support KVM
- `libvirt-daemon-system` : daemon de gestion des VMs
- `libvirt-clients` : outils en ligne de commande
- `bridge-utils` : outils pour la gestion des ponts r√©seau

### V√©rification de l'installation

```bash
# V√©rifier que KVM est charg√©
lsmod | grep kvm

# Tester la connexion √† libvirt
virsh list --all

# V√©rifier les capacit√©s du syst√®me
virt-host-validate
```

### Concepts de base QEMU/KVM

**Architecture simplifi√©e :**
```
Application VM (OS invit√©)
‚Üì
QEMU (√©mulation des p√©riph√©riques)
‚Üì
KVM (module kernel pour CPU/m√©moire)
‚Üì
Mat√©riel physique
```

**Fichiers importants :**
- `/etc/libvirt/` : configuration libvirt
- `/var/lib/libvirt/images/` : emplacement par d√©faut des disques VMs
- `/etc/libvirt/qemu/` : configurations XML des VMs

---

## 8.1.2 libvirt et virt-manager

### Qu'est-ce que libvirt ?

**libvirt** est une API et un daemon qui fournit une interface unifi√©e pour g√©rer diff√©rents hyperviseurs (KVM, Xen, VMware, etc.). Il offre :
- Gestion centralis√©e des VMs
- Interface standardis√©e
- S√©curit√© et authentification
- Gestion du stockage et r√©seau
- APIs pour l'automation

### Installation de virt-manager

**virt-manager** est l'interface graphique pour libvirt, parfaite pour les d√©butants :

```bash
# Installation de l'interface graphique
sudo apt install virt-manager virt-viewer

# Pour les environnements sans GUI, utiliser virt-install
sudo apt install virtinst
```

### Premi√®re utilisation de virt-manager

1. **Lancement :** Applications ‚Üí Administration ‚Üí Virtual Machine Manager
2. **Connexion automatique** √† `qemu:///system`
3. **Interface principale** affiche la liste des VMs

**√âl√©ments de l'interface :**
- **Liste des VMs** : √©tat, utilisation CPU/RAM
- **Boutons d'action** : d√©marrer, arr√™ter, pauser
- **Menu contextuel** : clic droit pour plus d'options

### Configuration de base libvirt

```bash
# Configuration du daemon libvirt
sudo systemctl enable libvirtd
sudo systemctl start libvirtd

# V√©rifier la configuration
virsh version

# Lister les r√©seaux virtuels
virsh net-list --all

# Lister les pools de stockage
virsh pool-list --all
```

### Gestion via ligne de commande

**Commandes virsh essentielles :**

```bash
# Lister toutes les VMs
virsh list --all

# D√©marrer une VM
virsh start nom-vm

# Arr√™ter proprement une VM
virsh shutdown nom-vm

# Forcer l'arr√™t
virsh destroy nom-vm

# Informations sur une VM
virsh dominfo nom-vm

# Modifier la configuration d'une VM
virsh edit nom-vm
```

**Note pour d√©butants :** `virsh` est l'outil en ligne de commande principal. M√™me si vous utilisez l'interface graphique, conna√Ætre quelques commandes de base est tr√®s utile.

### Structure des VMs dans libvirt

Chaque VM est d√©finie par :
- **Fichier XML** : configuration compl√®te (CPU, RAM, disques, r√©seau)
- **Disques virtuels** : fichiers image (qcow2, raw)
- **√âtat** : √©teinte, en marche, suspendue

---

## 8.1.3 VirtualBox

### Pourquoi VirtualBox ?

**VirtualBox** d'Oracle est un hyperviseur de type 2 (h√©berg√©) populaire pour :
- **Simplicit√© d'utilisation** : interface tr√®s conviviale
- **Support multi-plateforme** : Windows, macOS, Linux
- **Fonctionnalit√©s desktop** : partage de dossiers, copier-coller
- **Snapshots simples** : sauvegarde/restauration d'√©tats
- **Id√©al pour les tests** et l'apprentissage

### Installation de VirtualBox

**M√©thode 1 : D√©p√¥ts Debian (version stable)**
```bash
# Installation depuis les d√©p√¥ts officiels
sudo apt update
sudo apt install virtualbox virtualbox-ext-pack

# Ajouter l'utilisateur au groupe vboxusers
sudo usermod -aG vboxusers $USER
```

**M√©thode 2 : D√©p√¥t Oracle (version r√©cente)**
```bash
# Ajouter le d√©p√¥t Oracle
wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -
echo "deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian $(lsb_release -sc) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list

# Installation
sudo apt update
sudo apt install virtualbox-7.0
```

### Premi√®re utilisation VirtualBox

1. **Lancement :** `virtualbox` en terminal ou menu Applications
2. **Interface principale :** liste des VMs √† gauche, d√©tails √† droite
3. **Assistant de cr√©ation :** bouton "Nouvelle" pour cr√©er une VM

**√âtapes de cr√©ation d'une VM :**
1. **Nom et type d'OS** : Linux, Windows, etc.
2. **Allocation m√©moire** : RAM d√©di√©e √† la VM
3. **Disque dur virtuel** : taille et type
4. **Configuration finale** : CPU, r√©seau, etc.

### Avantages et limites de VirtualBox

**Avantages :**
- Interface graphique intuitive
- Excellent pour d√©buter en virtualisation
- Snapshots faciles √† g√©rer
- Additions invit√© (int√©gration desktop)
- Partage de dossiers simple

**Limites :**
- Performance moindre que KVM
- Moins adapt√© pour la production
- Interface web basique
- Pas d'API robuste pour l'automation

### Comparaison KVM vs VirtualBox

| Crit√®re | KVM/QEMU | VirtualBox |
|---------|----------|------------|
| **Performance** | Excellente (95-98%) | Bonne (80-90%) |
| **Facilit√© d'usage** | Mod√©r√©e | Tr√®s facile |
| **Production** | Excellent | D√©conseill√© |
| **Interface** | virt-manager/CLI | GUI conviviale |
| **Snapshots** | CLI/API | Interface simple |
| **R√©seau avanc√©** | Tr√®s flexible | Limit√© |

---

## 8.1.4 Gestion des machines virtuelles

### Cycle de vie d'une VM

**√âtapes typiques :**
1. **Planification** : besoin, OS, ressources
2. **Cr√©ation** : configuration initiale
3. **Installation** : OS et applications
4. **Configuration** : r√©seau, s√©curit√©, optimisations
5. **Exploitation** : surveillance, maintenance
6. **Sauvegarde** : snapshots, exports
7. **Suppression** : nettoyage des ressources

### Allocation des ressources

**CPU :**
- **Nombre de vCPUs** : g√©n√©ralement 1-2 par VM pour d√©buter
- **Limite** : ne pas d√©passer le nombre de c≈ìurs physiques
- **Bonnes pratiques** : surveiller l'utilisation CPU de l'h√¥te

**M√©moire RAM :**
- **Allocation dynamique** : la VM utilise seulement ce dont elle a besoin
- **Allocation statique** : RAM r√©serv√©e m√™me si non utilis√©e
- **R√®gle g√©n√©rale** : laisser au moins 2 GB pour l'h√¥te

**Stockage :**
- **Formats de disques** :
  - `qcow2` : format KVM avec compression et snapshots
  - `raw` : performance maximale, pas de fonctionnalit√©s avanc√©es
  - `VDI` : format VirtualBox
- **Allocation** :
  - **Thin provisioning** : le fichier grandit selon les besoins
  - **Thick provisioning** : espace r√©serv√© imm√©diatement

### Gestion avec virt-manager

**Cr√©ation d'une VM :**
1. **Nouvelle VM** ‚Üí Assistant de cr√©ation
2. **Source d'installation** : ISO, r√©seau, import
3. **Allocation m√©moire et CPU**
4. **Configuration stockage**
5. **Configuration r√©seau**
6. **Finalisation et d√©marrage**

**Gestion quotidienne :**
- **Console VNC** : acc√®s √† l'√©cran de la VM
- **Surveillance** : graphiques CPU, m√©moire, I/O
- **Snapshots** : sauvegarde d'√©tat instantan√©
- **Migration** : d√©placement vers autre h√¥te

### Gestion avec VirtualBox

**Interface VirtualBox Manager :**
- **Liste des VMs** : √©tat et utilisation ressources
- **Param√®tres VM** : configuration d√©taill√©e
- **Snapshots** : arbre des √©tats sauvegard√©s
- **Logs** : historique et d√©bogage

**Additions invit√© :**
```bash
# Dans la VM Linux
sudo apt install build-essential dkms linux-headers-$(uname -r)
# Puis ins√©rer le CD des additions depuis le menu VirtualBox
```

### Bonnes pratiques de gestion

**Nommage et organisation :**
- Noms explicites : `web-server-prod`, `test-debian-12`
- Tags et descriptions pour le classement
- Dossiers pour regrouper les VMs par projet

**Surveillance :**
- **Ressources h√¥te** : √©viter la sur-allocation
- **Performance VMs** : identifier les goulots d'√©tranglement
- **Logs syst√®me** : `/var/log/libvirt/` pour KVM

**Maintenance :**
- Mises √† jour r√©guli√®res des VMs
- Nettoyage des snapshots anciens
- D√©fragmentation des disques virtuels
- Sauvegarde des configurations importantes

---

## 8.1.5 R√©seaux virtuels avanc√©s

### Concepts de base r√©seau VM

**Types de connexion r√©seau :**

1. **NAT (Network Address Translation)**
   - VM derri√®re un routeur virtuel
   - Acc√®s internet, pas d'acc√®s depuis l'ext√©rieur
   - **Usage :** VMs isol√©es avec acc√®s web

2. **Bridge (Pont)**
   - VM directement sur le r√©seau physique
   - Obtient une IP du routeur comme une machine physique
   - **Usage :** serveurs accessibles depuis le r√©seau

3. **Host-only**
   - R√©seau priv√© entre h√¥te et VMs
   - Pas d'acc√®s internet pour les VMs
   - **Usage :** laboratoires isol√©s

4. **Internal**
   - R√©seau priv√© entre VMs uniquement
   - Isolation compl√®te
   - **Usage :** r√©seaux de test internes

### Configuration r√©seau avec libvirt

**R√©seau par d√©faut :**
```bash
# Voir la configuration du r√©seau par d√©faut
virsh net-dumpxml default

# D√©marrer/arr√™ter un r√©seau
virsh net-start default
virsh net-destroy default

# Configuration automatique au d√©marrage
virsh net-autostart default
```

**Cr√©ation d'un r√©seau personnalis√© :**
```xml
<!-- fichier: mon-reseau.xml -->
<network>
  <name>mon-reseau-prive</name>
  <forward mode='nat'/>
  <bridge name='virbr1' stp='on' delay='0'/>
  <ip address='192.168.100.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.100.100' end='192.168.100.200'/>
    </dhcp>
  </ip>
</network>
```

```bash
# D√©finir et d√©marrer le r√©seau
virsh net-define mon-reseau.xml
virsh net-start mon-reseau-prive
virsh net-autostart mon-reseau-prive
```

### Configuration bridge pour VMs

**Cr√©ation d'un pont r√©seau :**
```bash
# Installation des outils bridge
sudo apt install bridge-utils

# Cr√©ation d'un pont (m√©thode temporaire)
sudo brctl addbr br0
sudo brctl addif br0 eth0
sudo dhclient br0
```

**Configuration permanente dans `/etc/network/interfaces` :**
```
# Interface physique
auto eth0
iface eth0 inet manual

# Pont r√©seau
auto br0
iface br0 inet dhcp
bridge_ports eth0
bridge_stp off
bridge_fd 0
bridge_maxwait 0
```

### R√©seaux avanc√©s avec virt-manager

**Configuration par l'interface :**
1. **Gestionnaire de connexion** ‚Üí **R√©seaux virtuels**
2. **Nouveau r√©seau** ‚Üí Assistant de cr√©ation
3. **Choix du mode** : NAT, isol√©, bridge
4. **Configuration IP** : plage DHCP, adresse passerelle
5. **Finalisation** et application

**Modification d'une VM :**
1. **Param√®tres VM** ‚Üí **Mat√©riel r√©seau**
2. **Choix de la source** : r√©seau virtuel ou bridge
3. **Mod√®le de carte** : virtio pour performance
4. **Adresse MAC** : g√©n√©ration automatique ou manuelle

### R√©seau VirtualBox

**Types de cartes r√©seau VirtualBox :**

1. **NAT** : mode par d√©faut, isolation avec acc√®s internet
2. **Bridged Adapter** : connexion directe au r√©seau physique
3. **Internal Network** : r√©seau priv√© entre VMs
4. **Host-only Adapter** : r√©seau priv√© h√¥te-VMs
5. **NAT Network** : NAT partag√© entre plusieurs VMs

**Configuration via interface :**
- **Param√®tres VM** ‚Üí **R√©seau**
- Jusqu'√† 4 cartes r√©seau par VM
- Configuration avanc√©e : type de carte, mode promiscuit√©

### D√©pannage r√©seau

**Probl√®mes courants :**

1. **VM sans acc√®s internet :**
   ```bash
   # V√©rifier la configuration r√©seau de la VM
   ip addr show
   ping 8.8.8.8

   # V√©rifier le r√©seau virtuel sur l'h√¥te
   virsh net-list
   brctl show
   ```

2. **VM non accessible depuis l'ext√©rieur :**
   - V√©rifier le mode r√©seau (doit √™tre bridge)
   - Contr√¥ler le pare-feu de l'h√¥te
   - V√©rifier la configuration IP de la VM

3. **Performance r√©seau faible :**
   - Utiliser les pilotes virtio
   - V√©rifier la bande passante disponible
   - Optimiser la configuration de la carte r√©seau

**Outils de diagnostic :**
```bash
# Test de connectivit√©
ping, traceroute, netstat

# Analyse du trafic
tcpdump -i virbr0

# Monitoring de la bande passante
iftop, vnstat
```

### S√©curit√© r√©seau des VMs

**Isolation r√©seau :**
- Utiliser des r√©seaux internes pour isoler les VMs sensibles
- Configurer des VLANs pour la segmentation
- Appliquer des r√®gles de pare-feu sp√©cifiques

**Monitoring du trafic :**
- Surveiller les connexions suspectes
- Logger les acc√®s r√©seau
- Utiliser des IDS/IPS sur les r√©seaux virtuels

---

## R√©sum√© et bonnes pratiques

### Points cl√©s √† retenir

1. **KVM/QEMU** offre les meilleures performances pour la production
2. **VirtualBox** est id√©al pour l'apprentissage et les tests
3. **libvirt** unifie la gestion des hyperviseurs
4. **virt-manager** facilite la gestion graphique
5. **Les r√©seaux virtuels** offrent flexibilit√© et s√©curit√©

### Conseils pour d√©buter

- **Commencez par VirtualBox** si vous d√©butez en virtualisation
- **Passez √† KVM/QEMU** pour des besoins de performance
- **Utilisez l'interface graphique** puis apprenez la ligne de commande
- **Testez diff√©rents types de r√©seaux** pour comprendre les usages
- **Documentez vos configurations** pour faciliter la maintenance

### Pr√©paration pour la suite

La ma√Ætrise de la virtualisation syst√®me est essentielle avant d'aborder les conteneurs. Les concepts d'isolation, de gestion des ressources et de r√©seaux virtuels sont transposables aux technologies de conteneurisation que nous verrons dans les sections suivantes.

---

*La virtualisation syst√®me reste fondamentale m√™me √† l'√®re des conteneurs. Elle offre une isolation compl√®te et la possibilit√© de faire coexister diff√©rents syst√®mes d'exploitation, compl√©mentant parfaitement l'approche conteneur pour une infrastructure hybride optimale.*

‚è≠Ô∏è
