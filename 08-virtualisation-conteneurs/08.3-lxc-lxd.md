üîù Retour au [Sommaire](/SOMMAIRE.md)

# 8.3 LXC/LXD

## Introduction

LXC (Linux Containers) et LXD (Linux Container Daemon) offrent une approche diff√©rente de la conteneurisation par rapport √† Docker. Alors que Docker se concentre sur les conteneurs d'applications, LXC/LXD propose des **conteneurs syst√®me** qui se comportent comme des machines virtuelles l√©g√®res.

**Diff√©rences cl√©s avec Docker :**
- **Conteneurs syst√®me complets** : environnement Linux complet avec init system
- **Persistance par d√©faut** : les conteneurs sont con√ßus pour fonctionner en permanence
- **Gestion comme des VMs** : approche similaire aux machines virtuelles traditionnelles
- **Multi-processus** : plusieurs services peuvent tourner dans un m√™me conteneur
- **Interface plus simple** : gestion intuitive des conteneurs syst√®me

**Cas d'usage typiques :**
- Remplacement l√©ger des machines virtuelles
- Environnements de d√©veloppement isol√©s
- Test de configurations syst√®me
- H√©bergement de services traditionnels
- Laboratoires de formation
- Migration d'infrastructure legacy

---

## 8.3.1 Conteneurs syst√®me

### Comprendre les conteneurs syst√®me

**Qu'est-ce qu'un conteneur syst√®me ?**
Un conteneur syst√®me LXC est un environnement Linux complet et isol√© qui :
- Poss√®de son propre syst√®me de fichiers racine
- Ex√©cute un syst√®me d'initialisation (systemd, sysvinit)
- Peut faire tourner plusieurs processus simultan√©ment
- Se comporte comme une machine virtuelle sans la virtualisation mat√©rielle
- Partage le noyau avec l'h√¥te mais maintient l'isolation des processus

**Architecture LXC :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Conteneur LXC               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Services (nginx, mysql)  ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ Syst√®me d'init (systemd) ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ OS userspace (Debian)    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Noyau Linux partag√© (H√¥te)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Installation de LXC sur Debian

**Installation des paquets de base :**
```bash
# Mise √† jour du syst√®me
sudo apt update

# Installation de LXC
sudo apt install lxc lxc-templates

# V√©rification de la configuration du noyau
lxc-checkconfig

# Installation des outils compl√©mentaires
sudo apt install bridge-utils debootstrap
```

**V√©rification de l'installation :**
```bash
# V√©rifier que tous les composants sont pr√©sents
lxc-checkconfig

# La sortie doit montrer "enabled" pour tous les √©l√©ments importants :
# - Namespaces (pid, net, ipc, mnt, uts)
# - Control groups
# - Security features
```

### Configuration de base LXC

**Configuration globale dans `/etc/lxc/default.conf` :**
```bash
# R√©seau par d√©faut
lxc.net.0.type = veth
lxc.net.0.link = lxcbr0
lxc.net.0.flags = up
lxc.net.0.hwaddr = 00:16:3e:xx:xx:xx

# Mapping des utilisateurs (pour conteneurs non-privil√©gi√©s)
lxc.idmap = u 0 100000 65536
lxc.idmap = g 0 100000 65536

# Point de montage pour systemd
lxc.mount.auto = cgroup:mixed proc:mixed sys:mixed
```

**Pr√©paration du r√©seau :**
```bash
# V√©rifier que le pont r√©seau existe
ip link show lxcbr0

# Si le pont n'existe pas, le cr√©er manuellement
sudo brctl addbr lxcbr0
sudo ip addr add 10.0.3.1/24 dev lxcbr0
sudo ip link set lxcbr0 up
```

### Cr√©ation du premier conteneur

**M√©thodes de cr√©ation :**

1. **Avec un template (m√©thode classique) :**
```bash
# Cr√©er un conteneur Debian
sudo lxc-create -n mon-debian -t debian

# Cr√©er avec une version sp√©cifique
sudo lxc-create -n debian12 -t debian -- --release bookworm

# Cr√©er un conteneur Ubuntu
sudo lxc-create -n mon-ubuntu -t ubuntu
```

2. **Avec debootstrap (plus de contr√¥le) :**
```bash
# Cr√©er un conteneur Debian personnalis√©
sudo lxc-create -n debian-custom -t debian -- --packages=vim,curl,htop --release=bookworm
```

**Structure d'un conteneur :**
```bash
# Localisation des conteneurs
ls /var/lib/lxc/

# Structure d'un conteneur
/var/lib/lxc/mon-debian/
‚îú‚îÄ‚îÄ config          # Configuration du conteneur
‚îú‚îÄ‚îÄ rootfs/          # Syst√®me de fichiers du conteneur
‚îî‚îÄ‚îÄ tmp_mount_point/ # Point de montage temporaire
```

### Gestion de base des conteneurs

**Commandes essentielles :**
```bash
# D√©marrer un conteneur
sudo lxc-start -n mon-debian

# D√©marrer en mode daemon (arri√®re-plan)
sudo lxc-start -n mon-debian -d

# V√©rifier l'√©tat des conteneurs
lxc-ls -f
# ou
sudo lxc-info -n mon-debian

# Se connecter √† un conteneur
sudo lxc-attach -n mon-debian

# Arr√™ter un conteneur proprement
sudo lxc-stop -n mon-debian

# Forcer l'arr√™t
sudo lxc-stop -n mon-debian -k

# Supprimer un conteneur
sudo lxc-destroy -n mon-debian
```

**√âtats des conteneurs :**
- **STOPPED** : conteneur arr√™t√©
- **STARTING** : en cours de d√©marrage
- **RUNNING** : conteneur actif
- **STOPPING** : en cours d'arr√™t
- **ABORTING** : arr√™t forc√© en cours
- **FREEZING/FROZEN** : conteneur suspendu

### Installation de LXD

**LXD** est un daemon moderne qui simplifie la gestion de LXC :

```bash
# Installation de LXD
sudo apt install lxd

# Ajouter l'utilisateur au groupe lxd
sudo usermod -aG lxd $USER

# Se reconnecter pour appliquer le groupe
newgrp lxd

# Initialisation de LXD
sudo lxd init
```

**Configuration interactive de LXD :**
```
Would you like to use LXD clustering? (yes/no) [default=no]: no
Do you want to configure a new storage pool? (yes/no) [default=yes]: yes
Name of the new storage pool [default=default]: default
Name of the storage backend to use (btrfs, dir, lvm, zfs) [default=zfs]: dir
Would you like to connect to a MAAS server? (yes/no) [default=no]: no
Would you like to create a new local network bridge? (yes/no) [default=yes]: yes
What should the new bridge be called? [default=lxdbr0]: lxdbr0
What IPv4 address should be used? [default=auto]: auto
What IPv6 address should be used? [default=auto]: auto
Would you like LXD to be available over the network? (yes/no) [default=no]: no
Would you like stale cached images to be updated automatically? (yes/no) [default=yes]: yes
```

### Premi√®re utilisation de LXD

**Commandes de base LXD :**
```bash
# Lister les conteneurs
lxc list

# Cr√©er et d√©marrer un conteneur Ubuntu
lxc launch ubuntu:22.04 mon-ubuntu

# Cr√©er un conteneur Debian
lxc launch images:debian/12 mon-debian

# Informations sur un conteneur
lxc info mon-ubuntu

# Se connecter √† un conteneur
lxc exec mon-ubuntu -- bash

# Arr√™ter un conteneur
lxc stop mon-ubuntu

# Supprimer un conteneur
lxc delete mon-ubuntu
```

**Comparaison LXC vs LXD :**
| Aspect | LXC | LXD |
|--------|-----|-----|
| **Interface** | Commandes lxc-* | Commande lxc unique |
| **Privil√®ges** | Souvent root requis | Utilisateur dans groupe lxd |
| **Configuration** | Fichiers manuels | API et interface simplifi√©e |
| **Images** | Templates locaux | Images distantes automatiques |
| **R√©seau** | Configuration manuelle | Gestion automatis√©e |
| **Snapshots** | Outils externes | Int√©gr√© natif |

---

## 8.3.2 Configuration et gestion avanc√©e

### Configuration d√©taill√©e des conteneurs

**Fichier de configuration LXC :**
Un conteneur LXC est d√©fini par son fichier de configuration (`/var/lib/lxc/nom/config`) :

```bash
# Configuration r√©seau
lxc.net.0.type = veth
lxc.net.0.name = eth0
lxc.net.0.link = lxcbr0
lxc.net.0.flags = up
lxc.net.0.ipv4.address = 10.0.3.100/24

# Limitations de ressources
lxc.cgroup2.memory.max = 512M
lxc.cgroup2.cpu.max = 50000 100000

# Points de montage
lxc.mount.entry = /host/shared /var/lib/lxc/conteneur/rootfs/shared none bind 0 0

# S√©curit√©
lxc.cap.drop = sys_admin sys_time
lxc.seccomp.profile = /usr/share/lxc/config/common.seccomp
```

### Gestion des ressources

**Limitation CPU :**
```bash
# Avec LXC classique (dans le fichier config)
lxc.cgroup2.cpu.max = 50000 100000  # 50% d'un CPU

# Avec LXD
lxc config set mon-conteneur limits.cpu 2
lxc config set mon-conteneur limits.cpu.allowance 50%
```

**Limitation m√©moire :**
```bash
# Avec LXC
lxc.cgroup2.memory.max = 1G

# Avec LXD
lxc config set mon-conteneur limits.memory 1GB
lxc config set mon-conteneur limits.memory.swap false
```

**Limitation I/O disque :**
```bash
# Avec LXD
lxc config device set mon-conteneur root limits.read 20MB
lxc config device set mon-conteneur root limits.write 10MB
```

### Profils LXD

**Qu'est-ce qu'un profil ?**
Un profil LXD est un ensemble de configurations r√©utilisables :

```bash
# Lister les profils existants
lxc profile list

# Voir le contenu du profil par d√©faut
lxc profile show default

# Cr√©er un nouveau profil
lxc profile create web-server

# √âditer un profil
lxc profile edit web-server
```

**Exemple de profil web-server :**
```yaml
config:
  limits.cpu: "2"
  limits.memory: 2GB
  user.meta.description: "Profil pour serveurs web"
description: Configuration optimis√©e pour serveurs web
devices:
  eth0:
    name: eth0
    network: lxdbr0
    type: nic
  root:
    path: /
    pool: default
    type: disk
  web-storage:
    path: /var/www
    source: /srv/web-data
    type: disk
name: web-server
```

**Utilisation des profils :**
```bash
# Cr√©er un conteneur avec un profil sp√©cifique
lxc launch ubuntu:22.04 web01 --profile web-server

# Appliquer un profil √† un conteneur existant
lxc profile assign mon-conteneur default,web-server

# Cr√©er un profil avec copie d'un existant
lxc profile copy default production
```

### Gestion du stockage

**Types de stockage LXD :**
1. **dir** : stockage dans r√©pertoire simple
2. **btrfs** : syst√®me de fichiers avec snapshots
3. **zfs** : syst√®me de fichiers avanc√© avec compression
4. **lvm** : logical volume manager
5. **ceph** : stockage distribu√©

**Cr√©ation de pools de stockage :**
```bash
# Pool de stockage ZFS
lxc storage create zfs-pool zfs

# Pool de stockage sur disque s√©par√©
lxc storage create ssd-pool dir source=/mnt/ssd/lxd

# Lister les pools
lxc storage list

# Voir les d√©tails d'un pool
lxc storage show default
```

**Gestion des volumes de stockage :**
```bash
# Cr√©er un volume de stockage
lxc storage volume create default shared-data

# Lister les volumes
lxc storage volume list default

# Attacher un volume √† un conteneur
lxc config device add mon-conteneur shared disk pool=default source=shared-data path=/shared
```

### Images et templates personnalis√©s

**Gestion des images LXD :**
```bash
# Lister les images disponibles localement
lxc image list

# Rechercher des images sur les serveurs distants
lxc image list images: | grep debian

# T√©l√©charger une image
lxc image copy images:debian/12 local: --alias debian-12

# Informations sur une image
lxc image info debian-12

# Supprimer une image
lxc image delete debian-12
```

**Cr√©ation d'images personnalis√©es :**
```bash
# Cr√©er une image depuis un conteneur
lxc publish mon-conteneur --alias mon-template-web

# Cr√©er une image avec m√©tadonn√©es
lxc publish mon-conteneur --alias web-template \
  --metadata web-template.yaml \
  description="Template serveur web Nginx + PHP"

# Exporter une image
lxc image export mon-template-web /tmp/
```

**Structure d'un fichier de m√©tadonn√©es :**
```yaml
# web-template.yaml
architecture: x86_64
creation_date: 1640995200
expiry_date: 1672531200
properties:
  description: "Serveur web avec Nginx et PHP 8.1"
  os: "debian"
  release: "12"
  variant: "default"
  requirements.cdi: "false"
templates:
  /etc/nginx/sites-available/default:
    when:
    - create
    - rename
    template: nginx-default.tpl
```

---

## 8.3.3 Snapshots et migration

### Syst√®me de snapshots

**Qu'est-ce qu'un snapshot ?**
Un snapshot est une capture de l'√©tat complet d'un conteneur √† un moment donn√©, incluant :
- Le syst√®me de fichiers
- La configuration du conteneur
- L'√©tat de la m√©moire (pour snapshots avec √©tat)

**Avantages des snapshots :**
- Sauvegarde rapide avant modifications
- Retour en arri√®re instantan√©
- Test de configurations sans risque
- D√©ploiement de conteneurs identiques

### Gestion des snapshots avec LXD

**Cr√©ation de snapshots :**
```bash
# Snapshot simple
lxc snapshot mon-conteneur backup-avant-update

# Snapshot avec commentaire
lxc snapshot web-server "pre-nginx-update" --comment "Avant mise √† jour Nginx 1.22"

# Snapshot stateful (avec √©tat m√©moire)
lxc snapshot mon-conteneur backup-avec-etat --stateful
```

**Gestion des snapshots :**
```bash
# Lister les snapshots d'un conteneur
lxc info mon-conteneur

# Voir les d√©tails d'un snapshot
lxc info mon-conteneur/backup-avant-update

# Restaurer un snapshot
lxc restore mon-conteneur backup-avant-update

# Supprimer un snapshot
lxc delete mon-conteneur/backup-avant-update
```

**Snapshots automatiques :**
```bash
# Configuration de snapshots automatiques
lxc config set mon-conteneur snapshots.schedule "0 6 * * *"
lxc config set mon-conteneur snapshots.schedule.stopped true
lxc config set mon-conteneur snapshots.pattern "auto-%d"
lxc config set mon-conteneur snapshots.expiry "7d"
```

### Migration de conteneurs

**Types de migration :**
1. **Migration √† froid** : conteneur arr√™t√©
2. **Migration √† chaud** : conteneur en fonctionnement (live migration)
3. **Migration inter-h√¥tes** : d√©placement vers un autre serveur

**Migration locale :**
```bash
# Copier un conteneur
lxc copy source-container destination-container

# Copier avec tous les snapshots
lxc copy source-container destination-container --copy-snapshots

# D√©placer un conteneur (renommer)
lxc move ancien-nom nouveau-nom
```

### Migration inter-h√¥tes

**Configuration d'un serveur LXD distant :**

**Sur le serveur de destination :**
```bash
# Configurer LXD pour l'acc√®s r√©seau
lxc config set core.https_address 0.0.0.0:8443
lxc config set core.trust_password motdepasse-securise

# G√©n√©rer certificat (optionnel)
lxc config trust add client.crt
```

**Sur le serveur source :**
```bash
# Ajouter le serveur distant
lxc remote add serveur2 https://ip-serveur2:8443

# V√©rifier la connexion
lxc list serveur2:

# Migrer un conteneur
lxc move mon-conteneur serveur2:mon-conteneur
```

**Migration avec copie :**
```bash
# Copier vers serveur distant
lxc copy mon-conteneur serveur2:mon-conteneur-copie

# Migration live (conteneur en marche)
lxc move mon-conteneur serveur2: --mode=push
```

### Sauvegarde et restauration

**Export/Import de conteneurs :**
```bash
# Exporter un conteneur complet
lxc export mon-conteneur /backup/mon-conteneur-$(date +%Y%m%d).tar.gz

# Exporter avec compression optimis√©e
lxc export mon-conteneur - | gzip -9 > /backup/mon-conteneur.tar.gz

# Importer un conteneur
lxc import /backup/mon-conteneur.tar.gz

# Importer avec nouveau nom
lxc import /backup/mon-conteneur.tar.gz --alias nouveau-conteneur
```

**Sauvegarde automatis√©e :**
```bash
#!/bin/bash
# backup-lxd.sh

BACKUP_DIR="/backup/lxd"
DATE=$(date +%Y%m%d_%H%M%S)

# Cr√©er le r√©pertoire de sauvegarde
mkdir -p "$BACKUP_DIR/$DATE"

# Boucler sur tous les conteneurs
for container in $(lxc list -c n --format csv); do
    echo "Sauvegarde de $container..."

    # Cr√©er un snapshot
    lxc snapshot "$container" "backup-$DATE"

    # Exporter le conteneur
    lxc export "$container" "$BACKUP_DIR/$DATE/$container.tar.gz"

    # Supprimer le snapshot temporaire
    lxc delete "$container/backup-$DATE"
done

echo "Sauvegarde termin√©e dans $BACKUP_DIR/$DATE"
```

**Strat√©gie de sauvegarde 3-2-1 :**
```bash
# Script de rotation des sauvegardes
#!/bin/bash

BACKUP_DIR="/backup/lxd"
REMOTE_BACKUP="/mnt/nas/lxd-backups"

# Garder 7 jours localement
find "$BACKUP_DIR" -type d -mtime +7 -exec rm -rf {} \;

# Synchroniser vers stockage distant
rsync -av --delete "$BACKUP_DIR/" "$REMOTE_BACKUP/"

# Garder 30 jours sur stockage distant
find "$REMOTE_BACKUP" -type d -mtime +30 -exec rm -rf {} \;
```

---

## 8.3.4 Int√©gration r√©seau

### Architecture r√©seau LXD

**Composants r√©seau :**
1. **Ponts r√©seau** (bridges) : lxdbr0, br0
2. **Profils r√©seau** : configurations r√©utilisables
3. **R√©seaux manag√©s** : DHCP, DNS int√©gr√©s
4. **Tunnels** : connexions inter-h√¥tes

### Configuration des r√©seaux

**R√©seau par d√©faut :**
```bash
# Voir la configuration r√©seau par d√©faut
lxc network show lxdbr0

# Configuration typique de lxdbr0
ipv4.address: 10.166.11.1/24
ipv4.dhcp: "true"
ipv4.dhcp.ranges: 10.166.11.2-10.166.11.254
ipv4.nat: "true"
ipv6.address: fd42:4c81:5770:1eaf::1/64
```

**Cr√©ation d'un r√©seau personnalis√© :**
```bash
# Cr√©er un nouveau r√©seau
lxc network create production-network

# Configuration du r√©seau
lxc network set production-network ipv4.address 192.168.100.1/24
lxc network set production-network ipv4.dhcp true
lxc network set production-network ipv4.dhcp.ranges 192.168.100.50-192.168.100.200
lxc network set production-network dns.domain production.local
```

### Modes de r√©seau avanc√©s

**R√©seau en mode bridge :**
```bash
# Cr√©er un pont vers interface physique
lxc network create br-physical --type=bridge parent=eth0

# Utiliser le r√©seau physique
lxc config device add mon-conteneur eth0 nic network=br-physical
```

**Configuration de VLAN :**
```bash
# R√©seau avec VLAN
lxc network create vlan100 --type=bridge parent=eth0.100

# Attacher conteneur au VLAN
lxc config device add web-server eth0 nic network=vlan100
```

**R√©seau overlay (inter-h√¥tes) :**
```bash
# Cr√©er un r√©seau overlay
lxc network create overlay-network --type=overlay \
  --config tunnel.protocol=vxlan \
  --config tunnel.id=1000

# Le r√©seau sera disponible sur tous les membres du cluster
```

### Configuration IP avanc√©e

**Adresse IP statique :**
```bash
# M√©thode 1 : via profil r√©seau
lxc config device add mon-conteneur eth0 nic \
  network=lxdbr0 \
  ipv4.address=10.166.11.100

# M√©thode 2 : dans le conteneur
lxc exec mon-conteneur -- systemctl edit --full systemd-networkd

# Configuration dans /etc/systemd/network/eth0.network
[Network]
DHCP=no
Address=10.166.11.100/24
Gateway=10.166.11.1
DNS=10.166.11.1
```

**Multiples interfaces r√©seau :**
```bash
# Ajouter une seconde interface
lxc config device add mon-conteneur eth1 nic \
  network=production-network \
  name=eth1

# V√©rifier les interfaces
lxc exec mon-conteneur -- ip addr show
```

### Redirection de ports

**Port forwarding (proxy devices) :**
```bash
# Rediriger port 80 de l'h√¥te vers le conteneur
lxc config device add web-server port80 proxy \
  listen=tcp:0.0.0.0:80 \
  connect=tcp:127.0.0.1:80

# Redirection avec interface sp√©cifique
lxc config device add web-server https-proxy proxy \
  listen=tcp:192.168.1.100:443 \
  connect=tcp:10.166.11.50:443

# Redirection UDP (DNS)
lxc config device add dns-server dns-proxy proxy \
  listen=udp:0.0.0.0:53 \
  connect=udp:127.0.0.1:53
```

**Gestion avec iptables (m√©thode alternative) :**
```bash
# Redirection via iptables sur l'h√¥te
sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 \
  -j DNAT --to-destination 10.166.11.100:80

# Persistance avec iptables-persistent
sudo apt install iptables-persistent
sudo iptables-save > /etc/iptables/rules.v4
```

### DNS et d√©couverte de services

**Configuration DNS int√©gr√©e :**
```bash
# Activer DNS sur le r√©seau
lxc network set lxdbr0 dns.domain lxd.local
lxc network set lxdbr0 dns.mode managed

# Les conteneurs seront accessibles par :
# conteneur.lxd.local
```

**DNS personnalis√© :**
```bash
# Configuration d'un serveur DNS dans un conteneur
lxc launch ubuntu:22.04 dns-server
lxc exec dns-server -- apt update
lxc exec dns-server -- apt install -y bind9 bind9utils

# Configuration BIND9
lxc exec dns-server -- nano /etc/bind/named.conf.local
```

### S√©curit√© r√©seau

**Isolation des r√©seaux :**
```bash
# R√©seau interne sans acc√®s internet
lxc network create internal-network
lxc network set internal-network ipv4.address 172.16.1.1/24
lxc network set internal-network ipv4.nat false
lxc network set internal-network ipv6.nat false
```

**Filtrage avec pare-feu :**
```bash
# ACLs r√©seau (fonctionnalit√© avanc√©e)
lxc network create restricted-network
lxc network set restricted-network \
  security.acls "restricted-access"

# D√©finir les r√®gles ACL
lxc network acl create restricted-access
lxc network acl rule add restricted-access \
  ingress,allow,tcp \
  0.0.0.0/0 \
  10.0.0.0/8 \
  80,443
```

### Monitoring r√©seau

**Surveillance du trafic :**
```bash
# Statistiques r√©seau des conteneurs
lxc info --resources

# Trafic r√©seau par conteneur
lxc exec mon-conteneur -- cat /proc/net/dev

# Monitoring avec netstat
lxc exec mon-conteneur -- netstat -tuln
```

**Debugging r√©seau :**
```bash
# Test de connectivit√© depuis un conteneur
lxc exec mon-conteneur -- ping google.com
lxc exec mon-conteneur -- dig @8.8.8.8 example.com

# Analyse du trafic
lxc exec mon-conteneur -- tcpdump -i eth0

# V√©rification de la configuration r√©seau
lxc exec mon-conteneur -- ip route show
lxc exec mon-conteneur -- cat /etc/resolv.conf
```

## R√©sum√© et bonnes pratiques

### Points cl√©s √† retenir

**Avantages de LXC/LXD :**
- **Performance** : overhead minimal compar√© aux VMs
- **Flexibilit√©** : environnements syst√®me complets
- **Simplicit√©** : gestion intuitive avec LXD
- **√âvolutivit√©** : snapshots et migration faciles
- **Efficacit√©** : utilisation optimale des ressources

### Bonnes pratiques

**Gestion des conteneurs :**
- Utiliser des profils pour standardiser les configurations
- Mettre en place des snapshots automatiques avant modifications
- Documenter les conteneurs avec descriptions et tags
- S√©parer les donn√©es persistantes avec des volumes d√©di√©s

**S√©curit√© :**
- Privil√©gier les conteneurs non-privil√©gi√©s quand possible
- Utiliser des r√©seaux isol√©s pour segmenter les services
- Mettre √† jour r√©guli√®rement les images de base
- Limiter les ressources (CPU, m√©moire, I/O)

**R√©seau :**
- Planifier l'adressage IP pour √©viter les conflits
- Utiliser des VLANs pour la segmentation avanc√©e
- Documenter les redirections de ports
- Surveiller le trafic r√©seau

### Comparaison finale : Docker vs LXC/LXD

| Crit√®re | Docker | LXC/LXD |
|---------|--------|---------|
| **Cas d'usage** | Applications microservices | Syst√®mes complets, remplacement VMs |
| **Processus** | Un processus principal | Syst√®me multi-processus |
| **D√©marrage** | Tr√®s rapide (< 1s) | Rapide (2-5s) |
| **Persistance** | Conteneurs √©ph√©m√®res | Conteneurs persistants |
| **Gestion** | Images + Compose | Profils + Templates |
| **R√©seau** | Overlay complexe | Bridge traditionnel |
| **Courbe d'apprentissage** | Mod√©r√©e | Facile (similaire VMs) |

### Pr√©paration pour la suite

LXC/LXD constitue une excellente alternative aux machines virtuelles et compl√®te parfaitement Docker pour des cas d'usage diff√©rents. La ma√Ætrise de ces deux approches (conteneurs d'applications vs conteneurs syst√®me) vous permet de choisir la meilleure solution selon le contexte.

Dans la section suivante, nous aborderons Podman et les alternatives √† Docker, qui combinent certains avantages des deux approches avec un focus particulier sur la s√©curit√©.

---

*Les conteneurs syst√®me LXC/LXD repr√©sentent le pont parfait entre les machines virtuelles traditionnelles et les conteneurs d'applications modernes. Ils offrent la simplicit√© de gestion des VMs avec l'efficacit√© des conteneurs, tout en maintenant la familiarit√© des administrateurs syst√®me traditionnels.*

‚è≠Ô∏è
